{% extends "base.html" %}
{% block title %}è‹¦æ‰‹å•é¡Œä¸€è¦§ - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-crosshairs me-2"></i>å…‹æœçŠ¶æ³ãƒ‡ãƒ¼ã‚¿</h2>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>å­¦ç¿’ç”»é¢ã«æˆ»ã‚‹
        </a>
    </div>

    <ul class="nav nav-tabs mb-4" id="weakProblemTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-mastery-tab" data-bs-toggle="tab" data-bs-target="#my-mastery"
                type="button" role="tab" aria-controls="my-mastery" aria-selected="true">
                <i class="fas fa-check-circle me-1"></i>ç‰¹è¨“ä¸­ï¼šå…‹æœãƒªã‚¹ãƒˆ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="my-weak-tab" data-bs-toggle="tab" data-bs-target="#my-weak" type="button"
                role="tab" aria-controls="my-weak" aria-selected="false">
                <i class="fas fa-chart-bar me-1"></i>åˆ†æï¼šæ­£ç­”ç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="everyone-weak-tab" data-bs-toggle="tab" data-bs-target="#everyone-weak"
                type="button" role="tab" aria-controls="everyone-weak" aria-selected="false">
                <i class="fas fa-users me-1"></i>ã¿ã‚“ãªã®æ­£ç­”ç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ
            </button>
        </li>
    </ul>

    <div class="tab-content" id="weakProblemTabContent">
        <!-- ç‰¹è¨“ä¸­ï¼šå…‹æœãƒªã‚¹ãƒˆ -->
        <div class="tab-pane fade show active" id="my-mastery" role="tabpanel" aria-labelledby="my-mastery-tab">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h5 class="card-title mb-3 text-primary">ç¾åœ¨é€²è¡Œå½¢ã®ç‰¹è¨“ãƒªã‚¹ãƒˆ</h5>
                    <p class="text-muted small">
                        ç¾åœ¨ã€Œå…‹æœãƒ¢ãƒ¼ãƒ‰ã€ã®å‡ºé¡Œå¯¾è±¡ã«ãªã£ã¦ã„ã‚‹å…¨ã¦ã®å˜èªã§ã™ã€‚<br>
                        ï¼ˆ2å›é€£ç¶šæ­£è§£ã§ãƒªã‚¹ãƒˆã‹ã‚‰å’æ¥­ã—ã¾ã™ã€‚ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®ã‚‚ã®ã¯ä¸€æ™‚çš„ã«å‡ºé¡Œã•ã‚Œã¾ã›ã‚“ï¼‰
                    </p>

                    <div id="myMasteryLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div id="myMasteryEmpty" class="alert alert-success hidden">
                        ç¾åœ¨ã€ç‰¹è¨“ä¸­ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…¨ã¦å…‹æœæ¸ˆã¿ã§ã™ï¼ğŸ‰
                    </div>

                    <ul id="myMasteryList" class="list-group border-0 bg-transparent">
                        <!-- JavaScriptã§æŒ¿å…¥ -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- è‡ªåˆ†ã®è‹¦æ‰‹å•é¡Œ -->
        <div class="tab-pane fade" id="my-weak" role="tabpanel" aria-labelledby="my-weak-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">æ­£ç­”ç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ20</h5>
                    <p class="text-muted small">éå»ã®å…¨å­¦ç¿’å±¥æ­´ã‹ã‚‰ã€æ­£ç­”ç‡ãŒä½ã„é †ã«20å•ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™<br>
                        ã€ŒProgressã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å•é¡Œã¯å…‹æœãƒ¢ãƒ¼ãƒ‰ã®å¯¾è±¡ã§ã™ãŒã€ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®ã‚‚ã®ã¯å‡ºé¡Œã•ã‚Œã¾ã›ã‚“</p>

                    <div id="myWeakLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>

                    <div id="myWeakEmpty" class="alert alert-info hidden">
                        ã¾ã å›ç­”å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                    </div>

                    <ul id="myWeakList" class="list-group border-0 bg-transparent">
                        <!-- JavaScriptã§æŒ¿å…¥ -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- ã¿ã‚“ãªã®è‹¦æ‰‹å•é¡Œ -->
        <div class="tab-pane fade" id="everyone-weak" role="tabpanel" aria-labelledby="everyone-weak-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">ã¿ã‚“ãªã®æ­£ç­”ç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ20</h5>
                    <p class="text-muted small">åŒã˜éƒ¨å±‹ã®ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ã®æ­£ç­”ç‡ã‚’é›†è¨ˆã—ãŸã€é–“é•ã„ã‚„ã™ã„å•é¡ŒTop20ã§ã™ã€‚<br>â€»Zå•é¡Œï¼ˆé›£é–¢ç§å¤§å¯¾ç­–ï¼‰ã¯é›†è¨ˆå¯¾è±¡å¤–ã§ã™ã€‚</p>

                    <div id="everyoneWeakLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>

                    <div id="everyoneWeakEmpty" class="alert alert-info hidden">
                        é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                    </div>

                    <ul id="everyoneWeakList" class="list-group border-0 bg-transparent">
                        <!-- JavaScriptã§æŒ¿å…¥ -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadMyWeakProblems();

        // å…‹æœãƒªã‚¹ãƒˆã®ã‚¿ãƒ–
        const masteryTab = document.getElementById('my-mastery-tab');

        // åˆ†æãƒ¯ãƒ¼ã‚¹ãƒˆã®ã‚¿ãƒ–
        const weakTab = document.getElementById('my-weak-tab');

        // ã¿ã‚“ãªã®ãƒ¯ãƒ¼ã‚¹ãƒˆã®ã‚¿ãƒ–
        const everyoneTab = document.getElementById('everyone-weak-tab');
        let everyoneLoaded = false;

        everyoneTab.addEventListener('shown.bs.tab', function (event) {
            if (!everyoneLoaded) {
                loadEveryoneWeakProblems();
                everyoneLoaded = true;
            }
        });
    });

    // å•é¡ŒIDç”Ÿæˆé–¢æ•°ï¼ˆscript.jsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function generateProblemId(word) {
        try {
            const chapter = String(word.chapter || '0').padStart(3, '0');
            const number = String(word.number || '0').padStart(3, '0');
            const question = String(word.question || '');
            const answer = String(word.answer || '');

            const questionClean = question.substring(0, 15).replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '');
            const answerClean = answer.substring(0, 10).replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '');

            return `${chapter}-${number}-${questionClean}-${answerClean}`;
        } catch (error) {
            console.error('IDç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            return null;
        }
    }

    function loadMyWeakProblems() {
        const masteryLoading = document.getElementById('myMasteryLoading');
        const masteryEmpty = document.getElementById('myMasteryEmpty');
        const masteryList = document.getElementById('myMasteryList');

        const loading = document.getElementById('myWeakLoading');
        const empty = document.getElementById('myWeakEmpty');
        const list = document.getElementById('myWeakList');

        Promise.all([
            fetch('/api/load_quiz_progress').then(r => r.json()),
            fetch('/api/word_data').then(r => r.json())
        ]).then(([progressData, wordData]) => {
            if (masteryLoading) masteryLoading.classList.add('hidden');
            loading.classList.add('hidden');

            if (progressData.status !== 'success' || !wordData) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
                return;
            }

            const problemHistory = progressData.problemHistory || {};
            const incorrectWords = progressData.incorrectWords || [];

            // wordDataãŒé…åˆ—ã§ãªã„å ´åˆã®å¯¾å¿œ
            let words = Array.isArray(wordData) ? wordData : (wordData.word_data || []);

            const allProblemsWithStats = [];
            const masteryProblems = [];

            for (const [problemId, history] of Object.entries(problemHistory)) {
                const correctAttempts = history.correct_attempts || 0;
                const incorrectAttempts = history.incorrect_attempts || 0;
                const totalAttempts = correctAttempts + incorrectAttempts;

                const originalWord = words.find(word => generateProblemId(word) === problemId);
                if (!originalWord) continue;

                const isCurrentlyWeak = incorrectWords.includes(problemId);
                const stats = {
                    question: originalWord.question,
                    answer: originalWord.answer,
                    correctAttempts,
                    incorrectAttempts,
                    totalAttempts,
                    accuracyRate: totalAttempts > 0 ? (correctAttempts / totalAttempts * 100) : 100,
                    isCurrentlyWeak: isCurrentlyWeak,
                    streak: history.correct_streak || 0,
                    cooldownUntil: history.cooldown_until || 0
                };

                if (totalAttempts > 0) {
                    allProblemsWithStats.push(stats);
                }

                if (isCurrentlyWeak) {
                    masteryProblems.push(stats);
                }
            }

            // 1. ç‰¹è¨“ä¸­ï¼šå…‹æœãƒªã‚¹ãƒˆã®æç”»
            masteryProblems.sort((a, b) => {
                const now = Date.now();
                const aCool = (a.cooldownUntil > now);
                const bCool = (b.cooldownUntil > now);
                if (aCool !== bCool) return aCool ? 1 : -1;
                if (a.streak !== b.streak) return a.streak - b.streak;
                return b.incorrectAttempts - a.incorrectAttempts;
            });

            if (masteryProblems.length === 0) {
                if (masteryEmpty) masteryEmpty.classList.remove('hidden');
            } else {
                renderList(masteryList, masteryProblems, true, false); // true=personal, false=showRank
            }

            // 2. åˆ†æï¼šæ­£ç­”ç‡ãƒ¯ãƒ¼ã‚¹ãƒˆã®æç”»
            allProblemsWithStats.sort((a, b) => {
                // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®ã‚‚ã®ã‚‚å¹³ç­‰ã«ä¸¦ã¹ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¤å®šã‚’ã‚½ãƒ¼ãƒˆæ¡ä»¶ã‹ã‚‰å¤–ã™
                if (a.accuracyRate !== b.accuracyRate) return a.accuracyRate - b.accuracyRate;
                return b.totalAttempts - a.totalAttempts;
            });

            const top20 = allProblemsWithStats.slice(0, 20);

            if (top20.length === 0) {
                empty.classList.remove('hidden');
            } else {
                renderList(list, top20, true, true); // true=personal, true=showRank
            }
        }).catch(err => {
            console.error(err);
            if (masteryLoading) masteryLoading.classList.add('hidden');
            loading.classList.add('hidden');
            empty.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            empty.classList.remove('hidden');
        });
    }

    function loadEveryoneWeakProblems() {
        const loading = document.getElementById('everyoneWeakLoading');
        const empty = document.getElementById('everyoneWeakEmpty');
        const list = document.getElementById('everyoneWeakList');

        fetch('/api/weak_problems_everyone')
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');

                if (data.status === 'success' && data.problems && data.problems.length > 0) {
                    renderList(list, data.problems, false, true); // false=personal, true=showRank
                } else {
                    empty.classList.remove('hidden');
                }
            })
            .catch(err => {
                console.error(err);
                loading.classList.add('hidden');
                empty.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                empty.classList.remove('hidden');
            });
    }

    function renderList(container, items, isPersonal, showRank = true) {
        container.innerHTML = '';
        const now = Date.now();

        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item p-0 mb-3 border rounded shadow-sm overflow-hidden';

            const rankBadge = showRank ? `<span class="badge bg-primary me-2">${index + 1}ä½</span>` : '';

            let statusBadge = '';
            let extraInfo = '';

            if (isPersonal && item.isCurrentlyWeak) {
                // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¤å®š
                if (item.cooldownUntil > now) {
                    const diffMinutes = Math.ceil((item.cooldownUntil - now) / (60 * 1000));
                    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã‚‚ã€ŒProgress 0/2ã€ãªã©ã‚’è¡¨ç¤ºã—ã€ä¼‘æ†©ä¸­ãƒãƒƒã‚¸ã‚‚ä½µè¨˜ã™ã‚‹
                    if (item.streak === 0) {
                        statusBadge = `<span class="badge bg-danger ms-2"><i class="fas fa-dot-circle me-1"></i>Progress 0/2</span>`;
                    } else if (item.streak === 1) {
                        statusBadge = `<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star-half-alt me-1"></i>Progress 1/2</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>å…‹æœé–“è¿‘</span>`;
                    }
                    statusBadge += `<span class="badge bg-secondary ms-2"><i class="fas fa-hourglass-half me-1"></i>ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ (ã‚ã¨${diffMinutes}åˆ†)</span>`;
                } else {
                    // Streaksåˆ¤å®š (ãƒ¬ãƒ™ãƒ«è¡¨ç¤º)
                    if (item.streak === 0) {
                        statusBadge = `<span class="badge bg-danger ms-2"><i class="fas fa-dot-circle me-1"></i>Progress 0/2</span>`;
                    } else if (item.streak === 1) {
                        statusBadge = `<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star-half-alt me-1"></i>Progress 1/2</span>`;
                        extraInfo = '<small class="text-success fw-bold ms-2">ã‚ã¨1å›ã§å…‹æœï¼</small>';
                    } else {
                        statusBadge = `<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>å…‹æœé–“è¿‘</span>`;
                    }
                }
            }

            const accuracyColor = item.accuracyRate >= 80 ? 'text-success' : 'text-danger';

            li.innerHTML = `
            <div class="p-3">
                <div class="fw-bold mb-1">
                    ${rankBadge}${item.question}
                </div>
                <div class="text-muted small mb-0">
                    <span class="answer-blur" onclick="this.classList.toggle('revealed')">
                        ${item.answer}
                    </span>
                    <span class="ms-2 text-secondary" style="font-size: 0.8em;">(ã‚¯ãƒªãƒƒã‚¯ã§ç­”ãˆã‚’è¡¨ç¤º)</span>
                </div>
            </div>
            <div class="bg-light p-2 px-3 border-top d-flex flex-column flex-sm-row justify-content-between align-items-sm-center">
                <div class="d-flex align-items-center flex-wrap">
                    ${statusBadge}${extraInfo}
                </div>
                <div class="text-sm-end mt-2 mt-sm-0 d-flex flex-row flex-sm-column justify-content-between align-items-center align-items-sm-end">
                    <div class="fw-bold ${accuracyColor} me-3 me-sm-0">
                        æ­£ç­”ç‡: ${item.accuracyRate.toFixed(1)}%
                    </div>
                    <div class="text-muted" style="font-size: 0.75rem;">
                        ${isPersonal ?
                    `æ­£è§£:${item.correctAttempts} / ä¸æ­£è§£:${item.incorrectAttempts}` :
                    `å›ç­”:${item.totalAttempts}å›`}
                    </div>
                </div>
            </div>
        `;
            container.appendChild(li);
        });
    }
</script>

<style>
    .answer-blur {
        filter: blur(4px);
        cursor: pointer;
        transition: filter 0.2s;
        user-select: none;
        background-color: #f0f0f0;
        padding: 0 4px;
        border-radius: 3px;
    }

    .answer-blur.revealed {
        filter: none;
        background-color: transparent;
    }

    .hidden {
        display: none !important;
    }
</style>
{% endblock %}