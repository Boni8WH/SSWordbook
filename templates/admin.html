{% extends "base.html" %}
{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - {{ app_name }}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header d-flex justify-content-between align-items-center mb-4">
        <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>
        <a href="{{ url_for('admin_ranking_page') }}" class="btn btn-success">
            <i class="fas fa-trophy"></i> å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <!-- æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="expandAllSections()">
            <i class="fas fa-expand-arrows-alt"></i> å…¨ã¦å±•é–‹
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllSections()">
            <i class="fas fa-compress-arrows-alt"></i> å…¨ã¦æŠ˜ã‚ŠãŸãŸã¿
        </button>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-app-info" aria-expanded="false">
            <h3><i class="fas fa-mobile-alt"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-app-info">
            <div class="section-content">
                <p>ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºåã€æ›´æ–°å†…å®¹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã©ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>

                <div class="admin-panel" style="background-color: #e8f4fd; border-left: 5px solid #3498db;">
                    <h4>ç¾åœ¨ã®ã‚¢ãƒ—ãƒªæƒ…å ±</h4>
                    <div style="margin-top: 15px;">
                        <a href="{{ url_for('admin_app_info') }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ã‚’ç·¨é›†
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãŠçŸ¥ã‚‰ã›ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-announcements"
            aria-expanded="false">
            <h3><i class="fas fa-bullhorn"></i> ãŠçŸ¥ã‚‰ã›ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-announcements">
            <div class="section-content">
                <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãŠçŸ¥ã‚‰ã›ã‚’é…ä¿¡ã§ãã¾ã™ã€‚æœ€æ–°5ä»¶ãŒã€Œiã€ãƒœã‚¿ãƒ³ã®æƒ…å ±ãƒ‘ãƒãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

                <!-- æ–°è¦ãŠçŸ¥ã‚‰ã›ä½œæˆ -->
                <div class="admin-panel"
                    style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                    <h4><i class="fas fa-plus"></i> æ–°è¦ãŠçŸ¥ã‚‰ã›ä½œæˆ</h4>
                    <form action="{{ url_for('admin_add_announcement') }}" method="POST">
                        <div class="mb-3">
                            <label for="announcementTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" class="form-control" id="announcementTitle" name="title" required
                                placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›">
                        </div>
                        <div class="mb-3">
                            <label for="announcementContent" class="form-label">å†…å®¹</label>
                            <textarea class="form-control" id="announcementContent" name="content" rows="3" required
                                placeholder="ãŠçŸ¥ã‚‰ã›ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="announcementTarget" class="form-label">å¯¾è±¡éƒ¨å±‹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                            <input type="text" id="roomSearchInput" class="form-control mb-2" placeholder="éƒ¨å±‹ç•ªå·ã‚’æ¤œç´¢..."
                                onkeyup="filterRooms()">
                            <select class="form-select" id="announcementTarget" name="target_rooms" multiple size="5"
                                required>
                                <option value="all" selected>å…¨å“¡ (All)</option>
                                {% for room in room_settings %}
                                <option value="{{ room.room_number }}">{{ room.room_number }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Ctrl(Windows)ã¾ãŸã¯Command(Mac)ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã§ãã¾ã™ã€‚</div>
                        </div>
                        <script>
                            function filterRooms() {
                                var input, filter, select, options, i, txtValue;
                                input = document.getElementById("roomSearchInput");
                                filter = input.value.toUpperCase();
                                select = document.getElementById("announcementTarget");
                                options = select.getElementsByTagName("option");
                                for (i = 0; i < options.length; i++) {
                                    txtValue = options[i].textContent || options[i].innerText;
                                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                        options[i].style.display = "";
                                    } else {
                                        options[i].style.display = "none";
                                    }
                                }
                            }
                        </script>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-paper-plane"></i> ãŠçŸ¥ã‚‰ã›ã‚’é…ä¿¡
                        </button>
                    </form>
                </div>

                <!-- ãŠçŸ¥ã‚‰ã›ä¸€è¦§ -->
                <h4>é…ä¿¡æ¸ˆã¿ãŠçŸ¥ã‚‰ã›ä¸€è¦§</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>å¯¾è±¡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ann in announcements %}
                            <tr>
                                <td>{{ ann.date | to_jst }}</td>
                                <td>{{ ann.title }}</td>
                                <td>
                                    {% if ann.target_rooms == 'all' %}
                                    <span class="badge bg-success">å…¨å“¡</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ ann.target_rooms }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ann.is_active %}
                                    <span class="badge bg-primary">æœ‰åŠ¹</span>
                                    {% else %}
                                    <span class="badge bg-secondary">ç„¡åŠ¹</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form action="{{ url_for('admin_delete_announcement', id=ann.id) }}" method="POST"
                                        style="display: inline;" onsubmit="handleAnnouncementDelete(event)">
                                        <button type="submit" class="btn btn-sm btn-danger">å‰Šé™¤</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-management"
            aria-expanded="true">
            <h3><i class="fas fa-users"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-management">
            <div class="section-content">
                <p>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ users|length }}äºº</p>

                <h4>CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
                <div
                    style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                    <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
                    <ul>
                        <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: éƒ¨å±‹ç•ªå·,å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,å‡ºå¸­ç•ªå·,å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</li>
                        <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
                        <li>ä¾‹: 101,password123,001,student001,æˆå¯Œå…µåº«èŒ‚å®‰</li>
                        <li>åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®ç™»éŒ²ã‚‚å¯èƒ½ã§ã™ï¼ˆåŒä¸€äººç‰©ãŒè¤‡æ•°éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆï¼‰</li>
                    </ul>
                    <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-download"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>

                <form id="userUploadForm" enctype="multipart/form-data" class="upload-form">
                    <div class="input-group">
                        <label for="users_csv_file">ãƒ¦ãƒ¼ã‚¶ãƒ¼CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                        <input type="file" id="users_csv_file" name="file" accept=".csv" required>
                    </div>
                    <button type="button" class="btn btn-success" onclick="prepareUserUpload()">
                        <i class="fas fa-upload"></i> CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
                    </button>
                </form>

                <!-- é€²æ—ãƒãƒ¼ -->
                <div id="uploadProgressContainer" style="display: none; margin-top: 20px;">
                    <h5><i class="fas fa-spinner fa-spin"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†ä¸­...</h5>
                    <div class="progress" style="height: 25px;">
                        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                            aria-valuemax="100">0%</div>
                    </div>
                    <p id="uploadStatusMessage" class="text-muted mt-2">æº–å‚™ä¸­...</p>
                </div>

                <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div class="modal fade" id="uploadConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ‹¬ç™»éŒ²ã®ç¢ºèª</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>ä»¥ä¸‹ã®å†…å®¹ã§ç™»éŒ²ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ</p>
                                <ul>
                                    <li><strong>å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:</strong> <span id="confirmFileName"></span></li>
                                    <li><strong>ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:</strong> <span id="confirmUserCount"></span> äºº</li>
                                    <li><strong>æ¨å®šæ‰€è¦æ™‚é–“:</strong> <span id="confirmTimeEstimate"></span></li>
                                </ul>
                                <div class="alert alert-info">
                                    <small>â€» å‡¦ç†ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è¡Œã‚ã‚Œã¾ã™ã€‚é–‹å§‹å¾Œã¯ä»–ã®ä½œæ¥­ã‚’è¡Œã£ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button type="button" class="btn btn-primary" onclick="startUserUpload()">
                                    <i class="fas fa-play"></i> ç™»éŒ²é–‹å§‹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <h4>å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
                <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
                    <div class="input-group">
                        <label for="new_room_number">éƒ¨å±‹ç•ªå·:</label>
                        <input type="text" id="new_room_number" name="room_number" required>
                    </div>
                    <div class="input-group">
                        <label for="new_room_password">å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="new_room_password" name="room_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_student_id">å‡ºå¸­ç•ªå·:</label>
                        <input type="text" id="new_student_id" name="student_id" required>
                    </div>
                    <div class="input-group">
                        <label for="new_individual_password">å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="new_individual_password" name="individual_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:</label>
                        <input type="text" id="new_username" name="username" required>
                        <small class="form-text text-muted">â€»åŒä¸€äººç‰©ãŒè¤‡æ•°ã®éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆã€åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã§ã‚‚ç™»éŒ²å¯èƒ½ã§ã™</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                </form>

                <h4>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
                <!-- ã‚½ãƒ¼ãƒˆãƒ»æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="table-controls mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="roomSortSelect">éƒ¨å±‹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                            <select id="roomSortSelect" class="form-control form-control-sm">
                                <option value="">å…¨ã¦ã®éƒ¨å±‹</option>
                                {% set room_numbers = [] %}
                                {% for user in users %}
                                {% if user.room_number not in room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = room_numbers.append(user.room_number) %}
                                {% endif %}
                                {% endfor %}
                                {% for room_num in room_numbers|sort %}
                                <option value="{{ room_num }}">éƒ¨å±‹ {{ room_num }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="userSearchInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢:</label>
                            <input type="text" id="userSearchInput" class="form-control form-control-sm"
                                placeholder="åå‰ã€å‡ºå¸­ç•ªå·ã§æ¤œç´¢...">
                        </div>
                    </div>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-controls mb-2">
                    <button type="button" id="bulkDeleteBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-trash-alt"></i> é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ (<span id="selectedUserCount">0</span>)
                    </button>
                </div>
                <div class="scrollable-table-container">
                    <div class="table-responsive">
                        <table class="table table-striped" id="userTable">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th><input type="checkbox" id="selectAllUsers" title="è¡¨ç¤ºä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å…¨ã¦é¸æŠ"></th>
                                    <th>ID</th>
                                    <th style="cursor: pointer;" data-column="room">
                                        éƒ¨å±‹ç•ªå· <i class="fas fa-sort sort-icon" data-column="room"></i>
                                    </th>
                                    <th>å‡ºå¸­ç•ªå·</th>
                                    <th style="cursor: pointer;" data-column="name">
                                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå <i class="fas fa-sort sort-icon" data-column="name"></i>
                                    </th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                {% for user in users %}
                                {% if user.room_number != 'ADMIN' %}
                                <tr data-room="{{ user.room_number }}" data-name="{{ user.username.lower() }}"
                                    data-student="{{ user.student_id }}">
                                    <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}"></td>
                                    <td>{{ user.id }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ user.room_number }}</span>
                                        {% if room_data.get(user.room_number, {}).get('is_suspended', False) %}
                                        <span class="badge bg-warning text-dark ms-1">
                                            <i class="fas fa-pause"></i> ä¸€æ™‚åœæ­¢
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td><code>{{ user.student_id }}</code></td>
                                    <td><strong>{{ user.username }}</strong></td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm delete-user-btn"
                                            data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                            <i class="fas fa-trash"></i> å‰Šé™¤
                                        </button>
                                        <button class="btn btn-warning btn-sm delete-score-btn"
                                            data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                            <i class="fas fa-eraser"></i> ã‚¹ã‚³ã‚¢å‰Šé™¤
                                        </button>
                                        <button class="btn btn-info btn-sm reset-intro-btn" data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}">
                                            <i class="fas fa-undo"></i> Introãƒªã‚»ãƒƒãƒˆ
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- å•é¡ŒCSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-csv-management"
            aria-expanded="false">
            <h3><i class="fas fa-folder-open"></i> å•é¡ŒCSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-csv-management">
            <div class="section-content">
                <p>å„éƒ¨å±‹ã§ä½¿ç”¨ã™ã‚‹å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®words.csvãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                <div class="csv-template-section"
                    style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i> CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </h4>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        æ­£ã—ã„å½¢å¼ã®å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ãã§ã™ãã«ç·¨é›†ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
                    </p>
                    <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-file-csv"></i> å˜èªå¸³CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                    <small class="text-muted d-block mt-2">
                        â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šchapter, number, category, question, answer, enabled
                    </small>
                </div>
                <form action="{{ url_for('admin_upload_room_csv') }}" method="POST" enctype="multipart/form-data"
                    class="upload-form">
                    <div class="input-group">
                        <label for="room_csv_file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                        <input type="file" id="room_csv_file" name="file" accept=".csv" required>
                        <small class="form-text text-muted">ï¼Šãƒ•ã‚¡ã‚¤ãƒ«åã¯åŠè§’è‹±æ•°å­—ï¼Š</small>
                    </div>
                    <button type="submit" class="btn btn-success">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </form>

                <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h4>
                <div id="csv-files-list">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">
                            <i class="fas fa-sync-alt"></i> ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                        </button>
                    </div>
                    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
                    <div class="scrollable-table-container">
                        <div id="csv-files-container" style="margin-top: 15px; overflow-x: auto;">
                            <p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-room-settings"
            aria-expanded="false">
            <h3><i class="fas fa-home"></i> éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-room-settings">
            <div class="section-content">
                <p>å„éƒ¨å±‹ã®å­¦ç¿’ç¯„å›²ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã€ä¸€æ™‚åœæ­¢çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>

                <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªéƒ¨å±‹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="scrollable-table-container">
                    <div class="table-responsive" style="overflow-x: auto;">
                        <table class="table table-striped room-setting-table" style="min-width: 700px;">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th>éƒ¨å±‹ç•ªå·</th>
                                    <th>æœ‰åŠ¹å˜å…ƒè¨­å®š</th>
                                    <th>ä½¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set unique_room_numbers = [] %}
                                {% for user in users %}
                                {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(user.room_number) %}
                                {% endif %}
                                {% endfor %}

                                {% for setting in room_max_unit_settings.keys() %}
                                {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(setting) %}
                                {% endif %}
                                {% endfor %}

                                {% for room_num in unique_room_numbers|sort %}
                                <tr {% if room_data.get(room_num, {}).get('is_suspended', False) %}class="table-warning"
                                    {% endif %}>
                                    <td>
                                        <strong>{{ room_num }}</strong>
                                        {% if room_data.get(room_num, {}).get('is_suspended', False) %}
                                        <span class="badge bg-warning text-dark ms-1">
                                            <i class="fas fa-pause"></i> ä¸€æ™‚åœæ­¢ä¸­
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="unit-setting-container" id="unitContainer_{{ room_num }}">
                                            <div class="unit-controls mb-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                    onclick="loadAvailableUnits('{{ room_num }}')">
                                                    <i class="fas fa-sync"></i> å˜å…ƒä¸€è¦§èª­ã¿è¾¼ã¿
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm"
                                                    onclick="selectAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-check-double"></i> å…¨ã¦é¸æŠ
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm"
                                                    onclick="clearAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-times"></i> å…¨ã¦è§£é™¤
                                                </button>
                                            </div>
                                            <div class="unit-checkboxes" id="unitCheckboxes_{{ room_num }}">
                                                <p class="text-muted">ã€Œå˜å…ƒä¸€è¦§èª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åˆ©ç”¨å¯èƒ½ãªå˜å…ƒã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
                                            </div>
                                            <div class="selected-units-display mt-2">
                                                <small class="text-info">
                                                    é¸æŠä¸­: <span id="selectedCount_{{ room_num }}">0</span>å€‹ã®å˜å…ƒ
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <select id="csvFile_{{ room_num }}" class="form-control csv-setting-select"
                                            data-room-number="{{ room_num }}">
                                            <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv'
                                                )=='words.csv' %}selected{% endif %}>
                                                words.csv (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                                            </option>
                                            <!-- å‹•çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                                        </select>
                                        <small class="form-text text-muted">
                                            ç¾åœ¨ã®è¨­å®š: <code
                                                id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-primary btn-sm save-room-setting-btn"
                                                data-room-number="{{ room_num }}">ä¿å­˜</button>
                                            <button class="btn btn-info btn-sm regenerate-quiz-btn"
                                                data-room-number="{{ room_num }}">
                                                <i class="fas fa-sync-alt"></i> 10å• å†é¸è€ƒ
                                            </button>
                                            <button type="button" class="btn btn-warning btn-sm me-1"
                                                data-room-number="{{ room_num }}"
                                                data-is-suspended="{{ room_data.get(room_num, {}).get('is_suspended', False)|lower }}"
                                                onclick="toggleRoomSuspension(event, this)">
                                                {% if room_data.get(room_num, {}).get('is_suspended', False) %}
                                                <i class="fas fa-play"></i> å†é–‹
                                                {% else %}
                                                <i class="fas fa-pause"></i> ä¸€æ™‚åœæ­¢
                                                {% endif %}
                                            </button>
                                            <button type="button" class="btn btn-warning btn-sm delete-room-score-btn"
                                                onclick="confirmDeleteRoomScore(event, '{{ room_num }}')">
                                                <i class="fas fa-eraser"></i> ã‚¹ã‚³ã‚¢å…¨å‰Šé™¤
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm"
                                                onclick="deleteRoom(event, '{{ room_num }}')">å‰Šé™¤</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RPGæ•µã‚­ãƒ£ãƒ©ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-rpg-management"
            aria-expanded="false">
            <h3><i class="fas fa-dragon"></i> RPGæ•µã‚­ãƒ£ãƒ©ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-rpg-management">
            <div class="section-content">
                <p>RPGãƒ¢ãƒ¼ãƒ‰ã§ç™»å ´ã™ã‚‹æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆãƒœã‚¹ï¼‰ã‚’è¿½åŠ ç·¨é›†ã§ãã¾ã™ã€‚</p>

                <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="admin-panel"
                    style="background-color: #fce4ec; border-left: 5px solid #e91e63; margin-bottom: 20px;">
                    <h4><i class="fas fa-plus-circle"></i> æ–°è¦ãƒœã‚¹è¿½åŠ </h4>
                    <form id="addRpgEnemyForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ãƒœã‚¹å</label>
                                <input type="text" class="form-control" name="name" placeholder="ä¾‹: ãƒãƒ³ãƒ‹ãƒãƒ«" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">é›£æ˜“åº¦ (1-100)</label>
                                <input type="number" class="form-control" name="difficulty" min="1" max="100" value="1"
                                    required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ãƒœã‚¹ç”»åƒ (æˆ¦é—˜ç”¨)</label>
                                <input type="file" class="form-control" name="icon_image" accept="image/*">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">è¨ä¼å¾Œç”»åƒ (Statusç”¨)</label>
                                <input type="file" class="form-control" name="defeated_image" accept="image/*">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ç§°å·å</label>
                                <input type="text" class="form-control" name="badge_name" placeholder="ä¾‹: é›·å…‰ã®å°†è»"
                                    required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ç§°å·ã‚¢ã‚¤ã‚³ãƒ³ (ç”»åƒ)</label>
                                <input type="file" class="form-control" name="badge_image" accept="image/*">
                                <small class="text-muted">ã¾ãŸã¯ FontAwesomeã‚¯ãƒ©ã‚¹åã‚’å…¥åŠ›:</small>
                                <input type="text" class="form-control mt-1" name="badge_icon_class"
                                    placeholder="ä¾‹: fas fa-bolt">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">èª¬æ˜æ–‡</label>
                                <textarea class="form-control" name="description" rows="2"
                                    placeholder="ãƒœã‚¹ã®èª¬æ˜..."></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">é–‹å§‹ã‚»ãƒªãƒ•</label>
                                <textarea class="form-control" name="intro_dialogue" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è¨ä¼æ™‚ã‚»ãƒªãƒ• (Boss)</label>
                                <textarea class="form-control" name="defeat_dialogue" rows="2"
                                    placeholder="ãƒœã‚¹ãŒå€’ã‚ŒãŸæ™‚ã«è¨€ã†ã‚»ãƒªãƒ•"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">è¨ä¼å¾Œã‚³ãƒ¡ãƒ³ãƒˆ (Per)</label>
                                <div id="addDialogueContainer"></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                    onclick="addDialogueRow('addDialogueContainer')">
                                    <i class="fas fa-plus"></i> ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                                </button>
                            </div>
                        </div>

                        <hr>
                        <hr>
                        <h5>ã‚¯ãƒªã‚¢æ¡ä»¶ãƒ»å‡ºç¾æ¡ä»¶</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">åˆ¶é™æ™‚é–“ (ç§’)</label>
                                <input type="number" class="form-control" name="time_limit" value="60">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">åˆæ ¼æ­£è§£æ•°</label>
                                <input type="number" class="form-control" name="clear_correct_count" value="10">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">è¨±å®¹ãƒŸã‚¹æ•°</label>
                                <input type="number" class="form-control" name="clear_max_mistakes" value="2">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">å‡ºç¾å¿…è¦ã‚¹ã‚³ã‚¢ (Min 1000)</label>
                                <input type="number" class="form-control" name="appearance_required_score" value="1000"
                                    min="1000">
                            </div>
                        </div>

                        <div class="mb-3 p-3 border rounded bg-light">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_manual_order" value="true"
                                    id="addIsManualOrder" onchange="toggleManualOrder('add')">
                                <label class="form-check-label" for="addIsManualOrder">å„ªå…ˆè¡¨ç¤ºé †ã‚’æ‰‹å‹•è¨­å®šã™ã‚‹</label>
                            </div>
                            <div id="addDisplayOrderGroup" style="display: none; margin-top: 10px;">
                                <label class="form-label">è¡¨ç¤ºé † (å°ã•ã„æ•°å­—ãŒå…ˆ)</label>
                                <input type="number" class="form-control" name="display_order" value="0">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_active" value="true" checked
                                id="isActiveCheck">
                            <label class="form-check-label" for="isActiveCheck">ã™ãã«æœ‰åŠ¹ã«ã™ã‚‹</label>
                        </div>

                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-save"></i> ãƒœã‚¹ã‚’ç™»éŒ²
                        </button>
                    </form>
                </div>

                <!-- ãƒœã‚¹ä¸€è¦§ -->
                <h4>ç™»éŒ²æ¸ˆã¿ãƒœã‚¹ä¸€è¦§</h4>
                <div id="rpgEnemyListContainer">
                    <!-- JSã§ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰ -->
                    <div class="text-center"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: RPGç®¡ç†æ©Ÿèƒ½ -->
    <script>
        // Toggle Manual Order Input
        function toggleManualOrder(prefix) {
            const checkbox = document.getElementById(prefix + 'IsManualOrder');
            const group = document.getElementById(prefix + 'DisplayOrderGroup');
            if (checkbox && group) {
                group.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // â˜…é‡è¦ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyç›´ä¸‹ã«ç§»å‹•ã•ã›ã¦ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¹²æ¸‰ï¼ˆã¡ã‚‰ã¤ããƒ»å³é–‰ã˜ï¼‰ã‚’é˜²ã
            ['editRpgEnemyModal', 'uploadConfirmModal', 'deleteScoreModal'].forEach(id => {
                const modalEl = document.getElementById(id);
                if (modalEl) {
                    document.body.appendChild(modalEl);
                    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šé–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½è·¡
                    modalEl.addEventListener('hide.bs.modal', function (e) {
                        console.log(`ğŸ”’ Modal ${id} is hiding. Event type: ${e.type}`, e);
                        // console.trace(); // å¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–
                    });
                }
            });

            loadRpgEnemies();

            document.getElementById('addRpgEnemyForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const form = this; // Capture form context

                showConfirmModal(
                    'ç™»éŒ²ç¢ºèª',
                    'ã“ã®ãƒœã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ',
                    () => {
                        const formData = new FormData(form);

                        fetch('/admin/rpg/enemies/add', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('ç™»éŒ²ã—ã¾ã—ãŸï¼');
                                    form.reset();
                                    loadRpgEnemies();
                                } else {
                                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                                }
                            })
                            .catch(err => alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
                    }
                );
            });
        });

        function loadRpgEnemies() {
            fetch('/admin/rpg/enemies')
                .then(res => res.json())
                .then(enemies => {
                    // Store enemies globally for easy access
                    window.rpgEnemies = {};
                    enemies.forEach(e => { window.rpgEnemies[e.id] = e; });

                    const container = document.getElementById('rpgEnemyListContainer');
                    if (enemies.length === 0) {
                        container.innerHTML = '<p class="text-muted">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒœã‚¹ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                        return;
                    }

                    let html = '<div class="table-responsive"><table class="table table-bordered table-hover align-middle">';
                    html += '<thead class="table-dark"><tr><th>Icon</th><th>åå‰ (é›£æ˜“åº¦)</th><th>ç§°å·</th><th>æ¡ä»¶</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';

                    enemies.forEach(enemy => {
                        // ç”»åƒãƒ‘ã‚¹ã®ç”Ÿæˆ (DBçµŒç”±ã®URLã‚’ä½¿ç”¨)
                        const iconPath = enemy.icon_url ? enemy.icon_url : (enemy.icon_image ? `/static/images/rpg/${enemy.icon_image}` : '');

                        html += `<tr>
                        <td class="text-center"><img src="${iconPath}" style="width:50px; height:50px; object-fit:contain;"></td>
                        <td><strong>${enemy.name}</strong> <span class="text-warning">â˜…${enemy.difficulty}</span></td>
                        <td>${enemy.badge_name}</td>
                        <td><small>åˆ¶é™${enemy.time_limit}ç§’ / æ­£è§£${enemy.clear_correct_count} / ãƒŸã‚¹${enemy.clear_max_mistakes}ã¾ã§</small></td>
                        <td>${enemy.is_active ? '<span class="badge bg-success">æœ‰åŠ¹</span>' : '<span class="badge bg-secondary">ç„¡åŠ¹</span>'}</td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="openEditRpgEnemyModal(event, ${enemy.id})">
                                <i class="fas fa-edit"></i> ç·¨é›†
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteRpgEnemy(event, ${enemy.id})">
                                <i class="fas fa-trash"></i> å‰Šé™¤
                            </button>
                        </td>
                    </tr>`;
                    });

                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                });
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditRpgEnemyModal(event, enemyId) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const enemy = window.rpgEnemies[enemyId];
            if (!enemy) {
                console.error('Enemy not found for ID:', enemyId);
                return;
            }
            const modalElement = document.getElementById('editRpgEnemyModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            const form = document.getElementById('editRpgEnemyForm');

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            form.action = `/admin/rpg/enemies/edit/${enemy.id}`; // ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’å‹•çš„ã«è¨­å®š
            form.elements['name'].value = enemy.name;
            form.elements['difficulty'].value = enemy.difficulty;
            form.elements['badge_name'].value = enemy.badge_name;
            form.elements['description'].value = enemy.description || '';
            form.elements['intro_dialogue'].value = enemy.intro_dialogue || '';
            form.elements['defeat_dialogue'].value = enemy.defeat_dialogue || '';

            // ğŸ†• Dialogues Populate
            const container = document.getElementById('editDialogueContainer');
            if (container) {
                container.innerHTML = ''; // Request clear
                if (enemy.dialogues && enemy.dialogues.length > 0) {
                    enemy.dialogues.forEach(d => {
                        addDialogueRow('editDialogueContainer', d.content, d.expression);
                    });
                } else {
                    // If no dialogues but legacy defeat_dialogue exists, maybe add it as first row?
                    if (enemy.defeat_dialogue) {
                        addDialogueRow('editDialogueContainer', enemy.defeat_dialogue, 'normal');
                    }
                }
            }
            form.elements['time_limit'].value = enemy.time_limit;
            form.elements['clear_correct_count'].value = enemy.clear_correct_count;
            form.elements['clear_max_mistakes'].value = enemy.clear_max_mistakes;
            form.elements['display_order'].value = enemy.display_order;
            form.elements['appearance_required_score'].value = enemy.appearance_required_score;

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            form.elements['is_active'].checked = enemy.is_active;

            // Manual Order
            if (form.elements['is_manual_order']) {
                form.elements['is_manual_order'].checked = enemy.is_manual_order || false;
                toggleManualOrder('edit');
            }

            // ãƒãƒƒã‚¸ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒ©ã‚¹ (ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆ)
            form.elements['badge_icon_class'].value = enemy.badge_image && !enemy.badge_image.includes('/') ? enemy.badge_image : '';

            // æ—¢å­˜ã®ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–° (ã‚‚ã—ã‚ã‚Œã°)
            const currentIconPreview = document.getElementById('currentEditIconImage');
            if (currentIconPreview) {
                currentIconPreview.src = enemy.icon_url ? enemy.icon_url : (enemy.icon_image ? `/static/images/rpg/${enemy.icon_image}` : '/static/images/boss_alexander.png');
                currentIconPreview.style.display = 'block';
            }
            // Defeated Preview
            const currentDefeatedPreview = document.getElementById('currentEditDefeatedImage');
            if (currentDefeatedPreview) {
                if (enemy.defeated_image) {
                    currentDefeatedPreview.src = enemy.defeated_url ? enemy.defeated_url : `/static/images/rpg/${enemy.defeated_image}`;
                    currentDefeatedPreview.style.display = 'block';
                } else {
                    currentDefeatedPreview.style.display = 'none';
                }
            }
            const currentBadgePreview = document.getElementById('currentEditBadgeImage');
            if (currentBadgePreview) {
                if (enemy.badge_image && enemy.badge_image.includes('/')) { // ç”»åƒã®å ´åˆ
                    currentBadgePreview.src = enemy.badge_url ? enemy.badge_url : `/static/images/rpg/${enemy.badge_image}`;
                    currentBadgePreview.style.display = 'block';
                    document.getElementById('currentEditBadgeIconClass').style.display = 'none';
                } else if (enemy.badge_image) { // FontAwesomeã‚¯ãƒ©ã‚¹ã®å ´åˆ
                    document.getElementById('currentEditBadgeIconClass').className = `fas ${enemy.badge_image} fa-2x`;
                    document.getElementById('currentEditBadgeIconClass').style.display = 'inline-block';
                    currentBadgePreview.style.display = 'none';
                } else {
                    currentBadgePreview.style.display = 'none';
                    document.getElementById('currentEditBadgeIconClass').style.display = 'none';
                }
            }

            modal.show();
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditRpgEnemyModal() {
            const modalElement = document.getElementById('editRpgEnemyModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }

        // å‰Šé™¤å¯¾è±¡IDã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let deleteRpgEnemyTargetId = null;

        function deleteRpgEnemy(event, id) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // store ID
            deleteRpgEnemyTargetId = id;

            // show bootstrap modal
            const modalEl = document.getElementById('deleteRpgEnemyModal');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bootstrap.Modal(modalEl);
            }
            modal.show();
        }

        function executeDeleteRpgEnemy() {
            if (!deleteRpgEnemyTargetId) return;

            // hide modal
            const modalEl = document.getElementById('deleteRpgEnemyModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // execute delete
            fetch(`/admin/rpg/enemies/delete/${deleteRpgEnemyTargetId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadRpgEnemies();
                    } else {
                        alert('å‰Šé™¤å¤±æ•—: ' + data.message);
                    }
                })
                .catch(err => alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
        }

        // ğŸŸ¢ PER DIALOGUE LOGIC
        const PER_EXPRESSIONS = [
            { id: 'normal', label: 'é€šå¸¸ (Normal)' },
            { id: 'joy', label: 'å–œã³ (Joy)' },
            { id: 'trouble', label: 'å›°ã‚‹ (Trouble/Confusion)' },
            { id: 'grief', label: 'æ‚²ã—ã¿ (Grief)' },
            { id: 'analysis', label: 'åˆ†æ (Analysis)' },
            { id: 'caution', label: 'è­¦å‘Š (Caution)' }
        ];

        function addDialogueRow(containerId, content = '', expression = 'normal') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const rowId = 'dialogue_row_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

            const div = document.createElement('div');
            div.className = 'input-group mb-2 dialogue-row';
            div.id = rowId;

            // Expression Selector
            let selectHtml = `<select class="form-select" name="dialogue_expression[]" style="max-width: 150px;">`;
            PER_EXPRESSIONS.forEach(expr => {
                const selected = expr.id === expression ? 'selected' : '';
                selectHtml += `<option value="${expr.id}" ${selected}>${expr.label}</option>`;
            });
            selectHtml += `</select>`;

            div.innerHTML = `
                ${selectHtml}
                <textarea class="form-control" name="dialogue_content[]" rows="1" placeholder="ã‚»ãƒªãƒ•ã‚’å…¥åŠ›...">${content}</textarea>
                <button type="button" class="btn btn-outline-danger" onclick="removeDialogueRow(this)">
                    <i class="fas fa-minus"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeDialogueRow(btn) {
            btn.closest('.dialogue-row').remove();
        }

        // Also ensure Add Form is cleared when modal resets (if handled manually) or initialized
        // Note: For Add Form, we might need to clear it manually if the form is reset but container isn't.
        // Assuming page reload or form reset clears HTML inside if dynamic... actually it does NOT clear innerHTML of divs.
        // We should add a reset handler for addRpgEnemyForm.
        document.getElementById('addRpgEnemyForm').addEventListener('reset', function () {
            setTimeout(() => {
                document.getElementById('addDialogueContainer').innerHTML = '';
            }, 0);
        });

    </script>

    <!-- è«–è¿°å•é¡Œå…¬é–‹è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-essay-visibility"
            aria-expanded="false">
            <h3><i class="fas fa-eye"></i> è«–è¿°å•é¡Œå…¬é–‹è¨­å®š <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-essay-visibility">
            <div class="section-content">
                <p>éƒ¨å±‹ã”ã¨ã«ç« ãƒ»å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥ã§è«–è¿°å•é¡Œã®å…¬é–‹/éå…¬é–‹ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>

                <!-- éƒ¨å±‹é¸æŠ -->
                <div class="visibility-room-selector">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-4">
                            <label for="visibilityRoomSelect" class="form-label">
                                <i class="fas fa-door-open"></i> è¨­å®šå¯¾è±¡ã®éƒ¨å±‹
                            </label>
                            <select id="visibilityRoomSelect" class="form-select">
                                <option value="">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button id="loadVisibilitySettings" class="btn btn-primary" disabled>
                                    <i class="fas fa-download"></i> è¨­å®šã‚’èª­ã¿è¾¼ã¿
                                </button>
                                <button id="saveVisibilitySettings" class="btn btn-success" disabled>
                                    <i class="fas fa-save"></i> è¨­å®šã‚’ä¿å­˜
                                </button>
                                <button id="resetVisibilitySettings" class="btn btn-warning" disabled>
                                    <i class="fas fa-undo"></i> å…¨ã¦å…¬é–‹ã«ãƒªã‚»ãƒƒãƒˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¨­å®šãƒãƒˆãƒªãƒƒã‚¯ã‚¹ -->
                <div id="visibilityMatrix" class="visibility-matrix" style="display: none;">
                    <div class="matrix-header">
                        <h4><i class="fas fa-eye"></i> è«–è¿°å•é¡Œå…¬é–‹è¨­å®š</h4>
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle"></i>
                            å„ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å€‹åˆ¥è¨­å®šã€ã€Œç¬¬â—‹ç« ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç« å…¨ä½“ã®ä¸€æ‹¬è¨­å®šãŒã§ãã¾ã™
                        </p>
                    </div>

                    <!-- Grid Container -->
                    <div id="visibilityGrid" class="visibility-grid">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ -->
                        <div class="grid-header grid-cell-chapter">ç« </div>
                        <div class="grid-header grid-cell-type">ã‚¿ã‚¤ãƒ—A</div>
                        <div class="grid-header grid-cell-type">ã‚¿ã‚¤ãƒ—B</div>
                        <div class="grid-header grid-cell-type">ã‚¿ã‚¤ãƒ—C</div>
                        <div class="grid-header grid-cell-type">ã‚¿ã‚¤ãƒ—D</div>

                        <!-- ãƒ‡ãƒ¼ã‚¿è¡Œã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>

                    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ã®ã¿ -->
                    <div class="save-section mt-3 text-center">
                        <button type="button" class="btn btn-primary btn-lg" onclick="saveVisibilitySettings()">
                            <i class="fas fa-save"></i> è¨­å®šã‚’ä¿å­˜
                        </button>
                    </div>
                </div>

                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div id="visibilityStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- è«–è¿°å•é¡Œé›†ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€€-->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-essay-management"
            aria-expanded="false">
            <h3><i class="fas fa-edit"></i> è«–è¿°å•é¡Œé›†ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-essay-management">
            <div class="section-content">
                <p>è«–è¿°å•é¡Œã®ç™»éŒ²ãƒ»ç®¡ç†ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™ã€‚</p>
                <!-- è«–è¿°å•é¡ŒCSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div class="csv-import-section">
                    <h4><i class="fas fa-upload"></i> CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>

                    <!-- CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª¬æ˜ -->
                    <div class="csv-template-section">
                        <h5><i class="fas fa-download"></i> è«–è¿°å•é¡ŒCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h5>
                        <p>æ­£ã—ã„å½¢å¼ã®è«–è¿°å•é¡ŒCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚</p>

                        <div class="template-format">
                            <strong>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</strong><br>
                            <code>chapter,type,university,year,question,answer,answer_length,enabled</code><br><br>

                            <strong>å„åˆ—ã®èª¬æ˜:</strong><br>
                            â€¢ <strong>chapter</strong>: ç« ç•ªå·ï¼ˆä¾‹: 1, 2, comï¼‰<br>
                            â€¢ <strong>type</strong>: å•é¡Œã‚¿ã‚¤ãƒ—ï¼ˆA: 200å­—ä»¥ä¸Š, B: 100-150å­—, C: 50-75å­—, D: 30å­—ç¨‹åº¦ï¼‰<br>
                            â€¢ <strong>university</strong>: å‡ºé¡Œå¤§å­¦åï¼ˆä»»æ„ï¼‰<br>
                            â€¢ <strong>year</strong>: å‡ºé¡Œå¹´åº¦ï¼ˆä»»æ„ï¼‰<br>
                            â€¢ <strong>question</strong>: å•é¡Œæ–‡ï¼ˆå¿…é ˆï¼‰<br>
                            â€¢ <strong>answer</strong>: æ¨¡ç¯„è§£ç­”ï¼ˆä»»æ„ï¼‰<br>
                            â€¢ <strong>answer_length</strong>: è§£ç­”æ–‡å­—æ•°ï¼ˆè‡ªå‹•è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ä»»æ„ï¼‰<br>
                            â€¢ <strong>enabled</strong>: æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆ1: æœ‰åŠ¹, 0: ç„¡åŠ¹ï¼‰
                        </div>

                        <button class="btn btn-outline-info btn-sm" onclick="downloadEssayTemplate()">
                            <i class="fas fa-file-csv"></i> è«–è¿°å•é¡ŒCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>

                        <a href="{{ url_for('admin_essay_download_csv') }}" class="btn btn-outline-primary btn-sm ms-2">
                            <i class="fas fa-file-download"></i> ç™»éŒ²æ¸ˆã¿å•é¡Œã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>

                    <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <form id="essayUploadForm" enctype="multipart/form-data" class="csv-upload-form">
                        <div class="upload-area">
                            <div class="file-input-wrapper">
                                <label for="essay_csv_file" class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                                </label>
                                <input type="file" id="essay_csv_file" name="file" accept=".csv" required>
                                <small class="form-text text-muted">UTF-8ã¾ãŸã¯Shift_JISã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                            </div>

                            <div class="upload-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="replaceExisting"
                                        name="replace_existing">
                                    <label class="form-check-label" for="replaceExisting">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        æ—¢å­˜ã®å•é¡Œã‚’ç½®ãæ›ãˆã‚‹ï¼ˆæ³¨æ„ï¼šå…¨ã¦ã®è«–è¿°å•é¡ŒãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success btn-upload">
                                <i class="fas fa-upload"></i>
                                <span>è«–è¿°å•é¡ŒCSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- å€‹åˆ¥è«–è¿°å•é¡Œç™»éŒ² -->
                <div class="essay-form-section">
                    <h4><i class="fas fa-plus-circle"></i> å€‹åˆ¥è«–è¿°å•é¡Œç™»éŒ²</h4>

                    <div class="essay-form-container">
                        <form id="newEssayProblemForm" class="essay-registration-form" enctype="multipart/form-data">
                            <div class="essay-form-grid">
                                <!-- ç« ãƒ»ã‚¿ã‚¤ãƒ—è¡Œ -->
                                <div class="essay-input-group">
                                    <label for="new_essay_chapter">
                                        <i class="fas fa-bookmark"></i> ç« 
                                    </label>
                                    <input type="text" id="new_essay_chapter" name="chapter" placeholder="ä¾‹: 1, 2, com"
                                        required>
                                    <small class="essay-help-text">æ•°å­—ã¾ãŸã¯ã€Œcomã€ï¼ˆç·åˆå•é¡Œï¼‰ã‚’å…¥åŠ›</small>
                                </div>

                                <div class="essay-input-group">
                                    <label for="new_essay_type">
                                        <i class="fas fa-tag"></i> ã‚¿ã‚¤ãƒ—
                                    </label>
                                    <select id="new_essay_type" name="type" required>
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="A">ã‚¿ã‚¤ãƒ—A (200å­—ä»¥ä¸Š)</option>
                                        <option value="B">ã‚¿ã‚¤ãƒ—B (100-150å­—ç¨‹åº¦)</option>
                                        <option value="C">ã‚¿ã‚¤ãƒ—C (50-75å­—ç¨‹åº¦)</option>
                                        <option value="D">ã‚¿ã‚¤ãƒ—D (30å­—ç¨‹åº¦)</option>
                                    </select>
                                    <small class="essay-help-text">å•é¡Œã®æ–‡å­—æ•°è¦æ¨¡ã‚’é¸æŠ</small>
                                </div>

                                <!-- å¤§å­¦ãƒ»å¹´åº¦è¡Œ -->
                                <div class="essay-input-group">
                                    <label for="new_essay_university">
                                        <i class="fas fa-university"></i> å¤§å­¦å
                                    </label>
                                    <input type="text" id="new_essay_university" name="university"
                                        placeholder="ä¾‹: æ±äº¬å¤§å­¦">
                                    <small class="essay-help-text">å‡ºé¡Œå¤§å­¦åï¼ˆä»»æ„ï¼‰</small>
                                </div>

                                <div class="essay-input-group">
                                    <label for="new_essay_year">
                                        <i class="fas fa-calendar-alt"></i> å¹´åº¦
                                    </label>
                                    <input type="number" id="new_essay_year" name="year" placeholder="2024" min="2000"
                                        max="2030">
                                    <small class="essay-help-text">å‡ºé¡Œå¹´åº¦ï¼ˆä»»æ„ï¼‰</small>
                                </div>

                                <!-- å•é¡Œæ–‡ï¼ˆå…¨å¹…ï¼‰ -->
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_question">
                                        <i class="fas fa-question-circle"></i> å•é¡Œæ–‡
                                    </label>
                                    <textarea id="new_essay_question" name="question" class="essay-question-input"
                                        placeholder="å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required></textarea>
                                    <small class="essay-help-text">å‡ºé¡Œã™ã‚‹å•é¡Œã®å†…å®¹ã‚’è©³ã—ãè¨˜å…¥</small>
                                </div>
                                <!-- å•é¡Œç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_image">
                                        <i class="fas fa-image"></i> å•é¡Œç”»åƒï¼ˆã‚°ãƒ©ãƒ•ãƒ»åœ°å›³ç­‰ï¼‰
                                    </label>
                                    <input type="file" id="new_essay_image" name="image" accept="image/*"
                                        onchange="previewImage(this)">
                                    <div id="imagePreview" class="mt-2"></div>
                                    <small class="essay-help-text">JPGã€PNGã€GIFå½¢å¼ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰</small>
                                </div>
                                <!-- è§£ç­”ï¼ˆå…¨å¹…ï¼‰ -->
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_answer">
                                        <i class="fas fa-lightbulb"></i> æ¨¡ç¯„è§£ç­”
                                    </label>
                                    <div class="textarea-wrapper">
                                        <textarea id="new_essay_answer" name="answer" class="essay-answer-input"
                                            placeholder="æ¨¡ç¯„è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                            oninput="updateAnswerCharCount('new_essay_answer', 'newAnswerCharCount')"></textarea>
                                        <div class="char-counter" id="newAnswerCharCount">0å­—</div>
                                    </div>
                                    <small class="essay-help-text">å‚è€ƒã¨ãªã‚‹è§£ç­”ä¾‹ï¼ˆä»»æ„ï¼‰</small>
                                </div>
                            </div>

                            <!-- æœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                            <div class="essay-checkbox-group">
                                <input type="checkbox" id="new_essay_enabled" name="enabled" checked>
                                <label for="new_essay_enabled">
                                    <i class="fas fa-check-circle"></i> æœ‰åŠ¹ã«ã™ã‚‹
                                </label>
                            </div>

                            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                            <button type="submit" class="essay-submit-btn">
                                <i class="fas fa-plus"></i>
                                <span class="btn-text">è«–è¿°å•é¡Œã‚’è¿½åŠ </span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- è«–è¿°å•é¡Œä¸€è¦§ãƒ»ç®¡ç† -->
                <div class="essay-management-section">
                    <h4><i class="fas fa-list"></i> è«–è¿°å•é¡Œä¸€è¦§ãƒ»ç®¡ç†</h4>

                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="essay-filter-section">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="essayChapterFilter">ç« ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                                <select id="essayChapterFilter" class="form-control" onchange="filterEssayProblems()">
                                    <option value="">å…¨ã¦ã®ç« </option>
                                    <option value="1">ç¬¬1ç« </option>
                                    <option value="2">ç¬¬2ç« </option>
                                    <option value="3">ç¬¬3ç« </option>
                                    <option value="4">ç¬¬4ç« </option>
                                    <option value="5">ç¬¬5ç« </option>
                                    <option value="com">ç·åˆå•é¡Œ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="essayTypeFilter">ã‚¿ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                                <select id="essayTypeFilter" class="form-control" onchange="filterEssayProblems()">
                                    <option value="">å…¨ã¦ã®ã‚¿ã‚¤ãƒ—</option>
                                    <option value="A">ã‚¿ã‚¤ãƒ—A</option>
                                    <option value="B">ã‚¿ã‚¤ãƒ—B</option>
                                    <option value="C">ã‚¿ã‚¤ãƒ—C</option>
                                    <option value="D">ã‚¿ã‚¤ãƒ—D</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="essaySearch">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢:</label>
                                <input type="text" id="essaySearch" class="form-control"
                                    placeholder="å•é¡Œæ–‡ã‚„å¤§å­¦åã§æ¤œç´¢ï¼ˆ3æ–‡å­—ä»¥ä¸Šï¼‰...">
                            </div>
                        </div>
                    </div>

                    <!-- å•é¡Œä¸€è¦§ -->
                    <div id="essay-problems-container">
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-search fa-2x mb-3"></i><br>
                            <strong>æ¤œç´¢æ¡ä»¶ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</strong><br>
                            <small>ç« ã€ã‚¿ã‚¤ãƒ—ã€ã¾ãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨å•é¡Œä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-stats"
            aria-expanded="false">
            <h3><i class="fas fa-chart-bar"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-stats">
            <div class="section-content">
                <p>äº‹å‰è¨ˆç®—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®çŠ¶æ…‹ç¢ºèªãƒ»ä¿®å¾©ã‚’è¡Œã„ã¾ã™ã€‚</p>

                <!-- çµ±è¨ˆçŠ¶æ…‹ç¢ºèª -->
                <div class="admin-panel"
                    style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
                    <h4>ğŸ“ˆ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ç¢ºèª</h4>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®æ•´åˆæ€§ã¨æœ€æ–°æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚<br>
                        <strong>æ¨å¥¨ï¼š</strong>æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ãŸå¾Œã‚„ã€ãƒ‡ãƒ¼ã‚¿ã«ä¸æ•´åˆãŒã‚ã‚‹å ´åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                    </p>

                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="checkUserStats(event)">
                            <i class="fas fa-chart-line"></i> ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ã‚’ç¢ºèª
                        </button>

                        <button type="button" class="btn btn-success" onclick="repairUserStats(event)"
                            style="margin-left: 10px;">
                            <i class="fas fa-tools"></i> ğŸ”§ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©
                        </button>

                        <button type="button" class="btn btn-warning" onclick="initializeAllStats(event)"
                            style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> ğŸ”„ å…¨çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–
                        </button>
                    </div>
                </div>

                <!-- çµ±è¨ˆç¢ºèªçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="statsCheckResult" style="margin-top: 15px; display: none;">
                    <h5>ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ç¢ºèªçµæœ</h5>
                    <div id="statsCheckContent"
                        style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <!-- ç¢ºèªçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-database-management"
            aria-expanded="false">
            <h3><i class="fas fa-database"></i> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-database-management">
            <div class="section-content">
                <p>å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>

                <!-- å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— -->
                <div class="admin-panel"
                    style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                    <h4>ğŸ§¹ å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h4>
                    <p>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
                        <strong>æ¨å¥¨ï¼š</strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                    </p>

                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-warning" onclick="cleanupOrphanedTokens(event)">
                            <i class="fas fa-broom"></i> ğŸ§¹ å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
                        </button>

                        <button type="button" class="btn btn-info" onclick="checkDatabaseStatus(event)"
                            style="margin-left: 10px;">
                            <i class="fas fa-search"></i> ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
                        </button>
                    </div>
                </div>

                <div class="admin-panel"
                    style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
                    <h4>ğŸ—‘ï¸ IDä¸ä¸€è‡´å±¥æ­´ã®å‰Šé™¤</h4>
                    <p>ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å¤ã„å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
                        <strong>ç”¨é€”ï¼šï¼š</strong>å•é¡Œæ–‡ä¿®æ­£å¾Œã«å¤ã„IDã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã«ä½¿ç”¨ã€‚<br>
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong>å‰Šé™¤ã•ã‚ŒãŸå±¥æ­´ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚
                    </p>

                    <div style="margin-top: 15px;">

                        <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory(event)"
                            style="margin-left: 10px;">
                            <i class="fas fa-trash-alt"></i> ğŸ—‘ï¸ ç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤
                        </button>
                    </div>

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h5>ğŸ” ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" id="debugUsername" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">

                                </div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger btn-sm"
                                    onclick="forceCleanSpecificUser(event)">
                                    <i class="fas fa-exclamation-triangle"></i> å¼·åˆ¶å‰Šé™¤
                                </button>
                                <small class="text-muted d-block">â€»ä¸Šè¨˜ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›å¾Œã«ä½¿ç”¨</small>
                            </div>
                        </div>
                    </div>

                    <!-- ç„¡åŠ¹å±¥æ­´åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                        <h5>ğŸ“Š ç„¡åŠ¹å±¥æ­´åˆ†æçµæœ</h5>
                        <div id="invalidAnalysisContent"
                            style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒãƒƒã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="userDebugResult" style="margin-top: 15px; display: none;">
                        <h5>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒãƒƒã‚°çµæœ</h5>
                        <div id="debugContent"
                            style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- ãƒ‡ãƒãƒƒã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>

                <!-- å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆå¾“æ¥æ©Ÿèƒ½ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰ -->
                <div class="admin-panel"
                    style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
                    <h4>âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰</h4>
                    <p>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚’å¼·åˆ¶çš„ã«æ–°ã—ã„IDå½¢å¼ã«çµ±ä¸€ã—ã¾ã™ã€‚<br>
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong>ã“ã®æ“ä½œã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã«å½±éŸ¿ã—ã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚<br>
                        <strong>æ¨å¥¨ï¼š</strong>é€šå¸¸ã¯ä¸Šè¨˜ã®ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                    </p>

                    <div style="margin-top: 15px;">
                        <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST" style="display: inline;"
                            onsubmit="event.preventDefault(); showConfirmModal('ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ç¢ºèª', 'å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ãŒæ–°ã—ã„å½¢å¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚\nâš ï¸ é€šå¸¸ã¯ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã§ååˆ†ã§ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ', () => this.submit(), 'å®Ÿè¡Œ', 'btn-danger')">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-exclamation-triangle"></i> âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶ä¿®æ­£ï¼ˆéæ¨å¥¨ï¼‰
                            </button>
                        </form>

                        <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank"
                            style="margin-left: 10px;">
                            <i class="fas fa-chart-line"></i> ğŸ“Š ä¿®æ­£å‰ã®çŠ¶æ…‹ç¢ºèª
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit RPG Enemy Modal -->
<div class="modal fade" id="editRpgEnemyModal" tabindex="-1" aria-labelledby="editRpgEnemyModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRpgEnemyModalLabel">æ•µã‚­ãƒ£ãƒ©æƒ…å ±ã®ç·¨é›†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRpgEnemyForm" method="POST" enctype="multipart/form-data"
                    onsubmit="handleEditRpgEnemy(event)">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit_name" class="form-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_difficulty" class="form-label">é›£æ˜“åº¦ (â˜…)</label>
                            <input type="number" class="form-control" name="difficulty" min="1" max="100" value="1">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">ãƒœã‚¹ç”»åƒ (æˆ¦é—˜ç”¨)</label>
                            <input type="file" class="form-control" name="icon_image" accept="image/*">
                            <div class="mt-2 text-center">
                                <span class="text-muted small">ç¾åœ¨ã®ç”»åƒ:</span>
                                <img id="currentEditIconImage" src="" alt="Icon Preview"
                                    style="height: 50px; display: none; margin: 0 auto;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">è¨ä¼å¾Œç”»åƒ (Statusç”¨)</label>
                            <input type="file" class="form-control" name="defeated_image" accept="image/*">
                            <div class="mt-2 text-center">
                                <span class="text-muted small">ç¾åœ¨ã®ç”»åƒ:</span>
                                <img id="currentEditDefeatedImage" src="" alt="Defeated Preview"
                                    style="height: 50px; display: none; margin: 0 auto;">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="edit_badge_name" class="form-label">ç²å¾—ãƒãƒƒã‚¸å</label>
                            <input type="text" class="form-control" name="badge_name" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">ãƒãƒƒã‚¸ç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿)</label>
                            <input type="file" class="form-control" name="badge_image" accept="image/*">
                            <div class="mt-2">
                                <label class="form-label small">ã¾ãŸã¯FontAwesomeã‚¯ãƒ©ã‚¹</label>
                                <input type="text" class="form-control form-control-sm" name="badge_icon_class"
                                    placeholder="fa-solid fa-dragon">
                            </div>
                            <div class="mt-2 text-center">
                                <span class="text-muted small">ç¾åœ¨ã®ç”»åƒ:</span>
                                <img id="currentEditBadgeImage" src="" alt="Badge Preview"
                                    style="height: 50px; display: none; margin: 0 auto;">
                                <i id="currentEditBadgeIconClass" style="display: none;"></i>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="edit_description" class="form-label">èª¬æ˜æ–‡</label>
                            <textarea class="form-control" name="description" rows="2"></textarea>
                        </div>

                        <div class="col-md-6">
                            <label for="edit_intro_dialogue" class="form-label">ç™»å ´æ™‚ã‚»ãƒªãƒ•</label>
                            <textarea class="form-control" name="intro_dialogue" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">è¨ä¼æ™‚ã‚»ãƒªãƒ• (Boss)</label>
                            <textarea class="form-control" name="defeat_dialogue" rows="2"
                                placeholder="ãƒœã‚¹ãŒå€’ã‚ŒãŸæ™‚ã«è¨€ã†ã‚»ãƒªãƒ•"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">è¨ä¼å¾Œã‚³ãƒ¡ãƒ³ãƒˆ (Per)</label>
                            <div id="editDialogueContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                onclick="addDialogueRow('editDialogueContainer')">
                                <i class="fas fa-plus"></i> ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                            </button>
                        </div>

                        <div class="col-md-4">
                            <label for="edit_time_limit" class="form-label">åˆ¶é™æ™‚é–“(ç§’)</label>
                            <input type="number" class="form-control" name="time_limit" value="60">
                        </div>
                        <div class="col-md-4">
                            <label for="edit_clear_correct_count" class="form-label">ã‚¯ãƒªã‚¢æ­£è§£æ•°</label>
                            <input type="number" class="form-control" name="clear_correct_count" value="10">
                        </div>
                        <div class="col-md-4">
                            <label for="edit_clear_max_mistakes" class="form-label">è¨±å®¹ãƒŸã‚¹æ•°</label>
                            <input type="number" class="form-control" name="clear_max_mistakes" value="2">
                        </div>

                        <div class="col-md-6">
                            <label for="edit_appearance_required_score" class="form-label">å‡ºç¾å¿…è¦ã‚¹ã‚³ã‚¢ (Min 1000)</label>
                            <input type="number" class="form-control" name="appearance_required_score" value="1000"
                                min="1000">
                        </div>
                        <div class="col-md-12 mt-3">
                            <div class="form-check p-3 border rounded bg-light">
                                <input class="form-check-input" type="checkbox" name="is_manual_order"
                                    id="editIsManualOrder" value="true" onchange="toggleManualOrder('edit')">
                                <label class="form-check-label" for="editIsManualOrder">å„ªå…ˆè¡¨ç¤ºé †ã‚’æ‰‹å‹•è¨­å®šã™ã‚‹</label>

                                <div id="editDisplayOrderGroup" style="display: none; margin-top: 10px;">
                                    <label for="edit_display_order" class="form-label">è¡¨ç¤ºé † (å°ã•ã„æ•°å­—ãŒå…ˆ)</label>
                                    <input type="number" class="form-control" name="display_order" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="edit_is_active"
                                    value="true">
                                <label class="form-check-label" for="edit_is_active">
                                    æœ‰åŠ¹ã«ã™ã‚‹ (ç„¡åŠ¹ã«ã™ã‚‹ã¨ãƒœãƒ¼ãƒŠã‚¹å‰¥å¥ªç­‰ã®å½±éŸ¿ãŒå‡ºã¾ã™)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="btn btn-primary">å¤‰æ›´ã‚’ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete RPG Enemy Confirmation Modal -->
<div class="modal fade" id="deleteRpgEnemyModal" tabindex="-1" aria-labelledby="deleteRpgEnemyModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRpgEnemyModalLabel">å‰Šé™¤ã®ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>æœ¬å½“ã«ã“ã®ãƒœã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <p class="text-danger"><small>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteRpgEnemy()">
                    <i class="fas fa-trash"></i> å‰Šé™¤å®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal -->


<script>
    // Global function handling (Modal logic moved to script.js)


    async function handleEditRpgEnemy(event) {
        event.preventDefault();

        // Use custom modal instead of native confirm
        const form = event.target;

        showConfirmModal(
            'å¤‰æ›´ã®ä¿å­˜',
            'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã€é–¢é€£ã™ã‚‹ãƒœãƒ¼ãƒŠã‚¹ãŒå‰¥å¥ªã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
            () => {
                submitEditRpgEnemyForm(form);
            },
            'ä¿å­˜',
            'btn-primary'
        );
    }

    async function submitEditRpgEnemyForm(form) {
        const formData = new FormData(form);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤å‡¦ç†
        if (!form.elements['is_active'].checked) {
            formData.set('is_active', 'false');
        } else {
            formData.set('is_active', 'true');
        }

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.status === 'success') {
                alert(result.message);
                closeEditRpgEnemyModal();
                loadRpgEnemies(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    }
</script>

<!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
<form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
</form>

<script>
    // ========================================
    // 1. æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
    // ========================================

    // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹
    function expandAllSections() {
        document.querySelectorAll('.admin-section .collapse').forEach(section => {
            const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
            bsCollapse.show();
        });
        updateToggleIcons();
    }

    // å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚ŠãŸãŸã¿
    function collapseAllSections() {
        document.querySelectorAll('.admin-section .collapse').forEach(section => {
            const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
            bsCollapse.hide();
        });
        updateToggleIcons();
    }

    // ãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
    function updateToggleIcons() {
        document.querySelectorAll('.admin-section').forEach(section => {
            const collapseElement = section.querySelector('.collapse');
            const toggleIcon = section.querySelector('.toggle-icon');

            if (collapseElement && toggleIcon) {
                const isShown = collapseElement.classList.contains('show');
                toggleIcon.className = isShown ? 'fas fa-chevron-up toggle-icon' : 'fas fa-chevron-down toggle-icon';
            }
        });
    }

    // æŠ˜ã‚ŠãŸãŸã¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function initializeCollapseSections() {
        document.querySelectorAll('.admin-section .collapse').forEach(collapseElement => {
            collapseElement.addEventListener('shown.bs.collapse', updateToggleIcons);
            collapseElement.addEventListener('hidden.bs.collapse', updateToggleIcons);
        });
    }

    // ========================================
    // 2. æ—¢å­˜ã®ç®¡ç†æ©Ÿèƒ½ï¼ˆå…ƒã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ç§»æ¤ï¼‰
    // ========================================
    // éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹é–¢æ•°
    function loadRoomSettings() {
        document.querySelectorAll('.csv-setting-select').forEach(select => {
            const roomNumber = select.dataset.roomNumber;
            if (!roomNumber) return;

            fetch('/admin/get_room_setting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_number: roomNumber })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const csvFilename = data.csv_filename || 'words.csv';

                        select.value = csvFilename;

                        const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                        if (!optionExists && csvFilename !== 'words.csv') {
                            const newOption = document.createElement('option');
                            newOption.value = csvFilename;
                            newOption.textContent = csvFilename;
                            select.appendChild(newOption);
                            select.value = csvFilename;
                        }
                    }
                })
                .catch(error => {
                    console.error(`âŒ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
                });
        });
    }

    // CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    function loadCsvFilesList() {

        const container = document.getElementById('csv-files-container');
        if (container) {
            container.innerHTML = '<p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        }

        fetch('{{ url_for("admin_list_room_csv_files") }}')
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    updateCsvFilesDisplay(data.files);
                    updateCsvSelectOptions(data.files);
                } else {
                    console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—å¤±æ•—:', data.message);
                    if (container) {
                        container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '</p>';
                    }
                }
            })
            .catch(error => {
                console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                if (container) {
                    container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
                }
            });
    }

    function addHoursToTimestamp(dateString, hours) {
        const date = new Date(dateString);
        date.setHours(date.getHours() + hours);
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // CSVãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCsvFilesDisplay(files) {

        const container = document.getElementById('csv-files-container');
        if (!container) {
            console.error('âŒ csv-files-container ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        if (files.length === 0) {
            container.innerHTML = '<p class="text-muted">ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead class="table-dark"><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>å˜èªæ•°</th><th>ã‚µã‚¤ã‚º</th><th>æ›´æ–°æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead><tbody>';

        files.forEach((file, index) => {
            const sizeKB = Math.round(file.size / 1024);
            const wordCountDisplay = file.word_count > 0 ? `${file.word_count}å•` : 'ä¸æ˜';

            html += '<tr>' +
                '<td><code>' + file.filename + '</code></td>' +
                '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                '<td>' + sizeKB + ' KB</td>' +
                '<td><small>' + addHoursToTimestamp(file.modified, 9) + '</small></td>' +
                '<td><button type="button" class="btn btn-danger btn-sm" onclick="deleteCsvFile(event, \'' + file.filename + '\')">å‰Šé™¤</button></td>' +
                '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCsvSelectOptions(files) {
        const selects = document.querySelectorAll('.csv-setting-select');

        selects.forEach((select, index) => {
            const roomNumber = select.dataset.roomNumber;
            const currentValue = select.value;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            Array.from(select.options).forEach(option => {
                if (option.value !== 'words.csv') {
                    option.remove();
                }
            });

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
            if (files && Array.isArray(files)) {
                files.forEach(file => {
                    if (file.filename !== 'words.csv') {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        option.textContent = file.filename;
                        select.appendChild(option);
                    }
                });
            }

            // å…ƒã®å€¤ã‚’å¾©å…ƒ
            if (currentValue && currentValue !== '') {
                select.value = currentValue;
            }
        });
    }

    // CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤é–¢æ•°
    function deleteCsvFile(event, filename) {
        if (event) event.preventDefault();

        showConfirmModal(
            'CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤',
            'CSVãƒ•ã‚¡ã‚¤ãƒ« "' + filename + '" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹éƒ¨å±‹ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚',
            () => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_delete_room_csv", filename="_FILENAME_") }}'.replace('_FILENAME_', filename);

                document.body.appendChild(form);
                form.submit();
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
    function initializeUserTableSort() {
        const table = document.getElementById('userTable');
        const tbody = document.getElementById('userTableBody');

        if (!table || !tbody) return;

        // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.addEventListener('click', function () {
                const column = this.dataset.column;
                const isAscending = this.classList.contains('fa-sort-up');

                // å…¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.sort-icon').forEach(i => {
                    i.className = 'fas fa-sort sort-icon';
                });

                // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                this.className = `fas fa-sort-${isAscending ? 'down' : 'up'} sort-icon`;

                sortUserTable(column, !isAscending);
            });
        });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
    function initializeUserTable() {

        const sortIcons = document.querySelectorAll('.sort-icon[data-column]');

        if (sortIcons.length === 0) {
            console.warn('âš ï¸ ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        sortIcons.forEach(icon => {
            icon.addEventListener('click', function () {
                const column = this.getAttribute('data-column');

                // ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
                const isCurrentlyAscending = this.classList.contains('fa-sort-up');

                // å…¨ã¦ã®ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.sort-icon[data-column]').forEach(otherIcon => {
                    otherIcon.className = 'fas fa-sort sort-icon';
                });

                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                const newAscending = !isCurrentlyAscending;
                this.className = `fas fa-sort-${newAscending ? 'up' : 'down'} sort-icon`;

                // ã‚½ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
                sortUserTable(column, newAscending);
            });

        });

    }

    // â˜…ä¿®æ­£ï¼šã‚½ãƒ¼ãƒˆé–¢æ•°ï¼ˆæœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³åˆ—å‰Šé™¤ã«å¯¾å¿œï¼‰
    function sortUserTable(column, ascending) {

        const tbody = document.getElementById('userTableBody');
        if (!tbody) {
            console.error('âŒ userTableBodyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) {
            console.warn('âš ï¸ ã‚½ãƒ¼ãƒˆå¯¾è±¡ã®è¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        rows.sort((a, b) => {
            let aVal, bVal;

            switch (column) {
                case 'room':
                    // éƒ¨å±‹ç•ªå·ã®ã‚½ãƒ¼ãƒˆï¼ˆæ•°å€¤ã¨ã—ã¦æ¯”è¼ƒï¼‰
                    aVal = a.cells[1] ? a.cells[1].textContent.trim() : '';
                    bVal = b.cells[1] ? b.cells[1].textContent.trim() : '';
                    aVal = parseInt(aVal.replace(/[^0-9]/g, '')) || 0;
                    bVal = parseInt(bVal.replace(/[^0-9]/g, '')) || 0;
                    break;

                case 'name':
                    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®ã‚½ãƒ¼ãƒˆï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒï¼‰
                    aVal = a.cells[3] ? a.cells[3].textContent.trim().toLowerCase() : '';
                    bVal = b.cells[3] ? b.cells[3].textContent.trim().toLowerCase() : '';
                    break;

                default:
                    console.warn(`âš ï¸ æœªå¯¾å¿œã®ã‚½ãƒ¼ãƒˆåˆ—: ${column}`);
                    return 0;
            }

            // æ¯”è¼ƒå‡¦ç†
            if (aVal < bVal) return ascending ? -1 : 1;
            if (aVal > bVal) return ascending ? 1 : -1;
            return 0;
        });

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }

    function initializeUserFiltering() {

        const roomSelect = document.getElementById('roomSortSelect');
        const searchInput = document.getElementById('userSearchInput');

        if (!roomSelect) {
            console.error('âŒ roomSortSelectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        if (!searchInput) {
            console.error('âŒ userSearchInputãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        // éƒ¨å±‹é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        roomSelect.addEventListener('change', function () {
            filterUsers();
        });

        // æ¤œç´¢å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        searchInput.addEventListener('input', function () {
            filterUsers();
        });
    }

    // â˜…ä¿®æ­£ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ ï¼‰
    function filterUsers() {

        const roomSelect = document.getElementById('roomSortSelect');
        const searchInput = document.getElementById('userSearchInput');
        const tbody = document.getElementById('userTableBody');

        if (!tbody) {
            console.error('âŒ userTableBodyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        const selectedRoom = roomSelect ? roomSelect.value : '';
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach((row, index) => {
            // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
            const roomValue = row.getAttribute('data-room') || '';
            const nameValue = row.getAttribute('data-name') || '';
            const studentValue = row.getAttribute('data-student') || '';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã®åˆ¤å®š
            const roomMatch = !selectedRoom || roomValue === selectedRoom;
            const searchMatch = !searchTerm ||
                nameValue.includes(searchTerm) ||
                studentValue.includes(searchTerm);

            const shouldShow = roomMatch && searchMatch;
            row.style.display = shouldShow ? '' : 'none';

            if (shouldShow) visibleCount++;
        });
    }

    // â˜…ä¿®æ­£ï¼šãƒ‡ãƒãƒƒã‚°é–¢æ•°ï¼ˆå•é¡Œè¨ºæ–­ç”¨ï¼‰
    function debugUserTable() {
        const tbody = document.getElementById('userTableBody');
        const roomSelect = document.getElementById('roomSortSelect');
        const searchInput = document.getElementById('userSearchInput');
        const sortIcons = document.querySelectorAll('.sort-icon[data-column]');

        if (tbody) {
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 0) {
                const firstRow = rows[0];
            }
        }

        if (roomSelect) {
            Array.from(roomSelect.options).forEach((option, index) => {
            });
        }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ©Ÿèƒ½ï¼ˆå®‰å…¨ç‰ˆï¼‰
    function deleteUserSafe(button) {
        const userId = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-username');

        if (!userId || !username) {
            alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
        }

        const confirmMessage = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ å­¦ç¿’å±¥æ­´ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™\n\nå‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;

        showConfirmModal(
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤',
            confirmMessage,
            () => {
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'å‰Šé™¤ä¸­...';

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/delete_user/${userId}`;
                form.style.display = 'none';

                document.body.appendChild(form);
                form.submit();
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    window.debugUserTable = debugUserTable;
    window.filterUsers = filterUsers;

    // ========================================
    // 3. DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ========================================
    document.addEventListener('DOMContentLoaded', function () {
        // ========================================
        // 0. ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½
        // ========================================
        const selectAllCheckbox = document.getElementById('selectAllUsers');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectedUserCountSpan = document.getElementById('selectedUserCount');

        function updateBulkDeleteButton() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = selectedCheckboxes.length;
            selectedUserCountSpan.textContent = count;
            bulkDeleteBtn.disabled = count === 0;
        }

        selectAllCheckbox.addEventListener('change', function () {
            const isChecked = this.checked;
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ï¼ˆdisplay != 'none'ï¼‰è¡Œã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã¿ã‚’å¯¾è±¡
            document.querySelectorAll('#userTableBody tr').forEach(row => {
                if (row.style.display !== 'none') {
                    const checkbox = row.querySelector('.user-checkbox');
                    if (checkbox) {
                        checkbox.checked = isChecked;
                    }
                }
            });
            updateBulkDeleteButton();
        });

        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkDeleteButton);
        });

        bulkDeleteBtn.addEventListener('click', function (event) {
            event.preventDefault();
            const selectedIds = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            showConfirmModal(
                'ä¸€æ‹¬å‰Šé™¤',
                `${selectedIds.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`,
                () => {
                    fetch('/admin/bulk_delete_users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ user_ids: selectedIds }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('ä¸€æ‹¬å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                            alert('ä¸€æ‹¬å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                        });
                },
                'ä¸€æ‹¬å‰Šé™¤',
                'btn-danger'
            );
        });

        // ========================================
        // 1. åŸºæœ¬æ©Ÿèƒ½ã®åˆæœŸåŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
        // ========================================

        // æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ã®åˆæœŸåŒ–
        initializeCollapseSections();

        // ========================================
        // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ©Ÿèƒ½ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
        // ========================================

        document.addEventListener('click', function (event) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
            if (event.target.closest('.delete-user-btn')) {
                event.preventDefault();
                const button = event.target.closest('.delete-user-btn');
                const userId = button.getAttribute('data-user-id');
                const username = button.getAttribute('data-username');

                if (userId && username) {
                    deleteUserSafe(button);
                } else {
                    alert('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            }

            // Introãƒªã‚»ãƒƒãƒˆ
            if (event.target.closest('.reset-intro-btn')) {
                event.preventDefault();
                const button = event.target.closest('.reset-intro-btn');
                const userId = button.getAttribute('data-user-id');
                const username = button.getAttribute('data-username');

                if (userId && username) {
                    showConfirmModal(
                        'Introãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ',
                        `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã®RPGå°å…¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nå†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸéš›ã«RPGã®ã‚¤ãƒ³ãƒˆãƒ­ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`,
                        () => {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/admin/reset_intro_flag/${userId}`;
                            document.body.appendChild(form);
                            form.submit();
                        },
                        'ãƒªã‚»ãƒƒãƒˆ',
                        'btn-info'
                    );
                }
            }
        });

        // ========================================
        // 3. è«–è¿°å•é¡Œãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
        // ========================================

        setTimeout(() => {

            const essayForm = document.getElementById('newEssayProblemForm');

            if (essayForm) {
                essayForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const form = this;
                    const formData = new FormData(form);

                    // å¿…é ˆé …ç›®ã®ç¢ºèª
                    const chapter = formData.get('chapter');
                    const question = formData.get('question');
                    const type = formData.get('type');

                    if (!chapter || !question || !type) {
                        alert('âŒ ç« ã€ã‚¿ã‚¤ãƒ—ã€å•é¡Œæ–‡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                        return;
                    }

                    // æœ‰åŠ¹ãƒ•ãƒ©ã‚°ã®å‡¦ç†
                    const enabledCheckbox = document.getElementById('new_essay_enabled');
                    if (enabledCheckbox && enabledCheckbox.checked) {
                        formData.set('enabled', 'on');
                    } else {
                        formData.delete('enabled');
                    }

                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¿½åŠ ä¸­...';

                    // FormDataã§é€ä¿¡ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
                    fetch('/admin/essay/add_problem', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                let message = 'âœ… ' + data.message;
                                if (data.has_image) {
                                    message += ' ï¼ˆç”»åƒä»˜ãï¼‰';
                                }
                                alert(message);

                                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                                form.reset();
                                if (typeof clearImagePreview === 'function') {
                                    clearImagePreview();
                                }
                                document.getElementById('new_essay_enabled').checked = true;

                                // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                                if (typeof loadEssayStats === 'function') {
                                    loadEssayStats();
                                }
                                if (typeof loadEssayProblems === 'function') {
                                    loadEssayProblems();
                                }
                            } else {
                                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                            alert('âŒ è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        });
                });
            }

            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
            window.previewImage = function (input) {
                const previewDiv = document.getElementById('imagePreview');
                if (!previewDiv) return;

                if (input.files && input.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        previewDiv.innerHTML = `
                        <div class="image-preview-container">
                            <img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" 
                                 style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                                    onclick="clearImagePreview()">
                                <i class="fas fa-times"></i> å‰Šé™¤
                            </button>
                        </div>
                    `;
                    };

                    reader.readAsDataURL(input.files[0]);
                } else {
                    clearImagePreview();
                }
            };

            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            window.clearImagePreview = function () {
                const previewDiv = document.getElementById('imagePreview');
                const imageInput = document.getElementById('new_essay_image');

                if (previewDiv) {
                    previewDiv.innerHTML = '';
                }
                if (imageInput) {
                    imageInput.value = '';
                }
            };
        }, 500);

        // ========================================
        // 4. CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ï¼ˆé‡è¦ï¼ï¼‰
        // ========================================

        setTimeout(() => {
            if (typeof loadCsvFilesList === 'function') {
                loadCsvFilesList();
            } else {
                console.warn('loadCsvFilesListé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }, 1000);

        // ========================================
        // 5. éƒ¨å±‹è¨­å®šã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ & ä¿å­˜ãƒœã‚¿ãƒ³åˆæœŸåŒ–
        // ========================================

        setTimeout(() => {
            if (typeof loadRoomSettings === 'function') {
                loadRoomSettings();
            }

            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã«ç½®ãæ›ãˆ
            document.querySelectorAll('.save-room-setting-btn').forEach(button => {
                button.replaceWith(button.cloneNode(true));
            });

            // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.save-room-setting-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const roomNumber = this.dataset.roomNumber;
                    const csvFileSelect = document.getElementById('csvFile_' + roomNumber);

                    if (!csvFileSelect) {
                        alert('è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }

                    // é¸æŠã•ã‚ŒãŸå˜å…ƒã‚’å–å¾—
                    const selectedUnits = getSelectedUnits(roomNumber);
                    const csvFilename = csvFileSelect.value;

                    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
                    this.disabled = true;
                    this.textContent = 'ä¿å­˜ä¸­...';

                    // å˜å…ƒè¨­å®šã€CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åŒæ™‚ã«æ›´æ–°
                    Promise.all([
                        fetch('/admin/update_room_units_setting', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                room_number: roomNumber,
                                enabled_units: selectedUnits
                            })
                        }),
                        fetch('/admin/update_room_csv_setting', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                room_number: roomNumber,
                                csv_filename: csvFilename
                            })
                        })
                    ])
                        .then(responses => {
                            return Promise.all(responses.map(r => r.json()));
                        })
                        .then(results => {
                            const unitResult = results[0];
                            const csvResult = results[1];

                            if (unitResult.status === 'success' && csvResult.status === 'success') {
                                alert(`âœ… éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ:\nãƒ»æœ‰åŠ¹å˜å…ƒ: ${selectedUnits.length}å€‹\nãƒ»CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFilename}`);

                                // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                                loadRoomSettings();
                            } else {
                                const errorMsg = (unitResult.message || csvResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                                alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
                                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', { unitResult, csvResult });
                            }
                        })
                        .catch(error => {
                            console.error('âŒ ä¿å­˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                            alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                        })
                        .finally(() => {
                            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                            this.disabled = false;
                            this.textContent = 'ä¿å­˜';
                        });
                });
            });
        }, 1500);

        // ========================================
        // 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†åˆæœŸåŒ–
        // ========================================

        setTimeout(function () {
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
            if (typeof debugUserTable === 'function') {
                debugUserTable();
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ©Ÿèƒ½ã®åˆæœŸåŒ–
            if (typeof initializeUserTable === 'function') {
                initializeUserTable();
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–
            if (typeof initializeUserFiltering === 'function') {
                initializeUserFiltering();
            }
        }, 2000);

        // ========================================
        // 7. è«–è¿°å•é¡Œé–¢é€£ã®åˆæœŸåŒ–
        // ========================================

        setTimeout(() => {
            // è«–è¿°å•é¡Œçµ±è¨ˆã®ã¿èª­ã¿è¾¼ã¿ï¼ˆå•é¡Œä¸€è¦§ã¯æ¤œç´¢æ™‚ã®ã¿ï¼‰
            if (document.getElementById('essay-stats-container')) {
                if (typeof loadEssayStats === 'function') {
                    loadEssayStats();
                }
            }
            // åˆæœŸçŠ¶æ…‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            const problemsContainer = document.getElementById('essay-problems-container');
            if (problemsContainer) {
                problemsContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-search"></i><br>ç« ã€ã‚¿ã‚¤ãƒ—ã€ã¾ãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>';
            }


            // è«–è¿°å•é¡Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®åˆæœŸåŒ–
            const essayChapterFilter = document.getElementById('essayChapterFilter');
            const essayTypeFilter = document.getElementById('essayTypeFilter');
            const essaySearch = document.getElementById('essaySearch');

            if (essayChapterFilter) {
                essayChapterFilter.addEventListener('change', function () {
                    if (typeof loadEssayProblems === 'function') {
                        loadEssayProblems();
                    } else if (typeof filterEssayProblems === 'function') {
                        filterEssayProblems();
                    }
                });
            }
            if (essayTypeFilter) {
                essayTypeFilter.addEventListener('change', function () {
                    if (typeof loadEssayProblems === 'function') {
                        loadEssayProblems();
                    } else if (typeof filterEssayProblems === 'function') {
                        filterEssayProblems();
                    }
                });
            }
            if (essaySearch) {
                let searchTimeout;
                essaySearch.addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        // å…¥åŠ›å€¤ãŒ3æ–‡å­—æœªæº€ã®å ´åˆã¯æ¤œç´¢ã—ãªã„ï¼ˆç©ºç™½ã®å ´åˆã¯åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰
                        const searchValue = this.value.trim();
                        if (searchValue.length > 0 && searchValue.length < 3) {
                            return; // 3æ–‡å­—æœªæº€ã¯æ¤œç´¢ã—ãªã„
                        }

                        if (typeof loadEssayProblems === 'function') {
                            loadEssayProblems();
                        } else if (typeof filterEssayProblems === 'function') {
                            filterEssayProblems();
                        }
                    }, 800); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ™‚é–“ã‚’500msâ†’800msã«å»¶é•·
                });
            }
        }, 2500);

        // ========================================
        // 8. è«–è¿°å•é¡Œå…¬é–‹è¨­å®šåˆæœŸåŒ–
        // ========================================

        setTimeout(() => {
            if (typeof initializeVisibilitySettings === 'function') {
                initializeVisibilitySettings();
            }
        }, 3000);

        // ========================================
        // 9. ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰
        // ========================================

        // ========================================
        // 10. æœ€çµ‚ãƒã‚§ãƒƒã‚¯
        // ========================================

        setTimeout(() => {
            // å„ç¨®è¦ç´ ã®å­˜åœ¨ç¢ºèª
            const essayForm = document.getElementById('newEssayProblemForm');
            const userTable = document.getElementById('userTable');
            const csvUpload = document.getElementById('csvUploadForm');
            const visibilityMatrix = document.getElementById('visibilityMatrix');
        }, 4000);
    });

    // ========================================
    // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ç³»ã®é–¢æ•°
    // ========================================

    // ç„¡åŠ¹å±¥æ­´ã®å‰Šé™¤
    function cleanInvalidHistory(event) {
        if (event) event.preventDefault();

        showConfirmModal(
            'ç„¡åŠ¹å±¥æ­´å‰Šé™¤',
            'ç„¡åŠ¹ãªå­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™\nâš ï¸ æœ‰åŠ¹ãªå±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™\n\nå‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',
            () => {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'å‰Šé™¤ä¸­...';

                fetch('/admin/safe_clean_execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`âœ… ${data.message || 'å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ'}\nå‰Šé™¤æ•°: ${data.removed_entries}`);
                            location.reload();
                        } else {
                            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            },
            'å‰Šé™¤',
            'btn-warning'
        );
    }

    function cleanupOrphanedTokens(event) {
        if (event) event.preventDefault();

        showConfirmModal(
            'ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—',
            'å­¤ç«‹ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¯¾è±¡ã§ã™ã€‚',
            () => {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...';

                fetch('/admin/cleanup_orphaned_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`âœ… ${data.message}`);
                        } else {
                            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); // Closing brace and parenthesis will follow in original code
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            },
            'å®Ÿè¡Œ',
            'btn-warning'
        );
    }

    function checkDatabaseStatus(event) {
        if (event) event.preventDefault();
        fetch('/admin/check_database_status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const status = data.database_status;
                    let message = 'ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªçµæœ:\n\n';

                    for (const [tableName, tableInfo] of Object.entries(status.tables)) {
                        message += `ğŸ“‹ ${tableName}: ${tableInfo.exists ? 'å­˜åœ¨' : 'ä¸åœ¨'}\n`;
                        if (tableInfo.missing_columns.length > 0) {
                            message += `   ä¸è¶³ã‚«ãƒ©ãƒ : ${tableInfo.missing_columns.join(', ')}\n`;
                        }
                    }

                    if (status.needs_migration) {
                        message += '\nâš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
                    } else {
                        message += '\nâœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ­£å¸¸ã§ã™ã€‚';
                    }

                    alert(message);
                } else {
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
    }

    // ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¼·åˆ¶å‰Šé™¤
    function forceCleanSpecificUser(event) {
        if (event) event.preventDefault();
        const username = document.getElementById('debugUsername').value.trim();
        if (!username) {
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        showConfirmModal(
            'å¼·åˆ¶å‰Šé™¤ç¢ºèª',
            `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã®ä¸ä¸€è‡´å±¥æ­´ã‚’å¼·åˆ¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç„¡åŠ¹ãªIDã®å±¥æ­´ã®ã¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™`,
            () => {
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦é€ä¿¡
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/force_clean_user/${encodeURIComponent(username)}`;

                document.body.appendChild(form);
                form.submit();
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    function checkUserStats(event) {
        if (event) event.preventDefault();
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ç¢ºèªä¸­...';

        fetch('/admin/check_user_stats')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayStatsCheckResult(data);
                } else {
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('çµ±è¨ˆç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ çµ±è¨ˆç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
    }

    // çµ±è¨ˆç¢ºèªçµæœã®è¡¨ç¤º
    function displayStatsCheckResult(data) {
        const resultDiv = document.getElementById('statsCheckResult');
        const contentDiv = document.getElementById('statsCheckContent');

        const summary = data.summary;
        const roomStats = data.room_stats;

        let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${summary.total_users}äºº</li>
                    <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${summary.total_stats}å€‹</li>
                    <li>çµ±è¨ˆãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${summary.users_without_stats}äºº</li>
                    <li>å¤ã„çµ±è¨ˆ: ${summary.outdated_stats}å€‹</li>
                    <li>ã‚«ãƒãƒ¼ç‡: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ?
                '<p class="text-success">âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™ã€‚ä¿®å¾©ã¯ä¸è¦ã§ã™ã€‚</p>' :
                `<p class="text-warning">âš ï¸ ${summary.users_without_stats + summary.outdated_stats}ä»¶ã®çµ±è¨ˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
            }
            </div>
        </div>
    `;

        if (roomStats.length > 0) {
            html += '<h6>ğŸ  éƒ¨å±‹åˆ¥çµ±è¨ˆ</h6>';
            html += '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>éƒ¨å±‹ç•ªå·</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th><th>å¹³å‡ã‚¹ã‚³ã‚¢</th><th>æœ€é«˜ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>';

            roomStats.forEach(room => {
                html += `<tr>
                <td><span class="badge bg-secondary">${room.room_number}</span></td>
                <td>${room.user_count}äºº</td>
                <td>${room.avg_score}</td>
                <td class="text-success"><strong>${room.max_score}</strong></td>
            </tr>`;
            });

            html += '</tbody></table></div>';
        }

        contentDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©
    function repairUserStats(event) {
        if (event) event.preventDefault();

        showConfirmModal(
            'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ä¿®å¾©',
            'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»çµ±è¨ˆãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ–°è¦ä½œæˆ\nãƒ»å¤ã„çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚',
            () => {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'ä¿®å¾©ä¸­...';

                fetch('/admin/repair_user_stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`âœ… ${data.message}`);
                            // ä¿®å¾©å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                            setTimeout(() => checkUserStats(), 1000);
                        } else {
                            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            },
            'å®Ÿè¡Œ',
            'btn-warning'
        );
    }

    // å…¨çµ±è¨ˆã®å¼·åˆ¶å†åˆæœŸåŒ–
    function initializeAllStats(event) {
        if (event) event.preventDefault();

        showConfirmModal(
            'å…¨çµ±è¨ˆåˆæœŸåŒ–',
            'å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™\nâš ï¸ å…¨ã¦ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒå†è¨ˆç®—ã•ã‚Œã¾ã™\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',
            () => {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'åˆæœŸåŒ–ä¸­...';

                fetch('/admin/initialize_user_stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`âœ… ${data.message}`);
                            // åˆæœŸåŒ–å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                            setTimeout(() => checkUserStats(), 1000);
                        } else {
                            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            },
            'åˆæœŸåŒ–',
            'btn-danger'
        );
    }

    // ========================================
    // å˜å…ƒé¸æŠç®¡ç†æ©Ÿèƒ½
    // ========================================

    // åˆ©ç”¨å¯èƒ½ãªå˜å…ƒä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadAvailableUnits(roomNumber) {
        const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
        if (!container) return;

        container.innerHTML = '<p class="text-info">èª­ã¿è¾¼ã¿ä¸­...</p>';

        fetch(`/admin/get_available_units/${roomNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayUnitCheckboxes(roomNumber, data.available_units);
                    loadCurrentUnitSettings(roomNumber);
                } else {
                    container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('å˜å…ƒä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="text-danger">å˜å…ƒä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            });
    }

    // å˜å…ƒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
    function displayUnitCheckboxes(roomNumber, availableUnits) {
        const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
        if (!container) return;

        if (availableUnits.length === 0) {
            container.innerHTML = '<p class="text-muted">åˆ©ç”¨å¯èƒ½ãªå˜å…ƒãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        let html = '<div class="units-grid">';

        availableUnits.forEach(unit => {
            html += `
            <div class="form-check form-check-inline unit-checkbox">
                <input class="form-check-input" type="checkbox" 
                       id="unit_${roomNumber}_${unit}" 
                       value="${unit}"
                       onchange="updateSelectedCount('${roomNumber}')">
                <label class="form-check-label" for="unit_${roomNumber}_${unit}">
                    ${unit}
                </label>
            </div>
        `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // ç¾åœ¨ã®å˜å…ƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
    function loadCurrentUnitSettings(roomNumber) {
        fetch('/admin/get_room_setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_number: roomNumber })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.enabled_units) {
                    const enabledUnits = data.enabled_units;

                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    enabledUnits.forEach(unit => {
                        const checkbox = document.getElementById(`unit_${roomNumber}_${unit}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });

                    updateSelectedCount(roomNumber);
                }
            })
            .catch(error => {
                console.error('ç¾åœ¨è¨­å®šã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
    }

    // é¸æŠã•ã‚ŒãŸå˜å…ƒæ•°ã‚’æ›´æ–°
    function updateSelectedCount(roomNumber) {
        const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
        const countElement = document.getElementById(`selectedCount_${roomNumber}`);

        if (countElement) {
            countElement.textContent = checkboxes.length;
        }
    }

    // å…¨ã¦ã®å˜å…ƒã‚’é¸æŠ
    function selectAllUnits(roomNumber) {
        const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedCount(roomNumber);
    }

    // å…¨ã¦ã®å˜å…ƒé¸æŠã‚’è§£é™¤
    function clearAllUnits(roomNumber) {
        const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount(roomNumber);
    }

    // é¸æŠã•ã‚ŒãŸå˜å…ƒã®ãƒªã‚¹ãƒˆã‚’å–å¾—
    function getSelectedUnits(roomNumber) {
        const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // è«–è¿°å•é¡ŒCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadEssayTemplate() {
        const link = document.createElement('a');
        link.href = '/admin/download_essay_template';
        link.download = 'essay_problems_template.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // è«–è¿°å•é¡Œçµ±è¨ˆã‚’ãƒ­ãƒ¼ãƒ‰
    function loadEssayStats() {
        fetch('/admin/essay/stats')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateEssayStatistics(data);

                    // ç« ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦å‹•çš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                    fetch('/admin/essay/chapters')
                        .then(response => response.json())
                        .then(chaptersData => {
                            if (chaptersData.status === 'success') {
                                updateChapterFilter(chaptersData.chapters);
                            }
                        })
                        .catch(error => console.error('ç« ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error));
                }
            })
            .catch(error => {
                console.error('çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
    }

    // è«–è¿°å•é¡ŒCSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById('essayUploadForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const fileInput = document.getElementById('essay_csv_file');
        const replaceCheckbox = document.getElementById('replaceExisting');
        const submitBtn = this.querySelector('button[type="submit"]');

        if (!fileInput.files.length) {
            alert('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const file = fileInput.files[0];
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®ç¢ºèª
        if (replaceCheckbox.checked) {
            // ã“ã“ã§ä¸€æ—¦å‡¦ç†ã‚’åœæ­¢ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showConfirmModal(
                'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤',
                'âš ï¸ æ—¢å­˜ã®å…¨ã¦ã®è«–è¿°å•é¡ŒãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',
                () => {
                    executeEssayUpload(); // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œ
                },
                'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
                'btn-danger'
            );
            return;
        }

        executeEssayUpload(); // ç¢ºèªä¸è¦ãªå ´åˆã¯ç›´æ¥å®Ÿè¡Œ

        function executeEssayUpload() {

            const formData = new FormData();
            formData.append('file', file);
            if (replaceCheckbox.checked) {
                formData.append('replace_existing', 'on');
            }

            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            fetch('/admin/essay/upload_csv', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        let message = `âœ… ${data.message}`;
                        if (data.added_count > 0) {
                            message += `\nğŸ“Š è¿½åŠ ã•ã‚ŒãŸå•é¡Œæ•°: ${data.added_count}ä»¶`;
                        }
                        if (data.error_count > 0) {
                            message += `\nâš ï¸ ã‚¨ãƒ©ãƒ¼ä»¶æ•°: ${data.error_count}ä»¶`;
                        }
                        if (data.error_details && data.error_details.length > 0) {
                            message += `\n\nè©³ç´°ãªã‚¨ãƒ©ãƒ¼:\n${data.error_details.join('\n')}`;
                        }
                        alert(message);

                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        this.reset();

                        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                        loadEssayStats();
                        loadEssayProblems();
                    } else {
                        let errorMessage = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`;
                        if (data.error_details && data.error_details.length > 0) {
                            errorMessage += `\n\nè©³ç´°:\n${data.error_details.join('\n')}`;
                        }
                        alert(errorMessage);
                    }
                })
                .catch(error => {
                    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆUTF-8ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
        } // End of executeEssayUpload
    });

    function loadEssayProblems() {
        const container = document.getElementById('essay-problems-container');
        if (!container) return;

        const chapter = document.getElementById('essayChapterFilter')?.value || '';
        const type = document.getElementById('essayTypeFilter')?.value || '';
        const search = document.getElementById('essaySearch')?.value || '';

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ãŒä½•ã‚‚æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¡¨ç¤ºã—ãªã„
        if (!chapter && !type && !search) {
            container.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-search"></i><br>ç« ã€ã‚¿ã‚¤ãƒ—ã€ã¾ãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>';
            return;
        }

        container.innerHTML = '<p class="text-info">ğŸ“‹ å•é¡Œä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';


        const params = new URLSearchParams();
        if (chapter) params.append('chapter', chapter);
        if (type) params.append('type', type);
        if (search) params.append('search', search);

        fetch('/admin/essay/problems?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // ç« ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ¼ã‚¿ã«ç« ãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                    if (data.chapters && data.chapters.length > 0) {
                        updateChapterFilter(data.chapters);
                    }

                    // å•é¡Œä¸€è¦§ã‚’è¡¨ç¤º
                    if (data.problems && data.problems.length > 0) {
                        // çµ±è¨ˆã‚µãƒãƒªãƒ¼ã‚’ç°¡ç•¥åŒ–
                        let html = `
                        <div class="essay-stats-summary">
                            <div class="stat-item">
                                <div class="stat-value">${data.problems.length}</div>
                                <div class="stat-label">æ¤œç´¢çµæœ</div>
                            </div>
                        </div>
                        <div class="essay-problems-list">
                    `;


                        // å„å•é¡Œã‚’è¡¨ç¤º
                        data.problems.forEach(problem => {
                            const typeColor = {
                                'A': 'type-A',
                                'B': 'type-B',
                                'C': 'type-C',
                                'D': 'type-D'
                            }[problem.type] || '';

                            const enabledBadge = problem.enabled
                                ? '<span class="badge bg-success"><i class="fas fa-check"></i> æœ‰åŠ¹</span>'
                                : '<span class="badge bg-secondary"><i class="fas fa-times"></i> ç„¡åŠ¹</span>';

                            // å•é¡Œæ–‡ã‚’çŸ­ç¸®ï¼ˆ100æ–‡å­—ã¾ã§ï¼‰
                            const shortQuestion = problem.question.length > 100
                                ? problem.question.substring(0, 100) + '...'
                                : problem.question;

                            html += `
                            <div class="essay-problem-item">
                                <div class="problem-header">
                                    <div class="problem-info">
                                        <span class="badge badge-chapter">
                                            <i class="fas fa-book"></i> ç¬¬${problem.chapter}ç« 
                                        </span>
                                        <span class="badge badge-${typeColor}">
                                            <i class="fas fa-tag"></i> ã‚¿ã‚¤ãƒ—${problem.type}
                                        </span>
                                        ${enabledBadge}
                                        <div class="university-info">
                                            <i class="fas fa-university"></i>
                                            <span>${problem.university} ${problem.year}å¹´</span>
                                        </div>
                                    </div>
                                    <div class="problem-actions">
                                        <button class="btn btn-sm btn-info" onclick="editEssayProblem(${problem.id})" title="ç·¨é›†">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="toggleEssayProblem(${problem.id}, ${problem.enabled})" title="æœ‰åŠ¹/ç„¡åŠ¹">
                                            <i class="fas fa-toggle-${problem.enabled ? 'on' : 'off'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteEssayProblem(${problem.id})" title="å‰Šé™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="problem-content">
                                    <p class="problem-question">
                                        <strong>å•é¡Œ:</strong> ${shortQuestion}
                                    </p>
                                </div>
                                <div class="problem-meta">
                                    <div class="problem-meta-item">
                                        <i class="fas fa-file-alt"></i>
                                        <span>è§£ç­”: ${problem.answer_length}æ–‡å­—</span>
                                    </div>
                                    <div class="problem-meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>ID: ${problem.id}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        });

                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-warning">âš ï¸ è©²å½“ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                    }
                } else {
                    container.innerHTML = '<p class="text-danger">âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="text-danger">âŒ å•é¡Œä¸€è¦§ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
            });
    }

    // è«–è¿°å•é¡Œä¸€è¦§ã‚’è¡¨ç¤º
    function displayEssayProblems(problems) {
        const container = document.getElementById('essay-problems-container');

        if (!problems || !Array.isArray(problems)) {
            container.innerHTML = '<p class="text-danger">âŒ å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™</p>';
            return;
        }

        if (problems.length === 0) {
            container.innerHTML = '<p class="text-muted">ğŸ“­ æ¡ä»¶ã«åˆã†è«–è¿°å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
        html += '<thead class="table-dark"><tr>';
        html += '<th>ID</th><th>ç« </th><th>ã‚¿ã‚¤ãƒ—</th><th>å¤§å­¦</th><th>å¹´åº¦</th>';
        html += '<th>å•é¡Œæ–‡ï¼ˆæŠœç²‹ï¼‰</th><th>æ–‡å­—æ•°</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>';
        html += '</tr></thead><tbody>';

        problems.forEach(problem => {
            // å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ã‚’ç¢ºèª
            const questionPreview = (problem.question && problem.question.length > 50) ?
                problem.question.substring(0, 50) + '...' : (problem.question || 'å•é¡Œæ–‡ãªã—');

            html += '<tr>';
            html += '<td>' + (problem.id || 'N/A') + '</td>';
            html += '<td><span class="badge bg-secondary">' + (problem.chapter || 'N/A') + '</span></td>';
            html += '<td><span class="badge bg-' + getTypeColor(problem.type || 'A') + '">' + (problem.type || 'A') + '</span></td>';
            html += '<td>' + (problem.university || 'æœªè¨­å®š') + '</td>';
            html += '<td>' + (problem.year || 'N/A') + '</td>';
            html += '<td><small>' + questionPreview + '</small></td>';
            html += '<td>' + (problem.answer_length || 0) + 'å­—</td>';
            html += '<td>';
            if (problem.enabled) {
                html += '<span class="badge bg-success">æœ‰åŠ¹</span>';
            } else {
                html += '<span class="badge bg-secondary">ç„¡åŠ¹</span>';
            }
            html += '</td>';
            html += '<td>';
            html += '<div class="btn-group-vertical btn-group-sm">';
            html += '<button class="btn btn-primary btn-sm" onclick="editEssayProblem(' + (problem.id || 0) + ')">ç·¨é›†</button>';
            html += '<button class="btn btn-warning btn-sm" onclick="toggleEssayProblem(' + (problem.id || 0) + ', ' + (problem.enabled || false) + ')">åˆ‡æ›¿</button>';
            html += '<button class="btn btn-danger btn-sm" onclick="deleteEssayProblem(' + (problem.id || 0) + ')">å‰Šé™¤</button>';
            html += '</div></td>';
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // ã‚¿ã‚¤ãƒ—åˆ¥ã®è‰²ã‚’å–å¾—
    function getTypeColor(type) {
        switch (type) {
            case 'A': return 'danger';
            case 'B': return 'warning';
            case 'C': return 'info';
            case 'D': return 'success';
            default: return 'secondary';
        }
    }

    // ç« ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
    function updateChapterFilter(chapters) {
        const select = document.getElementById('essayChapterFilter');
        const currentValue = select.value;

        // æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆæœ€åˆã®å…¨ã¦ã®ç« ã¯æ®‹ã™ï¼‰
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }

        // æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        chapters.forEach(chapter => {
            const option = document.createElement('option');
            option.value = chapter;
            // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            if (chapter === 'com') {
                option.textContent = 'ç·åˆå•é¡Œ';
            } else if (!isNaN(chapter)) {
                option.textContent = 'ç¬¬' + chapter + 'ç« ';
            } else {
                option.textContent = chapter;
            }
            select.appendChild(option);
        });

        // å€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
    }

    // è«–è¿°å•é¡Œç·¨é›†
    function editEssayProblem(problemId) {
        // ã¾ãšå•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        fetch(`/admin/essay/problem/${problemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showEditDialog(data.problem);
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('å•é¡Œå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ å•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
    }

    // è«–è¿°å•é¡Œæ›´æ–°ï¼ˆå…±é€šé–¢æ•°ï¼‰
    function updateEssayProblem(problemId, updateData) {
        fetch('/admin/essay/update_problem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                problem_id: problemId,
                ...updateData
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('âœ… ' + data.message);
                    loadEssayProblems();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
    }

    function showEditDialog(problem) {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
        const existingModal = document.getElementById('editEssayModal');
        if (existingModal) {
            existingModal.remove();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLä½œæˆ
        const modalHTML = `
        <div class="modal fade" id="editEssayModal" tabindex="-1" aria-labelledby="editEssayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="editEssayModalLabel">
                            <i class="fas fa-edit"></i> è«–è¿°å•é¡Œç·¨é›† (ID: ${problem.id})
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEssayForm">
                            <input type="hidden" id="edit_problem_id" value="${problem.id}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_chapter" class="form-label">
                                            <i class="fas fa-bookmark"></i> ç«  <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit_chapter" value="${problem.chapter}" required>
                                        <small class="form-text text-muted">ä¾‹: 1, 2, com</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_type" class="form-label">
                                            <i class="fas fa-tag"></i> ã‚¿ã‚¤ãƒ— <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control" id="edit_type" required>
                                            <option value="A" ${problem.type === 'A' ? 'selected' : ''}>ã‚¿ã‚¤ãƒ—A (200å­—ä»¥ä¸Š)</option>
                                            <option value="B" ${problem.type === 'B' ? 'selected' : ''}>ã‚¿ã‚¤ãƒ—B (100-150å­—ç¨‹åº¦)</option>
                                            <option value="C" ${problem.type === 'C' ? 'selected' : ''}>ã‚¿ã‚¤ãƒ—C (50-75å­—ç¨‹åº¦)</option>
                                            <option value="D" ${problem.type === 'D' ? 'selected' : ''}>ã‚¿ã‚¤ãƒ—D (30å­—ç¨‹åº¦)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="edit_university" class="form-label">
                                            <i class="fas fa-university"></i> å¤§å­¦å
                                        </label>
                                        <input type="text" class="form-control" id="edit_university" value="${problem.university || ''}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_year" class="form-label">
                                            <i class="fas fa-calendar-alt"></i> å¹´åº¦
                                        </label>
                                        <input type="number" class="form-control" id="edit_year" value="${problem.year || 2025}" min="2000" max="2030">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_question" class="form-label">
                                    <i class="fas fa-question-circle"></i> å•é¡Œæ–‡ <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="edit_question" rows="4" required>${problem.question}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_answer" class="form-label">
                                    <i class="fas fa-lightbulb"></i> æ¨¡ç¯„è§£ç­”
                                </label>
                                <div class="textarea-wrapper">
                                    <textarea class="form-control" id="edit_answer" rows="6"
                                            oninput="updateAnswerCharCount('edit_answer', 'answerLength')">${problem.answer || ''}</textarea>
                                    <div class="char-counter" id="answerLength">${(problem.answer || '').length}å­—</div>
                                </div>
                                <small class="form-text text-muted">æ–‡å­—æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                            </div>

                            <!-- ç”»åƒç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                            <div class="mb-3">
                                <label class="form-label"><strong><i class="fas fa-image"></i> å•é¡Œç”»åƒ</strong></label>
                                <div class="image-management-section" id="imageManagement_${problem.id}">
                                    <!-- ç¾åœ¨ã®ç”»åƒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ -->
                                    <div class="current-image-section" id="currentImageSection_${problem.id}" style="display: none;">
                                        <div class="image-preview">
                                            <img src="/essay_image/${problem.id}" 
                                                alt="å•é¡Œç”»åƒ" 
                                                style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;"
                                                onerror="this.parentElement.parentElement.style.display='none'; document.getElementById('noImageSection_${problem.id}').style.display='block';">
                                        </div>
                                        <div class="image-actions mt-2">
                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteEssayImageFromEdit(${problem.id})">
                                                <i class="fas fa-trash"></i> ç”»åƒã‚’å‰Šé™¤
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadInEdit(${problem.id})">
                                                <i class="fas fa-exchange-alt"></i> ç”»åƒã‚’å¤‰æ›´
                                            </button>
                                        </div>
                                    </div>
                                        
                                    <!-- ç”»åƒãªã—ã®å ´åˆ -->
                                    <div class="no-image-section" id="noImageSection_${problem.id}" style="display: ${problem.has_image ? 'none' : 'block'};">
                                        <p class="text-muted"><i class="fas fa-image"></i> ç”»åƒã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="showImageUploadInEdit(${problem.id})">
                                            <i class="fas fa-upload"></i> ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                        </button>
                                    </div>
                                    
                                    <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰ -->
                                    <div class="image-upload-section" id="imageUploadSection_${problem.id}" style="display: none;">
                                        <form id="imageUploadForm_${problem.id}" enctype="multipart/form-data">
                                            <div class="form-group mb-2">
                                                <input type="file" id="imageInput_${problem.id}" name="image" 
                                                    accept="image/*" class="form-control" required>
                                                <small class="form-text text-muted">
                                                    å¯¾å¿œå½¢å¼: PNG, JPG, JPEG, GIF (æœ€å¤§5MB)
                                                </small>
                                            </div>
                                            <div class="form-group">
                                                <button type="button" id="uploadBtn_${problem.id}" class="btn btn-success btn-sm" onclick="uploadEssayImageFromEdit(${problem.id})">
                                                    <i class="fas fa-upload"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="hideImageUploadInEdit(${problem.id})">
                                                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_enabled" ${problem.enabled ? 'checked' : ''}>
                                <label class="form-check-label" for="edit_enabled">
                                    <i class="fas fa-check-circle"></i> æœ‰åŠ¹ã«ã™ã‚‹
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveEssayProblem()">
                            <i class="fas fa-save"></i> ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // DOMã«è¿½åŠ 
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        initializeCharCount('edit_answer', 'answerLength');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        const modal = new bootstrap.Modal(document.getElementById('editEssayModal'));
        modal.show();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã® cleanup
        document.getElementById('editEssayModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ç”»åƒã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        setTimeout(() => {
            checkAndShowImage(problem.id);
        }, 100);

    }

    function saveEssayProblem() {
        const problemId = document.getElementById('edit_problem_id').value;
        const submitBtn = document.querySelector('#editEssayModal .btn-primary');
        const originalText = submitBtn.innerHTML;

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const chapter = document.getElementById('edit_chapter').value.trim();
        const question = document.getElementById('edit_question').value.trim();
        const type = document.getElementById('edit_type').value;

        if (!chapter || !question || !type) {
            alert('âŒ ç« ã€ã‚¿ã‚¤ãƒ—ã€å•é¡Œæ–‡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';

        const data = {
            problem_id: parseInt(problemId),
            chapter: chapter,
            type: type,
            university: document.getElementById('edit_university').value.trim() || 'æœªæŒ‡å®š',
            year: parseInt(document.getElementById('edit_year').value) || 2025,
            question: question,
            answer: document.getElementById('edit_answer').value.trim() || 'è§£ç­”ãªã—',
            enabled: document.getElementById('edit_enabled').checked
        };

        fetch('/admin/essay/update_problem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('âœ… ' + data.message);

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editEssayModal'));
                    modal.hide();

                    // å•é¡Œä¸€è¦§ã‚’æ›´æ–°
                    loadEssayProblems();
                    loadEssayStats();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’æ”¹å–„
    function filterEssayProblems() {
        loadEssayProblems();
    }

    // ç·¨é›†å†…å®¹ã‚’ä¿å­˜
    function saveEditedProblem(problemId) {
        const formData = {
            chapter: document.getElementById('edit_chapter').value,
            type: document.getElementById('edit_type').value,
            university: document.getElementById('edit_university').value,
            year: parseInt(document.getElementById('edit_year').value),
            question: document.getElementById('edit_question').value,
            answer: document.getElementById('edit_answer').value,
            enabled: document.getElementById('edit_enabled').checked
        };

        const saveBtn = event.target;
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';

        // â˜… POSTãƒ¡ã‚½ãƒƒãƒ‰ã«å¤‰æ›´ã—ã€URLã‚‚å¤‰æ›´
        fetch('/admin/essay/update_problem', {
            method: 'POST',  // PUT ã‹ã‚‰ POST ã«å¤‰æ›´
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                problem_id: problemId,  // â˜… problem_id ã‚’è¿½åŠ 
                ...formData
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('âœ… ' + data.message);
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    bootstrap.Modal.getInstance(document.getElementById('editEssayModal')).hide();
                    loadEssayProblems();
                    if (typeof loadEssayStats === 'function') {
                        loadEssayStats();
                    }
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            });
    }

    // è«–è¿°å•é¡Œã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    function toggleEssayProblem(problemId, currentEnabled) {
        const newStatus = !currentEnabled;
        const action = newStatus ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';

        showConfirmModal(
            'å…¬é–‹çŠ¶æ…‹ã®å¤‰æ›´',
            'ã“ã®å•é¡Œã‚’' + action + 'ã«ã—ã¾ã™ã‹ï¼Ÿ',
            () => {
                fetch('/admin/essay/toggle_enabled', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        problem_id: problemId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('âœ… ' + data.message);
                            loadEssayProblems();
                            loadEssayStats();
                        } else {
                            alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ åˆ‡ã‚Šæ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    });
            },
            'å¤‰æ›´',
            'btn-primary'
        );
    }

    // loadEssayStatsé–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (typeof loadEssayStats === 'undefined') {
        window.loadEssayStats = function () {
            // çµ±è¨ˆã®å†èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            if (typeof updateEssayStatistics === 'function') {
                updateEssayStatistics();
            }
        };
    }

    function updateEssayStatistics() {
        fetch('/admin/essay/stats')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.stats) {
                    const statsElements = {
                        'totalEssayProblems': data.stats.total_problems || 0,
                        'enabledEssayProblems': data.stats.total_problems || 0,
                        'totalChapters': data.stats.total_chapters || 0,
                        'totalUniversities': data.stats.total_universities || 0
                    };

                    Object.entries(statsElements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            });
    }

    // è«–è¿°å•é¡Œå‰Šé™¤
    function deleteEssayProblem(problemId) {
        showConfirmModal(
            'è«–è¿°å•é¡Œå‰Šé™¤',
            'ã“ã®è«–è¿°å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚',
            () => {
                fetch('/admin/essay/delete_problem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        problem_id: problemId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('âœ… ' + data.message);
                            loadEssayProblems();
                            if (typeof loadEssayStats === 'function') {
                                loadEssayStats();
                            }
                        } else {
                            alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    });
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    // CSVå‡ºåŠ›
    function exportEssayProblems() {
        const chapter = document.getElementById('essayChapterFilter').value;
        const type = document.getElementById('essayTypeFilter').value;
        const search = document.getElementById('essaySearch').value;

        const params = new URLSearchParams();
        if (chapter) params.append('chapter', chapter);
        if (type) params.append('type', type);
        if (search) params.append('search', search);

        window.open('/admin/essay/export_csv?' + params.toString(), '_blank');
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
    function previewImage(input) {
        const previewDiv = document.getElementById('imagePreview');

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
                previewDiv.innerHTML = `
                <div class="image-preview-container">
                    <img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" 
                         style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                            onclick="clearImagePreview()">
                        <i class="fas fa-times"></i> å‰Šé™¤
                    </button>
                </div>
            `;
            };

            reader.readAsDataURL(input.files[0]);
        } else {
            clearImagePreview();
        }
    }

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    function clearImagePreview() {
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('new_essay_image').value = '';
    }

    // è«–è¿°å•é¡Œè¿½åŠ ã®é–¢æ•°ã‚’ä¿®æ­£
    function addEssayProblem() {
        const formData = {
            chapter: document.getElementById('add_chapter').value,
            type: document.getElementById('add_type').value,
            university: document.getElementById('add_university').value,
            year: document.getElementById('add_year').value,
            question: document.getElementById('add_question').value,
            answer: document.getElementById('add_answer').value,
            answer_length: document.getElementById('add_answer_length').value,
            enabled: document.getElementById('add_enabled').checked
        };

        fetch('/admin/essay/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => {

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${contentType}`);
                }

                return response.json();
            })
            .then(data => {

                if (data.status === 'success') {
                    alert(data.message);
                    document.getElementById('addEssayModal').style.display = 'none';
                    loadEssayProblems(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);

                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (error.message.includes('JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹')) {
                    alert('ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert(`è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                }
            });
    }

    // è«–è¿°å•é¡Œå…¬é–‹è¨­å®šç®¡ç†ã®JavaScriptï¼ˆæ”¹å–„ç‰ˆï¼‰

    let currentVisibilitySettings = {};
    let availableChapters = [];
    let availableTypes = ['A', 'B', 'C', 'D'];

    function initializeVisibilitySettings() {
        // éƒ¨å±‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        loadRoomList();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.getElementById('visibilityRoomSelect').addEventListener('change', function () {
            const selectedRoom = this.value;
            const loadBtn = document.getElementById('loadVisibilitySettings');
            const saveBtn = document.getElementById('saveVisibilitySettings');
            const resetBtn = document.getElementById('resetVisibilitySettings');

            if (selectedRoom) {
                loadBtn.disabled = false;
                saveBtn.disabled = false;
                resetBtn.disabled = false;
            } else {
                loadBtn.disabled = true;
                saveBtn.disabled = true;
                resetBtn.disabled = true;
                document.getElementById('visibilityMatrix').style.display = 'none';
            }
        });

        document.getElementById('loadVisibilitySettings').addEventListener('click', loadVisibilitySettings);
        document.getElementById('saveVisibilitySettings').addEventListener('click', saveVisibilitySettings);
        document.getElementById('resetVisibilitySettings').addEventListener('click', resetVisibilitySettings);

        // ã‚¿ã‚¤ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        const typeHeaders = document.querySelectorAll('.grid-header.grid-cell-type');
        typeHeaders.forEach((header, index) => {
            if (index < availableTypes.length) {
                const type = availableTypes[index];
                header.style.cursor = 'pointer';
                header.title = `${type}ã‚¿ã‚¤ãƒ—ã‚’ä¸€æ‹¬åˆ‡ã‚Šæ›¿ãˆ`;
                header.addEventListener('click', () => toggleTypeVisibility(type));

                // ãƒ›ãƒãƒ¼åŠ¹æœã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹è¿½åŠ 
                header.classList.add('clickable-header');
            }
        });
    }

    function loadRoomList() {
        fetch('/admin/get_room_list')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const select = document.getElementById('visibilityRoomSelect');

                    // æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ï¼‰
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }

                    // éƒ¨å±‹ç•ªå·ã‚’è¿½åŠ 
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = `éƒ¨å±‹ ${room}`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('éƒ¨å±‹ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showVisibilityStatus('error', 'éƒ¨å±‹ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }

    function loadVisibilitySettings() {
        const roomNumber = document.getElementById('visibilityRoomSelect').value;
        if (!roomNumber) return;

        showVisibilityStatus('info', 'è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');

        fetch(`/admin/essay_visibility_settings/${roomNumber}`)
            .then(response => response.json())
            .then(data => {

                if (data.status === 'success') {
                    try {
                        currentVisibilitySettings = data.settings;
                        availableChapters = data.chapters;

                        createVisibilityMatrix();
                        updateSettingsSummary();
                        showVisibilityStatus('success', `éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    } catch (e) {
                        console.error('âŒ è¨­å®šåæ˜ ã‚¨ãƒ©ãƒ¼:', e);
                        showVisibilityStatus('error', 'è¨­å®šã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
                    }
                } else {
                    console.error('âŒ è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.message);
                    showVisibilityStatus('error', data.message);
                }
            })
            .catch(error => {
                console.error('âŒ è¨­å®šèª­ã¿è¾¼ã¿ä¾‹å¤–:', error);
                showVisibilityStatus('error', 'è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }

    function createVisibilityMatrix() {
        const gridContainer = document.getElementById('visibilityGrid');

        // ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªã‚¢
        const existingCells = gridContainer.querySelectorAll(':not(.grid-header)');
        existingCells.forEach(cell => cell.remove());

        // CSSå¤‰æ•°ã‚’å‹•çš„ã«è¨­å®š
        document.documentElement.style.setProperty('--type-count', availableTypes.length);

        // å„ç« ã”ã¨ã«ã‚°ãƒªãƒƒãƒ‰è¡Œã‚’ç”Ÿæˆ
        availableChapters.forEach(chapter => {
            // ç« åã‚»ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰
            const chapterCell = document.createElement('div');
            chapterCell.className = 'grid-cell-chapter';

            // ãƒ©ãƒ™ãƒ«ã®ç”Ÿæˆ
            let chapterLabel = `ç¬¬${chapter}ç« `;
            if (chapter === 'com') {
                chapterLabel = 'ç·åˆå•é¡Œ';
            }

            chapterCell.textContent = chapterLabel;
            chapterCell.setAttribute('data-chapter', chapter);

            // ç« åã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ä¸€æ‹¬è¨­å®š
            chapterCell.addEventListener('click', function (event) {
                event.stopPropagation();
                toggleChapterVisibility(chapter);
            });

            gridContainer.appendChild(chapterCell);

            // å„ã‚¿ã‚¤ãƒ—ã®ã‚»ãƒ«
            availableTypes.forEach(type => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell-setting';

                // è¨­å®šçŠ¶æ…‹ã‚’å–å¾—
                const isVisible = getVisibilitySetting(chapter, type);

                // ã‚¢ã‚¤ã‚³ãƒ³è¦ç´ 
                const iconElement = document.createElement('i');
                iconElement.className = `${isVisible ? 'fas fa-eye' : 'fas fa-eye-slash'} setting-icon`;

                // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ 
                const textElement = document.createElement('div');
                textElement.className = 'setting-text';
                textElement.textContent = isVisible ? 'å…¬é–‹' : 'éå…¬é–‹';

                // ã‚»ãƒ«ã«è¿½åŠ 
                cell.appendChild(iconElement);
                cell.appendChild(textElement);

                // çŠ¶æ…‹ã‚¯ãƒ©ã‚¹è¨­å®š
                cell.classList.add(isVisible ? 'visible' : 'hidden');

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                cell.addEventListener('click', function (event) {
                    event.stopPropagation();
                    toggleIndividualVisibility(chapter, type, cell);
                });

                // ãƒ‡ãƒ¼ã‚¿å±æ€§è¨­å®š
                cell.setAttribute('data-chapter', chapter);
                cell.setAttribute('data-type', type);
                cell.setAttribute('data-visible', isVisible);

                gridContainer.appendChild(cell);
            });
        });

        document.getElementById('visibilityMatrix').style.display = 'block';

    }

    function updateCellAppearance(cell, isVisible) {
        // â˜…é‡è¦ï¼šã‚»ãƒ«å†…å®¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å†æ§‹ç¯‰
        cell.innerHTML = '';

        // ã‚¯ãƒ©ã‚¹æ›´æ–°
        cell.classList.remove('visible', 'hidden');
        cell.classList.add(isVisible ? 'visible' : 'hidden');

        // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³è¦ç´ ã‚’ä½œæˆ
        const iconElement = document.createElement('i');
        iconElement.className = `${isVisible ? 'fas fa-eye' : 'fas fa-eye-slash'} setting-icon`;

        // æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
        const textElement = document.createElement('div');
        textElement.className = 'setting-text';
        textElement.textContent = isVisible ? 'å…¬é–‹' : 'éå…¬é–‹';

        // ã‚»ãƒ«ã«è¿½åŠ 
        cell.appendChild(iconElement);
        cell.appendChild(textElement);

        // ãƒ‡ãƒ¼ã‚¿å±æ€§æ›´æ–°
        cell.setAttribute('data-visible', isVisible);

    }

    // ç« å…¨ä½“ã®ä¸€æ‹¬è¨­å®šæ©Ÿèƒ½
    function toggleChapterVisibility(chapter) {

        // è©²å½“ç« ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
        const chapterCells = document.querySelectorAll(`[data-chapter="${chapter}"].grid-cell-setting`);

        if (chapterCells.length === 0) {
            console.warn(`ç¬¬${chapter}ç« ã®ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            return;
        }

        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆéåŠæ•°ã§åˆ¤å®šï¼‰
        let visibleCount = 0;
        chapterCells.forEach(cell => {
            if (cell.getAttribute('data-visible') === 'true') {
                visibleCount++;
            }
        });

        // éåŠæ•°ãŒå…¬é–‹ãªã‚‰éå…¬é–‹ã«ã€ãã†ã§ãªã‘ã‚Œã°å…¬é–‹ã«
        const newVisibility = visibleCount < (chapterCells.length / 2);

        // å„ã‚»ãƒ«ã‚’æ›´æ–°
        chapterCells.forEach(cell => {
            const type = cell.getAttribute('data-type');

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            if (!currentVisibilitySettings[chapter]) {
                currentVisibilitySettings[chapter] = {};
            }
            currentVisibilitySettings[chapter][type] = newVisibility;

            // è¡¨ç¤ºæ›´æ–°
            updateCellAppearance(cell, newVisibility);
        });

        // ç« åã‚»ãƒ«ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        const chapterCell = document.querySelector(`[data-chapter="${chapter}"].grid-cell-chapter`);
        if (chapterCell) {
            chapterCell.style.animation = 'chapterUpdated 0.8s ease';
            setTimeout(() => {
                chapterCell.style.animation = '';
            }, 800);
        }
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = `
@keyframes chapterUpdated {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); background: linear-gradient(135deg, #c3e6cb 0%, #d4edda 100%) !important; }
    100% { transform: scale(1); }
}
`;
    document.head.appendChild(style);

    function getVisibilitySetting(chapter, type) {
        // è¨­å®šãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã®å€¤ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§trueï¼ˆå…¬é–‹ï¼‰
        if (currentVisibilitySettings[chapter] && currentVisibilitySettings[chapter][type] !== undefined) {
            return currentVisibilitySettings[chapter][type];
        }
        return true;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ç¢ºèª
    function debugMatrixState() {
        const cells = document.querySelectorAll('.visibility-cell');
        cells.forEach((cell, index) => {
            const chapter = cell.getAttribute('data-chapter');
            const type = cell.getAttribute('data-type');
            const isVisible = cell.getAttribute('data-visible') === 'true';
            const hasContent = cell.querySelector('.visibility-cell-content');
        });

    }

    function toggleIndividualVisibility(chapter, type, cell) {
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
        const currentStatus = getVisibilitySetting(chapter, type);
        const newStatus = !currentStatus;

        // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ ã‚’ç¢ºä¿
        if (!currentVisibilitySettings[chapter]) {
            currentVisibilitySettings[chapter] = {};
        }

        // è¨­å®šã‚’æ›´æ–°
        currentVisibilitySettings[chapter][type] = newStatus;

        // ã‚»ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        updateCellAppearance(cell, newStatus);
    }

    function setTypeVisible(targetType, isVisible) {
        availableChapters.forEach(chapter => {
            if (!currentVisibilitySettings[chapter]) {
                currentVisibilitySettings[chapter] = {};
            }
            currentVisibilitySettings[chapter][targetType] = isVisible;

            // ã‚»ãƒ«ã‚’æ›´æ–°
            const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${targetType}"]`);
            if (cell) {
                updateCellAppearance(cell, isVisible);
                cell.classList.add('changed');
                setTimeout(() => cell.classList.remove('changed'), 500);
            }
        });

        updateSettingsSummary();
        showVisibilityStatus('success', `å…¨ã¦ã®${targetType}å•é¡Œã‚’${isVisible ? 'å…¬é–‹' : 'éå…¬é–‹'}ã«è¨­å®šã—ã¾ã—ãŸ`);
    }

    function updateSettingsSummary() {
        let visibleCount = 0;
        let totalCount = 0;

        availableChapters.forEach(chapter => {
            availableTypes.forEach(type => {
                totalCount++;
                if (getVisibilitySetting(chapter, type)) {
                    visibleCount++;
                }
            });
        });

        const hiddenCount = totalCount - visibleCount;
        const visibilityRate = totalCount > 0 ? Math.round((visibleCount / totalCount) * 100) : 0;

        document.getElementById('visibleCount').textContent = visibleCount;
        document.getElementById('hiddenCount').textContent = hiddenCount;
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('visibilityRate').textContent = visibilityRate + '%';
    }

    function saveVisibilitySettings() {
        const roomNumber = document.getElementById('visibilityRoomSelect').value;
        if (!roomNumber) {
            alert('éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢
        const saveBtn = document.getElementById('saveVisibilitySettings');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';

        showVisibilityStatus('info', 'è¨­å®šã‚’ä¿å­˜ä¸­...');

        fetch('/admin/essay_visibility_settings/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                room_number: roomNumber,
                settings: currentVisibilitySettings
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showVisibilityStatus('success', `${data.message}`);
                } else {
                    showVisibilityStatus('error', data.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showVisibilityStatus('error', `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });
    }

    function resetVisibilitySettings() {
        showConfirmModal(
            'è¨­å®šãƒªã‚»ãƒƒãƒˆ',
            'å…¨ã¦ã®è¨­å®šã‚’å…¬é–‹çŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ',
            () => {
                setAllVisible(true);
                showVisibilityStatus('info', 'å…¨ã¦ã®è¨­å®šã‚’å…¬é–‹çŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            },
            'ãƒªã‚»ãƒƒãƒˆ',
            'btn-warning'
        );
    }

    function setAllVisible(isVisible) {
        availableChapters.forEach(chapter => {
            if (!currentVisibilitySettings[chapter]) {
                currentVisibilitySettings[chapter] = {};
            }
            availableTypes.forEach(type => {
                currentVisibilitySettings[chapter][type] = isVisible;

                // ã‚»ãƒ«ã‚’æ›´æ–°
                const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
                if (cell) {
                    updateCellAppearance(cell, isVisible);
                }
            });
        });
        updateSettingsSummary();
    }

    function toggleTypeVisibility(type) {
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆéåŠæ•°ã§åˆ¤å®šï¼‰
        let visibleCount = 0;
        let totalCount = 0;

        availableChapters.forEach(chapter => {
            totalCount++;
            if (getVisibilitySetting(chapter, type)) {
                visibleCount++;
            }
        });

        // éåŠæ•°ãŒå…¬é–‹ãªã‚‰éå…¬é–‹ã«ã€ãã†ã§ãªã‘ã‚Œã°å…¬é–‹ã«
        const newVisibility = totalCount > 0 && visibleCount < (totalCount / 2);

        setTypeVisible(type, newVisibility);
    }

    function showVisibilityStatus(type, message) {
        const statusDiv = document.getElementById('visibilityStatus');
        if (!statusDiv) {
            console.error('âŒ visibilityStatusè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        const iconClass = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'info': 'fas fa-info-circle',
            'warning': 'fas fa-exclamation-triangle'
        }[type] || 'fas fa-info-circle';

        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'info': 'alert-info',
            'warning': 'alert-warning'
        }[type] || 'alert-info';

        statusDiv.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            const alert = statusDiv.querySelector('.alert');
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 150);
            }
        }, 5000);
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function debugVisibilitySettings() {
        // å„ã‚»ãƒ«ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        availableChapters.forEach(chapter => {
            availableTypes.forEach(type => {
                const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
                const setting = getVisibilitySetting(chapter, type);
                if (cell) {
                }
            });
        });

    }

    // ãƒ†ã‚¹ãƒˆç”¨ã®é–¢æ•°
    function testIndividualClick(chapter, type) {
        const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
        if (cell) {
            cell.click();
        } else {
            console.error(`âŒ ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ç¬¬${chapter}ç«  ã‚¿ã‚¤ãƒ—${type}`);
        }
    }

    // è¨­å®šçŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showCurrentSettings() {
        const roomNumber = document.getElementById('visibilityRoomSelect').value;
        if (!roomNumber) {
            return;
        }
        console.table(currentVisibilitySettings);
    }

    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒãƒƒã‚°é–¢æ•°ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
    window.debugVisibilitySettings = debugVisibilitySettings;
    window.testIndividualClick = testIndividualClick;
    window.showCurrentSettings = showCurrentSettings;

    // éƒ¨å±‹å‰Šé™¤æ©Ÿèƒ½
    function deleteRoom(event, roomNumber) {
        if (event) event.preventDefault();

        showConfirmModal(
            'éƒ¨å±‹å‰Šé™¤',
            `éƒ¨å±‹${roomNumber}ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâ€» éƒ¨å±‹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚`,
            () => {
                fetch('/admin/delete_room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_number: roomNumber
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    });
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    function handleAnnouncementDelete(event) {
        event.preventDefault();
        const form = event.target;
        showConfirmModal(
            'ãŠçŸ¥ã‚‰ã›å‰Šé™¤',
            'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            () => {
                form.submit();
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    function toggleRoomSuspension(event, buttonElement) {
        if (event) event.preventDefault();
        const roomNumber = buttonElement.getAttribute('data-room-number');
        const currentSuspendedState = buttonElement.getAttribute('data-is-suspended') === 'true';

        const action = currentSuspendedState ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢';
        const confirmMessage = currentSuspendedState
            ? `éƒ¨å±‹${roomNumber}ã®ä¸€æ™‚åœæ­¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nè§£é™¤å¾Œã€ã“ã®éƒ¨å±‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†ã³ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`
            : `éƒ¨å±‹${roomNumber}ã‚’ä¸€æ™‚åœæ­¢ã«ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ä¸€æ™‚åœæ­¢ä¸­ã¯ã€ã“ã®éƒ¨å±‹ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚\nâ€» ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰åˆ¶é™ã•ã‚Œã¾ã™ã€‚`;

        const confirmBtnClass = currentSuspendedState ? 'btn-success' : 'btn-warning';

        showConfirmModal(
            `éƒ¨å±‹${roomNumber}ã®${action}`,
            confirmMessage,
            () => {
                const originalHTML = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡¦ç†ä¸­...';

                fetch('/admin/toggle_room_suspension', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_number: roomNumber
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                            buttonElement.disabled = false;
                            buttonElement.innerHTML = originalHTML;
                        }
                    })
                    .catch(error => {
                        console.error('ä¸€æ™‚åœæ­¢åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = originalHTML;
                    });
            },
            action,
            confirmBtnClass
        );
    }

    // ========================================
    // è«–è¿°å•é¡Œç·¨é›†ã§ã®ç”»åƒç®¡ç†æ©Ÿèƒ½
    // ========================================

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    function showImageUploadInEdit(problemId) {
        document.getElementById('imageUploadSection_' + problemId).style.display = 'block';

        // ç¾åœ¨ã®ç”»åƒè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
        const changeBtn = document.querySelector(`#currentImageSection_${problemId} .btn-secondary`);
        if (changeBtn) {
            changeBtn.style.display = 'none';
        }
    }

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
    function hideImageUploadInEdit(problemId) {
        const uploadSection = document.getElementById('imageUploadSection_' + problemId);
        const form = document.getElementById('imageUploadForm_' + problemId);

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (uploadSection) {
            uploadSection.style.display = 'none';
        }

        // ç¾åœ¨ã®ç”»åƒè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
        const changeBtn = document.querySelector(`#currentImageSection_${problemId} .btn-secondary`);
        if (changeBtn) {
            changeBtn.style.display = 'inline-block';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚»ãƒƒãƒˆ
        if (form) {
            try {
                form.reset();
            } catch (error) {
                console.warn('ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                const fileInput = document.getElementById('imageInput_' + problemId);
                if (fileInput) {
                    fileInput.value = '';
                }
            }
        }
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    function uploadEssayImageFromEdit(problemId) {

        const fileInput = document.getElementById('imageInput_' + problemId);

        if (!fileInput || !fileInput.files[0]) {
            alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);

        // IDã§ç›´æ¥ãƒœã‚¿ãƒ³ã‚’å–å¾—
        const uploadBtn = document.getElementById('uploadBtn_' + problemId);
        if (!uploadBtn) {
            console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', 'uploadBtn_' + problemId);
            alert('ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const originalText = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        fetch(`/admin/upload_essay_image/${problemId}`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {

                if (data.status === 'success') {
                    alert(data.message);

                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…ˆã«éè¡¨ç¤º
                    hideImageUploadInEdit(problemId);

                    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰ç”»åƒã‚’ãƒã‚§ãƒƒã‚¯ãƒ»è¡¨ç¤º
                    setTimeout(() => {
                        checkAndShowImage(problemId);
                    }, 500);
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
            });
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç”»åƒå‰Šé™¤
    function deleteEssayImageFromEdit(problemId) {
        showConfirmModal(
            'ç”»åƒå‰Šé™¤',
            'ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚',
            () => {
                fetch(`/admin/delete_essay_image/${problemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);

                            // ç¾åœ¨ã®ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã—ã€ãªã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                            document.getElementById('currentImageSection_' + problemId).style.display = 'none';
                            document.getElementById('noImageSection_' + problemId).style.display = 'block';

                            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚‚éè¡¨ç¤º
                            hideImageUploadInEdit(problemId);
                        } else {
                            alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    });
            },
            'å‰Šé™¤',
            'btn-danger'
        );
    }

    // ç”»åƒã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¨è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function checkAndShowImage(problemId) {
        const img = new Image();
        img.onload = function () {
            // ç”»åƒãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå ´åˆ
            document.getElementById('currentImageSection_' + problemId).style.display = 'block';
            document.getElementById('noImageSection_' + problemId).style.display = 'none';
        };
        img.onerror = function () {
            // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆ
            document.getElementById('currentImageSection_' + problemId).style.display = 'none';
            document.getElementById('noImageSection_' + problemId).style.display = 'block';
        };
        img.src = `/essay_image/${problemId}?t=${Date.now()}`;
    }

    // ========================================
    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ©Ÿèƒ½
    // ========================================
    function updateAnswerCharCount(textareaId, counterId) {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);

        if (!textarea || !counter) {
            console.warn(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${textareaId} ã¾ãŸã¯ ${counterId}`);
            return;
        }

        const currentLength = textarea.value.length;
        counter.textContent = `${currentLength}å­—`;

        // æ–‡å­—æ•°ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
        counter.classList.remove('warning', 'danger');

        if (currentLength > 500) {
            counter.classList.add('danger');
        } else if (currentLength > 300) {
            counter.classList.add('warning');
        }
    }

    function initializeCharCount(textareaId, counterId) {
        setTimeout(() => {
            updateAnswerCharCount(textareaId, counterId);
        }, 100);
    }

    // admin.html ã® <script> ã‚¿ã‚°ã®æœ«å°¾ã«è¿½åŠ 

    // ========================================
    // ä»Šæ—¥ã®10å• å†é¸è€ƒæ©Ÿèƒ½
    // ========================================
    document.addEventListener('click', function (event) {
        // ã‚¯ãƒ©ã‚¹å .regenerate-quiz-btn ã‚’æŒã¤ãƒœã‚¿ãƒ³ã‚’æ¢ã™
        const button = event.target.closest('.regenerate-quiz-btn');
        if (button) {
            const roomNumber = button.dataset.roomNumber;

            showConfirmModal(
                'ä»Šæ—¥ã®10å• å†é¸è€ƒ',
                `éƒ¨å±‹${roomNumber}ã®ã€Œä»Šæ—¥ã®10å•ã€ã‚’æœ¬å½“ã«å†é¸è€ƒã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                `âš ï¸ ã“ã®æ“ä½œã‚’è¡Œã†ã¨ã€ã“ã®éƒ¨å±‹ã®ä»Šæ—¥ã®è§£ç­”çµæœã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†åº¦æŒ‘æˆ¦ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`,
                () => {
                    // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‡¦ç†ä¸­...';

                    fetch('/admin/regenerate_daily_quiz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ room_number: roomNumber })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        })
                        .finally(() => {
                            // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-sync-alt"></i> 10å• å†é¸è€ƒ';
                        });
                },
                'å†é¸è€ƒ',
                'btn-warning'
            );
        }
    });
</script>

<style>
    /* ========================================
   1. åŸºæœ¬çš„ãªç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 15px;
        margin-bottom: 25px;
    }

    .admin-header h2 {
        margin: 0;
        color: #343a40;
    }

    /* ========================================
   2. æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰
   ======================================== */
    .admin-section {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .section-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 15px 20px !important;
        cursor: pointer;
        border-bottom: 1px solid #dee2e6;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    .section-header h3 {
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.3rem;
        color: #495057;
        font-weight: 600;
    }

    .section-header h3 i:first-child {
        margin-right: 10px;
        color: #6c757d;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .section-header[aria-expanded="true"] .toggle-icon {
        transform: rotate(180deg);
    }

    /* â˜…é‡è¦ï¼šã™ã¹ã¦ã®section-contentã‚’çµ±ä¸€ */
    .section-content {
        padding: 25px !important;
        background-color: #fff !important;
        transition: all 0.3s ease;
        box-sizing: border-box !important;
    }

    /* ç‰¹å®šã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®paddingä¸Šæ›¸ãã‚’é˜²ã */
    .admin-section .section-content {
        padding: 25px !important;
    }

    /* ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª¿æ•´ */
    .section-content>* {
        margin-bottom: 15px;
    }

    .section-content>*:last-child {
        margin-bottom: 0;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã®marginçµ±ä¸€ */
    .section-content .upload-form,
    .section-content .add-user-form,
    .section-content .essay-form-container,
    .section-content .csv-upload-form,
    .section-content .admin-panel {
        margin: 15px 0 !important;
        padding: 20px !important;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®marginçµ±ä¸€ */
    .section-content .scrollable-table-container,
    .section-content .table-controls {
        margin-bottom: 15px !important;
    }

    /* CSVé–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®paddingçµ±ä¸€ */
    .section-content .csv-template-section,
    .section-content .csv-import-section,
    .section-content .essay-stats-section,
    .section-content .essay-management-section,
    .section-content .essay-form-section {
        margin: 15px 0 !important;
        padding: 20px !important;
    }

    /* ç‰¹å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å€‹åˆ¥ä¿®æ­£ */
    #section-user-management .section-content,
    #section-csv-management .section-content,
    #section-room-settings .section-content,
    #section-essay-visibility .section-content,
    #section-essay-management .section-content,
    #section-user-stats .section-content,
    #section-database-management .section-content {
        padding: 25px !important;
        box-sizing: border-box !important;
    }

    /* ========================================
   3. ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .admin-panel {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #eee;
    }

    .admin-panel h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #343a40;
    }

    .admin-panel p {
        margin-bottom: 15px;
        line-height: 1.5;
    }

    /* ========================================
   4. ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ
   ======================================== */
    .scrollable-table-container {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: auto;
        /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¿½åŠ  */
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

    .scrollable-table-container .table {
        margin-bottom: 0;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #343a40 !important;
    }

    .table-controls {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
    }

    .table-controls label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }

    .table-responsive {
        overflow-x: auto !important;
    }

    /* ========================================
   5. ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ 
   ======================================== */
    .sort-icon {
        margin-left: 5px;
        opacity: 0.7;
        transition: opacity 0.2s, color 0.2s;
        cursor: pointer;
    }

    .sort-icon:hover {
        opacity: 1;
        color: #ffc107;
    }

    .fa-sort-up {
        color: #28a745;
    }

    .fa-sort-down {
        color: #dc3545;
    }

    .badge {
        font-size: 0.8em;
    }

    #userTableBody tr:hover {
        background-color: #f8f9fa !important;
    }

    .delete-user-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    /* ========================================
   6. ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .upload-form,
    .add-user-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
    }

    .btn-group-vertical .btn {
        margin-bottom: 2px;
    }

    /* ========================================
   7. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³
   ======================================== */
    .section-content {
        transition: all 0.3s ease;
    }

    .collapse {
        transition: height 0.35s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .clickable-header:hover {
        background-color: #e9ecef;
        text-decoration: underline;
    }

    @keyframes settingChanged {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        100% {
            transform: scale(1);
        }
    }

    #invalidHistoryAnalysisResult,
    #userDebugResult,
    #statsCheckResult {
        animation: fadeIn 0.3s ease-in;
    }

    /* ========================================
   8. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
   ======================================== */
    @media (max-width: 768px) {
        .admin-container {
            padding: 15px;
        }

        .admin-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .section-header {
            padding: 12px 15px !important;
        }

        .section-header h3 {
            font-size: 1.1rem;
        }

        .section-content {
            padding: 20px 15px !important;
        }

        .section-content .upload-form,
        .section-content .add-user-form,
        .section-content .admin-panel {
            padding: 15px !important;
            margin: 10px 0 !important;
        }

        .section-content .csv-template-section,
        .section-content .csv-import-section,
        .section-content .essay-stats-section,
        .section-content .essay-management-section,
        .section-content .essay-form-section {
            padding: 15px !important;
            margin: 10px 0 !important;
        }

        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .btn-group-vertical .btn {
            font-size: 0.7rem;
            padding: 4px 8px;
        }

        .scrollable-table-container {
            max-height: 300px;
            overflow-x: auto;
        }

        .table {
            font-size: 0.8rem;
            min-width: 600px;
            /* æœ€å°å¹…ã‚’ä¿è¨¼ */
        }

        .table th,
        .table td {
            padding: 0.3rem;
            white-space: nowrap;
            min-width: 80px;
            /* å„ã‚»ãƒ«ã®æœ€å°å¹… */
        }

        .table-controls .row {
            margin-bottom: 0;
        }

        .table-controls .col-md-6 {
            margin-bottom: 10px;
        }

        /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        .char-counter {
            font-size: 0.75rem;
            padding: 3px 6px;
            bottom: 8px;
            right: 8px;
        }

        .essay-answer-input,
        #edit_answer {
            padding-bottom: 30px !important;
            min-height: 140px !important;
            /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚é©åˆ‡ãªé«˜ã• */
        }

        .essay-answer-input {
            min-height: 160px !important;
        }
    }

    @media (max-width: 480px) {
        .section-header h3 {
            font-size: 1rem;
        }

        .section-content {
            padding: 15px 10px !important;
        }

        .section-content .upload-form,
        .section-content .add-user-form,
        .section-content .admin-panel {
            padding: 12px !important;
            margin: 8px 0 !important;
        }

        .admin-panel {
            padding: 15px;
        }

        .table {
            font-size: 0.75rem;
        }

        /* å°ç”»é¢ã§ã®æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼èª¿æ•´ */
        .char-counter {
            font-size: 0.7rem;
            padding: 2px 4px;
            bottom: 6px;
            right: 6px;
        }

        .essay-answer-input,
        #edit_answer {
            padding-bottom: 25px !important;
            min-height: 120px !important;
            /* ã‚¹ãƒãƒ›ã§ã‚‚æœ€ä½é™ã®é«˜ã• */
        }

        .essay-answer-input {
            min-height: 140px !important;
        }
    }

    /* ========================================
   9. çŠ¶æ…‹è¡¨ç¤ºã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
   ======================================== */
    .text-success {
        color: #28a745 !important;
    }

    .text-warning {
        color: #ffc107 !important;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .text-info {
        color: #17a2b8 !important;
    }

    .text-muted {
        color: #6c757d !important;
    }

    /* ========================================
   10. ç‰¹æ®Šãªè¡¨ç¤ºè¦ç´ 
   ======================================== */
    .csv-template-section {
        margin-bottom: 25px;
        padding: 15px;
        background-color: #f0f8ff;
        border: 1px solid #87ceeb;
        border-radius: 6px;
        border-left: 4px solid #17a2b8;
    }

    .flashes {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    .flashes li {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid;
    }

    .flashes li.success {
        background-color: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }

    .flashes li.error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
    }

    .flashes li.warning {
        background-color: #fff3cd;
        border-left-color: #ffc107;
        color: #856404;
    }

    .flashes li.info {
        background-color: #d1ecf1;
        border-left-color: #17a2b8;
        color: #0c5460;
    }

    /* ========================================
   11. å˜å…ƒé¸æŠç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .unit-setting-container {
        max-width: 400px;
    }

    .units-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .unit-checkbox {
        margin: 0 !important;
        font-size: 0.9em;
    }

    .unit-checkbox .form-check-input {
        margin-right: 4px;
    }

    .unit-controls .btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .selected-units-display {
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .units-grid {
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 6px;
        }

        .unit-setting-container {
            max-width: 100%;
        }
    }

    /* ========================================
   12. è«–è¿°å•é¡Œç®¡ç†ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .essay-management-controls .form-control {
        font-size: 0.9rem;
    }

    .essay-management-controls label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }

    .template-format {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        margin: 15px 0;
        line-height: 1.6;
    }

    .template-format code {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    #essay-problems-container .table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 0;
    }

    #essay-problems-container .table th {
        background: #ef6c00;
        color: white;
        border: none;
        padding: 12px 8px;
        font-weight: 600;
    }

    #essay-problems-container .table td {
        padding: 10px 8px;
        border-color: #f0f0f0;
        vertical-align: middle;
    }

    #essay-problems-container .table tr:hover {
        background-color: #fff3e0;
    }

    #essay-problems-container .btn-group-vertical .btn {
        margin-bottom: 2px;
        font-size: 0.7rem;
        padding: 2px 6px;
    }

    /* ========================================
   13. è«–è¿°å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .essay-stats-section {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #90caf9;
    }

    .essay-stats-section h4 {
        color: #1565c0;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .csv-import-section {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #81c784;
    }

    .csv-import-section h4 {
        color: #2e7d32;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .csv-template-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .csv-template-section h5 {
        color: #37474f;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .csv-upload-form {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #e0e0e0;
    }

    .upload-area {
        border: 2px dashed #90caf9;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        background: #fafafa;
        transition: all 0.3s ease;
    }

    .upload-area:hover {
        border-color: #42a5f5;
        background: #f0f8ff;
    }

    .file-input-wrapper {
        position: relative;
        margin-bottom: 20px;
    }

    .file-input-label {
        display: block;
        padding: 20px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .file-input-label:hover {
        background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
        transform: translateY(-2px);
    }

    .file-input-label i {
        font-size: 1.5rem;
        margin-bottom: 8px;
        display: block;
    }

    #essay_csv_file {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .upload-options {
        margin: 20px 0;
    }

    .upload-options .form-check {
        background: #fff3e0;
        border: 1px solid #ffcc02;
        border-radius: 6px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-upload {
        background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        border: none;
        padding: 12px 30px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 25px;
        color: white;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        transition: all 0.3s ease;
    }

    .btn-upload:hover {
        background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .essay-form-section {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border: 1px solid #ce93d8;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
    }

    .essay-form-section h4 {
        color: #7b1fa2;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .essay-form-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }

    .essay-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .essay-form-full-width {
        grid-column: 1 / -1;
    }

    .essay-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .essay-input-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .essay-input-group label i {
        color: #6c757d;
        width: 16px;
    }

    .essay-input-group input,
    .essay-input-group select,
    .essay-input-group textarea {
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #fafafa;
        font-family: inherit;
    }

    .essay-input-group input:focus,
    .essay-input-group select:focus,
    .essay-input-group textarea:focus {
        outline: none;
        border-color: #7b1fa2;
        background: white;
        box-shadow: 0 0 0 3px rgba(123, 31, 162, 0.1);
    }

    .essay-question-input,
    .essay-answer-input {
        min-height: 120px !important;
        resize: vertical;
        line-height: 1.6;
    }

    .essay-checkbox-group {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        margin-bottom: 20px;
    }

    .essay-checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin: 0;
        cursor: pointer;
        accent-color: #7b1fa2;
    }

    .essay-checkbox-group label {
        margin: 0;
        font-weight: 500;
        cursor: pointer;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .essay-submit-btn {
        background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
    }

    .essay-submit-btn:hover {
        background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(123, 31, 162, 0.4);
    }

    .essay-submit-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .essay-help-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
        font-style: italic;
    }

    .essay-management-section {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border: 1px solid #ffb74d;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
    }

    .essay-management-section h4 {
        color: #ef6c00;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .essay-filter-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .essay-filter-section label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        display: block;
    }

    .essay-filter-section .form-control {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 12px;
        transition: border-color 0.3s ease;
    }

    .essay-filter-section .form-control:focus {
        border-color: #ef6c00;
        box-shadow: 0 0 0 2px rgba(239, 108, 0, 0.1);
    }

    .essay-stats-summary {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border: 1px solid #ffb74d;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #f57c00;
    }

    /* ========================================
   14. è«–è¿°å•é¡Œä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„
   ======================================== */
    .essay-problem-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .essay-problem-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
        border-color: #ffa726;
    }

    .problem-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .problem-info {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .problem-info .badge {
        font-size: 0.85rem;
        padding: 5px 12px;
        font-weight: 500;
    }

    .badge-chapter {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .badge-type-A {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .badge-type-B {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: #333;
    }

    .badge-type-C {
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        color: white;
    }

    .badge-type-D {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }

    .university-info {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .university-info i {
        color: #ff6b6b;
    }

    .problem-content {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
    }

    .problem-question {
        color: #2c3e50;
        line-height: 1.6;
        margin: 0;
        font-size: 1rem;
    }

    .problem-question strong {
        color: #e67e22;
        font-weight: 600;
    }

    .problem-meta {
        display: flex;
        gap: 20px;
        color: #6c757d;
        font-size: 0.85rem;
        padding-top: 10px;
    }

    .problem-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .problem-meta-item i {
        color: #95a5a6;
    }

    .problem-actions {
        display: flex;
        gap: 5px;
    }

    .problem-actions .btn {
        padding: 6px 12px;
        font-size: 0.85rem;
        border-radius: 5px;
        transition: all 0.3s ease;
    }

    .problem-actions .btn-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }

    .problem-actions .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    .problem-actions .btn-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: white;
    }

    .problem-actions .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        color: white;
    }

    /* ========================================
   15. è«–è¿°å•é¡Œå…¬é–‹è¨­å®šãƒãƒˆãƒªãƒƒã‚¯ã‚¹ - CSS Grid ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰
   ======================================== */
    .visibility-matrix {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 0 !important;
        margin: 15px 0 !important;
    }

    .matrix-header {
        color: #495057;
        font-weight: 600;
        margin-bottom: 20px;
        padding: 20px 20px 0 20px !important;
    }

    .matrix-header h4 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .matrix-header p {
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    .visibility-grid {
        margin: 0 20px 20px 20px !important;
        display: grid !important;
        grid-template-columns: 120px repeat(var(--type-count, 4), 1fr) !important;
        gap: 3px !important;
        background: #fff !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #dee2e6 !important;
    }

    .grid-header {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 15px 8px !important;
        text-align: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 0.9rem !important;
    }

    .grid-cell-chapter {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%) !important;
        color: #495057 !important;
        font-weight: bold !important;
        border: 2px solid #dee2e6 !important;
        padding: 15px 8px !important;
        text-align: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        font-size: 0.9rem !important;
        min-height: 60px !important;
    }

    .grid-cell-chapter:hover {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border-color: #28a745 !important;
        transform: scale(1.02) !important;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3) !important;
    }

    .grid-cell-setting {
        background: #fff !important;
        border: 2px solid #dee2e6 !important;
        min-height: 60px !important;
        max-height: 60px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 4px !important;
        position: relative !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
    }

    .grid-cell-setting .setting-icon {
        font-size: 1.3em !important;
        line-height: 1 !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        width: auto !important;
        height: auto !important;
    }

    .grid-cell-setting .setting-text {
        font-size: 0.8em !important;
        font-weight: 600 !important;
        line-height: 1 !important;
        white-space: nowrap !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        text-align: center !important;
    }

    .grid-cell-setting.visible {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border-color: #28a745 !important;
    }

    .grid-cell-setting.visible .setting-icon,
    .grid-cell-setting.visible .setting-text {
        color: #28a745 !important;
    }

    .grid-cell-setting.hidden {
        background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%) !important;
        border-color: #dc3545 !important;
    }

    .grid-cell-setting.hidden .setting-icon,
    .grid-cell-setting.hidden .setting-text {
        color: #dc3545 !important;
    }

    .grid-cell-setting:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        z-index: 10 !important;
    }

    .save-section {
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin: 0 20px 20px 20px !important;
    }

    /* ========================================
   16. è«–è¿°å•é¡Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç”»åƒç®¡ç†ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .image-management-section {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
        margin-top: 10px;
    }

    .image-preview {
        text-align: center;
        margin-bottom: 10px;
    }

    .image-actions {
        text-align: center;
    }

    .image-actions .btn {
        margin: 0 5px;
    }

    .no-image-section {
        text-align: center;
        padding: 20px;
    }

    .image-upload-section {
        border-top: 1px solid #ddd;
        padding-top: 15px;
        margin-top: 15px;
    }

    .image-upload-section .form-group {
        margin-bottom: 10px;
    }

    /* ========================================
   17. ãƒãƒƒã‚¸ã¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .bg-success {
        background-color: #28a745 !important;
    }

    .bg-secondary {
        background-color: #6c757d !important;
    }

    .bg-primary {
        background-color: #007bff !important;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        margin: 0 2px;
    }

    .btn-outline-primary {
        border-color: #007bff;
        color: #007bff;
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }

    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }

    th[style*="cursor: pointer"] {
        user-select: none;
        background-color: #495057 !important;
    }

    th[style*="cursor: pointer"]:hover {
        background-color: #6c757d !important;
    }

    /* ========================================
   18. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆè«–è¿°å•é¡Œãƒ»å…¬é–‹è¨­å®šï¼‰
   ======================================== */
    @media (max-width: 768px) {
        .essay-form-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .image-preview img {
            max-height: 200px;
        }

        .image-actions .btn {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            margin-left: 0;
            margin-right: 0;
        }

        .image-management-section {
            padding: 10px;
        }

        .visibility-grid {
            grid-template-columns: 100px repeat(var(--type-count, 4), 1fr) !important;
            gap: 2px !important;
            font-size: 0.8em;
            margin: 0 15px 15px 15px !important;
        }

        .grid-cell-setting {
            min-height: 50px !important;
            max-height: 50px !important;
            gap: 2px !important;
        }

        .grid-cell-setting .setting-icon {
            font-size: 1.1em !important;
        }

        .grid-cell-setting .setting-text {
            font-size: 0.7em !important;
        }

        .grid-cell-chapter {
            padding: 10px 4px !important;
            font-size: 0.8rem !important;
            min-height: 50px !important;
        }

        .matrix-header {
            padding: 15px 15px 0 15px !important;
        }

        .save-section {
            margin: 0 15px 15px 15px !important;
        }
    }

    @media (max-width: 480px) {

        .essay-form-container,
        .csv-upload-form {
            padding: 12px;
        }

        .essay-input-group input,
        .essay-input-group select,
        .essay-input-group textarea {
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .essay-submit-btn,
        .btn-upload {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        .upload-area {
            padding: 15px;
        }

        .file-input-label i {
            font-size: 1.2rem;
        }

        .table-responsive {
            font-size: 0.8rem;
        }

        .table th,
        .table td {
            padding: 6px 4px;
            white-space: nowrap;
        }

        .visibility-grid {
            margin: 0 10px 10px 10px !important;
        }

        .matrix-header {
            padding: 10px 10px 0 10px !important;
        }

        .save-section {
            margin: 0 10px 10px 10px !important;
            padding: 15px;
        }
    }

    /* ========================================
   19. ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
   ======================================== */
    .debug-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 300px;
        z-index: 9999;
        display: none;
    }

    /* ========================================
   20. æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰
   ======================================== */

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆæ¨ªå¹…ãƒ•ãƒ«æ´»ç”¨ï¼‰ */
    .textarea-wrapper {
        position: relative;
        display: block;
        width: 100% !important;
        /* â˜…é‡è¦ï¼šæ¨ªå¹…ã‚’100%ã«è¨­å®š */
    }

    /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆå³ä¸‹è§’ã«å›ºå®šé…ç½®ï¼‰ */
    .char-counter {
        position: absolute;
        bottom: 8px !important;
        /* â˜…é‡è¦ï¼šä¸‹ç«¯ã‹ã‚‰8px */
        right: 8px !important;
        /* â˜…é‡è¦ï¼šå³ç«¯ã‹ã‚‰8px */
        background: rgba(255, 255, 255, 0.95);
        color: #6c757d;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        pointer-events: none;
        z-index: 10;
        font-family: monospace;
        white-space: nowrap;
        transition: all 0.3s ease;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªä½“ã‚‚æ¨ªå¹…ãƒ•ãƒ«æ´»ç”¨ */
    .textarea-wrapper textarea {
        width: 100% !important;
        /* â˜…é‡è¦ï¼šæ¨ªå¹…ã‚’100%ã«è¨­å®š */
        box-sizing: border-box !important;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¼·èª¿ */
    .textarea-wrapper textarea:focus+.char-counter {
        background: rgba(123, 31, 162, 0.1);
        color: #7b1fa2;
        border-color: #7b1fa2;
        transform: translateY(-2px);
    }

    /* æ–‡å­—æ•°ã«å¿œã˜ãŸè‰²å¤‰æ›´ */
    .char-counter.warning {
        background: rgba(255, 193, 7, 0.1);
        color: #856404;
        border-color: #ffc107;
    }

    .char-counter.danger {
        background: rgba(220, 53, 69, 0.1);
        color: #721c24;
        border-color: #dc3545;
    }
</style>
<!-- ã‚¹ã‚³ã‚¢å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteScoreModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i>ã‚¹ã‚³ã‚¢å‰Šé™¤ã®ç¢ºèª</h5><button type="button"
                    class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ä»¥ä¸‹ã®å¯¾è±¡ã®<strong>å…¨ã¦ã®å­¦ç¿’å±¥æ­´ã¨ã‚¹ã‚³ã‚¢</strong>ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                <div class="alert alert-warning"><strong>å¯¾è±¡:</strong><span id="deleteScoreTargetName"></span></div>
                <p class="text-danger small">â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚</p>
                <form id="deleteScoreForm"><input type="hidden" id="deleteScoreType" name="type">
                    < !-- user or room --><input type="hidden" id="deleteScoreTargetId" name="target_id">
                        <div class="mb-3"><label for="deleteScoreAdminPassword"
                                class="form-label">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label><input type="password" class="form-control"
                                id="deleteScoreAdminPassword" required></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button type="button" class="btn btn-warning"
                    onclick="executeDeleteScore()"><i class="fas fa-eraser"></i>å‰Šé™¤å®Ÿè¡Œ </button></div>
        </div>
    </div>
</div>
<script> // ã‚¹ã‚³ã‚¢å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡

    document.addEventListener('DOMContentLoaded', function () {
        // å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚³ã‚¢å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteScoreBtns = document.querySelectorAll('.delete-score-btn');

        deleteScoreBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const userId = this.dataset.userId;
                const username = this.dataset.username;

                showDeleteScoreModal('user', userId, `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${username}`);
            });
        });
    });

    // éƒ¨å±‹ã®ã‚¹ã‚³ã‚¢å‰Šé™¤ç¢ºèªï¼ˆonclickå±æ€§ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    function confirmDeleteRoomScore(event, roomNumber) {
        if (event) event.preventDefault();
        showDeleteScoreModal('room', roomNumber, `éƒ¨å±‹: ${roomNumber} ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼`);
    }

    function showDeleteScoreModal(type, id, name) {
        document.getElementById('deleteScoreType').value = type;
        document.getElementById('deleteScoreTargetId').value = id;
        document.getElementById('deleteScoreTargetName').textContent = name;
        document.getElementById('deleteScoreAdminPassword').value = '';

        let modal = bootstrap.Modal.getInstance(document.getElementById('deleteScoreModal'));
        if (!modal) {
            modal = new bootstrap.Modal(document.getElementById('deleteScoreModal'));
        }
        modal.show();
    }

    function executeDeleteScore() {
        const type = document.getElementById('deleteScoreType').value;
        const id = document.getElementById('deleteScoreTargetId').value;
        const password = document.getElementById('deleteScoreAdminPassword').value;

        if (!password) {
            alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const endpoint = type === 'user' ? '/admin/delete_user_score' : '/admin/delete_room_score';
        const data = new FormData();
        data.append('admin_password', password);

        if (type === 'user') {
            data.append('user_id', id);
        }

        else {
            data.append('room_number', id);
        }

        fetch(endpoint, {
            method: 'POST',
            body: data

        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                alert(data.message);
                location.reload();
            }

            else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
            }

        }).catch(error => {
            console.error('Error:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
    }

</script>
<style>
    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ä¸‹éƒ¨ä½™ç™½ç¢ºä¿ã¨é«˜ã•èª¿æ•´ */
    .essay-answer-input,
    #edit_answer {
        padding-bottom: 35px !important;
        resize: vertical;
        min-height: 150px !important;
        width: 100% !important;
        /* â˜…é‡è¦ï¼šæ¨ªå¹…ãƒ•ãƒ«æ´»ç”¨ */
        box-sizing: border-box !important;
    }

    /* æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆã‚ˆã‚Šå¤§ããï¼‰ */
    .essay-answer-input {
        min-height: 180px !important;
    }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    #edit_answer {
        min-height: 160px !important;
    }

    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãï¼ˆæ¨ªå¹…ãƒ•ãƒ«æ´»ç”¨ï¼‰ */
    .essay-question-input,
    .essay-answer-input {
        min-height: 120px !important;
        resize: vertical;
        line-height: 1.6;
        width: 100% !important;
        /* â˜…é‡è¦ï¼šæ¨ªå¹…ãƒ•ãƒ«æ´»ç”¨ */
        box-sizing: border-box !important;
    }

    /* æ¨¡ç¯„è§£ç­”å…¥åŠ›æ¬„ã®ã¿é«˜ã•ã‚’å¤§ãã */
    .essay-answer-input {
        min-height: 180px !important;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã§ã®èª¿æ•´ */
    @media (max-width: 768px) {
        .char-counter {
            font-size: 0.75rem;
            padding: 3px 6px;
            bottom: 6px !important;
            right: 6px !important;
        }

        .essay-answer-input,
        #edit_answer {
            padding-bottom: 30px !important;
            min-height: 140px !important;
        }

        .essay-answer-input {
            min-height: 160px !important;
        }
    }

    @media (max-width: 480px) {
        .char-counter {
            font-size: 0.7rem;
            padding: 2px 4px;
            bottom: 4px !important;
            right: 4px !important;
        }

        .essay-answer-input,
        #edit_answer {
            padding-bottom: 25px !important;
            min-height: 120px !important;
        }

        .essay-answer-input {
            min-height: 140px !important;
        }
    }
</style>

<script>
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ï¼ˆæ¨å®šæ™‚é–“è¨ˆç®—ï¼‰
    function prepareUserUpload() {
        const fileInput = document.getElementById('users_csv_file');
        if (!fileInput.files.length) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ã
            const userCount = Math.max(0, lines.length - 1);

            if (userCount === 0) {
                alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            // æ¨å®šæ™‚é–“è¨ˆç®— (1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šç´„0.08ç§’ + ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰)
            // 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§16ç§’ã ã£ãŸã®ã§ã€0.16ç§’/ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¦‹ç©ã‚‚ã‚‹ï¼ˆå®‰å…¨ãƒãƒ¼ã‚¸ãƒ³è¾¼ã¿ï¼‰
            const estimatedSeconds = Math.ceil(userCount * 0.16);
            let timeString = '';
            if (estimatedSeconds < 60) {
                timeString = `ç´„ ${estimatedSeconds} ç§’`;
            } else {
                const minutes = Math.floor(estimatedSeconds / 60);
                const seconds = estimatedSeconds % 60;
                timeString = `ç´„ ${minutes} åˆ† ${seconds} ç§’`;
            }

            document.getElementById('confirmFileName').textContent = file.name;
            document.getElementById('confirmUserCount').textContent = userCount;
            document.getElementById('confirmTimeEstimate').textContent = timeString;

            let modal = bootstrap.Modal.getInstance(document.getElementById('uploadConfirmModal'));
            if (!modal) {
                modal = new bootstrap.Modal(document.getElementById('uploadConfirmModal'));
            }
            modal.show();
        };

        reader.readAsText(file);
    }

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
    function startUserUpload() {
        const fileInput = document.getElementById('users_csv_file');
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modalEl = document.getElementById('uploadConfirmModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        // é€²æ—ãƒãƒ¼è¡¨ç¤º
        document.getElementById('uploadProgressContainer').style.display = 'block';
        document.getElementById('uploadProgressBar').style.width = '0%';
        document.getElementById('uploadProgressBar').textContent = '0%';
        document.getElementById('uploadStatusMessage').textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        // AJAXé€ä¿¡
        fetch("{{ url_for('admin_upload_users') }}?json=true", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
                    pollRegistrationStatus();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                document.getElementById('uploadProgressContainer').style.display = 'none';
            });
    }

    // é€²æ—ãƒãƒ¼ãƒªãƒ³ã‚°
    function pollRegistrationStatus() {
        fetch("{{ url_for('get_registration_status') }}")
            .then(response => response.json())
            .then(status => {
                if (status.is_processing) {
                    const percent = Math.round((status.current / status.total) * 100);
                    const progressBar = document.getElementById('uploadProgressBar');
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    progressBar.setAttribute('aria-valuenow', percent);

                    document.getElementById('uploadStatusMessage').textContent = status.message;

                    // 1ç§’å¾Œã«å†ç¢ºèª
                    setTimeout(pollRegistrationStatus, 1000);
                } else if (status.completed) {
                    // å®Œäº†
                    document.getElementById('uploadProgressBar').style.width = '100%';
                    document.getElementById('uploadProgressBar').textContent = '100%';
                    document.getElementById('uploadProgressBar').classList.remove('progress-bar-animated');
                    document.getElementById('uploadProgressBar').classList.add('bg-success');
                    document.getElementById('uploadStatusMessage').textContent = status.message;

                    alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n' + status.message);
                    location.reload(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ä¸€è¦§æ›´æ–°
                }
            })
            .catch(error => {
                console.error('Polling Error:', error);
            });
    }
</script>
{% endblock %}