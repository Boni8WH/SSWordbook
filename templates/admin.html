{% extends "base.html" %}
{% block title %}管理者ページ - {{ app_name }}{% endblock %}

{% block content %}
<style>
    /* Admin Sidebar Layout Styles */
    :root {
        --sidebar-width: 280px;
    }

    .sidebar-wrapper {
        width: var(--sidebar-width);
        min-height: 100vh;
        background-color: #343a40;
        color: #fff;
        /* Sticky Sidebar */
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
        flex-shrink: 0;
        /* Prevent shrinking */
        transition: margin 0.3s;
    }

    .main-content-wrapper {
        flex-grow: 1;
        min-width: 0;
        /* Prevent flex overflow */
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    .sidebar-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 12px 20px;
        display: block;
        text-decoration: none;
        border-left: 4px solid transparent;
        transition: all 0.3s;
    }

    .sidebar-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        text-decoration: none;
    }

    .sidebar-link.active {
        background-color: rgba(255, 255, 255, 0.2);
        border-left-color: #3498db;
        color: #fff;
    }

    .sidebar-heading {
        padding: 20px 20px 10px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.5);
    }

    .tab-pane {
        padding: 0;
        width: 100%;
    }

    .tab-pane .card {
        width: 100%;
        max-width: none;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .sidebar-wrapper {
            position: fixed;
            z-index: 1000;
            left: -100%;
            height: 100%;
            width: 80%;
            max-width: 300px;
            transition: left 0.3s ease;
        }

        .sidebar-wrapper.show {
            left: 0;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Extra small screens header adjustments */
        .admin-header-wrapper {
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-header-wrapper h2 {
            font-size: 1.3rem;
            width: 100%;
        }

        /* Manager auth form responsive */
        .admin-auth-form .row {
            flex-direction: column;
            gap: 8px;
        }

        .admin-auth-form .col-auto {
            width: 100%;
        }

        .admin-auth-form input,
        .admin-auth-form button {
            width: 100%;
        }
    }

    /* Extra small screen optimizations (576px and below) */
    @media (max-width: 576px) {

        /* Page header adjustments */
        .page-header-flex {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 10px;
        }

        .page-header-flex>div {
            width: 100%;
        }

        .page-header-flex .badge {
            display: block;
            margin-bottom: 5px;
        }

        .page-header-flex .btn {
            width: 100%;
        }

        /* User table action buttons - stack vertically */
        .user-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-action-buttons .btn {
            width: 100%;
            font-size: 0.7rem;
            padding: 4px 6px;
            white-space: nowrap;
        }

        /* Room settings operation buttons */
        .btn-group-vertical.btn-group-sm {
            width: 100%;
        }

        .btn-group-vertical.btn-group-sm .btn {
            font-size: 0.65rem;
            padding: 5px 4px;
        }

        /* Stats/Database button groups - stack vertically */
        .stats-button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stats-button-group .btn {
            margin-left: 0 !important;
            width: 100%;
        }

        /* Form input groups */
        .input-group-responsive {
            flex-direction: column;
        }

        .input-group-responsive .col-md-6 {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Touch-friendly grid cells */
        .grid-cell-setting,
        .grid-cell-chapter {
            min-height: 48px !important;
        }

        /* Announcement table compact */
        .announcement-table td,
        .announcement-table th {
            padding: 6px 4px;
            font-size: 0.75rem;
        }

        /* RPG form responsive */
        .rpg-form-row .col-md-3,
        .rpg-form-row .col-md-4,
        .rpg-form-row .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        /* Essay filter responsive */
        .essay-filter-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 10px;
        }

        .essay-filter-row .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        /* Card and panel padding reduction */
        .card-body {
            padding: 12px;
        }

        .admin-panel {
            padding: 12px !important;
        }

        /* Compact badges for mobile */
        .badge {
            font-size: 0.65rem;
            padding: 3px 6px;
        }

        /* ----------------------------------------------------
           Mobile Layout Fixes (Max Width 576px) - UPDATED
           ---------------------------------------------------- */

        /* 1. Global Safe Width */
        body,
        html {
            overflow-x: hidden;
        }

        .main-content-wrapper {
            width: 100% !important;
            padding: 10px !important;
            overflow-x: hidden !important;
        }

        /* 2. Fix Panel Overflows */
        .admin-panel,
        .csv-import-section,
        .csv-template-section,
        .card,
        .card-body {
            width: 100% !important;
            min-width: 0 !important;
            max-width: 100% !important;
            padding: 10px !important;
            box-sizing: border-box !important;
        }

        /* 3. Room Settings Table -> Mobile Card View */
        .room-setting-table {
            min-width: 0 !important;
            /* Override inline style */
            display: block !important;
            width: 100% !important;
        }

        .room-setting-table thead {
            display: none !important;
        }

        .room-setting-table tbody,
        .room-setting-table tr,
        .room-setting-table td {
            display: block !important;
            width: 100% !important;
        }

        .room-setting-table tr {
            margin-bottom: 20px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }

        .room-setting-table td {
            text-align: left;
            padding: 8px 0;
            border: none;
            border-bottom: 1px dashed #eee;
        }

        .room-setting-table td:last-child {
            border-bottom: none;
        }

        .room-setting-table td:first-child::before {
            content: "部屋番号: ";
            font-weight: bold;
            color: #555;
            display: inline-block;
            margin-right: 5px;
        }

        /* 4. Unit Setting Container Buttons */
        .unit-setting-container {
            max-width: 100% !important;
        }

        .unit-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .unit-controls button {
            width: 100%;
            margin: 0 !important;
        }

        /* 5. Fix CSV Section Code Blocks & Buttons */
        .csv-template-section pre,
        .csv-template-section code {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            word-break: break-all !important;
            max-width: 100% !important;
            display: block;
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        /* Buttons stack */
        .csv-template-section .btn-group,
        .csv-template-section .d-flex,
        .csv-import-section .d-flex {
            flex-direction: column !important;
            width: 100% !important;
            gap: 10px !important;
        }

        .csv-template-section .btn,
        .csv-import-section .btn,
        .csv-template-section a.btn {
            width: 100% !important;
            display: block;
            margin: 0 !important;
            white-space: normal !important;
        }

        /* 6. General Elements */
        input,
        select,
        textarea {
            max-width: 100% !important;
        }

        .btn-outline-primary+.btn-outline-primary {
            margin-left: 0 !important;
            margin-top: 5px;
        }

        /* Panel header adjust */
        .admin-panel h4,
        .csv-import-section h4 {
            font-size: 1rem;
            flex-wrap: wrap;
        }

        /* Fix CSVフォーマット code block */
        .csv-template-section pre,
        .csv-template-section code {
            display: block;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 0.7rem;
            line-height: 1.4;
        }

        /* Form elements full width */
        .csv-template-section input,
        .csv-template-section select,
        .csv-import-section input,
        .csv-import-section select {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Ul/li adjustments */
        .csv-template-section ul,
        .csv-import-section ul {
            padding-left: 15px;
            font-size: 0.8rem;
        }

        .csv-template-section li,
        .csv-import-section li {
            margin-bottom: 4px;
            line-height: 1.4;
        }
    }

    /* Hide Base Header/Footer for Admin Sidebar Layout */
    nav.navbar,
    footer.footer {
        display: none !important;
    }

    /* Remove top margin from base container since header is gone */
    body>.container.mt-4 {
        margin-top: 0 !important;
        max-width: none;
        padding: 0;
    }
</style>

</div> <!-- Close Base Container -->

<div class="d-flex w-100">
    <!-- Overlay for mobile sidebar -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar-wrapper d-flex flex-column" id="adminSidebar">
        <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
            <span class="fw-bold fs-5">管理メニュー</span>
            <button class="btn btn-sm btn-outline-light d-md-none" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="nav flex-column nav-pills mt-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            {% if not is_manager %}
            <a class="sidebar-link active" id="tab-link-app-info" data-bs-toggle="pill" href="#section-app-info"
                role="tab">
                <i class="fas fa-mobile-alt me-2"></i> アプリ情報
            </a>
            {% endif %}

            <a class="sidebar-link {% if is_manager %}active{% endif %}" id="tab-link-announcements"
                data-bs-toggle="pill" href="#section-announcements" role="tab">
                <i class="fas fa-bullhorn me-2"></i> お知らせ
            </a>

            {% if not is_manager %}
            <a class="sidebar-link" id="tab-link-user-management" data-bs-toggle="pill" href="#section-user-management"
                role="tab">
                <i class="fas fa-users me-2"></i> ユーザー管理
            </a>
            {% endif %}

            <a class="sidebar-link" id="tab-link-csv-management" data-bs-toggle="pill" href="#section-csv-management"
                role="tab">
                <i class="fas fa-file-csv me-2"></i> 問題CSV管理
            </a>

            <a class="sidebar-link" id="tab-link-room-settings" data-bs-toggle="pill" href="#section-room-settings"
                role="tab">
                <i class="fas fa-cogs me-2"></i> 部屋設定
            </a>

            {% if not is_manager %}
            <a class="sidebar-link" id="tab-link-rpg-management" data-bs-toggle="pill" href="#section-rpg-management"
                role="tab">
                <i class="fas fa-gamepad me-2"></i> RPG敵キャラ
            </a>

            <a class="sidebar-link" id="tab-link-essay-visibility" data-bs-toggle="pill"
                href="#section-essay-visibility" role="tab">
                <i class="fas fa-eye me-2"></i> 論述公開設定
            </a>

            <a class="sidebar-link" id="tab-link-essay-management" data-bs-toggle="pill"
                href="#section-essay-management" role="tab">
                <i class="fas fa-book me-2"></i> 論述問題集
            </a>

            <a class="sidebar-link" id="tab-link-user-stats" data-bs-toggle="pill" href="#section-user-stats"
                role="tab">
                <i class="fas fa-chart-bar me-2"></i> ユーザー統計
            </a>
            {% endif %}

            {% if not is_manager %}
            <div class="sidebar-heading">システム</div>
            <a class="sidebar-link" id="tab-link-database-management" data-bs-toggle="pill"
                href="#section-database-management" role="tab">
                <i class="fas fa-database me-2"></i> データベース
            </a>
            {% endif %}

            <div class="mt-auto p-3 border-top border-secondary">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light w-100 btn-sm mb-2">
                    <i class="fas fa-home me-1"></i> ホームへ
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger w-100 btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> ログアウト
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-wrapper">
        <!-- Mobile Header -->
        <div class="d-md-none bg-dark text-white p-3 d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold">管理者ページ</span>
            <button class="btn btn-outline-light btn-sm" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i> メニュー
            </button>
        </div>

        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-4 page-header-flex flex-wrap">
                <h2>管理者ページ</h2>
                <div>
                    {% if is_manager %}
                    <div class="badge bg-info text-dark me-2">
                        <i class="fas fa-user-tie"></i> 担当者: {{ manager_auth_rooms|join(', ') if manager_auth_rooms
                        else '未認証' }}
                    </div>
                    {% endif %}
                    <a href="{{ url_for('admin_ranking_page') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-trophy"></i> 全員ランキング
                    </a>
                </div>
            </div>

            {% if is_manager %}
            <div class="alert alert-info border-info mb-4 admin-auth-form">
                <form action="{{ url_for('admin_verify_room_password') }}" method="POST"
                    class="row g-2 align-items-center">
                    <div class="col-auto">
                        <label for="authRoomPassword" class="col-form-label"><strong>部屋認証追加:</strong></label>
                    </div>
                    <div class="col-auto">
                        <input type="password" id="authRoomPassword" name="room_password"
                            class="form-control form-control-sm" placeholder="パスワード" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-key"></i></button>
                    </div>
                </form>
            </div>
            {% endif %}

            <div class="tab-content" id="v-pills-tabContent">

                <!-- App Info Section (Transplanted) -->
                {% if not is_manager %}
                <div class="tab-pane fade show active" id="section-app-info" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-mobile-alt"></i> アプリ情報管理</h3>
                        </div>
                        <div class="card-body">
                            <form id="appInfoForm" action="{{ url_for('admin_app_info') }}" method="POST"
                                enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">ロゴ設定:</label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="logo_type"
                                                    id="logo_type_text" value="text" {% if app_info.logo_type=='text' or
                                                    not app_info.logo_type %}checked{% endif %}>
                                                <label class="form-check-label" for="logo_type_text">テキスト</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="logo_type"
                                                    id="logo_type_image" value="image" {% if app_info.logo_type=='image'
                                                    %}checked{% endif %}>
                                                <label class="form-check-label" for="logo_type_image">画像</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6" id="app_name_field">
                                        <div class="mb-3">
                                            <label for="app_name" class="form-label">アプリ名:</label>
                                            <input type="text" id="app_name" name="app_name" class="form-control"
                                                value="{{ app_info.app_name }}" required placeholder="例: 世界史単語帳">
                                        </div>
                                    </div>
                                    <div class="col-md-6" id="logo_image_field" style="display: none;">
                                        <div class="mb-3">
                                            <label for="logo_image" class="form-label">ロゴ画像:</label>
                                            <input type="file" id="logo_image" name="logo_image" class="form-control"
                                                accept="image/*">
                                            {% if app_info.logo_image_filename %}
                                            <div class="mt-2">
                                                <img src="{{ get_logo_url(app_info.logo_image_filename) }}"
                                                    style="max-height: 40px;" class="border p-1 rounded">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="version" class="form-label">バージョン:</label>
                                            <input type="text" id="version" name="version" class="form-control"
                                                value="{{ app_info.version }}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="contact_email" class="form-label">連絡先メール:</label>
                                            <input type="email" id="contact_email" name="contact_email"
                                                class="form-control" value="{{ app_info.contact_email }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="school_name" class="form-label">ハッシュタグ:</label>
                                            <input type="text" id="school_name" name="school_name" class="form-control"
                                                value="{{ app_info.school_name }}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="footer_text" class="form-label">フッターテキスト:</label>
                                    <input type="text" id="footer_text" name="footer_text" class="form-control"
                                        value="{{ app_info.footer_text }}">
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" id="saveAppInfoBtn">
                                        <i class="fas fa-save"></i> 保存
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="tab-pane fade" id="section-announcements" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-bullhorn"></i> お知らせ管理</h3>
                        </div>
                        <div class="card-body">
                            <p>ユーザーにお知らせを配信できます。最新5件が「i」ボタンの情報パネルに表示されます。</p>

                            <!-- 新規お知らせ作成 -->
                            <div class="admin-panel"
                                style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                                <h4><i class="fas fa-plus"></i> 新規お知らせ作成</h4>
                                <form action="{{ url_for('admin_add_announcement') }}" method="POST">
                                    <div class="mb-3">
                                        <label for="announcementTitle" class="form-label">タイトル</label>
                                        <input type="text" class="form-control" id="announcementTitle" name="title"
                                            required placeholder="例: メンテナンスのお知らせ">
                                    </div>
                                    <div class="mb-3">
                                        <label for="announcementContent" class="form-label">内容</label>
                                        <textarea class="form-control" id="announcementContent" name="content" rows="3"
                                            required placeholder="お知らせの詳細を入力してください"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="announcementTarget" class="form-label">対象部屋（複数選択可）</label>
                                        <input type="text" id="roomSearchInput" class="form-control mb-2"
                                            placeholder="部屋番号を検索..." onkeyup="filterRooms()"
                                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }">
                                        <select class="form-select" id="announcementTarget" name="target_rooms" multiple
                                            size="5" required>
                                            <option value="all" selected>全員 (All)</option>
                                            {% for room in room_settings %}
                                            <option value="{{ room.room_number }}">{{ room.room_number }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">Ctrl(Windows)またはCommand(Mac)を押しながらクリックで複数選択できます。
                                        </div>
                                    </div>
                                    <script>
                                        function filterRooms() {
                                            var input, filter, select, options, i, txtValue;
                                            input = document.getElementById("roomSearchInput");
                                            filter = input.value.toUpperCase();
                                            select = document.getElementById("announcementTarget");
                                            options = select.getElementsByTagName("option");
                                            for (i = 0; i < options.length; i++) {
                                                txtValue = options[i].textContent || options[i].innerText;
                                                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                                    options[i].style.display = "";
                                                } else {
                                                    options[i].style.display = "none";
                                                }
                                            }
                                        }
                                    </script>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="newAnnNotification"
                                            name="send_notification" checked>
                                        <label class="form-check-label" for="newAnnNotification">
                                            <i class="fas fa-bell"></i> 通知を送る
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-paper-plane"></i> お知らせを配信
                                    </button>
                                </form>
                            </div>

                            <!-- お知らせ一覧 -->
                            <h4>配信済みお知らせ一覧</h4>
                            <div class="table-responsive">

                                <table class="table table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>日付 / 更新</th>
                                            <th>タイトル</th>
                                            <th>対象</th>
                                            <th>状態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ann in announcements %}
                                        <tr>
                                            <td>
                                                {{ ann.date | to_jst }}
                                                {% if ann.updated_at %}
                                                <br><small class="text-muted"><i class="fas fa-sync-alt"></i> {{
                                                    ann.updated_at | to_jst }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ ann.title }}</td>
                                            <td>
                                                {% if ann.target_rooms == 'all' %}
                                                <span class="badge bg-success">全員</span>
                                                {% else %}
                                                <span class="badge bg-info">{{ ann.target_rooms }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if ann.is_active %}
                                                <span class="badge bg-primary">有効</span>
                                                {% else %}
                                                <span class="badge bg-secondary">無効</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button
                                                    class="btn btn-sm btn-outline-primary me-1 btn-edit-announcement"
                                                    data-announcement='{{ ann.to_dict() | tojson | safe }}'>
                                                    <i class="fas fa-edit"></i> 編集
                                                </button>
                                                <form action="{{ url_for('admin_delete_announcement', id=ann.id) }}"
                                                    method="POST" style="display: inline;"
                                                    class="delete-announcement-form">
                                                    <button type="button" class="btn btn-sm btn-danger"
                                                        onclick="confirmDeleteAnnouncement(this)">削除</button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center">お知らせはありません</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Announcement Modal -->
                <div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="editAnnouncementForm" method="POST">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="fas fa-edit"></i> お知らせ編集</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="editAnnTitle" class="form-label">タイトル</label>
                                        <input type="text" class="form-control" id="editAnnTitle" name="title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editAnnContent" class="form-label">内容</label>
                                        <textarea class="form-control" id="editAnnContent" name="content" rows="4"
                                            required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editAnnTarget" class="form-label">対象部屋</label>
                                        <input type="text" id="editRoomSearchInput" class="form-control mb-2"
                                            placeholder="部屋番号を検索..." onkeyup="filterEditRooms()"
                                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }">
                                        <select class="form-select" id="editAnnTarget" name="target_rooms" multiple
                                            size="5" required>
                                            <option value="all">全員 (All)</option>
                                            {% for room in room_settings %}
                                            <option value="{{ room.room_number }}">{{ room.room_number }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">PC: Ctrl/Cmd+クリックで複数選択</div>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="editAnnActive"
                                            name="is_active">
                                        <label class="form-check-label" for="editAnnActive">有効（ユーザーに表示）</label>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="editAnnNotification"
                                            name="send_notification">
                                        <label class="form-check-label" for="editAnnNotification">
                                            <i class="fas fa-bell"></i> 更新通知を送る
                                        </label>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">キャンセル</button>
                                    <button type="submit" class="btn btn-primary">更新する</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                    function filterEditRooms() {
                        var input, filter, select, options, i, txtValue;
                        input = document.getElementById("editRoomSearchInput");
                        filter = input.value.toUpperCase();
                        select = document.getElementById("editAnnTarget");
                        options = select.getElementsByTagName("option");
                        for (i = 0; i < options.length; i++) {
                            txtValue = options[i].textContent || options[i].innerText;
                            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                options[i].style.display = "";
                            } else {
                                options[i].style.display = "none";
                            }
                        }
                    }

                    function openEditAnnouncementModal(id, data) {
                        var form = document.getElementById('editAnnouncementForm');
                        form.action = '/admin/announcements/edit/' + id;

                        document.getElementById('editAnnTitle').value = data.title;
                        document.getElementById('editAnnContent').value = data.content;
                        document.getElementById('editAnnActive').checked = data.is_active;
                        document.getElementById('editAnnNotification').checked = false; // Default off

                        // Select target rooms
                        var select = document.getElementById('editAnnTarget');
                        var targets = [];
                        if (data.target_rooms) {
                            targets = data.target_rooms.split(',');
                        }

                        for (var i = 0; i < select.options.length; i++) {
                            var opt = select.options[i];
                            if (data.target_rooms === 'all' && opt.value === 'all') {
                                opt.selected = true;
                            } else if (targets.includes(opt.value)) {
                                opt.selected = true;
                            } else {
                                opt.selected = false;
                            }
                        }

                        var modal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
                        modal.show();
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        var editButtons = document.querySelectorAll('.btn-edit-announcement');
                        editButtons.forEach(function (btn) {
                            btn.addEventListener('click', function () {
                                var data = JSON.parse(this.getAttribute('data-announcement'));
                                openEditAnnouncementModal(data.id, data);
                            });
                        });
                    });
                </script>

                <!-- ユーザー管理セクション (Super Admin Only) -->
                {% if not is_manager %}
                <div class="tab-pane fade" id="section-user-management" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-users"></i> ユーザー管理</h3>
                        </div>
                        <div class="card-body">
                            <p>登録済みユーザー: {{ users|length }}人</p>

                            <h4>CSV一括ユーザー追加</h4>
                            <div
                                style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                                <p><strong>CSVファイル形式要件:</strong></p>
                                <ul>
                                    <li>ヘッダー行: 部屋番号,入室パスワード,出席番号,個別パスワード,アカウント名</li>
                                    <li>文字エンコーディング: UTF-8</li>
                                    <li>例: 101,password123,001,student001,成富兵庫茂安</li>
                                    <li>同一アカウント名の登録も可能です（同一人物が複数部屋に参加する場合）</li>
                                </ul>
                                <a href="{{ url_for('download_users_template_csv') }}"
                                    class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-download"></i> テンプレートをダウンロード
                                </a>
                            </div>

                            <form id="userUploadForm" enctype="multipart/form-data" class="upload-form">
                                <div class="input-group">
                                    <label for="users_csv_file">ユーザーCSVファイルを選択:</label>
                                    <input type="file" id="users_csv_file" name="file" accept=".csv" required>
                                </div>
                                <button type="button" class="btn btn-success" onclick="prepareUserUpload()">
                                    <i class="fas fa-upload"></i> CSV一括ユーザー追加
                                </button>
                            </form>

                            <!-- 進捗バー -->
                            <div id="uploadProgressContainer" style="display: none; margin-top: 20px;">
                                <h5><i class="fas fa-spinner fa-spin"></i> ユーザー登録処理中...</h5>
                                <div class="progress" style="height: 25px;">
                                    <div id="uploadProgressBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                        aria-valuemax="100">0%</div>
                                </div>
                                <p id="uploadStatusMessage" class="text-muted mt-2">準備中...</p>
                            </div>

                            <!-- 確認モーダル -->
                            <div class="modal fade" id="uploadConfirmModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">ユーザー一括登録の確認</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>以下の内容で登録を開始しますか？</p>
                                            <ul>
                                                <li><strong>対象ファイル:</strong> <span id="confirmFileName"></span></li>
                                                <li><strong>登録ユーザー数:</strong> <span id="confirmUserCount"></span> 人
                                                </li>
                                                <li><strong>推定所要時間:</strong> <span id="confirmTimeEstimate"></span>
                                                </li>
                                            </ul>
                                            <div class="alert alert-info">
                                                <small>※ 処理はバックグラウンドで行われます。開始後は他の作業を行っても問題ありません。</small>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">キャンセル</button>
                                            <button type="button" class="btn btn-primary" onclick="startUserUpload()">
                                                <i class="fas fa-play"></i> 登録開始
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h4>個別ユーザー追加</h4>
                            <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
                                <div class="input-group">
                                    <label for="new_room_number">部屋番号:</label>
                                    <input type="text" id="new_room_number" name="room_number" required>
                                </div>
                                <div class="input-group">
                                    <label for="new_room_password">入室パスワード:</label>
                                    <input type="password" id="new_room_password" name="room_password" required>
                                </div>
                                <div class="input-group">
                                    <label for="new_student_id">出席番号:</label>
                                    <input type="text" id="new_student_id" name="student_id" required>
                                </div>
                                <div class="input-group">
                                    <label for="new_individual_password">個別パスワード:</label>
                                    <input type="password" id="new_individual_password" name="individual_password"
                                        required>
                                </div>
                                <div class="input-group">
                                    <label for="new_username">アカウント名:</label>
                                    <input type="text" id="new_username" name="username" required>
                                    <small class="form-text text-muted">※同一人物が複数の部屋に参加する場合、同じアカウント名でも登録可能です</small>
                                </div>
                                <button type="submit" class="btn btn-primary">ユーザー追加</button>
                            </form>

                            <h4 class="mt-4"><i class="fas fa-user-tie text-warning"></i> 担当者(マネージャー)追加</h4>
                            <div class="admin-panel mb-4"
                                style="background-color: #fff3e0; border-left: 5px solid #ff9800;">
                                <p class="mb-3">
                                    部屋の管理を行う「担当者」を作成します。<br>
                                    <strong>担当者ログイン情報 (部屋番号不要)</strong> を設定します。
                                </p>
                                <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
                                    <input type="hidden" name="is_manager" value="true">
                                    <!-- 部屋番号、パスワードの入力は不要になりました -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">担当者ユーザー名 (ID)</label>
                                            <input type="text" class="form-control" name="username" required
                                                placeholder="例: tanaka_teacher">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">担当者パスワード</label>
                                            <input type="password" class="form-control" name="individual_password"
                                                required placeholder="ログイン用パスワード">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-warning text-dark">
                                        <i class="fas fa-plus-circle me-1"></i> 担当者を追加
                                    </button>
                                </form>
                            </div>

                            <h4>登録済みユーザー一覧</h4>
                            <!-- ソート・検索コントロール -->
                            <div class="table-controls mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="roomSortSelect">部屋でフィルター:</label>
                                        <select id="roomSortSelect" class="form-control form-control-sm">
                                            <option value="">全ての部屋</option>
                                            {% set room_numbers = [] %}
                                            {% for user in users %}
                                            {% if user.room_number not in room_numbers and user.room_number !=
                                            'ADMIN' %}
                                            {% set _ = room_numbers.append(user.room_number) %}
                                            {% endif %}
                                            {% endfor %}
                                            {% for room_num in room_numbers|sort %}
                                            <option value="{{ room_num }}">部屋 {{ room_num }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="userSearchInput">ユーザー検索:</label>
                                        <input type="text" id="userSearchInput" class="form-control form-control-sm"
                                            placeholder="名前、出席番号で検索...">
                                    </div>
                                </div>
                            </div>

                            <!-- ユーザー一覧テーブル -->
                            <div class="table-controls mb-2">
                                <button type="button" id="bulkDeleteBtn" class="btn btn-danger" disabled>
                                    <i class="fas fa-trash-alt"></i> 選択したユーザーを削除 (<span id="selectedUserCount">0</span>)
                                </button>
                                <button type="button" class="btn btn-warning ms-2" onclick="confirmResetAllIntro()">
                                    <i class="fas fa-history"></i> 全員のIntroリセット
                                </button>
                            </div>
                            <div class="scrollable-table-container">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="userTable">
                                        <thead class="table-dark sticky-header">
                                            <tr>
                                                <th><input type="checkbox" id="selectAllUsers" title="表示中のユーザーを全て選択">
                                                </th>
                                                <th>ID</th>
                                                <th style="cursor: pointer;" data-column="room">
                                                    部屋番号 <i class="fas fa-sort sort-icon" data-column="room"></i>
                                                </th>
                                                <th>出席番号</th>
                                                <th style="cursor: pointer;" data-column="name">
                                                    アカウント名 <i class="fas fa-sort sort-icon" data-column="name"></i>
                                                </th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userTableBody">
                                            {% for user in users %}
                                            {% if user.room_number != 'ADMIN' %}
                                            <tr data-room="{{ user.room_number }}"
                                                data-name="{{ user.username.lower() }}"
                                                data-student="{{ user.student_id }}">
                                                <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                                                </td>
                                                <td>{{ user.id }}</td>
                                                <td>
                                                    <span class="badge bg-primary">{{ user.room_number }}</span>
                                                    {% if room_data.get(user.room_number, {}).get('is_suspended',
                                                    False) %}
                                                    <span class="badge bg-warning text-dark ms-1">
                                                        <i class="fas fa-pause"></i> 一時停止
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td><code>{{ user.student_id }}</code></td>
                                                <td><strong>{{ user.username }}</strong></td>
                                                <td>
                                                    <div class="user-action-buttons d-flex flex-wrap gap-1">
                                                        <button type="button"
                                                            class="btn btn-danger btn-sm delete-user-btn"
                                                            data-user-id="{{ user.id }}"
                                                            data-username="{{ user.username }}">
                                                            <i class="fas fa-trash"></i> 削除
                                                        </button>
                                                        <button class="btn btn-warning btn-sm delete-score-btn"
                                                            data-user-id="{{ user.id }}"
                                                            data-username="{{ user.username }}">
                                                            <i class="fas fa-eraser"></i> スコア削除
                                                        </button>
                                                        <button class="btn btn-info btn-sm reset-intro-btn"
                                                            data-user-id="{{ user.id }}"
                                                            data-username="{{ user.username }}">
                                                            <i class="fas fa-undo"></i> Introリセット
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 問題CSVファイル管理セクション -->
                <div class="tab-pane fade" id="section-csv-management" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-folder-open"></i> 問題CSVファイル管理</h3>
                        </div>
                        <div class="card-body">
                            <p>各部屋で使用する単語帳CSVファイルを個別に設定できます。アップロードしない場合はデフォルトのwords.csvが使用されます。</p>
                            <div class="csv-template-section"
                                style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px; border-left: 4px solid #17a2b8;">
                                <h4
                                    style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-download"></i> CSVテンプレートダウンロード
                                </h4>
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                                    正しい形式の単語帳CSVファイルを作成するためのテンプレートです。サンプルデータ付きですぐに編集を開始できます。
                                </p>
                                <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-file-csv"></i> 単語帳CSVテンプレートをダウンロード
                                </a>
                                <small class="text-muted d-block mt-2">
                                    ※ ファイル形式：chapter, number, category, question, answer, enabled
                                </small>
                            </div>
                            <form action="{{ url_for('admin_upload_room_csv') }}" method="POST"
                                enctype="multipart/form-data" class="upload-form">
                                <div class="input-group">
                                    <label for="room_csv_file">CSVファイルを選択:</label>
                                    <input type="file" id="room_csv_file" name="file" accept=".csv" required>
                                    <small class="form-text text-muted">＊ファイル名は半角英数字＊</small>
                                </div>
                                <button type="submit" class="btn btn-success">CSVファイルアップロード</button>
                            </form>

                            <h4>アップロード済みCSVファイル一覧</h4>
                            <div id="csv-files-list">
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">
                                        <i class="fas fa-sync-alt"></i> ファイル一覧を更新
                                    </button>
                                </div>
                                <!-- スクロール可能なCSVファイルリスト -->
                                <div class="scrollable-table-container">
                                    <div id="csv-files-container" style="margin-top: 15px; overflow-x: auto;">
                                        <p class="text-info">📋 ファイル一覧を読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 部屋ごとの設定管理セクション -->
                <div class="tab-pane fade" id="section-room-settings" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-home"></i> 部屋ごとの設定管理</h3>
                        </div>
                        <div class="card-body">
                            <p>各部屋の学習範囲、CSVファイル、一時停止状態を管理します。</p>

                            <!-- スクロール可能な部屋設定テーブル -->
                            <div class="scrollable-table-container">
                                <div class="table-responsive" style="overflow-x: auto;">
                                    <table class="table table-striped room-setting-table" style="min-width: 700px;">
                                        <thead class="table-dark sticky-header">
                                            <tr>
                                                <th>部屋番号</th>
                                                <th>有効単元設定</th>
                                                <th>使用CSVファイル</th>
                                                {% if not is_manager %}
                                                <th>管理パスワード</th>
                                                {% endif %}
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set unique_room_numbers = [] %}
                                            {% for user in users %}
                                            {% if user.room_number not in unique_room_numbers and user.room_number
                                            != 'ADMIN' %}
                                            {% set _ = unique_room_numbers.append(user.room_number) %}
                                            {% endif %}
                                            {% endfor %}

                                            {% for setting in room_max_unit_settings.keys() %}
                                            {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                            {% set _ = unique_room_numbers.append(setting) %}
                                            {% endif %}
                                            {% endfor %}

                                            {% for room_num in unique_room_numbers|sort %}
                                            <tr {% if room_data.get(room_num, {}).get('is_suspended', False)
                                                %}class="table-warning" {% endif %}>
                                                <td>
                                                    <strong>{{ room_num }}</strong>
                                                    {% if room_data.get(room_num, {}).get('is_suspended', False) %}
                                                    <span class="badge bg-warning text-dark ms-1">
                                                        <i class="fas fa-pause"></i> 一時停止中
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="unit-setting-container"
                                                        id="unitContainer_{{ room_num }}">
                                                        <div class="unit-controls mb-2">
                                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                                onclick="loadAvailableUnits('{{ room_num }}')">
                                                                <i class="fas fa-sync"></i> 単元一覧読み込み
                                                            </button>
                                                            <button type="button" class="btn btn-outline-success btn-sm"
                                                                onclick="selectAllUnits('{{ room_num }}')">
                                                                <i class="fas fa-check-double"></i> 全て選択
                                                            </button>
                                                            <button type="button" class="btn btn-outline-warning btn-sm"
                                                                onclick="clearAllUnits('{{ room_num }}')">
                                                                <i class="fas fa-times"></i> 全て解除
                                                            </button>
                                                        </div>
                                                        <div class="unit-accordion" id="unitAccordion_{{ room_num }}">
                                                            <p class="text-muted">「単元一覧読み込み」をクリックして利用可能な単元を表示してください
                                                            </p>
                                                        </div>
                                                        <div class="selected-units-display mt-2">
                                                            <small class="text-info">
                                                                選択中: <span
                                                                    id="selectedCount_{{ room_num }}">0</span>個の単元
                                                            </small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <select id="csvFile_{{ room_num }}"
                                                        class="form-control csv-setting-select"
                                                        data-room-number="{{ room_num }}">
                                                        <option value="words.csv" {% if
                                                            room_csv_settings.get(room_num, 'words.csv' )=='words.csv'
                                                            %}selected{% endif %}>
                                                            words.csv (デフォルト)
                                                        </option>
                                                        <!-- 動的にオプションを追加 -->
                                                    </select>
                                                    <small class="form-text text-muted">
                                                        現在の設定: <code
                                                            id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                                    </small>
                                                </td>
                                                {% if not is_manager %}
                                                <td>
                                                    <input type="password" id="managerPassword_{{ room_num }}"
                                                        class="form-control form-control-sm" placeholder="変更時のみ入力"
                                                        autocomplete="new-password">
                                                    <small class="text-muted">担当者用パスワード</small>
                                                </td>
                                                {% endif %}
                                                <td>
                                                    <div class="btn-group-vertical btn-group-sm">
                                                        <button class="btn btn-primary btn-sm save-room-setting-btn"
                                                            data-room-number="{{ room_num }}">保存</button>
                                                        <button class="btn btn-info btn-sm regenerate-quiz-btn"
                                                            data-room-number="{{ room_num }}">
                                                            <i class="fas fa-sync-alt"></i> 10問 再選考
                                                        </button>
                                                        <button type="button" class="btn btn-warning btn-sm me-1"
                                                            data-room-number="{{ room_num }}"
                                                            data-is-suspended="{{ room_data.get(room_num, {}).get('is_suspended', False)|lower }}"
                                                            onclick="toggleRoomSuspension(event, this)">
                                                            {% if room_data.get(room_num, {}).get('is_suspended',
                                                            False) %}
                                                            <i class="fas fa-play"></i> 再開
                                                            {% else %}
                                                            <i class="fas fa-pause"></i> 一時停止
                                                            {% endif %}
                                                        </button>
                                                        {% if not is_manager %}
                                                        <button type="button"
                                                            class="btn btn-warning btn-sm delete-room-score-btn"
                                                            onclick="confirmDeleteRoomScore(event, '{{ room_num }}')">
                                                            <i class="fas fa-eraser"></i> スコア全削除
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm"
                                                            onclick="deleteRoom(event, '{{ room_num }}')">削除</button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RPG敵キャラ管理セクション -->
                {% if not is_manager %}
                <div class="tab-pane fade" id="section-rpg-management" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-dragon"></i> RPG敵キャラ管理</h3>
                        </div>
                        <div class="card-body">
                            <p>RPGモードで登場する敵キャラクター（ボス）を追加編集できます。</p>

                            <!-- 新規登録フォーム -->
                            <div class="admin-panel"
                                style="background-color: #fce4ec; border-left: 5px solid #e91e63; margin-bottom: 20px;">
                                <h4><i class="fas fa-plus-circle"></i> 新規ボス追加</h4>
                                <form id="addRpgEnemyForm" enctype="multipart/form-data">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">ボス名</label>
                                            <input type="text" class="form-control" name="name" placeholder="例: ハンニバル"
                                                required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">難易度 (1-100)</label>
                                            <input type="number" class="form-control" name="difficulty" min="1"
                                                max="100" value="1" required>
                                        </div>
                                    </div>

                                    <div class="row rpg-form-row">
                                        <div class="col-md-4 col-6 mb-3">
                                            <label class="form-label">ボス画像 (戦闘用)</label>
                                            <input type="file" class="form-control" name="icon_image" accept="image/*">
                                        </div>
                                        <div class="col-md-4 col-6 mb-3">
                                            <label class="form-label">討伐後画像 (Status用)</label>
                                            <input type="file" class="form-control" name="defeated_image"
                                                accept="image/*">
                                        </div>
                                        <div class="col-md-4 col-12 mb-3">
                                            <label class="form-label">称号名</label>
                                            <input type="text" class="form-control" name="badge_name"
                                                placeholder="例: 雷光の将軍" required>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">称号アイコン (画像)</label>
                                            <input type="file" class="form-control" name="badge_image" accept="image/*">
                                            <small class="text-muted">または FontAwesomeクラス名を入力:</small>
                                            <input type="text" class="form-control mt-1" name="badge_icon_class"
                                                placeholder="例: fas fa-bolt">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">説明文</label>
                                            <textarea class="form-control" name="description" rows="2"
                                                placeholder="ボスの説明..."></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">開始セリフ</label>
                                            <textarea class="form-control" name="intro_dialogue" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">討伐時セリフ (Boss)</label>
                                            <textarea class="form-control" name="defeat_dialogue" rows="2"
                                                placeholder="ボスが倒れた時に言うセリフ"></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">討伐後コメント (Per)</label>
                                            <div id="addDialogueContainer"></div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                                onclick="addDialogueRow('addDialogueContainer')">
                                                <i class="fas fa-plus"></i> コメント追加
                                            </button>
                                        </div>
                                    </div>

                                    <hr>
                                    <hr>
                                    <h5>クリア条件・出現条件</h5>
                                    <div class="row rpg-form-row">
                                        <div class="col-md-3 col-6 mb-3">
                                            <label class="form-label">制限時間 (秒)</label>
                                            <input type="number" class="form-control" name="time_limit" value="60">
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <label class="form-label">合格正解数</label>
                                            <input type="number" class="form-control" name="clear_correct_count"
                                                value="10">
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <label class="form-label">許容ミス数</label>
                                            <input type="number" class="form-control" name="clear_max_mistakes"
                                                value="2">
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <label class="form-label">出現必要スコア (Min 1000)</label>
                                            <input type="number" class="form-control" name="appearance_required_score"
                                                value="1000" min="1000">
                                        </div>
                                    </div>

                                    <div class="mb-3 p-3 border rounded bg-light">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="is_manual_order"
                                                value="true" id="addIsManualOrder" onchange="toggleManualOrder('add')">
                                            <label class="form-check-label" for="addIsManualOrder">優先表示順を手動設定する</label>
                                        </div>
                                        <div id="addDisplayOrderGroup" style="display: none; margin-top: 10px;">
                                            <label class="form-label">表示順 (小さい数字が先)</label>
                                            <input type="number" class="form-control" name="display_order" value="0">
                                        </div>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="is_active" value="true"
                                            checked id="isActiveCheck">
                                        <label class="form-check-label" for="isActiveCheck">すぐに有効にする</label>
                                    </div>

                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-save"></i> ボスを登録
                                    </button>
                                </form>
                            </div>

                            <!-- ボス一覧 -->
                            <h4>登録済みボス一覧</h4>
                            <div id="rpgEnemyListContainer">
                                <!-- JSで一覧をロード -->
                                <div class="text-center"><i class="fas fa-spinner fa-spin"></i> 読み込み中...</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}


                <!-- スクリプト: RPG管理機能 -->
                <script>
                    // Toggle Manual Order Input
                    function toggleManualOrder(prefix) {
                        const checkbox = document.getElementById(prefix + 'IsManualOrder');
                        const group = document.getElementById(prefix + 'DisplayOrderGroup');
                        if (checkbox && group) {
                            group.style.display = checkbox.checked ? 'block' : 'none';
                        }
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        // ★重要：モーダルをbody直下に移動させて、レイアウト干渉（ちらつき・即閉じ）を防ぐ
                        ['editRpgEnemyModal', 'uploadConfirmModal', 'deleteScoreModal'].forEach(id => {
                            const modalEl = document.getElementById(id);
                            if (modalEl) {
                                document.body.appendChild(modalEl);
                                // デバッグ用：閉じるイベントの追跡
                                modalEl.addEventListener('hide.bs.modal', function (e) {

                                    // console.trace(); // 必要に応じて有効化
                                });
                            }
                        });

                        loadRpgEnemies();

                        const addRpgForm = document.getElementById('addRpgEnemyForm');
                        if (addRpgForm) {
                            addRpgForm.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const form = this; // Capture form context

                                showConfirmModal(
                                    '登録確認',
                                    'このボスを登録しますか？',
                                    () => {
                                        const formData = new FormData(form);

                                        fetch('/admin/rpg/enemies/add', {
                                            method: 'POST',
                                            body: formData
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.status === 'success') {
                                                    alert('登録しました！');
                                                    form.reset();
                                                    loadRpgEnemies();
                                                } else {
                                                    alert('エラー: ' + data.message);
                                                }
                                            })
                                            .catch(err => alert('通信エラーが発生しました'));
                                    }
                                );
                            });
                        }
                    });

                    function loadRpgEnemies() {
                        fetch('/admin/rpg/enemies')
                            .then(res => res.json())
                            .then(enemies => {
                                // Store enemies globally for easy access
                                window.rpgEnemies = {};
                                enemies.forEach(e => { window.rpgEnemies[e.id] = e; });

                                const container = document.getElementById('rpgEnemyListContainer');
                                if (enemies.length === 0) {
                                    container.innerHTML = '<p class="text-muted">登録されているボスはいません。</p>';
                                    return;
                                }

                                let html = '<div class="table-responsive"><table class="table table-bordered table-hover align-middle">';
                                html += '<thead class="table-dark"><tr><th>Icon</th><th>名前 (難易度)</th><th>称号</th><th>条件</th><th>状態</th><th>操作</th></tr></thead><tbody>';

                                enemies.forEach(enemy => {
                                    // 画像パスの生成 (DB経由のURLを使用)
                                    const iconPath = enemy.icon_url ? enemy.icon_url : (enemy.icon_image ? `/static/images/rpg/${enemy.icon_image}` : '');

                                    html += `<tr>
                        <td class="text-center"><img src="${iconPath}" style="width:50px; height:50px; object-fit:contain;"></td>
                        <td><strong>${enemy.name}</strong> <span class="text-warning">★${enemy.difficulty}</span></td>
                        <td>${enemy.badge_name}</td>
                        <td><small>制限${enemy.time_limit}秒 / 正解${enemy.clear_correct_count} / ミス${enemy.clear_max_mistakes}まで</small></td>
                        <td>${enemy.is_active ? '<span class="badge bg-success">有効</span>' : '<span class="badge bg-secondary">無効</span>'}</td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="openEditRpgEnemyModal(event, ${enemy.id})">
                                <i class="fas fa-edit"></i> 編集
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteRpgEnemy(event, ${enemy.id})">
                                <i class="fas fa-trash"></i> 削除
                            </button>
                        </td>
                    </tr>`;
                                });

                                html += '</tbody></table></div>';
                                container.innerHTML = html;
                            });
                    }

                    // 編集モーダルを開く
                    function openEditRpgEnemyModal(event, enemyId) {
                        if (event) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        const enemy = window.rpgEnemies[enemyId];
                        if (!enemy) {
                            console.error('Enemy not found for ID:', enemyId);
                            return;
                        }
                        const modalElement = document.getElementById('editRpgEnemyModal');
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalElement);
                        }
                        const form = document.getElementById('editRpgEnemyForm');

                        // フォームに値をセット
                        form.action = `/admin/rpg/enemies/edit/${enemy.id}`; // フォームのactionを動的に設定
                        form.elements['name'].value = enemy.name;
                        form.elements['difficulty'].value = enemy.difficulty;
                        form.elements['badge_name'].value = enemy.badge_name;
                        form.elements['description'].value = enemy.description || '';
                        form.elements['intro_dialogue'].value = enemy.intro_dialogue || '';
                        form.elements['defeat_dialogue'].value = enemy.defeat_dialogue || '';

                        // 🆕 Dialogues Populate
                        const container = document.getElementById('editDialogueContainer');
                        if (container) {
                            container.innerHTML = ''; // Request clear
                            if (enemy.dialogues && enemy.dialogues.length > 0) {
                                enemy.dialogues.forEach(d => {
                                    addDialogueRow('editDialogueContainer', d.content, d.expression);
                                });
                            } else {
                                // If no dialogues but legacy defeat_dialogue exists, maybe add it as first row?
                                if (enemy.defeat_dialogue) {
                                    addDialogueRow('editDialogueContainer', enemy.defeat_dialogue, 'normal');
                                }
                            }
                        }
                        form.elements['time_limit'].value = enemy.time_limit;
                        form.elements['clear_correct_count'].value = enemy.clear_correct_count;
                        form.elements['clear_max_mistakes'].value = enemy.clear_max_mistakes;
                        form.elements['display_order'].value = enemy.display_order;
                        form.elements['appearance_required_score'].value = enemy.appearance_required_score;

                        // チェックボックス
                        form.elements['is_active'].checked = enemy.is_active;

                        // Manual Order
                        if (form.elements['is_manual_order']) {
                            form.elements['is_manual_order'].checked = enemy.is_manual_order || false;
                            toggleManualOrder('edit');
                        }

                        // バッジアイコンクラス (画像アップロードはリセット)
                        form.elements['badge_icon_class'].value = enemy.badge_image && !enemy.badge_image.includes('/') ? enemy.badge_image : '';

                        // 既存の画像プレビューを更新 (もしあれば)
                        const currentIconPreview = document.getElementById('currentEditIconImage');
                        if (currentIconPreview) {
                            currentIconPreview.src = enemy.icon_url ? enemy.icon_url : (enemy.icon_image ? `/static/images/rpg/${enemy.icon_image}` : '/static/images/boss_alexander.png');
                            currentIconPreview.style.display = 'block';
                        }
                        // Defeated Preview
                        const currentDefeatedPreview = document.getElementById('currentEditDefeatedImage');
                        if (currentDefeatedPreview) {
                            if (enemy.defeated_image) {
                                currentDefeatedPreview.src = enemy.defeated_url ? enemy.defeated_url : `/static/images/rpg/${enemy.defeated_image}`;
                                currentDefeatedPreview.style.display = 'block';
                            } else {
                                currentDefeatedPreview.style.display = 'none';
                            }
                        }
                        const currentBadgePreview = document.getElementById('currentEditBadgeImage');
                        if (currentBadgePreview) {
                            if (enemy.badge_image && enemy.badge_image.includes('/')) { // 画像の場合
                                currentBadgePreview.src = enemy.badge_url ? enemy.badge_url : `/static/images/rpg/${enemy.badge_image}`;
                                currentBadgePreview.style.display = 'block';
                                document.getElementById('currentEditBadgeIconClass').style.display = 'none';
                            } else if (enemy.badge_image) { // FontAwesomeクラスの場合
                                document.getElementById('currentEditBadgeIconClass').className = `fas ${enemy.badge_image} fa-2x`;
                                document.getElementById('currentEditBadgeIconClass').style.display = 'inline-block';
                                currentBadgePreview.style.display = 'none';
                            } else {
                                currentBadgePreview.style.display = 'none';
                                document.getElementById('currentEditBadgeIconClass').style.display = 'none';
                            }
                        }

                        modal.show();
                    }

                    // 編集モーダルを閉じる
                    function closeEditRpgEnemyModal() {
                        const modalElement = document.getElementById('editRpgEnemyModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    }

                    // 削除対象IDを保持するグローバル変数
                    let deleteRpgEnemyTargetId = null;

                    function deleteRpgEnemy(event, id) {
                        if (event) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        // store ID
                        deleteRpgEnemyTargetId = id;

                        // show bootstrap modal
                        const modalEl = document.getElementById('deleteRpgEnemyModal');
                        let modal = bootstrap.Modal.getInstance(modalEl);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalEl);
                        }
                        modal.show();
                    }

                    function executeDeleteRpgEnemy() {
                        if (!deleteRpgEnemyTargetId) return;

                        // hide modal
                        const modalEl = document.getElementById('deleteRpgEnemyModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();

                        // execute delete
                        fetch(`/admin/rpg/enemies/delete/${deleteRpgEnemyTargetId}`, { method: 'POST' })
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    loadRpgEnemies();
                                } else {
                                    alert('削除失敗: ' + data.message);
                                }
                            })
                            .catch(err => alert('通信エラーが発生しました'));
                    }

                    // 🟢 PER DIALOGUE LOGIC
                    const PER_EXPRESSIONS = [
                        { id: 'normal', label: '通常 (Normal)' },
                        { id: 'joy', label: '喜び (Joy)' },
                        { id: 'trouble', label: '困る (Trouble/Confusion)' },
                        { id: 'grief', label: '悲しみ (Grief)' },
                        { id: 'analysis', label: '分析 (Analysis)' },
                        { id: 'caution', label: '警告 (Caution)' }
                    ];

                    function addDialogueRow(containerId, content = '', expression = 'normal') {
                        const container = document.getElementById(containerId);
                        if (!container) return;

                        const rowId = 'dialogue_row_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

                        const div = document.createElement('div');
                        div.className = 'input-group mb-2 dialogue-row';
                        div.id = rowId;

                        // Expression Selector
                        let selectHtml = `<select class="form-select" name="dialogue_expression[]" style="max-width: 150px;">`;
                        PER_EXPRESSIONS.forEach(expr => {
                            const selected = expr.id === expression ? 'selected' : '';
                            selectHtml += `<option value="${expr.id}" ${selected}>${expr.label}</option>`;
                        });
                        selectHtml += `</select>`;

                        div.innerHTML = `
                ${selectHtml}
                <textarea class="form-control" name="dialogue_content[]" rows="1" placeholder="セリフを入力...">${content}</textarea>
                <button type="button" class="btn btn-outline-danger" onclick="removeDialogueRow(this)">
                    <i class="fas fa-minus"></i>
                </button>
            `;

                        container.appendChild(div);
                    }

                    function removeDialogueRow(btn) {
                        btn.closest('.dialogue-row').remove();
                    }

                    // Also ensure Add Form is cleared when modal resets (if handled manually) or initialized
                    // Note: For Add Form, we might need to clear it manually if the form is reset but container isn't.
                    // Assuming page reload or form reset clears HTML inside if dynamic... actually it does NOT clear innerHTML of divs.
                    // We should add a reset handler for addRpgEnemyForm.
                    const addRpgFormReset = document.getElementById('addRpgEnemyForm');
                    if (addRpgFormReset) {
                        addRpgFormReset.addEventListener('reset', function () {
                            setTimeout(() => {
                                document.getElementById('addDialogueContainer').innerHTML = '';
                            }, 0);
                        });
                    }

                </script>

                {% if not is_manager %}
                <!-- 論述問題公開設定セクション -->
                <div class="tab-pane fade" id="section-essay-visibility" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-eye"></i> 論述問題公開設定</h3>
                        </div>
                        <div class="card-body">
                            <p>部屋ごとに章・問題タイプ別で論述問題の公開/非公開を設定できます。</p>

                            <!-- 部屋選択 -->
                            <div class="visibility-room-selector">
                                <div class="row align-items-center mb-3">
                                    <div class="col-md-4">
                                        <label for="visibilityRoomSelect" class="form-label">
                                            <i class="fas fa-door-open"></i> 設定対象の部屋
                                        </label>
                                        <select id="visibilityRoomSelect" class="form-select">
                                            <option value="">部屋を選択してください</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="btn-group" role="group">
                                            <button id="loadVisibilitySettings" class="btn btn-primary" disabled>
                                                <i class="fas fa-download"></i> 設定を読み込み
                                            </button>
                                            <button id="saveVisibilitySettings" class="btn btn-success" disabled>
                                                <i class="fas fa-save"></i> 設定を保存
                                            </button>
                                            <button id="resetVisibilitySettings" class="btn btn-warning" disabled>
                                                <i class="fas fa-undo"></i> 全て公開にリセット
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 設定マトリックス -->
                            <div id="visibilityMatrix" class="visibility-matrix" style="display: none;">
                                <div class="matrix-header">
                                    <h4><i class="fas fa-eye"></i> 論述問題公開設定</h4>
                                    <p class="text-muted mb-3">
                                        <i class="fas fa-info-circle"></i>
                                        各セルをクリックして個別設定、「第○章」をクリックして章全体の一括設定ができます
                                    </p>
                                </div>

                                <!-- Grid Container -->
                                <div id="visibilityGrid" class="visibility-grid">
                                    <!-- ヘッダー行 -->
                                    <div class="grid-header grid-cell-chapter">章</div>
                                    <div class="grid-header grid-cell-type">タイプA</div>
                                    <div class="grid-header grid-cell-type">タイプB</div>
                                    <div class="grid-header grid-cell-type">タイプC</div>
                                    <div class="grid-header grid-cell-type">タイプD</div>

                                    <!-- データ行はJavaScriptで動的生成 -->
                                </div>

                                <!-- 保存ボタンのみ -->
                                <div class="save-section mt-3 text-center">
                                    <button type="button" class="btn btn-primary btn-lg"
                                        onclick="saveVisibilitySettings()">
                                        <i class="fas fa-save"></i> 設定を保存
                                    </button>
                                </div>
                            </div>

                            <!-- 状態表示 -->
                            <div id="visibilityStatus" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                {% endif %}


                <!-- 論述問題集管理セクション　-->
                {% if not is_manager %}
                <div class="tab-pane fade" id="section-essay-management" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-edit"></i> 論述問題集管理</h3>
                        </div>
                        <div class="card-body">
                            <p>論述問題の登録・管理・インポートを行います。</p>
                            <!-- 論述問題CSV一括インポート -->
                            <div class="csv-import-section">
                                <h4><i class="fas fa-upload"></i> CSV一括インポート</h4>

                                <!-- CSVテンプレート説明 -->
                                <div class="csv-template-section">
                                    <h5><i class="fas fa-download"></i> 論述問題CSVテンプレート</h5>
                                    <p>正しい形式の論述問題CSVファイルを作成するためのテンプレートです。</p>

                                    <div class="template-format">
                                        <strong>CSVフォーマット:</strong><br>
                                        <code>chapter,type,university,year,question,answer,answer_length,enabled</code><br><br>

                                        <strong>各列の説明:</strong><br>
                                        • <strong>chapter</strong>: 章番号（例: 1, 2, com）<br>
                                        • <strong>type</strong>: 問題タイプ（A: 200字以上, B: 100-150字, C: 50-75字, D:
                                        30字程度）<br>
                                        • <strong>university</strong>: 出題大学名（任意）<br>
                                        • <strong>year</strong>: 出題年度（任意）<br>
                                        • <strong>question</strong>: 問題文（必須）<br>
                                        • <strong>answer</strong>: 模範解答（任意）<br>
                                        • <strong>answer_length</strong>: 解答文字数（自動計算されるため任意）<br>
                                        • <strong>enabled</strong>: 有効フラグ（1: 有効, 0: 無効）
                                    </div>

                                    <button class="btn btn-outline-info btn-sm" onclick="downloadEssayTemplate()">
                                        <i class="fas fa-file-csv"></i> 論述問題CSVテンプレートをダウンロード
                                    </button>

                                    <a href="{{ url_for('admin_essay_download_csv') }}"
                                        class="btn btn-outline-primary btn-sm ms-2">
                                        <i class="fas fa-file-download"></i> 登録済み問題をCSVでダウンロード
                                    </a>
                                </div>

                                <!-- CSVアップロードフォーム -->
                                <form id="essayUploadForm" enctype="multipart/form-data" class="csv-upload-form">
                                    <div class="upload-area">
                                        <div class="file-input-wrapper">
                                            <label for="essay_csv_file" class="file-input-label">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                <span>CSVファイルを選択</span>
                                            </label>
                                            <input type="file" id="essay_csv_file" name="file" accept=".csv" required>
                                            <small
                                                class="form-text text-muted">UTF-8またはShift_JISエンコーディングのCSVファイルを選択してください</small>
                                        </div>

                                        <div class="upload-options">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="replaceExisting"
                                                    name="replace_existing">
                                                <label class="form-check-label" for="replaceExisting">
                                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                                    既存の問題を置き換える（注意：全ての論述問題が削除されます）
                                                </label>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-success btn-upload">
                                            <i class="fas fa-upload"></i>
                                            <span>論述問題CSV一括インポート</span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- 個別論述問題登録 -->
                            <div class="essay-form-section">
                                <h4><i class="fas fa-plus-circle"></i> 個別論述問題登録</h4>

                                <div class="essay-form-container">
                                    <form id="newEssayProblemForm" class="essay-registration-form"
                                        enctype="multipart/form-data">
                                        <div class="essay-form-grid">
                                            <!-- 章・タイプ行 -->
                                            <div class="essay-input-group">
                                                <label for="new_essay_chapter">
                                                    <i class="fas fa-bookmark"></i> 章
                                                </label>
                                                <input type="text" id="new_essay_chapter" name="chapter"
                                                    placeholder="例: 1, 2, com" required>
                                                <small class="essay-help-text">数字または「com」（総合問題）を入力</small>
                                            </div>

                                            <div class="essay-input-group">
                                                <label for="new_essay_type">
                                                    <i class="fas fa-tag"></i> タイプ
                                                </label>
                                                <select id="new_essay_type" name="type" required>
                                                    <option value="">選択してください</option>
                                                    <option value="A">タイプA (200字以上)</option>
                                                    <option value="B">タイプB (100-150字程度)</option>
                                                    <option value="C">タイプC (50-75字程度)</option>
                                                    <option value="D">タイプD (30字程度)</option>
                                                </select>
                                                <small class="essay-help-text">問題の文字数規模を選択</small>
                                            </div>

                                            <!-- 大学・年度行 -->
                                            <div class="essay-input-group">
                                                <label for="new_essay_university">
                                                    <i class="fas fa-university"></i> 大学名
                                                </label>
                                                <input type="text" id="new_essay_university" name="university"
                                                    placeholder="例: 東京大学">
                                                <small class="essay-help-text">出題大学名（任意）</small>
                                            </div>

                                            <div class="essay-input-group">
                                                <label for="new_essay_year">
                                                    <i class="fas fa-calendar-alt"></i> 年度
                                                </label>
                                                <input type="number" id="new_essay_year" name="year" placeholder="2024"
                                                    min="2000" max="2030">
                                                <small class="essay-help-text">出題年度（任意）</small>
                                            </div>

                                            <!-- 問題文（全幅） -->
                                            <div class="essay-input-group essay-form-full-width">
                                                <label for="new_essay_question">
                                                    <i class="fas fa-question-circle"></i> 問題文
                                                </label>
                                                <textarea id="new_essay_question" name="question"
                                                    class="essay-question-input" placeholder="問題文を入力してください..."
                                                    required></textarea>
                                                <small class="essay-help-text">出題する問題の内容を詳しく記入</small>
                                            </div>
                                            <!-- 問題画像アップロード -->
                                            <div class="essay-input-group essay-form-full-width">
                                                <label for="new_essay_image">
                                                    <i class="fas fa-image"></i> 問題画像（グラフ・地図等）
                                                </label>
                                                <input type="file" id="new_essay_image" name="image" accept="image/*"
                                                    onchange="previewImage(this)">
                                                <div id="imagePreview" class="mt-2"></div>
                                                <small class="essay-help-text">JPG、PNG、GIF形式の画像ファイル（任意）</small>
                                            </div>
                                            <!-- 解答（全幅） -->
                                            <div class="essay-input-group essay-form-full-width">
                                                <label for="new_essay_answer">
                                                    <i class="fas fa-lightbulb"></i> 模範解答
                                                </label>
                                                <div class="textarea-wrapper">
                                                    <textarea id="new_essay_answer" name="answer"
                                                        class="essay-answer-input" placeholder="模範解答を入力してください..."
                                                        oninput="updateAnswerCharCount('new_essay_answer', 'newAnswerCharCount')"></textarea>
                                                    <div class="char-counter" id="newAnswerCharCount">0字</div>
                                                </div>
                                                <small class="essay-help-text">参考となる解答例（任意）</small>
                                            </div>
                                        </div>

                                        <!-- 有効化チェックボックス -->
                                        <div class="essay-checkbox-group">
                                            <input type="checkbox" id="new_essay_enabled" name="enabled" checked>
                                            <label for="new_essay_enabled">
                                                <i class="fas fa-check-circle"></i> 有効にする
                                            </label>
                                        </div>

                                        <!-- 送信ボタン -->
                                        <button type="submit" class="essay-submit-btn">
                                            <i class="fas fa-plus"></i>
                                            <span class="btn-text">論述問題を追加</span>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- 論述問題一覧・管理 -->
                            <div class="essay-management-section">
                                <h4><i class="fas fa-list"></i> 論述問題一覧・管理</h4>

                                <!-- フィルター -->
                                <div class="essay-filter-section">
                                    <div class="row essay-filter-row">
                                        <div class="col-md-3 col-6">
                                            <label for="essayChapterFilter">章でフィルター:</label>
                                            <select id="essayChapterFilter" class="form-control"
                                                onchange="filterEssayProblems()">
                                                <option value="">全ての章</option>
                                                <option value="1">第1章</option>
                                                <option value="2">第2章</option>
                                                <option value="3">第3章</option>
                                                <option value="4">第4章</option>
                                                <option value="5">第5章</option>
                                                <option value="com">総合問題</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <label for="essayTypeFilter">タイプでフィルター:</label>
                                            <select id="essayTypeFilter" class="form-control"
                                                onchange="filterEssayProblems()">
                                                <option value="">全てのタイプ</option>
                                                <option value="A">タイプA</option>
                                                <option value="B">タイプB</option>
                                                <option value="C">タイプC</option>
                                                <option value="D">タイプD</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 col-12 mt-sm-0 mt-2">
                                            <label for="essaySearch">キーワード検索:</label>
                                            <input type="text" id="essaySearch" class="form-control"
                                                placeholder="問題文や大学名で検索（3文字以上）...">
                                        </div>
                                    </div>
                                </div>

                                <!-- 問題一覧 -->
                                <div id="essay-problems-container">
                                    <div class="text-center text-muted p-4">
                                        <i class="fas fa-search fa-2x mb-3"></i><br>
                                        <strong>検索条件を指定してください</strong><br>
                                        <small>章、タイプ、またはキーワードを入力すると問題一覧が表示されます</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}


                <!-- ユーザー統計管理セクション -->
                {% if not is_manager %}
                <div class="tab-pane fade" id="section-user-stats" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-chart-bar"></i> ユーザー統計管理</h3>
                        </div>
                        <div class="card-body">
                            <p>事前計算されたユーザー統計の状態確認・修復を行います。</p>

                            <!-- 統計状態確認 -->
                            <div class="admin-panel"
                                style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
                                <h4>📈 統計データ状態確認</h4>
                                <p>ユーザー統計の整合性と最新性を確認します。<br>
                                    <strong>推奨：</strong>新しいユーザーを追加した後や、データに不整合がある場合に実行してください。
                                </p>

                                <div class="stats-button-group" style="margin-top: 15px;">
                                    <button type="button" class="btn btn-info" onclick="checkUserStats(event)">
                                        <i class="fas fa-chart-line"></i> 📊 統計状態を確認
                                    </button>

                                    <button type="button" class="btn btn-success" onclick="repairUserStats(event)"
                                        style="margin-left: 10px;">
                                        <i class="fas fa-tools"></i> 🔧 統計データを修復
                                    </button>

                                    <button type="button" class="btn btn-warning" onclick="initializeAllStats(event)"
                                        style="margin-left: 10px;">
                                        <i class="fas fa-sync-alt"></i> 🔄 全統計を強制再初期化
                                    </button>
                                </div>
                            </div>

                            <!-- 統計確認結果表示エリア -->
                            <div id="statsCheckResult" style="margin-top: 15px; display: none;">
                                <h5>📊 統計状態確認結果</h5>
                                <div id="statsCheckContent"
                                    style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                    <!-- 確認結果がここに表示されます -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}


                <!-- データベース管理セクション -->
                {% if not is_manager %}
                <div class="tab-pane fade" id="section-database-management" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h3><i class="fas fa-database"></i> データベース管理</h3>
                        </div>
                        <div class="card-body">
                            <p>学習履歴データの整合性確認とデータクリーンアップを行います。</p>

                            <!-- 孤立したトークンのクリーンアップ -->
                            <div class="admin-panel"
                                style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                                <h4>🧹 孤立データのクリーンアップ</h4>
                                <p>削除されたユーザーに関連する古いパスワードリセットトークンを削除します。<br>
                                    <strong>推奨：</strong>ユーザー削除後やメンテナンス時に実行してください。
                                </p>

                                <div class="stats-button-group" style="margin-top: 15px;">
                                    <button type="button" class="btn btn-warning"
                                        onclick="cleanupOrphanedTokens(event)">
                                        <i class="fas fa-broom"></i> 🧹 孤立したトークンを削除
                                    </button>

                                    <button type="button" class="btn btn-info" onclick="checkDatabaseStatus(event)"
                                        style="margin-left: 10px;">
                                        <i class="fas fa-search"></i> 📊 データベース状態確認
                                    </button>
                                </div>
                            </div>

                            <div class="admin-panel"
                                style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
                                <h4>🗑️ ID不一致履歴の削除</h4>
                                <p>現在の問題データと一致しない古い学習履歴を削除します。<br>
                                    <strong>用途：：</strong>問題文修正後に古いIDの履歴を削除する場合に使用。<br>
                                    <strong>⚠️ 注意：</strong>削除された履歴は復元できません。
                                </p>

                                <div style="margin-top: 15px;">

                                    <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory(event)"
                                        style="margin-left: 10px;">
                                        <i class="fas fa-trash-alt"></i> 🗑️ 無効履歴を削除
                                    </button>
                                </div>

                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <h5>🔍 特定ユーザーのデバッグ</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" id="debugUsername" class="form-control"
                                                    placeholder="ユーザー名を入力">

                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-danger btn-sm"
                                                onclick="forceCleanSpecificUser(event)">
                                                <i class="fas fa-exclamation-triangle"></i> 強制削除
                                            </button>
                                            <small class="text-muted d-block">※上記でユーザー名を入力後に使用</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- 無効履歴分析結果表示エリア -->
                                <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                                    <h5>📊 無効履歴分析結果</h5>
                                    <div id="invalidAnalysisContent"
                                        style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <!-- 分析結果がここに表示されます -->
                                    </div>
                                </div>

                                <!-- デバッグ結果表示エリア -->
                                <div id="userDebugResult" style="margin-top: 15px; display: none;">
                                    <h5>🔍 ユーザーデバッグ結果</h5>
                                    <div id="debugContent"
                                        style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <!-- デバッグ結果がここに表示されます -->
                                    </div>
                                </div>
                            </div>

                            <!-- 全データ修正（従来機能・バックアップ用） -->
                            <div class="admin-panel"
                                style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
                                <h4>⚠️ 全データ修正（バックアップ用）</h4>
                                <p>全ユーザーの学習履歴を強制的に新しいID形式に統一します。<br>
                                    <strong>⚠️ 注意：</strong>この操作は全ユーザーの学習履歴に影響し、元に戻せません。<br>
                                    <strong>推奨：：</strong>通常は上記の「ID不一致問題のみ修正」を使用してください。
                                </p>

                                <div style="margin-top: 15px;">
                                    <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST"
                                        style="display: inline;"
                                        onsubmit="event.preventDefault(); showConfirmModal('データ修正確認', '全ユーザーデータを修正しますか？\n\n⚠️ この操作は元に戻せません。\n⚠️ すべての学習履歴が新しい形式に変換されます。\n⚠️ 通常は「ID不一致問題のみ修正」で十分です。\n\n本当に実行しますか？', () => this.submit(), '実行', 'btn-danger')">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-exclamation-triangle"></i> ⚠️ 全データ強制修正（非推奨）
                                        </button>
                                    </form>

                                    <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank"
                                        style="margin-left: 10px;">
                                        <i class="fas fa-chart-line"></i> 📊 修正前の状態確認
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div> <!-- Close tab-content -->
        </div> <!-- Close p-4 -->
    </div> <!-- Close main-content-wrapper -->
</div> <!-- Close d-flex -->

<script>
    // Sidebar Toggle
    function toggleSidebar() {
        document.getElementById('adminSidebar').classList.toggle('show');
        document.querySelector('.sidebar-overlay').classList.toggle('show');
    }

    // Tab Persistence & App Info AJAX
    document.addEventListener('DOMContentLoaded', function () {
        // Restore active tab
        var activeTab = localStorage.getItem('activeAdminTab');
        if (activeTab) {
            var tabTrigger = document.querySelector('a[href="' + activeTab + '"]');
            if (tabTrigger) {
                var tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }

        // Save active tab
        var tabLinks = document.querySelectorAll('.sidebar-link[data-bs-toggle="pill"]');
        tabLinks.forEach(function (link) {
            link.addEventListener('shown.bs.tab', function (e) {
                localStorage.setItem('activeAdminTab', e.target.getAttribute('href'));
            });
        });

        // App Info AJAX Handle
        const appInfoForm = document.getElementById('appInfoForm');
        if (appInfoForm) {
            appInfoForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Show confirmation if text logo
                // (Logic inherited from admin_app_info.html)
                const logoTypeText = document.getElementById('logo_type_text');
                const performSubmit = () => {
                    const formData = new FormData(appInfoForm);
                    const submitBtn = document.getElementById('saveAppInfoBtn');
                    const originalBtnContent = submitBtn.innerHTML;

                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

                    fetch(appInfoForm.action, {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;

                            // Show success message
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show fixed-top m-3';
                            alertDiv.style.zIndex = '2000';
                            alertDiv.innerHTML = '<i class="fas fa-check-circle"></i> アプリ情報を更新しました！ <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                            document.body.appendChild(alertDiv);
                            setTimeout(() => {
                                alertDiv.remove();
                                // Optional: Reload to see changes like App Name immediately if needed
                                // location.reload(); 
                            }, 2000);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnContent;
                            alert('エラーが発生しました。');
                        });
                };

                if (logoTypeText && logoTypeText.checked) {
                    if (typeof showConfirmModal === 'function') {
                        showConfirmModal(
                            'アプリ情報の更新',
                            'アプリ情報を更新しますか？',
                            performSubmit,
                            '更新',
                            'btn-primary'
                        );
                    } else {
                        if (confirm('アプリ情報を更新しますか？')) performSubmit();
                    }
                } else {
                    performSubmit();
                }
            });
        }

        // Logo Type Toggle Logic (Transplanted)
        const logoTypeText = document.getElementById('logo_type_text');
        const logoTypeImage = document.getElementById('logo_type_image');
        const appNameField = document.getElementById('app_name_field');
        const logoImageField = document.getElementById('logo_image_field');

        if (logoTypeText && logoTypeImage) {
            function toggleLogoFields() {
                if (logoTypeImage.checked) {
                    appNameField.style.display = 'none';
                    logoImageField.style.display = 'block';
                } else {
                    appNameField.style.display = 'block';
                    logoImageField.style.display = 'none';
                }
            }
            logoTypeText.addEventListener('change', toggleLogoFields);
            logoTypeImage.addEventListener('change', toggleLogoFields);
            toggleLogoFields(); // Init
        }
    });
</script>

<div class="container" style="display:none"> <!-- Open hidden container to match base.html closing div -->

    <!-- 汎用ユーティリティモーダル -->
    <div class="modal fade" id="utilityModal" tabindex="-1" role="dialog" aria-labelledby="utilityModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="utilityModalLabel">確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="utilityModalBody" style="white-space: pre-wrap;">
                    <!-- メッセージがここに挿入されます -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        id="utilityModalCancelBtn">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="utilityModalConfirmBtn">実行</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit RPG Enemy Modal -->
    <div class="modal fade" id="editRpgEnemyModal" tabindex="-1" aria-labelledby="editRpgEnemyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRpgEnemyModalLabel">敵キャラ情報の編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRpgEnemyForm" method="POST" enctype="multipart/form-data"
                        onsubmit="handleEditRpgEnemy(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="edit_name" class="form-label">キャラクター名</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_difficulty" class="form-label">難易度 (★)</label>
                                <input type="number" class="form-control" name="difficulty" min="1" max="100" value="1">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">ボス画像 (戦闘用)</label>
                                <input type="file" class="form-control" name="icon_image" accept="image/*">
                                <div class="mt-2 text-center">
                                    <span class="text-muted small">現在の画像:</span>
                                    <img id="currentEditIconImage" src="" alt="Icon Preview"
                                        style="height: 50px; display: none; margin: 0 auto;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">討伐後画像 (Status用)</label>
                                <input type="file" class="form-control" name="defeated_image" accept="image/*">
                                <div class="mt-2 text-center">
                                    <span class="text-muted small">現在の画像:</span>
                                    <img id="currentEditDefeatedImage" src="" alt="Defeated Preview"
                                        style="height: 50px; display: none; margin: 0 auto;">
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label for="edit_badge_name" class="form-label">獲得バッジ名</label>
                                <input type="text" class="form-control" name="badge_name" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">バッジ画像 (変更する場合のみ)</label>
                                <input type="file" class="form-control" name="badge_image" accept="image/*">
                                <div class="mt-2">
                                    <label class="form-label small">またはFontAwesomeクラス</label>
                                    <input type="text" class="form-control form-control-sm" name="badge_icon_class"
                                        placeholder="fa-solid fa-dragon">
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="text-muted small">現在の画像:</span>
                                    <img id="currentEditBadgeImage" src="" alt="Badge Preview"
                                        style="height: 50px; display: none; margin: 0 auto;">
                                    <i id="currentEditBadgeIconClass" style="display: none;"></i>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="edit_description" class="form-label">説明文</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>

                            <div class="col-md-6">
                                <label for="edit_intro_dialogue" class="form-label">登場時セリフ</label>
                                <textarea class="form-control" name="intro_dialogue" rows="2"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">討伐時セリフ (Boss)</label>
                                <textarea class="form-control" name="defeat_dialogue" rows="2"
                                    placeholder="ボスが倒れた時に言うセリフ"></textarea>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">討伐後コメント (Per)</label>
                                <div id="editDialogueContainer"></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                    onclick="addDialogueRow('editDialogueContainer')">
                                    <i class="fas fa-plus"></i> コメント追加
                                </button>
                            </div>

                            <div class="col-md-4">
                                <label for="edit_time_limit" class="form-label">制限時間(秒)</label>
                                <input type="number" class="form-control" name="time_limit" value="60">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_clear_correct_count" class="form-label">クリア正解数</label>
                                <input type="number" class="form-control" name="clear_correct_count" value="10">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_clear_max_mistakes" class="form-label">許容ミス数</label>
                                <input type="number" class="form-control" name="clear_max_mistakes" value="2">
                            </div>

                            <div class="col-md-6">
                                <label for="edit_appearance_required_score" class="form-label">出現必要スコア (Min
                                    1000)</label>
                                <input type="number" class="form-control" name="appearance_required_score" value="1000"
                                    min="1000">
                            </div>
                            <div class="col-md-12 mt-3">
                                <div class="form-check p-3 border rounded bg-light">
                                    <input class="form-check-input" type="checkbox" name="is_manual_order"
                                        id="editIsManualOrder" value="true" onchange="toggleManualOrder('edit')">
                                    <label class="form-check-label" for="editIsManualOrder">優先表示順を手動設定する</label>

                                    <div id="editDisplayOrderGroup" style="display: none; margin-top: 10px;">
                                        <label for="edit_display_order" class="form-label">表示順
                                            (小さい数字が先)</label>
                                        <input type="number" class="form-control" name="display_order" value="0">
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="edit_is_active"
                                        value="true">
                                    <label class="form-check-label" for="edit_is_active">
                                        有効にする (無効にするとボーナス剥奪等の影響が出ます)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer mt-3">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                            <button type="submit" class="btn btn-primary">変更を保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete RPG Enemy Confirmation Modal -->
    <div class="modal fade" id="deleteRpgEnemyModal" tabindex="-1" aria-labelledby="deleteRpgEnemyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteRpgEnemyModalLabel">削除の確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>本当にこのボスを削除しますか？</p>
                    <p class="text-danger"><small>この操作は取り消せません。</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" onclick="executeDeleteRpgEnemy()">
                        <i class="fas fa-trash"></i> 削除実行
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->


    <script>
        // Global function handling (Modal logic moved to script.js)


        async function handleEditRpgEnemy(event) {
            event.preventDefault();

            // Use custom modal instead of native confirm
            const form = event.target;

            showConfirmModal(
                '変更の保存',
                '変更を保存しますか？\n※無効化する場合、関連するボーナスが剥奪される可能性があります。',
                () => {
                    submitEditRpgEnemyForm(form);
                },
                '保存',
                'btn-primary'
            );
        }

        async function submitEditRpgEnemyForm(form) {
            const formData = new FormData(form);

            // チェックボックスの値処理
            if (!form.elements['is_active'].checked) {
                formData.set('is_active', 'false');
            } else {
                formData.set('is_active', 'true');
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    closeEditRpgEnemyModal();
                    loadRpgEnemies(); // リスト再読み込み
                } else {
                    alert('エラー: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('通信エラーが発生しました');
            }
        }
    </script>

    <!-- リセット確認フォーム（非表示） -->
    <form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
    </form>

    <script>
        // ========================================
        // 1. 折りたたみ機能
        // ========================================

        // 全セクション展開
        function expandAllSections() {
            document.querySelectorAll('.admin-section .collapse').forEach(section => {
                const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
                bsCollapse.show();
            });
            updateToggleIcons();
        }

        // 全セクション折りたたみ
        function collapseAllSections() {
            document.querySelectorAll('.admin-section .collapse').forEach(section => {
                const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
                bsCollapse.hide();
            });
            updateToggleIcons();
        }

        // トグルアイコンの更新
        function updateToggleIcons() {
            document.querySelectorAll('.admin-section').forEach(section => {
                const collapseElement = section.querySelector('.collapse');
                const toggleIcon = section.querySelector('.toggle-icon');

                if (collapseElement && toggleIcon) {
                    const isShown = collapseElement.classList.contains('show');
                    toggleIcon.className = isShown ? 'fas fa-chevron-up toggle-icon' : 'fas fa-chevron-down toggle-icon';
                }
            });
        }

        // 折りたたみイベントリスナーを設定
        function initializeCollapseSections() {
            document.querySelectorAll('.admin-section .collapse').forEach(collapseElement => {
                collapseElement.addEventListener('shown.bs.collapse', updateToggleIcons);
                collapseElement.addEventListener('hidden.bs.collapse', updateToggleIcons);
            });
        }

        // ========================================
        // 2. 既存の管理機能（元のスクリプトから移植）
        // ========================================
        // 部屋設定を再読み込みする関数
        function loadRoomSettings() {
            document.querySelectorAll('.csv-setting-select').forEach(select => {
                const roomNumber = select.dataset.roomNumber;
                if (!roomNumber) return;

                fetch('/admin/get_room_setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_number: roomNumber })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const csvFilename = data.csv_filename || 'words.csv';

                            select.value = csvFilename;

                            const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                            if (!optionExists && csvFilename !== 'words.csv') {
                                const newOption = document.createElement('option');
                                newOption.value = csvFilename;
                                newOption.textContent = csvFilename;
                                select.appendChild(newOption);
                                select.value = csvFilename;
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`❌ 部屋${roomNumber}の設定読み込みエラー:`, error);
                    });
            });
        }

        // CSVファイル一覧を読み込む関数
        function loadCsvFilesList() {

            const container = document.getElementById('csv-files-container');
            if (container) {
                container.innerHTML = '<p class="text-info">📋 ファイル一覧を読み込み中...</p>';
            }

            fetch('{{ url_for("admin_list_room_csv_files") }}')
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        updateCsvFilesDisplay(data.files);
                        updateCsvSelectOptions(data.files);
                    } else {
                        console.error('❌ ファイル一覧取得失敗:', data.message);
                        if (container) {
                            container.innerHTML = '<p class="text-danger">❌ ファイル一覧の取得に失敗しました: ' + (data.message || '不明なエラー') + '</p>';
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ ファイル一覧取得エラー:', error);
                    if (container) {
                        container.innerHTML = '<p class="text-danger">❌ ファイル一覧の取得中にエラーが発生しました: ' + error.message + '</p>';
                    }
                });
        }

        function formatTimestamp(dateString) {
            // バックエンドから返されるタイムスタンプは既にJST
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // CSVファイル表示を更新する関数
        function updateCsvFilesDisplay(files) {

            const container = document.getElementById('csv-files-container');
            if (!container) {
                console.error('❌ csv-files-container が見つかりません');
                return;
            }

            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted">📭 アップロードされたCSVファイルはありません。</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead class="table-dark"><tr><th>ファイル名</th><th>単語数</th><th>サイズ</th><th>更新日時</th><th>操作</th></tr></thead><tbody>';

            files.forEach((file, index) => {
                const sizeKB = Math.round(file.size / 1024);
                const wordCountDisplay = file.word_count > 0 ? `${file.word_count}問` : '不明';

                html += '<tr>' +
                    '<td><code>' + file.filename + '</code></td>' +
                    '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                    '<td>' + sizeKB + ' KB</td>' +
                    '<td><small>' + formatTimestamp(file.modified) + '</small></td>' +
                    '<td><button type="button" class="btn btn-danger btn-sm" onclick="deleteCsvFile(event, \'' + file.filename + '\')">削除</button></td>' +
                    '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // セレクトボックスのオプションを更新する関数
        function updateCsvSelectOptions(files) {
            const selects = document.querySelectorAll('.csv-setting-select');

            selects.forEach((select, index) => {
                const roomNumber = select.dataset.roomNumber;
                const currentValue = select.value;

                // デフォルト以外のオプションを削除
                Array.from(select.options).forEach(option => {
                    if (option.value !== 'words.csv') {
                        option.remove();
                    }
                });

                // アップロードされたファイルをオプションに追加
                if (files && Array.isArray(files)) {
                    files.forEach(file => {
                        if (file.filename !== 'words.csv') {
                            const option = document.createElement('option');
                            option.value = file.filename;
                            option.textContent = file.filename;
                            select.appendChild(option);
                        }
                    });
                }

                // 元の値を復元
                if (currentValue && currentValue !== '') {
                    select.value = currentValue;
                }
            });
        }

        // CSVファイル削除関数
        function deleteCsvFile(event, filename) {
            if (event) event.preventDefault();

            showConfirmModal(
                'CSVファイル削除',
                'CSVファイル "' + filename + '" を削除しますか？\n\n⚠️ このファイルを使用している部屋の設定はデフォルトに戻ります。',
                () => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("admin_delete_room_csv", filename="_FILENAME_") }}'.replace('_FILENAME_', filename);

                    document.body.appendChild(form);
                    form.submit();
                },
                '削除',
                'btn-danger'
            );
        }

        // ユーザーテーブルのソート機能
        function initializeUserTableSort() {
            const table = document.getElementById('userTable');
            const tbody = document.getElementById('userTableBody');

            if (!table || !tbody) return;

            // ソートアイコンクリック処理
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.addEventListener('click', function () {
                    const column = this.dataset.column;
                    const isAscending = this.classList.contains('fa-sort-up');

                    // 全アイコンをリセット
                    document.querySelectorAll('.sort-icon').forEach(i => {
                        i.className = 'fas fa-sort sort-icon';
                    });

                    // 現在のアイコンを更新
                    this.className = `fas fa-sort-${isAscending ? 'down' : 'up'} sort-icon`;

                    sortUserTable(column, !isAscending);
                });
            });
        }

        // ユーザーテーブル初期化
        function initializeUserTable() {

            const sortIcons = document.querySelectorAll('.sort-icon[data-column]');

            if (sortIcons.length === 0) {
                console.warn('⚠️ ソートアイコンが見つかりません');
                return;
            }

            sortIcons.forEach(icon => {
                icon.addEventListener('click', function () {
                    const column = this.getAttribute('data-column');

                    // 現在のソート状態を確認
                    const isCurrentlyAscending = this.classList.contains('fa-sort-up');

                    // 全てのソートアイコンをリセット
                    document.querySelectorAll('.sort-icon[data-column]').forEach(otherIcon => {
                        otherIcon.className = 'fas fa-sort sort-icon';
                    });

                    // クリックされたアイコンの状態を更新
                    const newAscending = !isCurrentlyAscending;
                    this.className = `fas fa-sort-${newAscending ? 'up' : 'down'} sort-icon`;

                    // ソートを実行
                    sortUserTable(column, newAscending);
                });

            });

        }

        // ★修正：ソート関数（最終ログイン列削除に対応）
        function sortUserTable(column, ascending) {

            const tbody = document.getElementById('userTableBody');
            if (!tbody) {
                console.error('❌ userTableBodyが見つかりません');
                return;
            }

            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) {
                console.warn('⚠️ ソート対象の行がありません');
                return;
            }

            rows.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'room':
                        // 部屋番号のソート（数値として比較）
                        aVal = a.cells[1] ? a.cells[1].textContent.trim() : '';
                        bVal = b.cells[1] ? b.cells[1].textContent.trim() : '';
                        aVal = parseInt(aVal.replace(/[^0-9]/g, '')) || 0;
                        bVal = parseInt(bVal.replace(/[^0-9]/g, '')) || 0;
                        break;

                    case 'name':
                        // アカウント名のソート（文字列として比較）
                        aVal = a.cells[3] ? a.cells[3].textContent.trim().toLowerCase() : '';
                        bVal = b.cells[3] ? b.cells[3].textContent.trim().toLowerCase() : '';
                        break;

                    default:
                        console.warn(`⚠️ 未対応のソート列: ${column}`);
                        return 0;
                }

                // 比較処理
                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });

            // テーブルを再構築
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function initializeUserFiltering() {

            const roomSelect = document.getElementById('roomSortSelect');
            const searchInput = document.getElementById('userSearchInput');

            if (!roomSelect) {
                console.error('❌ roomSortSelectが見つかりません');
                return;
            }

            if (!searchInput) {
                console.error('❌ userSearchInputが見つかりません');
                return;
            }

            // 部屋選択のイベントリスナー
            roomSelect.addEventListener('change', function () {
                filterUsers();
            });

            // 検索入力のイベントリスナー
            searchInput.addEventListener('input', function () {
                filterUsers();
            });
        }

        // ★修正：フィルター関数（デバッグ情報を追加）
        function filterUsers() {

            const roomSelect = document.getElementById('roomSortSelect');
            const searchInput = document.getElementById('userSearchInput');
            const tbody = document.getElementById('userTableBody');

            if (!tbody) {
                console.error('❌ userTableBodyが見つかりません');
                return;
            }

            const selectedRoom = roomSelect ? roomSelect.value : '';
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;

            rows.forEach((row, index) => {
                // データ属性から値を取得
                const roomValue = row.getAttribute('data-room') || '';
                const nameValue = row.getAttribute('data-name') || '';
                const studentValue = row.getAttribute('data-student') || '';

                // フィルター条件の判定
                const roomMatch = !selectedRoom || roomValue === selectedRoom;
                const searchMatch = !searchTerm ||
                    nameValue.includes(searchTerm) ||
                    studentValue.includes(searchTerm);

                const shouldShow = roomMatch && searchMatch;
                row.style.display = shouldShow ? '' : 'none';

                if (shouldShow) visibleCount++;
            });
        }

        // ★修正：デバッグ関数（問題診断用）
        function debugUserTable() {
            const tbody = document.getElementById('userTableBody');
            const roomSelect = document.getElementById('roomSortSelect');
            const searchInput = document.getElementById('userSearchInput');
            const sortIcons = document.querySelectorAll('.sort-icon[data-column]');

            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                if (rows.length > 0) {
                    const firstRow = rows[0];
                }
            }

            if (roomSelect) {
                Array.from(roomSelect.options).forEach((option, index) => {
                });
            }
        }

        // ユーザー削除機能（安全版）
        function deleteUserSafe(button) {
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');

            if (!userId || !username) {
                alert('❌ ユーザー情報の取得に失敗しました。');
                return;
            }

            const confirmMessage = `ユーザー「${username}」を削除しますか？\n\n⚠️ この操作は元に戻せません\n⚠️ 学習履歴も全て削除されます\n\n削除を実行しますか？`;

            showConfirmModal(
                'ユーザー削除',
                confirmMessage,
                () => {
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = '削除中...';

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/delete_user/${userId}`;
                    form.style.display = 'none';

                    document.body.appendChild(form);
                    form.submit();
                },
                '削除',
                'btn-danger'
            );
        }
        window.debugUserTable = debugUserTable;
        window.filterUsers = filterUsers;

        // ========================================
        // 3. DOMContentLoaded イベントリスナー
        // ========================================
        document.addEventListener('DOMContentLoaded', function () {

            // ========================================
            // 0. 一括削除機能
            // ========================================
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedUserCountSpan = document.getElementById('selectedUserCount');

            if (selectAllCheckbox && bulkDeleteBtn && selectedUserCountSpan) {
                function updateBulkDeleteButton() {
                    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                    const count = selectedCheckboxes.length;
                    selectedUserCountSpan.textContent = count;
                    bulkDeleteBtn.disabled = count === 0;
                }

                selectAllCheckbox.addEventListener('change', function () {
                    const isChecked = this.checked;
                    // 現在表示されている（display != 'none'）行のチェックボックスのみを対象
                    document.querySelectorAll('#userTableBody tr').forEach(row => {
                        if (row.style.display !== 'none') {
                            const checkbox = row.querySelector('.user-checkbox');
                            if (checkbox) {
                                checkbox.checked = isChecked;
                            }
                        }
                    });
                    updateBulkDeleteButton();
                });

                userCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateBulkDeleteButton);
                });

                bulkDeleteBtn.addEventListener('click', function (event) {
                    event.preventDefault();
                    const selectedIds = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);

                    if (selectedIds.length === 0) {
                        alert('削除するユーザーが選択されていません。');
                        return;
                    }

                    showConfirmModal(
                        '一括削除',
                        `${selectedIds.length}人のユーザーを本当に削除しますか？\\n\\n⚠️ この操作は元に戻せません。`,
                        () => {
                            fetch('/admin/bulk_delete_users', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ user_ids: selectedIds }),
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert(data.message);
                                        window.location.reload();
                                    } else {
                                        alert('エラー: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('一括削除エラー:', error);
                                    alert('一括削除中にエラーが発生しました。');
                                });
                        },
                        '一括削除',
                        'btn-danger'
                    );
                });
            }

            // ========================================
            // 1. 基本機能の初期化（最優先）
            // ========================================

            // 折りたたみ機能の初期化
            initializeCollapseSections();

            // ========================================
            // 2. ユーザー削除機能（イベント委譲）
            // ========================================

            document.addEventListener('click', function (event) {
                // ユーザー削除
                if (event.target.closest('.delete-user-btn')) {
                    event.preventDefault();
                    const button = event.target.closest('.delete-user-btn');
                    const userId = button.getAttribute('data-user-id');
                    const username = button.getAttribute('data-username');

                    if (userId && username) {
                        deleteUserSafe(button);
                    } else {
                        alert('❌ ユーザー情報の取得に失敗しました。');
                    }
                }

                // Introリセット
                if (event.target.closest('.reset-intro-btn')) {
                    event.preventDefault();
                    const button = event.target.closest('.reset-intro-btn');
                    const userId = button.getAttribute('data-user-id');
                    const username = button.getAttribute('data-username');

                    if (userId && username) {
                        showConfirmModal(
                            'Introフラグリセット',
                            `ユーザー「${username}」のRPG導入フラグをリセットしますか？\n\n再度ログインした際にRPGのイントロが表示されるようになります。`,
                            () => {
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = `/admin/reset_intro_flag/${userId}`;
                                document.body.appendChild(form);
                                form.submit();
                            },
                            'リセット',
                            'btn-info'
                        );
                    }
                }
            });

            // ========================================
            // 3. 論述問題フォーム初期化
            // ========================================

            setTimeout(() => {

                const essayForm = document.getElementById('newEssayProblemForm');

                if (essayForm) {
                    essayForm.addEventListener('submit', function (e) {
                        e.preventDefault();

                        const form = this;
                        const formData = new FormData(form);

                        // 必須項目の確認
                        const chapter = formData.get('chapter');
                        const question = formData.get('question');
                        const type = formData.get('type');

                        if (!chapter || !question || !type) {
                            alert('❌ 章、タイプ、問題文は必須項目です。');
                            return;
                        }

                        // 有効フラグの処理
                        const enabledCheckbox = document.getElementById('new_essay_enabled');
                        if (enabledCheckbox && enabledCheckbox.checked) {
                            formData.set('enabled', 'on');
                        } else {
                            formData.delete('enabled');
                        }

                        const submitBtn = form.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 追加中...';

                        // FormDataで送信（画像ファイル対応）
                        fetch('/admin/essay/add_problem', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    let message = '✅ ' + data.message;
                                    if (data.has_image) {
                                        message += ' （画像付き）';
                                    }
                                    alert(message);

                                    // フォームをリセット
                                    form.reset();
                                    if (typeof clearImagePreview === 'function') {
                                        clearImagePreview();
                                    }
                                    document.getElementById('new_essay_enabled').checked = true;

                                    // 統計情報を更新
                                    if (typeof loadEssayStats === 'function') {
                                        loadEssayStats();
                                    }
                                    if (typeof loadEssayProblems === 'function') {
                                        loadEssayProblems();
                                    }
                                } else {
                                    alert('❌ エラー: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('追加エラー:', error);
                                alert('❌ 追加中にエラーが発生しました。');
                            })
                            .finally(() => {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            });
                    });
                }

                // 画像プレビュー機能
                window.previewImage = function (input) {
                    const previewDiv = document.getElementById('imagePreview');
                    if (!previewDiv) return;

                    if (input.files && input.files[0]) {
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            previewDiv.innerHTML = `
                        <div class="image-preview-container">
                            <img src="${e.target.result}" alt="プレビュー" 
                                 style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                                    onclick="clearImagePreview()">
                                <i class="fas fa-times"></i> 削除
                            </button>
                        </div>
                    `;
                        };

                        reader.readAsDataURL(input.files[0]);
                    } else {
                        clearImagePreview();
                    }
                };

                // 画像プレビューをクリア
                window.clearImagePreview = function () {
                    const previewDiv = document.getElementById('imagePreview');
                    const imageInput = document.getElementById('new_essay_image');

                    if (previewDiv) {
                        previewDiv.innerHTML = '';
                    }
                    if (imageInput) {
                        imageInput.value = '';
                    }
                };
            }, 500);

            // ========================================
            // 4. CSVファイル一覧を自動読み込み
            // ========================================

            setTimeout(() => {
                if (typeof loadCsvFilesList === 'function') {
                    loadCsvFilesList();
                } else {
                    console.warn('loadCsvFilesList関数が見つかりません');
                }
            }, 1000);

            // ========================================
            // 5. 部屋設定を自動読み込み & 保存ボタン初期化
            // ========================================


            setTimeout(() => {

                if (typeof loadRoomSettings === 'function') {
                    loadRoomSettings();
                }

                // 既存のイベントリスナーを削除して新しいものに置き換え
                const saveButtons = document.querySelectorAll('.save-room-setting-btn');


                saveButtons.forEach(button => {
                    button.replaceWith(button.cloneNode(true));
                });

                // 新しいイベントリスナーを追加
                document.querySelectorAll('.save-room-setting-btn').forEach(button => {

                    button.addEventListener('click', function (event) {

                        event.preventDefault(); // フォーム送信を防ぐ
                        const roomNumber = this.dataset.roomNumber;
                        const csvFileSelect = document.getElementById('csvFile_' + roomNumber);

                        if (!csvFileSelect) {
                            showInfoModal('エラー', '設定要素が見つかりません。', 'error');
                            return;
                        }

                        // 選択された単元を取得
                        const selectedUnits = getSelectedUnits(roomNumber);
                        const csvFilename = csvFileSelect.value;
                        const managerPasswordInput = document.getElementById('managerPassword_' + roomNumber);
                        const managerPassword = managerPasswordInput ? managerPasswordInput.value : '';

                        // ボタンを無効化して重複実行を防ぐ
                        this.disabled = true;
                        this.textContent = '保存中...';

                        // 単元設定、CSVファイル設定を同時に更新
                        Promise.all([
                            fetch('/admin/update_room_units_setting', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    room_number: roomNumber,
                                    enabled_units: selectedUnits
                                })
                            }),
                            fetch('/admin/update_room_csv_setting', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    room_number: roomNumber,
                                    csv_filename: csvFilename
                                })
                            }),
                            fetch('/admin/update_room_management_password', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    room_number: roomNumber,
                                    password: managerPassword
                                })
                            })
                        ])
                            .then(responses => {
                                return Promise.all(responses.map(r => r.json()));
                            })
                            .then(results => {
                                const unitResult = results[0];
                                const csvResult = results[1];
                                const passwordResult = results[2];

                                if (unitResult.status === 'success' && csvResult.status === 'success' && passwordResult.status === 'success') {
                                    let msg = `✅ 部屋 ${roomNumber} の設定を更新しました:\n・有効単元: ${selectedUnits.length}個\n・CSVファイル: ${csvFilename}`;
                                    if (managerPassword) {
                                        msg += `\n・管理パスワード: 更新しました`;
                                        // 入力欄をクリア
                                        if (managerPasswordInput) {
                                            managerPasswordInput.value = '';
                                        }
                                    }
                                    showInfoModal('保存完了', msg, 'success');

                                    // 設定を再読み込み
                                    loadRoomSettings();
                                } else {
                                    const errorMsg = (unitResult.message || csvResult.message || '不明なエラー');
                                    showInfoModal('保存エラー', '❌ 設定の保存中にエラーが発生しました: ' + errorMsg, 'error');
                                    console.error('❌ 保存エラー:', { unitResult, csvResult });
                                }
                            })
                            .catch(error => {
                                console.error('❌ 保存処理中にエラー:', error);
                                showInfoModal('通信エラー', '❌ 設定の保存中にエラーが発生しました: ' + error.message, 'error');
                            })
                            .finally(() => {
                                // ボタンを元に戻す
                                this.disabled = false;
                                this.textContent = '保存';
                            });
                    });
                });
            }, 1500);

            // ========================================
            // 6. ユーザー管理初期化
            // ========================================

            setTimeout(function () {
                // デバッグ情報を出力
                if (typeof debugUserTable === 'function') {
                    debugUserTable();
                }

                // ユーザーテーブル機能の初期化
                if (typeof initializeUserTable === 'function') {
                    initializeUserTable();
                }

                // フィルタリング機能の初期化
                if (typeof initializeUserFiltering === 'function') {
                    initializeUserFiltering();
                }
            }, 2000);

            // ========================================
            // 7. 論述問題関連の初期化
            // ========================================

            setTimeout(() => {
                // 論述問題統計のみ読み込み（問題一覧は検索時のみ）
                if (document.getElementById('essay-stats-container')) {
                    if (typeof loadEssayStats === 'function') {
                        loadEssayStats();
                    }
                }
                // 初期状態のメッセージを設定
                const problemsContainer = document.getElementById('essay-problems-container');
                if (problemsContainer) {
                    problemsContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-search"></i><br>章、タイプ、またはキーワードを指定して検索してください</div>';
                }


                // 論述問題フィルター機能の初期化
                const essayChapterFilter = document.getElementById('essayChapterFilter');
                const essayTypeFilter = document.getElementById('essayTypeFilter');
                const essaySearch = document.getElementById('essaySearch');

                if (essayChapterFilter) {
                    essayChapterFilter.addEventListener('change', function () {
                        if (typeof loadEssayProblems === 'function') {
                            loadEssayProblems();
                        } else if (typeof filterEssayProblems === 'function') {
                            filterEssayProblems();
                        }
                    });
                }
                if (essayTypeFilter) {
                    essayTypeFilter.addEventListener('change', function () {
                        if (typeof loadEssayProblems === 'function') {
                            loadEssayProblems();
                        } else if (typeof filterEssayProblems === 'function') {
                            filterEssayProblems();
                        }
                    });
                }
                if (essaySearch) {
                    let searchTimeout;
                    essaySearch.addEventListener('input', function () {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            // 入力値が3文字未満の場合は検索しない（空白の場合は初期状態に戻す）
                            const searchValue = this.value.trim();
                            if (searchValue.length > 0 && searchValue.length < 3) {
                                return; // 3文字未満は検索しない
                            }

                            if (typeof loadEssayProblems === 'function') {
                                loadEssayProblems();
                            } else if (typeof filterEssayProblems === 'function') {
                                filterEssayProblems();
                            }
                        }, 800); // デバウンス時間を500ms→800msに延長
                    });
                }
            }, 2500);

            // ========================================
            // 8. 論述問題公開設定初期化
            // ========================================

            setTimeout(() => {
                if (typeof initializeVisibilitySettings === 'function') {
                    initializeVisibilitySettings();
                }
            }, 3000);

            // ========================================
            // 9. デバッグモード設定（削除済み）
            // ========================================

            // ========================================
            // 10. 最終チェック
            // ========================================

            setTimeout(() => {
                // 各種要素の存在確認
                const essayForm = document.getElementById('newEssayProblemForm');
                const userTable = document.getElementById('userTable');
                const csvUpload = document.getElementById('csvUploadForm');
                const visibilityMatrix = document.getElementById('visibilityMatrix');
            }, 4000);
        });

        // ========================================
        // 4. データベース管理系の関数
        // ========================================

        // 無効履歴の削除
        function cleanInvalidHistory(event) {
            if (event) event.preventDefault();

            showConfirmModal(
                '無効履歴削除',
                '無効な学習履歴を削除しますか？\n\n⚠️ この操作は元に戻せません\n⚠️ 現在の問題データと一致しない履歴が完全に削除されます\n⚠️ 有効な履歴は保持されます\n\n削除を実行しますか？',
                () => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = '削除中...';

                    fetch('/admin/safe_clean_execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(`✅ ${data.message || '削除が完了しました'}\n削除数: ${data.removed_entries}`);
                                location.reload();
                            } else {
                                alert(`❌ エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('削除エラー:', error);
                            alert('❌ 削除中にエラーが発生しました。');
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = originalText;
                        });
                },
                '削除',
                'btn-warning'
            );
        }

        function cleanupOrphanedTokens(event) {
            if (event) event.preventDefault();

            showConfirmModal(
                'トークンクリーンアップ',
                '孤立したパスワードリセットトークンを削除しますか？\n\n※削除されたユーザーに関連する古いトークンが対象です。',
                () => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = 'クリーンアップ中...';

                    fetch('/admin/cleanup_orphaned_tokens', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(`✅ ${data.message}`);
                            } else {
                                alert(`❌ エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('クリーンアップエラー:', error);
                            alert('❌ クリーンアップ中にエラーが発生しました。'); // Closing brace and parenthesis will follow in original code
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = originalText;
                        });
                },
                '実行',
                'btn-warning'
            );
        }

        function checkDatabaseStatus(event) {
            if (event) event.preventDefault();
            fetch('/admin/check_database_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const status = data.database_status;
                        let message = '📊 データベース状態確認結果:\n\n';

                        for (const [tableName, tableInfo] of Object.entries(status.tables)) {
                            message += `📋 ${tableName}: ${tableInfo.exists ? '存在' : '不在'}\n`;
                            if (tableInfo.missing_columns.length > 0) {
                                message += `   不足カラム: ${tableInfo.missing_columns.join(', ')}\n`;
                            }
                        }

                        if (status.needs_migration) {
                            message += '\n⚠️ マイグレーションが必要です。';
                        } else {
                            message += '\n✅ データベースは正常です。';
                        }

                        alert(message);
                    } else {
                        alert(`❌ エラー: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('状態確認エラー:', error);
                    alert('❌ データベース状態確認中にエラーが発生しました。');
                });
        }

        // 特定ユーザーの強制削除
        function forceCleanSpecificUser(event) {
            if (event) event.preventDefault();
            const username = document.getElementById('debugUsername').value.trim();
            if (!username) {
                alert('ユーザー名を入力してください。');
                return;
            }

            showConfirmModal(
                '強制削除確認',
                `ユーザー「${username}」の不一致履歴を強制削除しますか？\n\n⚠️ この操作は元に戻せません\n⚠️ 無効なIDの履歴のみが削除されます`,
                () => {
                    // フォームを作成して送信
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/force_clean_user/${encodeURIComponent(username)}`;

                    document.body.appendChild(form);
                    form.submit();
                },
                '削除',
                'btn-danger'
            );
        }

        function checkUserStats(event) {
            if (event) event.preventDefault();
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '確認中...';

            fetch('/admin/check_user_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayStatsCheckResult(data);
                    } else {
                        alert(`❌ エラー: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('統計確認エラー:', error);
                    alert('❌ 統計確認中にエラーが発生しました。');
                })
                .finally(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                });
        }

        // 統計確認結果の表示
        function displayStatsCheckResult(data) {
            const resultDiv = document.getElementById('statsCheckResult');
            const contentDiv = document.getElementById('statsCheckContent');

            const summary = data.summary;
            const roomStats = data.room_stats;

            let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>📊 全体統計</h6>
                <ul>
                    <li>総ユーザー数: ${summary.total_users}人</li>
                    <li>統計データ数: ${summary.total_stats}個</li>
                    <li>統計なしユーザー: ${summary.users_without_stats}人</li>
                    <li>古い統計: ${summary.outdated_stats}個</li>
                    <li>カバー率: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>💡 推奨アクション</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ?
                    '<p class="text-success">✅ 統計データは最新です。修復は不要です。</p>' :
                    `<p class="text-warning">⚠️ ${summary.users_without_stats + summary.outdated_stats}件の統計に問題があります。<br>「統計データを修復」の実行を推奨します。</p>`
                }
            </div>
        </div>
    `;

            if (roomStats.length > 0) {
                html += '<h6>🏠 部屋別統計</h6>';
                html += '<div class="table-responsive"><table class="table table-sm table-striped">';
                html += '<thead><tr><th>部屋番号</th><th>ユーザー数</th><th>平均スコア</th><th>最高スコア</th></tr></thead><tbody>';

                roomStats.forEach(room => {
                    html += `<tr>
                <td><span class="badge bg-secondary">${room.room_number}</span></td>
                <td>${room.user_count}人</td>
                <td>${room.avg_score}</td>
                <td class="text-success"><strong>${room.max_score}</strong></td>
            </tr>`;
                });

                html += '</tbody></table></div>';
            }

            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        // 統計データの修復
        function repairUserStats(event) {
            if (event) event.preventDefault();

            showConfirmModal(
                '統計データ修復',
                '統計データの修復を実行しますか？\n\n・統計がないユーザーに新規作成\n・古い統計データを更新\n\n処理に時間がかかる場合があります。',
                () => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = '修復中...';

                    fetch('/admin/repair_user_stats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(`✅ ${data.message}`);
                                // 修復後に状態を再確認
                                setTimeout(() => checkUserStats(), 1000);
                            } else {
                                alert(`❌ エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('修復エラー:', error);
                            alert('❌ 修復中にエラーが発生しました。');
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = originalText;
                        });
                },
                '実行',
                'btn-warning'
            );
        }

        // 全統計の強制再初期化
        function initializeAllStats(event) {
            if (event) event.preventDefault();

            showConfirmModal(
                '全統計初期化',
                '全ユーザーの統計を強制再初期化しますか？\n\n⚠️ この操作は時間がかかります\n⚠️ 全ての統計データが再計算されます\n\n実行しますか？',
                () => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = '初期化中...';

                    fetch('/admin/initialize_user_stats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(`✅ ${data.message}`);
                                // 初期化後に状態を再確認
                                setTimeout(() => checkUserStats(), 1000);
                            } else {
                                alert(`❌ エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('初期化エラー:', error);
                            alert('❌ 初期化中にエラーが発生しました。');
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = originalText;
                        });
                },
                '初期化',
                'btn-danger'
            );
        }

        // ========================================
        // 汎用モーダル関数
        // ========================================

        /**
         * 確認モーダルを表示する
         * @param {string} title - モーダルのタイトル
         * @param {string} message - モーダルのメッセージ
         * @param {function} onConfirm - 「実行」ボタンが押された時のコールバック
         * @param {string} [confirmText='実行'] - 実行ボタンのテキスト
         * @param {string} [confirmClass='btn-primary'] - 実行ボタンのクラス
         */
        function showConfirmModal(title, message, onConfirm, confirmText = '実行', confirmClass = 'btn-primary') {
            const modalDom = document.getElementById('utilityModal');
            let modalEl = bootstrap.Modal.getInstance(modalDom);
            if (!modalEl) {
                modalEl = new bootstrap.Modal(modalDom);
            }
            const titleEl = document.getElementById('utilityModalLabel');
            const bodyEl = document.getElementById('utilityModalBody');
            const confirmBtn = document.getElementById('utilityModalConfirmBtn');
            const cancelBtn = document.getElementById('utilityModalCancelBtn');

            // テキスト設定
            titleEl.textContent = title;
            bodyEl.textContent = message;
            confirmBtn.textContent = confirmText;

            // ボタンクラスのリセットと設定
            confirmBtn.className = 'btn ' + confirmClass;

            // キャンセルボタンを表示
            cancelBtn.style.display = 'inline-block';

            // イベントリスナーのクリーンアップ（重要：多重登録防止）
            // jQueryのoff()ではなく、cloneNodeで置き換えるのが安全だが、
            // ここでは単純化のためにonclickプロパティを使用する
            confirmBtn.onclick = function () {
                modalEl.hide();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            };

            modalEl.show();
        }

        /**
         * 情報モーダル（アラート）を表示する
         * @param {string} title - モーダルのタイトル
         * @param {string} message - モーダルのメッセージ
         * @param {string} [type='info'] - タイプ ('info', 'success', 'error')
         */
        function showInfoModal(title, message, type = 'info') {
            const modalDom = document.getElementById('utilityModal');
            let modalEl = bootstrap.Modal.getInstance(modalDom);
            if (!modalEl) {
                modalEl = new bootstrap.Modal(modalDom);
            }
            const titleEl = document.getElementById('utilityModalLabel');
            const bodyEl = document.getElementById('utilityModalBody');
            const confirmBtn = document.getElementById('utilityModalConfirmBtn');
            const cancelBtn = document.getElementById('utilityModalCancelBtn');

            // テキスト設定
            titleEl.textContent = title;
            bodyEl.textContent = message;

            // タイプに応じたスタイル設定
            let btnClass = 'btn-primary';
            if (type === 'success') btnClass = 'btn-success';
            if (type === 'error') btnClass = 'btn-danger';

            confirmBtn.textContent = 'OK';
            confirmBtn.className = 'btn ' + btnClass;

            // キャンセルボタンを非表示
            cancelBtn.style.display = 'none';

            // OKボタンの動作（閉じるだけ）
            confirmBtn.onclick = function () {
                modalEl.hide();
            };

            modalEl.show();
        }

        // グローバルスコープに公開
        window.showConfirmModal = showConfirmModal;
        window.showInfoModal = showInfoModal;

        // ========================================
        // 単元選択管理機能
        // ========================================

        // 利用可能な単元一覧を読み込む
        function loadAvailableUnits(roomNumber) {
            const container = document.getElementById(`unitAccordion_${roomNumber}`);
            if (!container) return;

            container.innerHTML = '<p class="text-info">読み込み中...</p>';

            fetch(`/admin/get_available_units/${roomNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayUnitCheckboxes(roomNumber, {
                            units_by_chapter: data.units_by_chapter,
                            chapters: data.chapters
                        });
                        loadCurrentUnitSettings(roomNumber);
                    } else {
                        container.innerHTML = '<p class="text-danger">エラー: ' + data.message + '</p>';
                    }
                })
                .catch(error => {
                    console.error('単元一覧取得エラー:', error);
                    container.innerHTML = '<p class="text-danger">単元一覧の取得に失敗しました</p>';
                });
        }

        // 単元チェックボックスをタブ形式で表示
        function displayUnitCheckboxes(roomNumber, unitsData) {
            const container = document.getElementById(`unitAccordion_${roomNumber}`);
            if (!container) return;

            const { units_by_chapter, chapters } = unitsData;

            if (!chapters || chapters.length === 0) {
                container.innerHTML = '<p class="text-muted">利用可能な単元がありません</p>';
                return;
            }

            // タブナビゲーション
            let tabsHtml = '<div class="unit-tabs-wrapper"><ul class="nav nav-tabs unit-tabs" role="tablist">';
            chapters.forEach((chapter, index) => {
                const chapterLabel = chapter === 'Z' ? 'Z問題' :
                    chapter === 'S' ? 'S章' :
                        `第${chapter}章`;
                const activeClass = index === 0 ? 'active' : '';
                const tabId = `tab-${chapter}-${roomNumber}`;
                const paneId = `pane-${chapter}-${roomNumber}`;

                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${activeClass}" id="${tabId}" 
                                data-bs-toggle="tab" data-bs-target="#${paneId}" 
                                type="button" role="tab" aria-controls="${paneId}" 
                                aria-selected="${index === 0}">
                            ${chapterLabel}
                        </button>
                    </li>
                `;
            });
            tabsHtml += '</ul></div>';

            // タブコンテンツ
            let contentHtml = '<div class="tab-content unit-tab-content">';
            chapters.forEach((chapter, index) => {
                const units = units_by_chapter[chapter] || [];
                const activeClass = index === 0 ? 'show active' : '';
                const paneId = `pane-${chapter}-${roomNumber}`;

                contentHtml += `
                    <div class="tab-pane fade ${activeClass}" id="${paneId}" role="tabpanel" aria-labelledby="tab-${chapter}-${roomNumber}">
                        <div class="tab-controls">
                            <button class="btn btn-sm btn-success" onclick="selectChapterUnits('${roomNumber}', '${chapter}')" title="この章の全単元を選択">
                                <i class="fas fa-check-double"></i> 全選択
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="clearChapterUnits('${roomNumber}', '${chapter}')" title="この章の全単元を解除">
                                <i class="fas fa-times"></i> 全解除
                            </button>
                        </div>
                        <div class="units-grid">
                            ${units.map(unitInfo => {
                    const unitNum = unitInfo.number;
                    const unitName = unitInfo.name;
                    const displayText = unitName ? `${unitNum} - ${unitName}` : unitNum;

                    return `
                                    <div class="form-check unit-checkbox-item">
                                        <input class="form-check-input chapter-${chapter}-unit" type="checkbox" 
                                               id="unit_${roomNumber}_${unitNum}" 
                                               value="${unitNum}"
                                               data-chapter="${chapter}"
                                               onchange="updateSelectedCount('${roomNumber}')">
                                        <label class="form-check-label" for="unit_${roomNumber}_${unitNum}">
                                            ${displayText}
                                        </label>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            });
            contentHtml += '</div>';

            container.innerHTML = tabsHtml + contentHtml;
        }

        // 現在の単元設定を読み込み
        function loadCurrentUnitSettings(roomNumber) {
            fetch('/admin/get_room_setting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_number: roomNumber })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.enabled_units) {
                        const enabledUnits = data.enabled_units;

                        // チェックボックスの状態を更新
                        enabledUnits.forEach(unit => {
                            const checkbox = document.getElementById(`unit_${roomNumber}_${unit}`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });

                        updateSelectedCount(roomNumber);
                    }
                })
                .catch(error => {
                    console.error('現在設定の取得エラー:', error);
                });
        }

        // 選択された単元数を更新
        function updateSelectedCount(roomNumber) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} input[type="checkbox"]:checked`);
            const countElement = document.getElementById(`selectedCount_${roomNumber}`);

            if (countElement) {
                countElement.textContent = checkboxes.length;
            }
        }

        // 全ての単元を選択
        function selectAllUnits(roomNumber) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount(roomNumber);
        }

        // 全ての単元選択を解除
        function clearAllUnits(roomNumber) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount(roomNumber);
        }

        // 章ごとの全単元を選択
        function selectChapterUnits(roomNumber, chapter) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} .chapter-${chapter}-unit`);
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateSelectedCount(roomNumber);
        }

        // 章ごとの全単元選択を解除
        function clearChapterUnits(roomNumber, chapter) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} .chapter-${chapter}-unit`);
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectedCount(roomNumber);
        }

        // 選択された単元のリストを取得
        function getSelectedUnits(roomNumber) {
            const checkboxes = document.querySelectorAll(`#unitAccordion_${roomNumber} input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 論述問題CSVテンプレートダウンロード
        function downloadEssayTemplate() {
            const link = document.createElement('a');
            link.href = '/admin/download_essay_template';
            link.download = 'essay_problems_template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 論述問題統計をロード
        function loadEssayStats() {
            fetch('/admin/essay/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateEssayStatistics(data);

                        // 章リストを取得して動的にフィルターを更新
                        fetch('/admin/essay/chapters')
                            .then(response => response.json())
                            .then(chaptersData => {
                                if (chaptersData.status === 'success') {
                                    updateChapterFilter(chaptersData.chapters);
                                }
                            })
                            .catch(error => console.error('章リスト取得エラー:', error));
                    }
                })
                .catch(error => {
                    console.error('統計取得エラー:', error);
                });
        }

        // 論述問題CSVアップロード
        const essayUploadForm = document.getElementById('essayUploadForm');
        if (essayUploadForm) {
            essayUploadForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const fileInput = document.getElementById('essay_csv_file');
                const replaceCheckbox = document.getElementById('replaceExisting');
                const submitBtn = this.querySelector('button[type="submit"]');

                if (!fileInput.files.length) {
                    alert('❌ CSVファイルを選択してください。');
                    return;
                }

                const file = fileInput.files[0];
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('❌ CSVファイルを選択してください。');
                    return;
                }

                // 既存データ削除の確認
                if (replaceCheckbox.checked) {
                    // ここで一旦処理を停止し、モーダルを表示
                    showConfirmModal(
                        '既存データの削除',
                        '⚠️ 既存の全ての論述問題が削除されます。本当に実行しますか？',
                        () => {
                            executeEssayUpload(); // コールバックでアップロード処理を実行
                        },
                        'アップロード',
                        'btn-danger'
                    );
                    return;
                }

                executeEssayUpload(); // 確認不要な場合は直接実行

                function executeEssayUpload() {

                    const formData = new FormData();
                    formData.append('file', file);
                    if (replaceCheckbox.checked) {
                        formData.append('replace_existing', 'on');
                    }

                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> アップロード中...';

                    fetch('/admin/essay/upload_csv', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                let message = `✅ ${data.message}`;
                                if (data.added_count > 0) {
                                    message += `\n📊 追加された問題数: ${data.added_count}件`;
                                }
                                if (data.error_count > 0) {
                                    message += `\n⚠️ エラー件数: ${data.error_count}件`;
                                }
                                if (data.error_details && data.error_details.length > 0) {
                                    message += `\n\n詳細なエラー:\n${data.error_details.join('\n')}`;
                                }
                                alert(message);

                                // フォームをリセット
                                essayUploadForm.reset();

                                // 統計情報を更新
                                loadEssayStats();
                                loadEssayProblems();
                            } else {
                                let errorMessage = `❌ エラー: ${data.message}`;
                                if (data.error_details && data.error_details.length > 0) {
                                    errorMessage += `\n\n詳細:\n${data.error_details.join('\n')}`;
                                }
                                alert(errorMessage);
                            }
                        })
                        .catch(error => {
                            console.error('アップロードエラー:', error);
                            alert('❌ アップロード中にエラーが発生しました。\nファイル形式とエンコーディング（UTF-8）を確認してください。');
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        });
                } // End of executeEssayUpload
            });
        }

        function loadEssayProblems() {
            const container = document.getElementById('essay-problems-container');
            if (!container) return;

            const chapter = document.getElementById('essayChapterFilter')?.value || '';
            const type = document.getElementById('essayTypeFilter')?.value || '';
            const search = document.getElementById('essaySearch')?.value || '';

            // フィルター条件が何も指定されていない場合は表示しない
            if (!chapter && !type && !search) {
                container.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-search"></i><br>章、タイプ、またはキーワードを指定して検索してください</div>';
                return;
            }

            container.innerHTML = '<p class="text-info">📋 問題一覧を読み込み中...</p>';


            const params = new URLSearchParams();
            if (chapter) params.append('chapter', chapter);
            if (type) params.append('type', type);
            if (search) params.append('search', search);

            fetch('/admin/essay/problems?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 章フィルターを更新（データに章リストが含まれている場合）
                        if (data.chapters && data.chapters.length > 0) {
                            updateChapterFilter(data.chapters);
                        }

                        // 問題一覧を表示
                        if (data.problems && data.problems.length > 0) {
                            // 統計サマリーを簡略化
                            let html = `
                        <div class="essay-stats-summary">
                            <div class="stat-item">
                                <div class="stat-value">${data.problems.length}</div>
                                <div class="stat-label">検索結果</div>
                            </div>
                        </div>
                        <div class="essay-problems-list">
                    `;


                            // 各問題を表示
                            data.problems.forEach(problem => {
                                const typeColor = {
                                    'A': 'type-A',
                                    'B': 'type-B',
                                    'C': 'type-C',
                                    'D': 'type-D'
                                }[problem.type] || '';

                                const enabledBadge = problem.enabled
                                    ? '<span class="badge bg-success"><i class="fas fa-check"></i> 有効</span>'
                                    : '<span class="badge bg-secondary"><i class="fas fa-times"></i> 無効</span>';

                                // 問題文を短縮（100文字まで）
                                const shortQuestion = problem.question.length > 100
                                    ? problem.question.substring(0, 100) + '...'
                                    : problem.question;

                                html += `
                            <div class="essay-problem-item">
                                <div class="problem-header">
                                    <div class="problem-info">
                                        <span class="badge badge-chapter">
                                            <i class="fas fa-book"></i> 第${problem.chapter}章
                                        </span>
                                        <span class="badge badge-${typeColor}">
                                            <i class="fas fa-tag"></i> タイプ${problem.type}
                                        </span>
                                        ${enabledBadge}
                                        <div class="university-info">
                                            <i class="fas fa-university"></i>
                                            <span>${problem.university} ${problem.year}年</span>
                                        </div>
                                    </div>
                                    <div class="problem-actions">
                                        <button class="btn btn-sm btn-info" onclick="editEssayProblem(${problem.id})" title="編集">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="toggleEssayProblem(${problem.id}, ${problem.enabled})" title="有効/無効">
                                            <i class="fas fa-toggle-${problem.enabled ? 'on' : 'off'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteEssayProblem(${problem.id})" title="削除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="problem-content">
                                    <p class="problem-question">
                                        <strong>問題:</strong> ${shortQuestion}
                                    </p>
                                </div>
                                <div class="problem-meta">
                                    <div class="problem-meta-item">
                                        <i class="fas fa-file-alt"></i>
                                        <span>解答: ${problem.answer_length}文字</span>
                                    </div>
                                    <div class="problem-meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>ID: ${problem.id}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                            });

                            html += '</div>';
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<p class="text-warning">⚠️ 該当する問題が見つかりませんでした。</p>';
                        }
                    } else {
                        container.innerHTML = '<p class="text-danger">❌ エラー: ' + data.message + '</p>';
                    }
                })
                .catch(error => {
                    console.error('読み込みエラー:', error);
                    container.innerHTML = '<p class="text-danger">❌ 問題一覧の読み込み中にエラーが発生しました。</p>';
                });
        }

        // 論述問題一覧を表示
        function displayEssayProblems(problems) {
            const container = document.getElementById('essay-problems-container');

            if (!problems || !Array.isArray(problems)) {
                container.innerHTML = '<p class="text-danger">❌ 問題データが不正です</p>';
                return;
            }

            if (problems.length === 0) {
                container.innerHTML = '<p class="text-muted">📭 条件に合う論述問題が見つかりません。</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
            html += '<thead class="table-dark"><tr>';
            html += '<th>ID</th><th>章</th><th>タイプ</th><th>大学</th><th>年度</th>';
            html += '<th>問題文（抜粋）</th><th>文字数</th><th>状態</th><th>操作</th>';
            html += '</tr></thead><tbody>';

            problems.forEach(problem => {
                // 各プロパティの存在を確認
                const questionPreview = (problem.question && problem.question.length > 50) ?
                    problem.question.substring(0, 50) + '...' : (problem.question || '問題文なし');

                html += '<tr>';
                html += '<td>' + (problem.id || 'N/A') + '</td>';
                html += '<td><span class="badge bg-secondary">' + (problem.chapter || 'N/A') + '</span></td>';
                html += '<td><span class="badge bg-' + getTypeColor(problem.type || 'A') + '">' + (problem.type || 'A') + '</span></td>';
                html += '<td>' + (problem.university || '未設定') + '</td>';
                html += '<td>' + (problem.year || 'N/A') + '</td>';
                html += '<td><small>' + questionPreview + '</small></td>';
                html += '<td>' + (problem.answer_length || 0) + '字</td>';
                html += '<td>';
                if (problem.enabled) {
                    html += '<span class="badge bg-success">有効</span>';
                } else {
                    html += '<span class="badge bg-secondary">無効</span>';
                }
                html += '</td>';
                html += '<td>';
                html += '<div class="btn-group-vertical btn-group-sm">';
                html += '<button class="btn btn-primary btn-sm" onclick="editEssayProblem(' + (problem.id || 0) + ')">編集</button>';
                html += '<button class="btn btn-warning btn-sm" onclick="toggleEssayProblem(' + (problem.id || 0) + ', ' + (problem.enabled || false) + ')">切替</button>';
                html += '<button class="btn btn-danger btn-sm" onclick="deleteEssayProblem(' + (problem.id || 0) + ')">削除</button>';
                html += '</div></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // タイプ別の色を取得
        function getTypeColor(type) {
            switch (type) {
                case 'A': return 'danger';
                case 'B': return 'warning';
                case 'C': return 'info';
                case 'D': return 'success';
                default: return 'secondary';
            }
        }

        // 章フィルターを更新
        function updateChapterFilter(chapters) {
            const select = document.getElementById('essayChapterFilter');
            const currentValue = select.value;

            // 既存オプションを削除（最初の全ての章は残す）
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // 新しいオプションを追加
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                // 表示テキストをフォーマット
                if (chapter === 'com') {
                    option.textContent = '総合問題';
                } else if (!isNaN(chapter)) {
                    option.textContent = '第' + chapter + '章';
                } else {
                    option.textContent = chapter;
                }
                select.appendChild(option);
            });

            // 値を復元
            select.value = currentValue;
        }

        // 論述問題編集
        function editEssayProblem(problemId) {
            // まず問題データを取得
            fetch(`/admin/essay/problem/${problemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showEditDialog(data.problem);
                    } else {
                        alert('❌ エラー: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('問題取得エラー:', error);
                    alert('❌ 問題データの取得中にエラーが発生しました。');
                });
        }

        // 論述問題更新（共通関数）
        function updateEssayProblem(problemId, updateData) {
            fetch('/admin/essay/update_problem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problem_id: problemId,
                    ...updateData
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ ' + data.message);
                        loadEssayProblems();
                    } else {
                        alert('❌ エラー: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('更新エラー:', error);
                    alert('❌ 更新中にエラーが発生しました。');
                });
        }

        function showEditDialog(problem) {
            // 既存のモーダルがあれば削除
            const existingModal = document.getElementById('editEssayModal');
            if (existingModal) {
                existingModal.remove();
            }

            // モーダルHTML作成
            const modalHTML = `
        <div class="modal fade" id="editEssayModal" tabindex="-1" aria-labelledby="editEssayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="editEssayModalLabel">
                            <i class="fas fa-edit"></i> 論述問題編集 (ID: ${problem.id})
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEssayForm">
                            <input type="hidden" id="edit_problem_id" value="${problem.id}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_chapter" class="form-label">
                                            <i class="fas fa-bookmark"></i> 章 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit_chapter" value="${problem.chapter}" required>
                                        <small class="form-text text-muted">例: 1, 2, com</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_type" class="form-label">
                                            <i class="fas fa-tag"></i> タイプ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control" id="edit_type" required>
                                            <option value="A" ${problem.type === 'A' ? 'selected' : ''}>タイプA (200字以上)</option>
                                            <option value="B" ${problem.type === 'B' ? 'selected' : ''}>タイプB (100-150字程度)</option>
                                            <option value="C" ${problem.type === 'C' ? 'selected' : ''}>タイプC (50-75字程度)</option>
                                            <option value="D" ${problem.type === 'D' ? 'selected' : ''}>タイプD (30字程度)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="edit_university" class="form-label">
                                            <i class="fas fa-university"></i> 大学名
                                        </label>
                                        <input type="text" class="form-control" id="edit_university" value="${problem.university || ''}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_year" class="form-label">
                                            <i class="fas fa-calendar-alt"></i> 年度
                                        </label>
                                        <input type="number" class="form-control" id="edit_year" value="${problem.year || 2025}" min="2000" max="2030">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_question" class="form-label">
                                    <i class="fas fa-question-circle"></i> 問題文 <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="edit_question" rows="4" required>${problem.question}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_answer" class="form-label">
                                    <i class="fas fa-lightbulb"></i> 模範解答
                                </label>
                                <div class="textarea-wrapper">
                                    <textarea class="form-control" id="edit_answer" rows="6"
                                            oninput="updateAnswerCharCount('edit_answer', 'answerLength')">${problem.answer || ''}</textarea>
                                    <div class="char-counter" id="answerLength">${(problem.answer || '').length}字</div>
                                </div>
                                <small class="form-text text-muted">文字数が表示されます</small>
                            </div>

                            <!-- 画像管理セクションを追加 -->
                            <div class="mb-3">
                                <label class="form-label"><strong><i class="fas fa-image"></i> 問題画像</strong></label>
                                <div class="image-management-section" id="imageManagement_${problem.id}">
                                    <!-- 現在の画像があるかチェック -->
                                    <div class="current-image-section" id="currentImageSection_${problem.id}" style="display: none;">
                                        <div class="image-preview">
                                            <img src="/essay_image/${problem.id}" 
                                                alt="問題画像" 
                                                style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;"
                                                onerror="this.parentElement.parentElement.style.display='none'; document.getElementById('noImageSection_${problem.id}').style.display='block';">
                                        </div>
                                        <div class="image-actions mt-2">
                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteEssayImageFromEdit(${problem.id})">
                                                <i class="fas fa-trash"></i> 画像を削除
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadInEdit(${problem.id})">
                                                <i class="fas fa-exchange-alt"></i> 画像を変更
                                            </button>
                                        </div>
                                    </div>
                                        
                                    <!-- 画像なしの場合 -->
                                    <div class="no-image-section" id="noImageSection_${problem.id}" style="display: ${problem.has_image ? 'none' : 'block'};">
                                        <p class="text-muted"><i class="fas fa-image"></i> 画像は設定されていません</p>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="showImageUploadInEdit(${problem.id})">
                                            <i class="fas fa-upload"></i> 画像をアップロード
                                        </button>
                                    </div>
                                    
                                    <!-- 画像アップロードフォーム（初期状態では非表示） -->
                                    <div class="image-upload-section" id="imageUploadSection_${problem.id}" style="display: none;">
                                        <form id="imageUploadForm_${problem.id}" enctype="multipart/form-data">
                                            <div class="form-group mb-2">
                                                <input type="file" id="imageInput_${problem.id}" name="image" 
                                                    accept="image/*" class="form-control" required>
                                                <small class="form-text text-muted">
                                                    対応形式: PNG, JPG, JPEG, GIF (最大5MB)
                                                </small>
                                            </div>
                                            <div class="form-group">
                                                <button type="button" id="uploadBtn_${problem.id}" class="btn btn-success btn-sm" onclick="uploadEssayImageFromEdit(${problem.id})">
                                                    <i class="fas fa-upload"></i> アップロード
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="hideImageUploadInEdit(${problem.id})">
                                                    <i class="fas fa-times"></i> キャンセル
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_enabled" ${problem.enabled ? 'checked' : ''}>
                                <label class="form-check-label" for="edit_enabled">
                                    <i class="fas fa-check-circle"></i> 有効にする
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> キャンセル
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveEssayProblem()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

            // DOMに追加
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            initializeCharCount('edit_answer', 'answerLength');

            // モーダル表示
            const modal = new bootstrap.Modal(document.getElementById('editEssayModal'));
            modal.show();

            // モーダルが閉じられた時の cleanup
            document.getElementById('editEssayModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });

            // モーダル表示後に画像の存在チェック
            setTimeout(() => {
                checkAndShowImage(problem.id);
            }, 100);

        }

        function saveEssayProblem() {
            const problemId = document.getElementById('edit_problem_id').value;
            const submitBtn = document.querySelector('#editEssayModal .btn-primary');
            const originalText = submitBtn.innerHTML;

            // バリデーション
            const chapter = document.getElementById('edit_chapter').value.trim();
            const question = document.getElementById('edit_question').value.trim();
            const type = document.getElementById('edit_type').value;

            if (!chapter || !question || !type) {
                alert('❌ 章、タイプ、問題文は必須項目です。');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

            const data = {
                problem_id: parseInt(problemId),
                chapter: chapter,
                type: type,
                university: document.getElementById('edit_university').value.trim() || '未指定',
                year: parseInt(document.getElementById('edit_year').value) || 2025,
                question: question,
                answer: document.getElementById('edit_answer').value.trim() || '解答なし',
                enabled: document.getElementById('edit_enabled').checked
            };

            fetch('/admin/essay/update_problem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ ' + data.message);

                        // モーダルを閉じる
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editEssayModal'));
                        modal.hide();

                        // 問題一覧を更新
                        loadEssayProblems();
                        loadEssayStats();
                    } else {
                        alert('❌ エラー: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('保存エラー:', error);
                    alert('❌ 保存中にエラーが発生しました。');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
        }

        // フィルター機能を改善
        function filterEssayProblems() {
            loadEssayProblems();
        }

        // 編集内容を保存
        function saveEditedProblem(problemId) {
            const formData = {
                chapter: document.getElementById('edit_chapter').value,
                type: document.getElementById('edit_type').value,
                university: document.getElementById('edit_university').value,
                year: parseInt(document.getElementById('edit_year').value),
                question: document.getElementById('edit_question').value,
                answer: document.getElementById('edit_answer').value,
                enabled: document.getElementById('edit_enabled').checked
            };

            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            // ★ POSTメソッドに変更し、URLも変更
            fetch('/admin/essay/update_problem', {
                method: 'POST',  // PUT から POST に変更
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problem_id: problemId,  // ★ problem_id を追加
                    ...formData
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('✅ ' + data.message);
                        // モーダルを閉じる
                        bootstrap.Modal.getInstance(document.getElementById('editEssayModal')).hide();
                        loadEssayProblems();
                        if (typeof loadEssayStats === 'function') {
                            loadEssayStats();
                        }
                    } else {
                        alert('❌ エラー: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('保存エラー:', error);
                    alert('❌ 保存中にエラーが発生しました。');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                });
        }

        // 論述問題の有効/無効切り替え
        function toggleEssayProblem(problemId, currentEnabled) {
            const newStatus = !currentEnabled;
            const action = newStatus ? '有効' : '無効';

            showConfirmModal(
                '公開状態の変更',
                'この問題を' + action + 'にしますか？',
                () => {
                    fetch('/admin/essay/toggle_enabled', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            problem_id: problemId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('✅ ' + data.message);
                                loadEssayProblems();
                                loadEssayStats();
                            } else {
                                alert('❌ エラー: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('切り替えエラー:', error);
                            alert('❌ 切り替え中にエラーが発生しました。');
                        });
                },
                '変更',
                'btn-primary'
            );
        }

        // loadEssayStats関数が定義されていない場合のフォールバック
        if (typeof loadEssayStats === 'undefined') {
            window.loadEssayStats = function () {
                // 統計の再読み込みを試行
                if (typeof updateEssayStatistics === 'function') {
                    updateEssayStatistics();
                }
            };
        }

        function updateEssayStatistics() {
            fetch('/admin/essay/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.stats) {
                        const statsElements = {
                            'totalEssayProblems': data.stats.total_problems || 0,
                            'enabledEssayProblems': data.stats.total_problems || 0,
                            'totalChapters': data.stats.total_chapters || 0,
                            'totalUniversities': data.stats.total_universities || 0
                        };

                        Object.entries(statsElements).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element) {
                                element.textContent = value;
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('統計更新エラー:', error);
                });
        }

        // 論述問題削除
        function deleteEssayProblem(problemId) {
            showConfirmModal(
                '論述問題削除',
                'この論述問題を削除しますか？\n\n⚠️ この操作は元に戻せません。',
                () => {
                    fetch('/admin/essay/delete_problem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            problem_id: problemId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('✅ ' + data.message);
                                loadEssayProblems();
                                if (typeof loadEssayStats === 'function') {
                                    loadEssayStats();
                                }
                            } else {
                                alert('❌ エラー: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('削除エラー:', error);
                            alert('❌ 削除中にエラーが発生しました。');
                        });
                },
                '削除',
                'btn-danger'
            );
        }

        // CSV出力
        function exportEssayProblems() {
            const chapter = document.getElementById('essayChapterFilter').value;
            const type = document.getElementById('essayTypeFilter').value;
            const search = document.getElementById('essaySearch').value;

            const params = new URLSearchParams();
            if (chapter) params.append('chapter', chapter);
            if (type) params.append('type', type);
            if (search) params.append('search', search);

            window.open('/admin/essay/export_csv?' + params.toString(), '_blank');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 画像プレビュー機能
        function previewImage(input) {
            const previewDiv = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    previewDiv.innerHTML = `
                <div class="image-preview-container">
                    <img src="${e.target.result}" alt="プレビュー" 
                         style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                            onclick="clearImagePreview()">
                        <i class="fas fa-times"></i> 削除
                    </button>
                </div>
            `;
                };

                reader.readAsDataURL(input.files[0]);
            } else {
                clearImagePreview();
            }
        }

        // 画像プレビューをクリア
        function clearImagePreview() {
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('new_essay_image').value = '';
        }

        // 論述問題追加の関数を修正
        function addEssayProblem() {
            const formData = {
                chapter: document.getElementById('add_chapter').value,
                type: document.getElementById('add_type').value,
                university: document.getElementById('add_university').value,
                year: document.getElementById('add_year').value,
                question: document.getElementById('add_question').value,
                answer: document.getElementById('add_answer').value,
                answer_length: document.getElementById('add_answer_length').value,
                enabled: document.getElementById('add_enabled').checked
            };

            fetch('/admin/essay/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {

                    // レスポンスの内容タイプをチェック
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`JSONではないレスポンス: ${contentType}`);
                    }

                    return response.json();
                })
                .then(data => {

                    if (data.status === 'success') {
                        alert(data.message);
                        document.getElementById('addEssayModal').style.display = 'none';
                        loadEssayProblems(); // 一覧を再読み込み
                    } else {
                        alert(`エラー: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('追加エラー:', error);

                    // より詳細なエラーメッセージ
                    if (error.message.includes('JSONではないレスポンス')) {
                        alert('サーバーでエラーが発生しました。管理者に連絡してください。');
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        alert('ネットワークエラーが発生しました。接続を確認してください。');
                    } else {
                        alert(`追加中にエラーが発生しました: ${error.message}`);
                    }
                });
        }

        // 論述問題公開設定管理のJavaScript（改善版）

        let currentVisibilitySettings = {};
        let availableChapters = [];
        let availableTypes = ['A', 'B', 'C', 'D'];

        function initializeVisibilitySettings() {
            // 部屋一覧を読み込み
            loadRoomList();

            // イベントリスナーを設定
            document.getElementById('visibilityRoomSelect').addEventListener('change', function () {
                const selectedRoom = this.value;
                const loadBtn = document.getElementById('loadVisibilitySettings');
                const saveBtn = document.getElementById('saveVisibilitySettings');
                const resetBtn = document.getElementById('resetVisibilitySettings');

                if (selectedRoom) {
                    loadBtn.disabled = false;
                    saveBtn.disabled = false;
                    resetBtn.disabled = false;
                } else {
                    loadBtn.disabled = true;
                    saveBtn.disabled = true;
                    resetBtn.disabled = true;
                    document.getElementById('visibilityMatrix').style.display = 'none';
                }
            });

            document.getElementById('loadVisibilitySettings').addEventListener('click', loadVisibilitySettings);
            document.getElementById('saveVisibilitySettings').addEventListener('click', saveVisibilitySettings);
            document.getElementById('resetVisibilitySettings').addEventListener('click', resetVisibilitySettings);

            // タイプヘッダーにクリックイベントを追加
            const typeHeaders = document.querySelectorAll('.grid-header.grid-cell-type');
            typeHeaders.forEach((header, index) => {
                if (index < availableTypes.length) {
                    const type = availableTypes[index];
                    header.style.cursor = 'pointer';
                    header.title = `${type}タイプを一括切り替え`;
                    header.addEventListener('click', () => toggleTypeVisibility(type));

                    // ホバー効果のためのクラス追加
                    header.classList.add('clickable-header');
                }
            });
        }

        function loadRoomList() {
            fetch('/admin/get_room_list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const select = document.getElementById('visibilityRoomSelect');

                        // 既存オプションをクリア（最初のオプションは残す）
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }

                        // 部屋番号を追加
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room;
                            option.textContent = `部屋 ${room}`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('部屋一覧読み込みエラー:', error);
                    showVisibilityStatus('error', '部屋一覧の読み込みに失敗しました');
                });
        }

        function loadVisibilitySettings() {
            const roomNumber = document.getElementById('visibilityRoomSelect').value;
            if (!roomNumber) return;

            showVisibilityStatus('info', '設定を読み込み中...');

            fetch(`/admin/essay_visibility_settings/${roomNumber}`)
                .then(response => response.json())
                .then(data => {

                    if (data.status === 'success') {
                        try {
                            currentVisibilitySettings = data.settings;
                            availableChapters = data.chapters;

                            createVisibilityMatrix();
                            updateSettingsSummary();
                            showVisibilityStatus('success', `部屋 ${roomNumber} の設定を読み込みました`);
                        } catch (e) {
                            console.error('❌ 設定反映エラー:', e);
                            showVisibilityStatus('error', '設定の表示中にエラーが発生しました: ' + e.message);
                        }
                    } else {
                        console.error('❌ 設定読み込みエラー:', data.message);
                        showVisibilityStatus('error', data.message);
                    }
                })
                .catch(error => {
                    console.error('❌ 設定読み込み例外:', error);
                    showVisibilityStatus('error', '設定の読み込みに失敗しました');
                });
        }

        function createVisibilityMatrix() {
            const gridContainer = document.getElementById('visibilityGrid');

            // ヘッダー以外のセルをクリア
            const existingCells = gridContainer.querySelectorAll(':not(.grid-header)');
            existingCells.forEach(cell => cell.remove());

            // CSS変数を動的に設定
            document.documentElement.style.setProperty('--type-count', availableTypes.length);

            // 各章ごとにグリッド行を生成
            availableChapters.forEach(chapter => {
                // 章名セル（クリック可能）
                const chapterCell = document.createElement('div');
                chapterCell.className = 'grid-cell-chapter';

                // ラベルの生成
                let chapterLabel = `第${chapter}章`;
                if (chapter === 'com') {
                    chapterLabel = '総合問題';
                }

                chapterCell.textContent = chapterLabel;
                chapterCell.setAttribute('data-chapter', chapter);

                // 章名セルクリックで一括設定
                chapterCell.addEventListener('click', function (event) {
                    event.stopPropagation();
                    toggleChapterVisibility(chapter);
                });

                gridContainer.appendChild(chapterCell);

                // 各タイプのセル
                availableTypes.forEach(type => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell-setting';

                    // 設定状態を取得
                    const isVisible = getVisibilitySetting(chapter, type);

                    // アイコン要素
                    const iconElement = document.createElement('i');
                    iconElement.className = `${isVisible ? 'fas fa-eye' : 'fas fa-eye-slash'} setting-icon`;

                    // テキスト要素
                    const textElement = document.createElement('div');
                    textElement.className = 'setting-text';
                    textElement.textContent = isVisible ? '公開' : '非公開';

                    // セルに追加
                    cell.appendChild(iconElement);
                    cell.appendChild(textElement);

                    // 状態クラス設定
                    cell.classList.add(isVisible ? 'visible' : 'hidden');

                    // クリックイベント
                    cell.addEventListener('click', function (event) {
                        event.stopPropagation();
                        toggleIndividualVisibility(chapter, type, cell);
                    });

                    // データ属性設定
                    cell.setAttribute('data-chapter', chapter);
                    cell.setAttribute('data-type', type);
                    cell.setAttribute('data-visible', isVisible);

                    gridContainer.appendChild(cell);
                });
            });

            document.getElementById('visibilityMatrix').style.display = 'block';

        }

        function updateCellAppearance(cell, isVisible) {
            // ★重要：セル内容を完全にクリアしてから再構築
            cell.innerHTML = '';

            // クラス更新
            cell.classList.remove('visible', 'hidden');
            cell.classList.add(isVisible ? 'visible' : 'hidden');

            // 新しいアイコン要素を作成
            const iconElement = document.createElement('i');
            iconElement.className = `${isVisible ? 'fas fa-eye' : 'fas fa-eye-slash'} setting-icon`;

            // 新しいテキスト要素を作成
            const textElement = document.createElement('div');
            textElement.className = 'setting-text';
            textElement.textContent = isVisible ? '公開' : '非公開';

            // セルに追加
            cell.appendChild(iconElement);
            cell.appendChild(textElement);

            // データ属性更新
            cell.setAttribute('data-visible', isVisible);

        }

        // 章全体の一括設定機能
        function toggleChapterVisibility(chapter) {

            // 該当章の現在の状態を確認
            const chapterCells = document.querySelectorAll(`[data-chapter="${chapter}"].grid-cell-setting`);

            if (chapterCells.length === 0) {
                console.warn(`第${chapter}章のセルが見つかりません`);
                return;
            }

            // 現在の状態を確認（過半数で判定）
            let visibleCount = 0;
            chapterCells.forEach(cell => {
                if (cell.getAttribute('data-visible') === 'true') {
                    visibleCount++;
                }
            });

            // 過半数が公開なら非公開に、そうでなければ公開に
            const newVisibility = visibleCount < (chapterCells.length / 2);

            // 各セルを更新
            chapterCells.forEach(cell => {
                const type = cell.getAttribute('data-type');

                // データ更新
                if (!currentVisibilitySettings[chapter]) {
                    currentVisibilitySettings[chapter] = {};
                }
                currentVisibilitySettings[chapter][type] = newVisibility;

                // 表示更新
                updateCellAppearance(cell, newVisibility);
            });

            // 章名セルのビジュアルフィードバック
            const chapterCell = document.querySelector(`[data-chapter="${chapter}"].grid-cell-chapter`);
            if (chapterCell) {
                chapterCell.style.animation = 'chapterUpdated 0.8s ease';
                setTimeout(() => {
                    chapterCell.style.animation = '';
                }, 800);
            }
        }

        // アニメーション追加
        const style = document.createElement('style');
        style.textContent = `
@keyframes chapterUpdated {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); background: linear-gradient(135deg, #c3e6cb 0%, #d4edda 100%) !important; }
    100% { transform: scale(1); }
}
`;
        document.head.appendChild(style);

        function getVisibilitySetting(chapter, type) {
            // 設定が存在する場合はその値、存在しない場合はデフォルトでtrue（公開）
            if (currentVisibilitySettings[chapter] && currentVisibilitySettings[chapter][type] !== undefined) {
                return currentVisibilitySettings[chapter][type];
            }
            return true;
        }

        // デバッグ用：マトリックスの状態確認
        function debugMatrixState() {
            const cells = document.querySelectorAll('.visibility-cell');
            cells.forEach((cell, index) => {
                const chapter = cell.getAttribute('data-chapter');
                const type = cell.getAttribute('data-type');
                const isVisible = cell.getAttribute('data-visible') === 'true';
                const hasContent = cell.querySelector('.visibility-cell-content');
            });

        }

        function toggleIndividualVisibility(chapter, type, cell) {
            // 現在の状態を取得
            const currentStatus = getVisibilitySetting(chapter, type);
            const newStatus = !currentStatus;

            // 設定オブジェクトの構造を確保
            if (!currentVisibilitySettings[chapter]) {
                currentVisibilitySettings[chapter] = {};
            }

            // 設定を更新
            currentVisibilitySettings[chapter][type] = newStatus;

            // セルの表示を更新
            updateCellAppearance(cell, newStatus);
        }

        function setTypeVisible(targetType, isVisible) {
            availableChapters.forEach(chapter => {
                if (!currentVisibilitySettings[chapter]) {
                    currentVisibilitySettings[chapter] = {};
                }
                currentVisibilitySettings[chapter][targetType] = isVisible;

                // セルを更新
                const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${targetType}"]`);
                if (cell) {
                    updateCellAppearance(cell, isVisible);
                    cell.classList.add('changed');
                    setTimeout(() => cell.classList.remove('changed'), 500);
                }
            });

            updateSettingsSummary();
            showVisibilityStatus('success', `全ての${targetType}問題を${isVisible ? '公開' : '非公開'}に設定しました`);
        }

        function updateSettingsSummary() {
            let visibleCount = 0;
            let totalCount = 0;

            availableChapters.forEach(chapter => {
                availableTypes.forEach(type => {
                    totalCount++;
                    if (getVisibilitySetting(chapter, type)) {
                        visibleCount++;
                    }
                });
            });

            const hiddenCount = totalCount - visibleCount;
            const visibilityRate = totalCount > 0 ? Math.round((visibleCount / totalCount) * 100) : 0;

            document.getElementById('visibleCount').textContent = visibleCount;
            document.getElementById('hiddenCount').textContent = hiddenCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('visibilityRate').textContent = visibilityRate + '%';
        }

        function saveVisibilitySettings() {
            const roomNumber = document.getElementById('visibilityRoomSelect').value;
            if (!roomNumber) {
                alert('部屋を選択してください');
                return;
            }

            // 保存ボタンを無効化して連続クリックを防止
            const saveBtn = document.getElementById('saveVisibilitySettings');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

            showVisibilityStatus('info', '設定を保存中...');

            fetch('/admin/essay_visibility_settings/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    room_number: roomNumber,
                    settings: currentVisibilitySettings
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        showVisibilityStatus('success', `${data.message}`);
                    } else {
                        showVisibilityStatus('error', data.message || '保存に失敗しました');
                    }
                })
                .catch(error => {
                    console.error('❌ 保存エラー:', error);
                    showVisibilityStatus('error', `保存に失敗しました: ${error.message}`);
                })
                .finally(() => {
                    // ボタンを元に戻す
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                });
        }

        function resetVisibilitySettings() {
            showConfirmModal(
                '設定リセット',
                '全ての設定を公開状態にリセットしますか？',
                () => {
                    setAllVisible(true);
                    showVisibilityStatus('info', '全ての設定を公開状態にリセットしました');
                },
                'リセット',
                'btn-warning'
            );
        }

        function setAllVisible(isVisible) {
            availableChapters.forEach(chapter => {
                if (!currentVisibilitySettings[chapter]) {
                    currentVisibilitySettings[chapter] = {};
                }
                availableTypes.forEach(type => {
                    currentVisibilitySettings[chapter][type] = isVisible;

                    // セルを更新
                    const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
                    if (cell) {
                        updateCellAppearance(cell, isVisible);
                    }
                });
            });
            updateSettingsSummary();
        }

        function toggleTypeVisibility(type) {
            // 現在の状態を確認（過半数で判定）
            let visibleCount = 0;
            let totalCount = 0;

            availableChapters.forEach(chapter => {
                totalCount++;
                if (getVisibilitySetting(chapter, type)) {
                    visibleCount++;
                }
            });

            // 過半数が公開なら非公開に、そうでなければ公開に
            const newVisibility = totalCount > 0 && visibleCount < (totalCount / 2);

            setTypeVisible(type, newVisibility);
        }

        function showVisibilityStatus(type, message) {
            const statusDiv = document.getElementById('visibilityStatus');
            if (!statusDiv) {
                console.error('❌ visibilityStatus要素が見つかりません');
                return;
            }

            const iconClass = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-triangle'
            }[type] || 'fas fa-info-circle';

            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';

            statusDiv.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

            // 5秒後に自動で非表示
            setTimeout(() => {
                const alert = statusDiv.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 150);
                }
            }, 5000);
        }

        // デバッグ用ヘルパー関数
        function debugVisibilitySettings() {
            // 各セルの状態をチェック
            availableChapters.forEach(chapter => {
                availableTypes.forEach(type => {
                    const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
                    const setting = getVisibilitySetting(chapter, type);
                    if (cell) {
                    }
                });
            });

        }

        // テスト用の関数
        function testIndividualClick(chapter, type) {
            const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
            if (cell) {
                cell.click();
            } else {
                console.error(`❌ セルが見つかりません: 第${chapter}章 タイプ${type}`);
            }
        }

        // 設定状況を表示する関数
        function showCurrentSettings() {
            const roomNumber = document.getElementById('visibilityRoomSelect').value;
            if (!roomNumber) {
                return;
            }
            console.table(currentVisibilitySettings);
        }

        // コンソールからデバッグ関数を呼び出せるようにグローバルに設定
        window.debugVisibilitySettings = debugVisibilitySettings;
        window.testIndividualClick = testIndividualClick;
        window.showCurrentSettings = showCurrentSettings;

        // 部屋削除機能
        function deleteRoom(event, roomNumber) {
            if (event) event.preventDefault();

            showConfirmModal(
                '部屋削除',
                `部屋${roomNumber}を本当に削除しますか？\n\n⚠️ この操作は元に戻せません。\n※ 部屋にユーザーが存在する場合は削除できません。`,
                () => {
                    fetch('/admin/delete_room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            room_number: roomNumber
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert(`エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('削除エラー:', error);
                            alert('削除中にエラーが発生しました');
                        });
                },
                '削除',
                'btn-danger'
            );
        }

        function confirmDeleteAnnouncement(btn) {
            const form = btn.closest('form');
            showConfirmModal(
                'お知らせ削除',
                '本当に削除しますか？',
                () => {
                    form.submit();
                },
                '削除',
                'btn-danger'
            );
        }

        function toggleRoomSuspension(event, buttonElement) {
            if (event) event.preventDefault();
            const roomNumber = buttonElement.getAttribute('data-room-number');
            const currentSuspendedState = buttonElement.getAttribute('data-is-suspended') === 'true';

            const action = currentSuspendedState ? '再開' : '一時停止';
            const confirmMessage = currentSuspendedState
                ? `部屋${roomNumber}の一時停止を解除しますか？\n\n解除後、この部屋のユーザーは再びログインできるようになります。`
                : `部屋${roomNumber}を一時停止にしますか？\n\n⚠️ 一時停止中は、この部屋のすべてのユーザーがログインできなくなります。\n※ 現在ログイン中のユーザーは次回ログイン時から制限されます。`;

            const confirmBtnClass = currentSuspendedState ? 'btn-success' : 'btn-warning';

            showConfirmModal(
                `部屋${roomNumber}の${action}`,
                confirmMessage,
                () => {
                    const originalHTML = buttonElement.innerHTML;
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';

                    fetch('/admin/toggle_room_suspension', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            room_number: roomNumber
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert(`エラー: ${data.message}`);
                                buttonElement.disabled = false;
                                buttonElement.innerHTML = originalHTML;
                            }
                        })
                        .catch(error => {
                            console.error('一時停止切り替えエラー:', error);
                            alert('処理中にエラーが発生しました');
                            buttonElement.disabled = false;
                            buttonElement.innerHTML = originalHTML;
                        });
                },
                action,
                confirmBtnClass
            );
        }

        // ========================================
        // 論述問題編集での画像管理機能
        // ========================================

        // 画像アップロードフォームを表示
        function showImageUploadInEdit(problemId) {
            document.getElementById('imageUploadSection_' + problemId).style.display = 'block';

            // 現在の画像表示ボタンのテキストを変更
            const changeBtn = document.querySelector(`#currentImageSection_${problemId} .btn-secondary`);
            if (changeBtn) {
                changeBtn.style.display = 'none';
            }
        }

        // 画像アップロードフォームを非表示
        function hideImageUploadInEdit(problemId) {
            const uploadSection = document.getElementById('imageUploadSection_' + problemId);
            const form = document.getElementById('imageUploadForm_' + problemId);

            // セクションを非表示
            if (uploadSection) {
                uploadSection.style.display = 'none';
            }

            // 現在の画像表示ボタンのテキストを変更
            const changeBtn = document.querySelector(`#currentImageSection_${problemId} .btn-secondary`);
            if (changeBtn) {
                changeBtn.style.display = 'inline-block';
            }

            // フォームが存在する場合のみリセット
            if (form) {
                try {
                    form.reset();
                } catch (error) {
                    console.warn('フォームのリセットに失敗しました:', error);
                    // フォームリセットに失敗してもファイル入力をクリア
                    const fileInput = document.getElementById('imageInput_' + problemId);
                    if (fileInput) {
                        fileInput.value = '';
                    }
                }
            }
        }

        // 編集モーダルから画像アップロード（改良版）
        function uploadEssayImageFromEdit(problemId) {

            const fileInput = document.getElementById('imageInput_' + problemId);

            if (!fileInput || !fileInput.files[0]) {
                alert('画像ファイルを選択してください');
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            // IDで直接ボタンを取得
            const uploadBtn = document.getElementById('uploadBtn_' + problemId);
            if (!uploadBtn) {
                console.error('アップロードボタンが見つかりません:', 'uploadBtn_' + problemId);
                alert('ボタンが見つかりません。ページを再読み込みしてください。');
                return;
            }

            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> アップロード中...';

            fetch(`/admin/upload_essay_image/${problemId}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {

                    if (data.status === 'success') {
                        alert(data.message);

                        // アップロードフォームを先に非表示
                        hideImageUploadInEdit(problemId);

                        // 少し遅延を入れてから画像をチェック・表示
                        setTimeout(() => {
                            checkAndShowImage(problemId);
                        }, 500);
                    } else {
                        alert(`エラー: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('アップロードエラー:', error);
                    alert('アップロード中にエラーが発生しました');
                })
                .finally(() => {
                    // ボタンを元に戻す
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = originalText;
                });
        }

        // 編集モーダルから画像削除
        function deleteEssayImageFromEdit(problemId) {
            showConfirmModal(
                '画像削除',
                'この画像を削除しますか？\n\n⚠️ この操作は元に戻せません。',
                () => {
                    fetch(`/admin/delete_essay_image/${problemId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert(data.message);

                                // 現在の画像セクションを非表示し、なしセクションを表示
                                document.getElementById('currentImageSection_' + problemId).style.display = 'none';
                                document.getElementById('noImageSection_' + problemId).style.display = 'block';

                                // アップロードフォームも非表示
                                hideImageUploadInEdit(problemId);
                            } else {
                                alert(`エラー: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('削除エラー:', error);
                            alert('削除中にエラーが発生しました');
                        });
                },
                '削除',
                'btn-danger'
            );
        }

        // 画像の存在チェックと表示切り替え
        function checkAndShowImage(problemId) {
            const img = new Image();
            img.onload = function () {
                // 画像が正常に読み込まれた場合
                document.getElementById('currentImageSection_' + problemId).style.display = 'block';
                document.getElementById('noImageSection_' + problemId).style.display = 'none';
            };
            img.onerror = function () {
                // 画像が読み込めない場合
                document.getElementById('currentImageSection_' + problemId).style.display = 'none';
                document.getElementById('noImageSection_' + problemId).style.display = 'block';
            };
            img.src = `/essay_image/${problemId}?t=${Date.now()}`;
        }

        // ========================================
        // 文字数カウンター機能
        // ========================================
        function updateAnswerCharCount(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);

            if (!textarea || !counter) {
                console.warn(`要素が見つかりません: ${textareaId} または ${counterId}`);
                return;
            }

            const currentLength = textarea.value.length;
            counter.textContent = `${currentLength}字`;

            // 文字数に応じてスタイル変更
            counter.classList.remove('warning', 'danger');

            if (currentLength > 500) {
                counter.classList.add('danger');
            } else if (currentLength > 300) {
                counter.classList.add('warning');
            }
        }

        function initializeCharCount(textareaId, counterId) {
            setTimeout(() => {
                updateAnswerCharCount(textareaId, counterId);
            }, 100);
        }

        // admin.html の <script> タグの末尾に追加

        // ========================================
        // 今日の10問 再選考機能
        // ========================================

        document.addEventListener('click', function (event) {
            // クラス名 .regenerate-quiz-btn を持つボタンを探す
            const button = event.target.closest('.regenerate-quiz-btn');
            if (button) {

                const roomNumber = button.dataset.roomNumber;

                showConfirmModal(
                    '今日の10問 再選考',
                    `部屋${roomNumber}の「今日の10問」を本当に再選考しますか？\n\n` +
                    `⚠️ この操作を行うと、この部屋の今日の解答結果はすべて削除され、ユーザーは再度挑戦できるようになります。`,
                    () => {
                        // ボタンをローディング状態にする
                        button.disabled = true;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';

                        fetch('/admin/regenerate_daily_quiz', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ room_number: roomNumber })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    showInfoModal('再選考完了', data.message, 'success');
                                } else {
                                    showInfoModal('エラー', `エラー: ${data.message}`, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showInfoModal('エラー', 'エラーが発生しました。コンソールを確認してください。', 'error');
                            })
                            .finally(() => {
                                // ボタンを元の状態に戻す
                                button.disabled = false;
                                button.innerHTML = '<i class="fas fa-sync-alt"></i> 10問 再選考';
                            });
                    },
                    '再選考',
                    'btn-warning'
                );
            }
        });
    </script>

    <style>
        /* ========================================
   1. 基本的な管理者パネルスタイル
   ======================================== */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .admin-header h2 {
            margin: 0;
            color: #343a40;
        }

        /* ========================================
   2. 折りたたみセクションのスタイル（修正版）
   ======================================== */
        .admin-section {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 20px !important;
            cursor: pointer;
            border-bottom: 1px solid #dee2e6;
            transition: all 0.3s ease;
            user-select: none;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .section-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.3rem;
            color: #495057;
            font-weight: 600;
        }

        .section-header h3 i:first-child {
            margin-right: 10px;
            color: #6c757d;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .section-header[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        /* ★重要：すべてのsection-contentを統一 */
        .section-content {
            padding: 25px !important;
            background-color: #fff !important;
            transition: all 0.3s ease;
            box-sizing: border-box !important;
        }

        /* 特定のセクションのpadding上書きを防ぐ */
        .admin-section .section-content {
            padding: 25px !important;
        }

        /* ネストされたコンテンツの調整 */
        .section-content>* {
            margin-bottom: 15px;
        }

        .section-content>*:last-child {
            margin-bottom: 0;
        }

        /* フォームコンテナのmargin統一 */
        .section-content .upload-form,
        .section-content .add-user-form,
        .section-content .essay-form-container,
        .section-content .csv-upload-form,
        .section-content .admin-panel {
            margin: 15px 0 !important;
            padding: 20px !important;
        }

        /* テーブルコンテナのmargin統一 */
        .section-content .scrollable-table-container,
        .section-content .table-controls {
            margin-bottom: 15px !important;
        }

        /* CSV関連セクションのpadding統一 */
        .section-content .csv-template-section,
        .section-content .csv-import-section,
        .section-content .essay-stats-section,
        .section-content .essay-management-section,
        .section-content .essay-form-section {
            margin: 15px 0 !important;
            padding: 20px !important;
        }

        /* 特定セクションの個別修正 */
        #section-user-management .section-content,
        #section-csv-management .section-content,
        #section-room-settings .section-content,
        #section-essay-visibility .section-content,
        #section-essay-management .section-content,
        #section-user-stats .section-content,
        #section-database-management .section-content {
            padding: 25px !important;
            box-sizing: border-box !important;
        }

        /* ========================================
   3. 管理者パネルのスタイル
   ======================================== */
        .admin-panel {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            width: 100%;
            box-sizing: border-box;
        }

        .admin-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #343a40;
        }

        .admin-panel p {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        /* ========================================
   4. テーブルとスクロールコンテナ
   ======================================== */
        .scrollable-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            /* 横スクロール追加 */
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .scrollable-table-container .table {
            margin-bottom: 0;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #343a40 !important;
        }

        .table-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .table-controls label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .table-responsive {
            overflow-x: auto !important;
        }

        /* ========================================
   5. ソートアイコンとインタラクティブ要素
   ======================================== */
        .sort-icon {
            margin-left: 5px;
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s;
            cursor: pointer;
        }

        .sort-icon:hover {
            opacity: 1;
            color: #ffc107;
        }

        .fa-sort-up {
            color: #28a745;
        }

        .fa-sort-down {
            color: #dc3545;
        }

        .badge {
            font-size: 0.8em;
        }

        #userTableBody tr:hover {
            background-color: #f8f9fa !important;
        }

        .delete-user-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* ========================================
   6. フォームとボタンのスタイル
   ======================================== */
        .upload-form,
        .add-user-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }

        /* ========================================
   7. アニメーションとトランジション
   ======================================== */
        .section-content {
            transition: all 0.3s ease;
        }

        .collapse {
            transition: height 0.35s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .clickable-header:hover {
            background-color: #e9ecef;
            text-decoration: underline;
        }

        @keyframes settingChanged {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            }

            100% {
                transform: scale(1);
            }
        }

        #invalidHistoryAnalysisResult,
        #userDebugResult,
        #statsCheckResult {
            animation: fadeIn 0.3s ease-in;
        }

        /* ========================================
   8. レスポンシブデザイン
   ======================================== */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .section-header {
                padding: 12px 15px !important;
            }

            .section-header h3 {
                font-size: 1.1rem;
            }

            .section-content {
                padding: 20px 15px !important;
            }

            .section-content .upload-form,
            .section-content .add-user-form,
            .section-content .admin-panel {
                padding: 15px !important;
                margin: 10px 0 !important;
            }

            .section-content .csv-template-section,
            .section-content .csv-import-section,
            .section-content .essay-stats-section,
            .section-content .essay-management-section,
            .section-content .essay-form-section {
                padding: 15px !important;
                margin: 10px 0 !important;
            }

            .btn-group-vertical {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .btn-group-vertical .btn {
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            .scrollable-table-container {
                max-height: 300px;
                overflow-x: auto;
            }

            .table {
                font-size: 0.8rem;
                min-width: 600px;
                /* 最小幅を保証 */
            }

            .table th,
            .table td {
                padding: 0.3rem;
                white-space: nowrap;
                min-width: 80px;
                /* 各セルの最小幅 */
            }

            .table-controls .row {
                margin-bottom: 0;
            }

            .table-controls .col-md-6 {
                margin-bottom: 10px;
            }

            /* 文字数カウンターのレスポンシブ対応 */
            .char-counter {
                font-size: 0.75rem;
                padding: 3px 6px;
                bottom: 8px;
                right: 8px;
            }

            .essay-answer-input,
            #edit_answer {
                padding-bottom: 30px !important;
                min-height: 140px !important;
                /* タブレットでも適切な高さ */
            }

            .essay-answer-input {
                min-height: 160px !important;
            }
        }

        @media (max-width: 480px) {
            .section-header h3 {
                font-size: 1rem;
            }

            .section-content {
                padding: 15px 10px !important;
            }

            .section-content .upload-form,
            .section-content .add-user-form,
            .section-content .admin-panel {
                padding: 12px !important;
                margin: 8px 0 !important;
            }

            .admin-panel {
                padding: 15px;
            }

            .table {
                font-size: 0.75rem;
            }

            /* 小画面での文字数カウンター調整 */
            .char-counter {
                font-size: 0.7rem;
                padding: 2px 4px;
                bottom: 6px;
                right: 6px;
            }

            .essay-answer-input,
            #edit_answer {
                padding-bottom: 25px !important;
                min-height: 120px !important;
                /* スマホでも最低限の高さ */
            }

            .essay-answer-input {
                min-height: 140px !important;
            }
        }

        /* ========================================
   9. 状態表示とフィードバック
   ======================================== */
        .text-success {
            color: #28a745 !important;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .text-info {
            color: #17a2b8 !important;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* ========================================
   10. 特殊な表示要素
   ======================================== */
        .csv-template-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f0f8ff;
            border: 1px solid #87ceeb;
            border-radius: 6px;
            border-left: 4px solid #17a2b8;
            width: 100%;
            box-sizing: border-box;
        }

        .flashes {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .flashes li {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .flashes li.success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .flashes li.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .flashes li.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .flashes li.info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        /* ========================================
   11. 単元選択用のスタイル
   ======================================== */


        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .unit-checkbox {
            margin: 0 !important;
            font-size: 0.9em;
        }

        .unit-checkbox .form-check-input {
            margin-right: 4px;
        }

        .unit-controls .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .selected-units-display {
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .units-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 6px;
            }

            .unit-setting-container {
                max-width: 100%;
            }
        }

        /* ========================================
   12. 論述問題管理用のスタイル
   ======================================== */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .essay-management-controls .form-control {
            font-size: 0.9rem;
        }

        .essay-management-controls label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .template-format {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 15px 0;
            line-height: 1.6;
        }

        .template-format code {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        #essay-problems-container .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 0;
        }

        #essay-problems-container .table th {
            background: #ef6c00;
            color: white;
            border: none;
            padding: 12px 8px;
            font-weight: 600;
        }

        #essay-problems-container .table td {
            padding: 10px 8px;
            border-color: #f0f0f0;
            vertical-align: middle;
        }

        #essay-problems-container .table tr:hover {
            background-color: #fff3e0;
        }

        #essay-problems-container .btn-group-vertical .btn {
            margin-bottom: 2px;
            font-size: 0.7rem;
            padding: 2px 6px;
        }

        /* ========================================
   13. 論述問題セクションのスタイル
   ======================================== */
        .essay-stats-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #90caf9;
        }

        .essay-stats-section h4 {
            color: #1565c0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .csv-import-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #81c784;
            width: 100%;
            box-sizing: border-box;
        }

        .csv-import-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .csv-template-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .csv-template-section h5 {
            color: #37474f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .csv-upload-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .upload-area {
            border: 2px dashed #90caf9;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #42a5f5;
            background: #f0f8ff;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .file-input-label {
            display: block;
            padding: 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            transform: translateY(-2px);
        }

        .file-input-label i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        #essay_csv_file {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-options {
            margin: 20px 0;
        }

        .upload-options .form-check {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-upload {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 25px;
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .essay-form-section {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 1px solid #ce93d8;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .essay-form-section h4 {
            color: #7b1fa2;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .essay-form-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .essay-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .essay-form-full-width {
            grid-column: 1 / -1;
        }

        .essay-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .essay-input-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .essay-input-group label i {
            color: #6c757d;
            width: 16px;
        }

        .essay-input-group input,
        .essay-input-group select,
        .essay-input-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fafafa;
            font-family: inherit;
        }

        .essay-input-group input:focus,
        .essay-input-group select:focus,
        .essay-input-group textarea:focus {
            outline: none;
            border-color: #7b1fa2;
            background: white;
            box-shadow: 0 0 0 3px rgba(123, 31, 162, 0.1);
        }

        .essay-question-input,
        .essay-answer-input {
            min-height: 120px !important;
            resize: vertical;
            line-height: 1.6;
        }

        .essay-checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .essay-checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #7b1fa2;
        }

        .essay-checkbox-group label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .essay-submit-btn {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }

        .essay-submit-btn:hover {
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 31, 162, 0.4);
        }

        .essay-submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .essay-help-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
            font-style: italic;
        }

        .essay-management-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 1px solid #ffb74d;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .essay-management-section h4 {
            color: #ef6c00;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .essay-filter-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .essay-filter-section label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }

        .essay-filter-section .form-control {
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 12px;
            transition: border-color 0.3s ease;
        }

        .essay-filter-section .form-control:focus {
            border-color: #ef6c00;
            box-shadow: 0 0 0 2px rgba(239, 108, 0, 0.1);
        }

        .essay-stats-summary {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 1px solid #ffb74d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f57c00;
        }

        /* ========================================
   14. 論述問題一覧のスタイル改善
   ======================================== */
        .essay-problem-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .essay-problem-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #ffa726;
        }

        /* Force Full Width for Inner Content */
        .card,
        .admin-panel,
        .csv-import-section,
        .essay-form-section,
        .csv-template-section,
        .unit-setting-container,
        .essay-form-container,
        .essay-management-section,
        .essay-filter-section,
        #essay-problems-container {
            max-width: 100% !important;
            width: 100% !important;
        }

        /* 単元設定コンテナの幅制限（テーブルセル内の拡張を防ぐ） */
        .unit-setting-container {
            max-width: 400px !important;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .problem-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .problem-info .badge {
            font-size: 0.85rem;
            padding: 5px 12px;
            font-weight: 500;
        }

        .badge-chapter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .badge-type-A {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .badge-type-B {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #333;
        }

        .badge-type-C {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .badge-type-D {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .university-info {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .university-info i {
            color: #ff6b6b;
        }

        .problem-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .problem-question {
            color: #2c3e50;
            line-height: 1.6;
            margin: 0;
            font-size: 1rem;
        }

        .problem-question strong {
            color: #e67e22;
            font-weight: 600;
        }

        .problem-meta {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.85rem;
            padding-top: 10px;
        }

        .problem-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .problem-meta-item i {
            color: #95a5a6;
        }

        .problem-actions {
            display: flex;
            gap: 5px;
        }

        .problem-actions .btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .problem-actions .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .problem-actions .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .problem-actions .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
        }

        .problem-actions .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
        }

        /* ========================================
           14B. タブ形式単元選択UI
           ======================================== */
        .unit-accordion {
            margin: 10px 0;
            max-width: 100%;
            overflow: hidden;
        }

        .unit-tabs-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .unit-tabs-wrapper::-webkit-scrollbar {
            height: 6px;
        }

        .unit-tabs-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .unit-tabs-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .unit-tabs-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .unit-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 0;
            display: flex;
            flex-wrap: nowrap;
        }

        .unit-tabs .nav-link {
            color: #495057;
            font-weight: 500;
            padding: 10px 20px;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .unit-tabs .nav-link:hover {
            background-color: #f8f9fa;
            border-bottom-color: #adb5bd;
        }

        .unit-tabs .nav-link.active {
            color: #28a745;
            background-color: #fff;
            border-bottom-color: #28a745;
            font-weight: 600;
        }

        .unit-tab-content {
            padding: 15px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 6px 6px;
        }

        .tab-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-controls .btn {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        .units-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3px;
            justify-items: start;
        }

        .unit-checkbox-item {
            margin: 0;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .unit-checkbox-item:hover {
            background: #e9ecef;
        }

        .unit-checkbox-item .form-check-input {
            margin-top: 0.3rem;
        }

        .unit-checkbox-item .form-check-label {
            font-size: 0.9rem;
            color: #495057;
            cursor: pointer;
            user-select: none;
            text-align: left;
            width: 100%;
        }

        .unit-checkbox-item .form-check-input:checked~.form-check-label {
            color: #28a745;
            font-weight: 600;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .unit-tabs .nav-link {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .units-grid {
                grid-template-columns: 1fr;
            }

            .tab-controls {
                flex-direction: column;
            }

            .tab-controls .btn {
                width: 100%;
            }
        }


        /* ========================================
   15. 論述問題公開設定マトリックス - CSS Grid レイアウト（修正版）
   ======================================== */
        .visibility-matrix {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 0 !important;
            margin: 15px 0 !important;
        }

        .matrix-header {
            color: #495057;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 20px 20px 0 20px !important;
        }

        .matrix-header h4 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .matrix-header p {
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .visibility-grid {
            margin: 0 20px 20px 20px !important;
            display: grid !important;
            grid-template-columns: 120px repeat(var(--type-count, 4), 1fr) !important;
            gap: 3px !important;
            background: #fff !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid #dee2e6 !important;
        }

        .grid-header {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
            color: white !important;
            font-weight: 600 !important;
            padding: 15px 8px !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 0.9rem !important;
        }

        .grid-cell-chapter {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%) !important;
            color: #495057 !important;
            font-weight: bold !important;
            border: 2px solid #dee2e6 !important;
            padding: 15px 8px !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 0.9rem !important;
            min-height: 60px !important;
        }

        .grid-cell-chapter:hover {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            border-color: #28a745 !important;
            transform: scale(1.02) !important;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3) !important;
        }

        .grid-cell-setting {
            background: #fff !important;
            border: 2px solid #dee2e6 !important;
            min-height: 60px !important;
            max-height: 60px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            position: relative !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
        }

        .grid-cell-setting .setting-icon {
            font-size: 1.3em !important;
            line-height: 1 !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            width: auto !important;
            height: auto !important;
        }

        .grid-cell-setting .setting-text {
            font-size: 0.8em !important;
            font-weight: 600 !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            text-align: center !important;
        }

        .grid-cell-setting.visible {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            border-color: #28a745 !important;
        }

        .grid-cell-setting.visible .setting-icon,
        .grid-cell-setting.visible .setting-text {
            color: #28a745 !important;
        }

        .grid-cell-setting.hidden {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%) !important;
            border-color: #dc3545 !important;
        }

        .grid-cell-setting.hidden .setting-icon,
        .grid-cell-setting.hidden .setting-text {
            color: #dc3545 !important;
        }

        .grid-cell-setting:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            z-index: 10 !important;
        }

        .save-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 0 20px 20px 20px !important;
        }

        /* ========================================
   16. 論述問題編集モーダル内の画像管理スタイル
   ======================================== */
        .image-management-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }

        .image-preview {
            text-align: center;
            margin-bottom: 10px;
        }

        .image-actions {
            text-align: center;
        }

        .image-actions .btn {
            margin: 0 5px;
        }

        .no-image-section {
            text-align: center;
            padding: 20px;
        }

        .image-upload-section {
            border-top: 1px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }

        .image-upload-section .form-group {
            margin-bottom: 10px;
        }

        /* ========================================
   17. バッジとボタンのスタイル
   ======================================== */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .bg-success {
            background-color: #28a745 !important;
        }

        .bg-secondary {
            background-color: #6c757d !important;
        }

        .bg-primary {
            background-color: #007bff !important;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            margin: 0 2px;
        }

        .btn-outline-primary {
            border-color: #007bff;
            color: #007bff;
        }

        .btn-outline-primary:hover {
            background-color: #007bff;
            color: white;
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

        th[style*="cursor: pointer"] {
            user-select: none;
            background-color: #495057 !important;
        }

        th[style*="cursor: pointer"]:hover {
            background-color: #6c757d !important;
        }

        /* ========================================
   18. レスポンシブ対応（論述問題・公開設定）
   ======================================== */
        @media (max-width: 768px) {
            .essay-form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .image-preview img {
                max-height: 200px;
            }

            .image-actions .btn {
                display: block;
                width: 100%;
                margin-bottom: 5px;
                margin-left: 0;
                margin-right: 0;
            }

            .image-management-section {
                padding: 10px;
            }

            .visibility-grid {
                grid-template-columns: 100px repeat(var(--type-count, 4), 1fr) !important;
                gap: 2px !important;
                font-size: 0.8em;
                margin: 0 15px 15px 15px !important;
            }

            .grid-cell-setting {
                min-height: 50px !important;
                max-height: 50px !important;
                gap: 2px !important;
            }

            .grid-cell-setting .setting-icon {
                font-size: 1.1em !important;
            }

            .grid-cell-setting .setting-text {
                font-size: 0.7em !important;
            }

            .grid-cell-chapter {
                padding: 10px 4px !important;
                font-size: 0.8rem !important;
                min-height: 50px !important;
            }

            .matrix-header {
                padding: 15px 15px 0 15px !important;
            }

            .save-section {
                margin: 0 15px 15px 15px !important;
            }
        }

        @media (max-width: 480px) {

            .essay-form-container,
            .csv-upload-form {
                padding: 12px;
            }

            .essay-input-group input,
            .essay-input-group select,
            .essay-input-group textarea {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .essay-submit-btn,
            .btn-upload {
                padding: 10px 20px;
                font-size: 0.95rem;
            }

            .upload-area {
                padding: 15px;
            }

            .file-input-label i {
                font-size: 1.2rem;
            }

            .table-responsive {
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .visibility-grid {
                margin: 0 10px 10px 10px !important;
            }

            .matrix-header {
                padding: 10px 10px 0 10px !important;
            }

            .save-section {
                margin: 0 10px 10px 10px !important;
                padding: 15px;
            }
        }

        /* ========================================
   19. デバッグ用スタイル（開発時のみ）
   ======================================== */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
            display: none;
        }

        /* ========================================
   20. 文字数カウンター用スタイル（修正版）
   ======================================== */

        /* テキストエリア用のラッパー（横幅フル活用） */
        .textarea-wrapper {
            position: relative;
            display: block;
            width: 100% !important;
            /* ★重要：横幅を100%に設定 */
        }

        /* 文字数カウンター（右下角に固定配置） */
        .char-counter {
            position: absolute;
            bottom: 8px !important;
            /* ★重要：下端から8px */
            right: 8px !important;
            /* ★重要：右端から8px */
            background: rgba(255, 255, 255, 0.95);
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            z-index: 10;
            font-family: monospace;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        /* テキストエリア自体も横幅フル活用 */
        .textarea-wrapper textarea {
            width: 100% !important;
            /* ★重要：横幅を100%に設定 */
            box-sizing: border-box !important;
        }

        /* テキストエリアにフォーカス時のカウンター強調 */
        .textarea-wrapper textarea:focus+.char-counter {
            background: rgba(123, 31, 162, 0.1);
            color: #7b1fa2;
            border-color: #7b1fa2;
            transform: translateY(-2px);
        }

        /* 文字数に応じた色変更 */
        .char-counter.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border-color: #ffc107;
        }

        .char-counter.danger {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border-color: #dc3545;
        }
    </style>
    <!-- スコア削除確認モーダル -->
    <div class="modal fade" id="deleteScoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i>スコア削除の確認</h5><button
                        type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>以下の対象の<strong>全ての学習履歴とスコア</strong>を削除します。<br>この操作は取り消せません。</p>
                    <div class="alert alert-warning"><strong>対象:</strong><span id="deleteScoreTargetName"></span></div>
                    <p class="text-danger small">※ ユーザー自体は削除されません。学習データのみが初期化されます。</p>
                    <form id="deleteScoreForm"><input type="hidden" id="deleteScoreType" name="type">
                        < !-- user or room --><input type="hidden" id="deleteScoreTargetId" name="target_id">
                            <div class="mb-3"><label for="deleteScoreAdminPassword"
                                    class="form-label">管理者パスワード:</label><input type="password" class="form-control"
                                    id="deleteScoreAdminPassword" required></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-warning"
                        onclick="executeDeleteScore()"><i class="fas fa-eraser"></i>削除実行 </button></div>
            </div>
        </div>
    </div>
    <script> // スコア削除モーダルの制御

        document.addEventListener('DOMContentLoaded', function () {
            // 個別ユーザーのスコア削除ボタン
            const deleteScoreBtns = document.querySelectorAll('.delete-score-btn');

            deleteScoreBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const userId = this.dataset.userId;
                    const username = this.dataset.username;

                    showDeleteScoreModal('user', userId, `ユーザー: ${username}`);
                });
            });
        });

        // 部屋のスコア削除確認（onclick属性から呼ばれる）
        function confirmDeleteRoomScore(event, roomNumber) {
            if (event) event.preventDefault();
            showDeleteScoreModal('room', roomNumber, `部屋: ${roomNumber} の全ユーザー`);
        }

        function showDeleteScoreModal(type, id, name) {
            document.getElementById('deleteScoreType').value = type;
            document.getElementById('deleteScoreTargetId').value = id;
            document.getElementById('deleteScoreTargetName').textContent = name;
            document.getElementById('deleteScoreAdminPassword').value = '';

            let modal = bootstrap.Modal.getInstance(document.getElementById('deleteScoreModal'));
            if (!modal) {
                modal = new bootstrap.Modal(document.getElementById('deleteScoreModal'));
            }
            modal.show();
        }

        function executeDeleteScore() {
            const type = document.getElementById('deleteScoreType').value;
            const id = document.getElementById('deleteScoreTargetId').value;
            const password = document.getElementById('deleteScoreAdminPassword').value;

            if (!password) {
                alert('管理者パスワードを入力してください。');
                return;
            }

            const endpoint = type === 'user' ? '/admin/delete_user_score' : '/admin/delete_room_score';
            const data = new FormData();
            data.append('admin_password', password);

            if (type === 'user') {
                data.append('user_id', id);
            }

            else {
                data.append('room_number', id);
            }

            fetch(endpoint, {
                method: 'POST',
                body: data

            }).then(response => response.json()).then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload();
                }

                else {
                    alert('エラー: ' + data.message);
                }

            }).catch(error => {
                console.error('Error:', error);
                alert('通信エラーが発生しました。');
            });
        }

    </script>
    <style>
        /* テキストエリアの下部余白確保と高さ調整 */
        .essay-answer-input,
        #edit_answer {
            padding-bottom: 35px !important;
            resize: vertical;
            min-height: 150px !important;
            width: 100% !important;
            /* ★重要：横幅フル活用 */
            box-sizing: border-box !important;
        }

        /* 新規登録フォーム用のテキストエリア（より大きく） */
        .essay-answer-input {
            min-height: 180px !important;
        }

        /* 編集モーダル用のテキストエリア */
        #edit_answer {
            min-height: 160px !important;
        }

        /* 既存のスタイルを上書き（横幅フル活用） */
        .essay-question-input,
        .essay-answer-input {
            min-height: 120px !important;
            resize: vertical;
            line-height: 1.6;
            width: 100% !important;
            /* ★重要：横幅フル活用 */
            box-sizing: border-box !important;
        }

        /* 模範解答入力欄のみ高さを大きく */
        .essay-answer-input {
            min-height: 180px !important;
        }

        /* レスポンシブ対応での調整 */
        @media (max-width: 768px) {
            .char-counter {
                font-size: 0.75rem;
                padding: 3px 6px;
                bottom: 6px !important;
                right: 6px !important;
            }

            .essay-answer-input,
            #edit_answer {
                padding-bottom: 30px !important;
                min-height: 140px !important;
            }

            .essay-answer-input {
                min-height: 160px !important;
            }
        }

        @media (max-width: 480px) {
            .char-counter {
                font-size: 0.7rem;
                padding: 2px 4px;
                bottom: 4px !important;
                right: 4px !important;
            }

            .essay-answer-input,
            #edit_answer {
                padding-bottom: 25px !important;
                min-height: 120px !important;
            }

            .essay-answer-input {
                min-height: 140px !important;
            }
        }
    </style>

    <script>
        // ユーザーアップロード準備（推定時間計算）
        function prepareUserUpload() {
            const fileInput = document.getElementById('users_csv_file');
            if (!fileInput.files.length) {
                alert('ファイルを選択してください。');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                // ヘッダー行を除く
                const userCount = Math.max(0, lines.length - 1);

                if (userCount === 0) {
                    alert('有効なデータが含まれていません。');
                    return;
                }

                // 推定時間計算 (1ユーザーあたり約0.08秒 + オーバーヘッド)
                // 100ユーザーで16秒だったので、0.16秒/ユーザーと見積もる（安全マージン込み）
                const estimatedSeconds = Math.ceil(userCount * 0.16);
                let timeString = '';
                if (estimatedSeconds < 60) {
                    timeString = `約 ${estimatedSeconds} 秒`;
                } else {
                    const minutes = Math.floor(estimatedSeconds / 60);
                    const seconds = estimatedSeconds % 60;
                    timeString = `約 ${minutes} 分 ${seconds} 秒`;
                }

                document.getElementById('confirmFileName').textContent = file.name;
                document.getElementById('confirmUserCount').textContent = userCount;
                document.getElementById('confirmTimeEstimate').textContent = timeString;

                let modal = bootstrap.Modal.getInstance(document.getElementById('uploadConfirmModal'));
                if (!modal) {
                    modal = new bootstrap.Modal(document.getElementById('uploadConfirmModal'));
                }
                modal.show();
            };

            reader.readAsText(file);
        }

        // アップロード開始
        function startUserUpload() {
            const fileInput = document.getElementById('users_csv_file');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // モーダルを閉じる
            const modalEl = document.getElementById('uploadConfirmModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // 進捗バー表示
            document.getElementById('uploadProgressContainer').style.display = 'block';
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadProgressBar').textContent = '0%';
            document.getElementById('uploadStatusMessage').textContent = 'アップロード中...';

            // AJAX送信
            fetch("{{ url_for('admin_upload_users') }}?json=true", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // ポーリング開始
                        pollRegistrationStatus();
                    } else {
                        showInfoModal('エラー', 'エラー: ' + data.message, 'error');
                        document.getElementById('uploadProgressContainer').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showInfoModal('エラー', 'アップロード中にエラーが発生しました。', 'error');
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                });
        }

        // 進捗ポーリング
        function pollRegistrationStatus() {
            fetch("{{ url_for('get_registration_status') }}")
                .then(response => response.json())
                .then(status => {
                    if (status.is_processing) {
                        const percent = Math.round((status.current / status.total) * 100);
                        const progressBar = document.getElementById('uploadProgressBar');
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                        progressBar.setAttribute('aria-valuenow', percent);

                        document.getElementById('uploadStatusMessage').textContent = status.message;

                        // 1秒後に再確認
                        setTimeout(pollRegistrationStatus, 1000);
                    } else if (status.completed) {
                        // 完了
                        document.getElementById('uploadProgressBar').style.width = '100%';
                        document.getElementById('uploadProgressBar').textContent = '100%';
                        document.getElementById('uploadProgressBar').classList.remove('progress-bar-animated');
                        document.getElementById('uploadProgressBar').classList.add('bg-success');
                        document.getElementById('uploadStatusMessage').textContent = status.message;

                        showConfirmModal(
                            '登録完了',
                            '登録が完了しました！\n' + status.message,
                            () => {
                                location.reload();
                            },
                            'OK',
                            'btn-success'
                        );
                    }
                })
                .catch(error => {
                    console.error('Polling Error:', error);
                });
        }
        // 全ユーザーのIntroリセット確認
        function confirmResetAllIntro() {
            showConfirmModal(
                '全ユーザーIntroリセット',
                '全ユーザーのRPG導入フラグをリセットしますか？\n\n⚠️ この操作は全ユーザーに影響します。\n全員が次回ログイン時に再びRPGイントロを見ることになります。',
                () => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/admin/reset_intro_flag_all';
                    document.body.appendChild(form);
                    form.submit();
                },
                '全員リセット',
                'btn-warning'
            );
        }
    </script>

    <!-- Info Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalTitle">通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="infoModalBody">
                    <!-- Message -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.showInfoModal = function (title, message, type = 'info') {


            const modalEl = document.getElementById('infoModal');
            const titleEl = document.getElementById('infoModalTitle');
            const bodyEl = document.getElementById('infoModalBody');

            if (!modalEl || !titleEl || !bodyEl) {
                console.error('Modal elements not found:', { modalEl, titleEl, bodyEl });
                return;
            }

            titleEl.textContent = title;
            bodyEl.innerHTML = message.replace(/\n/g, '<br>');

            // Reset classes
            const headerEl = modalEl.querySelector('.modal-header');
            if (headerEl) {
                headerEl.className = 'modal-header';

                if (type === 'success') {
                    headerEl.classList.add('bg-success', 'text-white');
                } else if (type === 'error') {
                    headerEl.classList.add('bg-danger', 'text-white');
                } else {
                    headerEl.classList.add('bg-primary', 'text-white');
                }
            }


            const modal = new bootstrap.Modal(modalEl);
            modal.show();

        };

        // URLパラメータのチェック
        document.addEventListener('DOMContentLoaded', () => {
            // モーダルをbodyに移動して表示問題を修正
            const infoModal = document.getElementById('infoModal');
            if (infoModal && !infoModal.dataset.moved) {

                document.body.appendChild(infoModal);
                infoModal.dataset.moved = 'true';
            }

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('announcement_sent') === 'true') {
                // 少し遅延させてモーダルが確実に準備できてから表示
                setTimeout(() => {
                    showInfoModal('送信完了', 'お知らせが正常に配信されました！', 'success');
                }, 100);

                // URLからパラメータを削除（カレント履歴を書き換え）
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }

            // 論述問題集タブが表示されたら章フィルターを初期化
            const essayTabLink = document.getElementById('tab-link-essay-management');
            if (essayTabLink) {
                essayTabLink.addEventListener('shown.bs.tab', function (e) {
                    // 既に初期化済みかチェック（2回目以降は不要）
                    if (!essayTabLink.dataset.initialized) {
                        if (typeof loadEssayStats === 'function') {
                            loadEssayStats();
                        }
                        essayTabLink.dataset.initialized = 'true';
                    }
                });
            }
        });

        // --------------------------------------------------------
        // Rich Text Editor Support (ContentEditable)
        // --------------------------------------------------------

        function convertToRichText(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea || textarea.style.display === 'none') {
                // If already converted (and hidden) or not found, try to find the editor
                if (textarea && textarea.style.display === 'none') {
                    const existingEditor = document.getElementById(textareaId + '_editor');
                    if (existingEditor) return existingEditor;
                }
                return null;
            }

            // Create editor div
            const editor = document.createElement('div');
            editor.id = textareaId + '_editor';
            editor.contentEditable = true;

            // Inherit styles - copy strictly needed ones + bootstrap class
            editor.className = textarea.className; // Inherit bootstrap classes like 'form-control'

            // Set styles to likely match 'form-control' appearance and dimensions
            editor.style.minHeight = (textarea.rows * 1.5) + 'em'; // Approx height
            editor.style.height = 'auto';
            editor.style.maxHeight = '400px';
            editor.style.overflowY = 'auto';
            editor.style.whiteSpace = 'pre-wrap'; // Preserve whitespace
            editor.style.cursor = 'text';

            // Copy initial content (Textarea contains HTML tags, div should render them)
            editor.innerHTML = textarea.value;

            // Insert editor before textarea
            textarea.parentNode.insertBefore(editor, textarea);
            textarea.style.display = 'none';

            // Sync: Editor -> Textarea
            editor.addEventListener('input', () => {
                textarea.value = editor.innerHTML;
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
            });

            // Handle Paste: Strip styles, keep structure? Or just let it be?
            // Simple approach: Let browser handle for now, but ensure we don't paste massive inline styles.
            // For now, no sanitizer.

            // Ensure pressing Enter creates <div> or <br> not <p> if desired?
            // Browsers vary. Default is usually ok.

            return editor;
        }

        // Initialize editors on load for static forms
        document.addEventListener('DOMContentLoaded', () => {
            const staticTargets = ['announcementContent', 'new_essay_question', 'new_essay_answer'];
            staticTargets.forEach(id => convertToRichText(id));
        });

        // --------------------------------------------------------
        // Hook into Modals for Dynamic Content
        // --------------------------------------------------------

        // Hook openEditAnnouncementModal
        if (typeof window.openEditAnnouncementModal === 'function') {
            const originalOpenEditAnn = window.openEditAnnouncementModal;
            window.openEditAnnouncementModal = function (id, data) {
                originalOpenEditAnn(id, data);
                // Wait for modal to be populated (original function sets values synchronously)
                // Convert if not yet converted
                let editor = convertToRichText('editAnnContent');
                // If already converted, update its content
                if (!editor) editor = document.getElementById('editAnnContent_editor');
                if (editor) {
                    editor.innerHTML = data.content;
                    // Update hidden textarea just in case
                    document.getElementById('editAnnContent').value = data.content;
                }
            };
        }

        // Hook showEditDialog (Essay Edit)
        // Ensure showEditDialog exists (it should be defined in previous scripts)
        // Since showEditDialog is defined as function declaration earlier, we can wrap it.
        // But if it is called via onclick="showEditDialog", window.showEditDialog works.
        // Wait, showEditDialog is NOT global? It's in <script> tag. Yes global.

        // We need to wait for the original function to complete strictly? 
        // Original adds to DOM.
        const originalShowEditDialog = window.showEditDialog;
        if (originalShowEditDialog) {
            window.showEditDialog = function (problem) {
                originalShowEditDialog(problem);
                // The modal is created and inserted into DOM.
                // We can immediately target the textareas.
                // Wait for transition? No, DOM is there.
                setTimeout(() => {
                    ['edit_question', 'edit_answer'].forEach(id => {
                        let editor = convertToRichText(id);
                        // If already converted (unlikely for new modal), sync.
                        // Since modal is recreated, we always convert anew.
                    });
                }, 50); // Small delay to ensure DOM is ready
            }
        } else {
            console.warn("showEditDialog function not found to hook.");
        }

    </script>
    {% endblock %}