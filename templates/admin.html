{% extends "base.html" %}
{% block title %}管理者ページ - {{ app_name }}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header d-flex justify-content-between align-items-center mb-4">
        <h2>管理者ページ</h2>
        <a href="{{ url_for('admin_ranking_page') }}" class="btn btn-success">
            <i class="fas fa-trophy"></i> 全員ランキング表示
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- 折りたたみコントロール -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="expandAllSections()">
            <i class="fas fa-expand-arrows-alt"></i> 全て展開
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllSections()">
            <i class="fas fa-compress-arrows-alt"></i> 全て折りたたみ
        </button>
    </div>

    <!-- アプリ情報管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-app-info" aria-expanded="false">
            <h3><i class="fas fa-mobile-alt"></i> アプリ情報管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-app-info">
            <div class="section-content">
                <p>アプリの表示名、更新内容、バージョン情報などを編集できます。</p>
                
                <div class="admin-panel" style="background-color: #e8f4fd; border-left: 5px solid #3498db;">
                    <h4>現在のアプリ情報</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>アプリ名:</strong> {{ app_info.app_name if app_info else '世界史単語帳' }}</p>
                            <p><strong>バージョン:</strong> {{ app_info.version if app_info else '1.0.0' }}</p>
                            <p><strong>最終更新日:</strong> {{ app_info.last_updated_date if app_info else '2025年6月15日' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>更新内容:</strong></p>
                            <div style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em;">
                                {{ app_info.update_content if app_info else 'アプリケーションが開始されました。' }}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <a href="{{ url_for('admin_app_info') }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> アプリ情報を編集
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-external-link-alt"></i> 実際の表示を確認
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-management" aria-expanded="true">
            <h3><i class="fas fa-users"></i> ユーザー管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-management">
            <div class="section-content">
                <p>登録済みユーザー: {{ users|length }}人</p>
                
                <h4>CSV一括ユーザー追加</h4>
                <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                    <p><strong>CSVファイル形式要件:</strong></p>
                    <ul>
                        <li>ヘッダー行: 部屋番号,入室パスワード,出席番号,個別パスワード,アカウント名</li>
                        <li>文字エンコーディング: UTF-8</li>
                        <li>例: 101,password123,001,student001,成富兵庫茂安</li>
                        <li>同一アカウント名の登録も可能です（同一人物が複数部屋に参加する場合）</li>
                    </ul>
                    <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-download"></i> テンプレートをダウンロード
                    </a>
                </div>

                <form action="{{ url_for('admin_upload_users') }}" method="POST" enctype="multipart/form-data" class="upload-form">
                    <div class="input-group">
                        <label for="users_csv_file">ユーザーCSVファイルを選択:</label>
                        <input type="file" id="users_csv_file" name="file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> CSV一括ユーザー追加
                    </button>
                </form>
                
                <h4>個別ユーザー追加</h4>
                <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
                    <div class="input-group">
                        <label for="new_room_number">部屋番号:</label>
                        <input type="text" id="new_room_number" name="room_number" required>
                    </div>
                    <div class="input-group">
                        <label for="new_room_password">入室パスワード:</label>
                        <input type="password" id="new_room_password" name="room_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_student_id">出席番号:</label>
                        <input type="text" id="new_student_id" name="student_id" required>
                    </div>
                    <div class="input-group">
                        <label for="new_individual_password">個別パスワード:</label>
                        <input type="password" id="new_individual_password" name="individual_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_username">アカウント名:</label>
                        <input type="text" id="new_username" name="username" required>
                        <small class="form-text text-muted">※同一人物が複数の部屋に参加する場合、同じアカウント名でも登録可能です</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ユーザー追加</button>
                </form>
                
                <h4>登録済みユーザー一覧</h4>
                <!-- ソート機能付きユーザーリスト -->
                <div class="table-controls mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="roomSortSelect">部屋でソート:</label>
                            <select id="roomSortSelect" class="form-control form-control-sm">
                                <option value="">全ての部屋</option>
                                {% set room_numbers = [] %}
                                {% for user in users %}
                                    {% if user.room_number not in room_numbers and user.room_number != 'ADMIN' %}
                                        {% set _ = room_numbers.append(user.room_number) %}
                                    {% endif %}
                                {% endfor %}
                                {% for room_num in room_numbers|sort %}
                                    <option value="{{ room_num }}">部屋 {{ room_num }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="userSearchInput">ユーザー検索:</label>
                            <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="名前、出席番号で検索...">
                        </div>
                    </div>
                </div>

                <!-- スクロール可能なテーブルコンテナ -->
                <div class="scrollable-table-container">
                    <div class="table-responsive" style="overflow-x: auto;">
                        <table class="table table-striped user-list-table" id="userTable" style="min-width: 800px;">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th>ID</th>
                                    <th>部屋 <i class="fas fa-sort sort-icon" data-column="room" style="cursor: pointer;"></i></th>
                                    <th>出席番号</th>
                                    <th>現在のアカウント名 <i class="fas fa-sort sort-icon" data-column="name" style="cursor: pointer;"></i></th>
                                    <th>最初のアカウント名</th>
                                    <th>変更日時</th>
                                    <th>最終ログイン <i class="fas fa-sort sort-icon" data-column="login" style="cursor: pointer;"></i></th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                {% for user in users %}
                                {% if user.username != 'admin' %}
                                <tr data-room="{{ user.room_number }}" data-name="{{ user.username|lower }}" data-student="{{ user.student_id|lower }}">
                                    <td>{{ user.id }}</td>
                                    <td><span class="badge bg-secondary">{{ user.room_number }}</span></td>
                                    <td>{{ user.student_id }}</td>
                                    <td>
                                        {{ user.username }}
                                        {% if user.original_username and user.original_username != user.username %}
                                        <span class="badge bg-warning text-dark ms-1">
                                            <i class="fas fa-edit"></i> 変更済み
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.original_username and user.original_username != user.username %}
                                        <span class="text-muted">{{ user.original_username }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.username_changed_at | to_jst if user.username_changed_at else '-' }}</td>
                                    <td>{{ user.last_login | to_jst if user.last_login else '未ログイン' }}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-user-btn"
                                                data-user-id="{{ user.id }}"
                                                data-username="{{ user.username }}"
                                                data-room="{{ user.room_number }}">削除</button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 部屋ごとCSVファイル管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-csv-management" aria-expanded="false">
            <h3><i class="fas fa-folder-open"></i> 部屋ごとCSVファイル管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-csv-management">
            <div class="section-content">
                <p>各部屋で使用する単語帳CSVファイルを個別に設定できます。アップロードしない場合はデフォルトのwords.csvが使用されます。</p>
                <div class="csv-template-section" style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i> CSVテンプレートダウンロード
                    </h4>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        正しい形式の単語帳CSVファイルを作成するためのテンプレートです。サンプルデータ付きですぐに編集を開始できます。
                    </p>
                    <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-file-csv"></i> 単語帳CSVテンプレートをダウンロード
                    </a>
                    <small class="text-muted d-block mt-2">
                        ※ ファイル形式：chapter, number, category, question, answer, enabled
                    </small>
                </div>        
                <form action="{{ url_for('admin_upload_room_csv') }}" method="POST" enctype="multipart/form-data" class="upload-form">
                    <div class="input-group">
                        <label for="room_csv_file">CSVファイルを選択:</label>
                        <input type="file" id="room_csv_file" name="file" accept=".csv" required>
                        <small class="form-text text-muted">＊ファイル名は半角英数字＊</small>
                    </div>
                    <button type="submit" class="btn btn-success">CSVファイルアップロード</button>
                </form>

                <h4>アップロード済みCSVファイル一覧</h4>
                <div id="csv-files-list">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">
                            <i class="fas fa-sync-alt"></i> ファイル一覧を更新
                        </button>
                    </div>
                    <!-- スクロール可能なCSVファイルリスト -->
                    <div class="scrollable-table-container">
                        <div id="csv-files-container" style="margin-top: 15px; overflow-x: auto;">
                            <p class="text-info">📋 ファイル一覧を読み込み中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 部屋ごとの設定管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-room-settings" aria-expanded="false">
            <h3><i class="fas fa-home"></i> 部屋ごとの設定管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-room-settings">
            <div class="section-content">
                <p>各部屋の学習範囲とCSVファイルを設定します。</p>

                <!-- スクロール可能な部屋設定テーブル -->
                <div class="scrollable-table-container">
                    <div class="table-responsive" style="overflow-x: auto;">
                        <table class="table table-striped room-setting-table" style="min-width: 700px;">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th>部屋番号</th>
                                    <th>有効単元設定</th>
                                    <th>使用CSVファイル</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set unique_room_numbers = [] %}
                                {% for user in users %}
                                    {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                                        {% set _ = unique_room_numbers.append(user.room_number) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for setting in room_max_unit_settings.keys() %}
                                    {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                        {% set _ = unique_room_numbers.append(setting) %}
                                    {% endif %}
                                {% endfor %}

                                {% for room_num in unique_room_numbers|sort %}
                                <tr>
                                    <td><strong>{{ room_num }}</strong></td>
                                    <td>
                                        <div class="unit-setting-container" id="unitContainer_{{ room_num }}">
                                            <div class="unit-controls mb-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadAvailableUnits('{{ room_num }}')">
                                                    <i class="fas fa-sync"></i> 単元一覧読み込み
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-check-double"></i> 全て選択
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-times"></i> 全て解除
                                                </button>
                                            </div>
                                            <div class="unit-checkboxes" id="unitCheckboxes_{{ room_num }}">
                                                <p class="text-muted">「単元一覧読み込み」をクリックして利用可能な単元を表示してください</p>
                                            </div>
                                            <div class="selected-units-display mt-2">
                                                <small class="text-info">
                                                    選択中: <span id="selectedCount_{{ room_num }}">0</span>個の単元
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <select id="csvFile_{{ room_num }}" 
                                                class="form-control csv-setting-select" 
                                                data-room-number="{{ room_num }}">
                                            <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv') == 'words.csv' %}selected{% endif %}>
                                                words.csv (デフォルト)
                                            </option>
                                            <!-- 動的にオプションを追加 -->
                                        </select>
                                        <small class="form-text text-muted">
                                            現在の設定: <code id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-primary btn-sm save-room-setting-btn" 
                                                    data-room-number="{{ room_num }}">保存</button>
                                            <button class="btn btn-danger btn-sm delete-room-setting-btn" 
                                                    data-room-number="{{ room_num }}">削除</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-essay-visibility" aria-expanded="false">
            <h3><i class="fas fa-eye"></i> 論述問題公開設定 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-essay-visibility">
            <div class="section-content">
                <p>部屋ごとに章・問題タイプ別で論述問題の公開/非公開を設定できます。</p>
                
                <!-- 部屋選択 -->
                <div class="visibility-room-selector">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-4">
                            <label for="visibilityRoomSelect" class="form-label">
                                <i class="fas fa-door-open"></i> 設定対象の部屋
                            </label>
                            <select id="visibilityRoomSelect" class="form-select">
                                <option value="">部屋を選択してください</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button id="loadVisibilitySettings" class="btn btn-primary" disabled>
                                    <i class="fas fa-download"></i> 設定を読み込み
                                </button>
                                <button id="saveVisibilitySettings" class="btn btn-success" disabled>
                                    <i class="fas fa-save"></i> 設定を保存
                                </button>
                                <button id="resetVisibilitySettings" class="btn btn-warning" disabled>
                                    <i class="fas fa-undo"></i> 全て公開にリセット
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 設定マトリックス -->
                <div id="visibilityMatrix" class="visibility-matrix" style="display: none;">
                    <div class="matrix-header">
                        <h4><i class="fas fa-table"></i> 公開設定マトリックス</h4>
                        <p class="text-muted">各セルをクリックして公開/非公開を切り替えできます</p>
                    </div>
                    
                    <!-- 一括操作ボタン -->
                    <div class="bulk-operations mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-success" onclick="setAllVisible(true)">
                                <i class="fas fa-eye"></i> 全て公開
                            </button>
                            <button class="btn btn-outline-danger" onclick="setAllVisible(false)">
                                <i class="fas fa-eye-slash"></i> 全て非公開
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm ms-2" role="group">
                            <button class="btn btn-outline-info" onclick="setTypeVisible('A', true)">A問題を公開</button>
                            <button class="btn btn-outline-info" onclick="setTypeVisible('B', true)">B問題を公開</button>
                            <button class="btn btn-outline-info" onclick="setTypeVisible('C', true)">C問題を公開</button>
                            <button class="btn btn-outline-info" onclick="setTypeVisible('D', true)">D問題を公開</button>
                        </div>
                    </div>
                    
                    <!-- マトリックステーブル -->
                    <div class="table-responsive">
                        <table id="visibilityTable" class="table table-bordered visibility-table">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 120px;">章</th>
                                    <th class="text-center">A問題<br><small>(200字以上)</small></th>
                                    <th class="text-center">B問題<br><small>(100-150字)</small></th>
                                    <th class="text-center">C問題<br><small>(50-75字)</small></th>
                                    <th class="text-center">D問題<br><small>(30字程度)</small></th>
                                </tr>
                            </thead>
                            <tbody id="visibilityTableBody">
                                <!-- JavaScriptで動的生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 設定状況サマリー -->
                    <div class="settings-summary mt-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-chart-pie"></i> 設定状況</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <span class="badge bg-success me-1">公開:</span>
                                        <span id="visibleCount">0</span>件
                                    </div>
                                    <div class="col-md-3">
                                        <span class="badge bg-danger me-1">非公開:</span>
                                        <span id="hiddenCount">0</span>件
                                    </div>
                                    <div class="col-md-3">
                                        <span class="badge bg-info me-1">総数:</span>
                                        <span id="totalCount">0</span>件
                                    </div>
                                    <div class="col-md-3">
                                        <span class="badge bg-primary me-1">公開率:</span>
                                        <span id="visibilityRate">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 状態表示 -->
                <div id="visibilityStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- 論述問題集管理セクション　-->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-essay-management" aria-expanded="false">
            <h3><i class="fas fa-edit"></i> 論述問題集管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-essay-management">
            <div class="section-content">
                <p>論述問題の登録・管理・インポートを行います。</p>
                <!-- 論述問題CSV一括インポート -->
                <div class="csv-import-section">
                    <h4><i class="fas fa-upload"></i> CSV一括インポート</h4>
                    
                    <!-- CSVテンプレート説明 -->
                    <div class="csv-template-section">
                        <h5><i class="fas fa-download"></i> 論述問題CSVテンプレート</h5>
                        <p>正しい形式の論述問題CSVファイルを作成するためのテンプレートです。</p>
                        
                        <div class="template-format">
                            <strong>CSVフォーマット:</strong><br>
                            <code>chapter,type,university,year,question,answer,answer_length,enabled</code><br><br>
                            
                            <strong>各列の説明:</strong><br>
                            • <strong>chapter</strong>: 章番号（例: 1, 2, com）<br>
                            • <strong>type</strong>: 問題タイプ（A: 200字以上, B: 100-150字, C: 50-75字, D: 30字程度）<br>
                            • <strong>university</strong>: 出題大学名（任意）<br>
                            • <strong>year</strong>: 出題年度（任意）<br>
                            • <strong>question</strong>: 問題文（必須）<br>
                            • <strong>answer</strong>: 模範解答（任意）<br>
                            • <strong>answer_length</strong>: 解答文字数（自動計算されるため任意）<br>
                            • <strong>enabled</strong>: 有効フラグ（1: 有効, 0: 無効）
                        </div>
                        
                        <button class="btn btn-outline-info btn-sm" onclick="downloadEssayTemplate()">
                            <i class="fas fa-file-csv"></i> 論述問題CSVテンプレートをダウンロード
                        </button>
                    </div>

                    <!-- CSVアップロードフォーム -->
                    <form id="essayUploadForm" enctype="multipart/form-data" class="csv-upload-form">
                        <div class="upload-area">
                            <div class="file-input-wrapper">
                                <label for="essay_csv_file" class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>CSVファイルを選択またはドラッグ&ドロップ</span>
                                </label>
                                <input type="file" id="essay_csv_file" name="file" accept=".csv" required>
                                <small class="form-text text-muted">UTF-8またはShift_JISエンコーディングのCSVファイルを選択してください</small>
                            </div>
                            
                            <div class="upload-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="replaceExisting" name="replace_existing">
                                    <label class="form-check-label" for="replaceExisting">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        既存の問題を置き換える（注意：全ての論述問題が削除されます）
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success btn-upload">
                                <i class="fas fa-upload"></i>
                                <span>論述問題CSV一括インポート</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 個別論述問題登録 -->
                <div class="essay-form-section">
                    <h4><i class="fas fa-plus-circle"></i> 個別論述問題登録</h4>
                    
                    <div class="essay-form-container">
                        <form id="newEssayProblemForm" class="essay-registration-form" enctype="multipart/form-data">
                            <div class="essay-form-grid">
                                <!-- 章・タイプ行 -->
                                <div class="essay-input-group">
                                    <label for="new_essay_chapter">
                                        <i class="fas fa-bookmark"></i> 章
                                    </label>
                                    <input type="text" 
                                        id="new_essay_chapter" 
                                        name="chapter" 
                                        placeholder="例: 1, 2, com" 
                                        required>
                                    <small class="essay-help-text">数字または「com」（総合問題）を入力</small>
                                </div>

                                <div class="essay-input-group">
                                    <label for="new_essay_type">
                                        <i class="fas fa-tag"></i> タイプ
                                    </label>
                                    <select id="new_essay_type" name="type" required>
                                        <option value="">選択してください</option>
                                        <option value="A">タイプA (200字以上)</option>
                                        <option value="B">タイプB (100-150字程度)</option>
                                        <option value="C">タイプC (50-75字程度)</option>
                                        <option value="D">タイプD (30字程度)</option>
                                    </select>
                                    <small class="essay-help-text">問題の文字数規模を選択</small>
                                </div>

                                <!-- 大学・年度行 -->
                                <div class="essay-input-group">
                                    <label for="new_essay_university">
                                        <i class="fas fa-university"></i> 大学名
                                    </label>
                                    <input type="text" 
                                        id="new_essay_university" 
                                        name="university" 
                                        placeholder="例: 東京大学">
                                    <small class="essay-help-text">出題大学名（任意）</small>
                                </div>

                                <div class="essay-input-group">
                                    <label for="new_essay_year">
                                        <i class="fas fa-calendar-alt"></i> 年度
                                    </label>
                                    <input type="number" 
                                        id="new_essay_year" 
                                        name="year" 
                                        placeholder="2024" 
                                        min="2000" 
                                        max="2030">
                                    <small class="essay-help-text">出題年度（任意）</small>
                                </div>

                                <!-- 問題文（全幅） -->
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_question">
                                        <i class="fas fa-question-circle"></i> 問題文
                                    </label>
                                    <textarea id="new_essay_question" 
                                            name="question" 
                                            class="essay-question-input"
                                            placeholder="問題文を入力してください..." 
                                            required></textarea>
                                    <small class="essay-help-text">出題する問題の内容を詳しく記入</small>
                                </div>
                                <!-- 問題画像アップロード -->                     
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_image">
                                        <i class="fas fa-image"></i> 問題画像（グラフ・地図等）
                                    </label>
                                    <input type="file" 
                                        id="new_essay_image" 
                                        name="image" 
                                        accept="image/*" 
                                        onchange="previewImage(this)">
                                    <div id="imagePreview" class="mt-2"></div>
                                    <small class="essay-help-text">JPG、PNG、GIF形式の画像ファイル（任意）</small>
                                </div>
                                <!-- 解答（全幅） -->
                                <div class="essay-input-group essay-form-full-width">
                                    <label for="new_essay_answer">
                                        <i class="fas fa-lightbulb"></i> 模範解答
                                    </label>
                                    <textarea id="new_essay_answer" 
                                            name="answer" 
                                            class="essay-answer-input"
                                            placeholder="模範解答を入力してください..."></textarea>
                                    <small class="essay-help-text">参考となる解答例（任意）</small>
                                </div>
                            </div>

                            <!-- 有効化チェックボックス -->
                            <div class="essay-checkbox-group">
                                <input type="checkbox" 
                                    id="new_essay_enabled" 
                                    name="enabled" 
                                    checked>
                                <label for="new_essay_enabled">
                                    <i class="fas fa-check-circle"></i> 有効にする
                                </label>
                            </div>

                            <!-- 送信ボタン -->
                            <button type="submit" class="essay-submit-btn">
                                <i class="fas fa-plus"></i>
                                <span class="btn-text">論述問題を追加</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 論述問題一覧・管理 -->
                <div class="essay-management-section">
                    <h4><i class="fas fa-list"></i> 論述問題一覧・管理</h4>
                    
                    <!-- フィルター -->
                    <div class="essay-filter-section">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="essayChapterFilter">章でフィルター:</label>
                                <select id="essayChapterFilter" class="form-control" onchange="filterEssayProblems()">
                                    <option value="">全ての章</option>
                                    <option value="1">第1章</option>
                                    <option value="2">第2章</option>
                                    <option value="3">第3章</option>
                                    <option value="4">第4章</option>
                                    <option value="5">第5章</option>
                                    <option value="com">総合問題</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="essayTypeFilter">タイプでフィルター:</label>
                                <select id="essayTypeFilter" class="form-control" onchange="filterEssayProblems()">
                                    <option value="">全てのタイプ</option>
                                    <option value="A">タイプA</option>
                                    <option value="B">タイプB</option>
                                    <option value="C">タイプC</option>
                                    <option value="D">タイプD</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="essaySearch">キーワード検索:</label>
                                <input type="text" id="essaySearch" class="form-control" placeholder="問題文や大学名で検索..." onkeyup="filterEssayProblems()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 問題一覧 -->
                    <div id="essay-problems-container">
                        <p class="text-info">📋 問題一覧を読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー統計管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-stats" aria-expanded="false">
            <h3><i class="fas fa-chart-bar"></i> ユーザー統計管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-stats">
            <div class="section-content">
                <p>事前計算されたユーザー統計の状態確認・修復を行います。</p>

                <!-- 統計状態確認 -->
                <div class="admin-panel" style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
                    <h4>📈 統計データ状態確認</h4>
                    <p>ユーザー統計の整合性と最新性を確認します。<br>
                    <strong>推奨：</strong>新しいユーザーを追加した後や、データに不整合がある場合に実行してください。</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="checkUserStats()">
                            <i class="fas fa-chart-line"></i> 📊 統計状態を確認
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="repairUserStats()" style="margin-left: 10px;">
                            <i class="fas fa-tools"></i> 🔧 統計データを修復
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="initializeAllStats()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> 🔄 全統計を強制再初期化
                        </button>
                    </div>
                </div>

                <!-- 統計確認結果表示エリア -->
                <div id="statsCheckResult" style="margin-top: 15px; display: none;">
                    <h5>📊 統計状態確認結果</h5>
                    <div id="statsCheckContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <!-- 確認結果がここに表示されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- データベース管理セクション -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-database-management" aria-expanded="false">
            <h3><i class="fas fa-database"></i> データベース管理 <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-database-management">
            <div class="section-content">
                <p>学習履歴データの整合性確認とデータクリーンアップを行います。</p>

                <!-- 孤立したトークンのクリーンアップ -->
                <div class="admin-panel" style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                    <h4>🧹 孤立データのクリーンアップ</h4>
                    <p>削除されたユーザーに関連する古いパスワードリセットトークンを削除します。<br>
                    <strong>推奨：</strong>ユーザー削除後やメンテナンス時に実行してください。</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-warning" onclick="cleanupOrphanedTokens()">
                            <i class="fas fa-broom"></i> 🧹 孤立したトークンを削除
                        </button>
                        
                        <button type="button" class="btn btn-info" onclick="checkDatabaseStatus()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> 📊 データベース状態確認
                        </button>
                    </div>
                </div>

                <div class="admin-panel" style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
                    <h4>🗑️ ID不一致履歴の削除</h4>
                    <p>現在の問題データと一致しない古い学習履歴を削除します。<br>
                    <strong>用途：</strong>問題文修正後に古いIDの履歴を削除する場合に使用。<br>
                    <strong>⚠️ 注意：</strong>削除された履歴は復元できません。</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="analyzeInvalidHistoryDetailed()">
                            <i class="fas fa-search"></i> 📊 詳細分析（デバッグ版）
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory()" style="margin-left: 10px;">
                            <i class="fas fa-trash-alt"></i> 🗑️ 無効履歴を削除
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h5>🔍 特定ユーザーのデバッグ</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" id="debugUsername" class="form-control" placeholder="ユーザー名を入力">
                                    <button class="btn btn-outline-secondary" onclick="debugSpecificUser()">
                                        <i class="fas fa-bug"></i> デバッグ
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger btn-sm" onclick="forceCleanSpecificUser()">
                                    <i class="fas fa-exclamation-triangle"></i> 強制削除
                                </button>
                                <small class="text-muted d-block">※上記でユーザー名を入力後に使用</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 無効履歴分析結果表示エリア -->
                    <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                        <h5>📊 無効履歴分析結果</h5>
                        <div id="invalidAnalysisContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- 分析結果がここに表示されます -->
                        </div>
                    </div>
                    
                    <!-- デバッグ結果表示エリア -->
                    <div id="userDebugResult" style="margin-top: 15px; display: none;">
                        <h5>🔍 ユーザーデバッグ結果</h5>
                        <div id="debugContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- デバッグ結果がここに表示されます -->
                        </div>
                    </div>
                </div>

                <!-- 全データ修正（従来機能・バックアップ用） -->
                <div class="admin-panel" style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
                    <h4>⚠️ 全データ修正（バックアップ用）</h4>
                    <p>全ユーザーの学習履歴を強制的に新しいID形式に統一します。<br>
                    <strong>⚠️ 注意：</strong>この操作は全ユーザーの学習履歴に影響し、元に戻せません。<br>
                    <strong>推奨：</strong>通常は上記の「ID不一致問題のみ修正」を使用してください。</p>
                    
                    <div style="margin-top: 15px;">
                        <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST" style="display: inline;" 
                            onsubmit="return confirm('全ユーザーデータを修正しますか？\n\n⚠️ この操作は元に戻せません。\n⚠️ すべての学習履歴が新しい形式に変換されます。\n⚠️ 通常は「ID不一致問題のみ修正」で十分です。\n\n本当に実行しますか？')">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-exclamation-triangle"></i> ⚠️ 全データ強制修正（非推奨）
                            </button>
                            </form>
                        
                        <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank" style="margin-left: 10px;">
                            <i class="fas fa-chart-line"></i> 📊 修正前の状態確認
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- リセット確認フォーム（非表示） -->
<form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
</form>

<script>
// ========================================
// 1. 折りたたみ機能
// ========================================

// 全セクション展開
function expandAllSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(section => {
        const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
        bsCollapse.show();
    });
    updateToggleIcons();
}

// 全セクション折りたたみ
function collapseAllSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(section => {
        const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
        bsCollapse.hide();
    });
    updateToggleIcons();
}

// トグルアイコンの更新
function updateToggleIcons() {
    document.querySelectorAll('.admin-section').forEach(section => {
        const collapseElement = section.querySelector('.collapse');
        const toggleIcon = section.querySelector('.toggle-icon');
        
        if (collapseElement && toggleIcon) {
            const isShown = collapseElement.classList.contains('show');
            toggleIcon.className = isShown ? 'fas fa-chevron-up toggle-icon' : 'fas fa-chevron-down toggle-icon';
        }
    });
}

// 折りたたみイベントリスナーを設定
function initializeCollapseSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(collapseElement => {
        collapseElement.addEventListener('shown.bs.collapse', updateToggleIcons);
        collapseElement.addEventListener('hidden.bs.collapse', updateToggleIcons);
    });
}

// ========================================
// 2. 既存の管理機能（元のスクリプトから移植）
// ========================================

console.log('🔧 admin.html スクリプト読み込み開始');

// 部屋設定を再読み込みする関数
function loadRoomSettings() {
    console.log('🔄 部屋設定を再読み込み中...');
    
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const roomNumber = select.dataset.roomNumber;
        if (!roomNumber) return;
        
        fetch('/admin/get_room_setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_number: roomNumber })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const csvFilename = data.csv_filename || 'words.csv';
                console.log(`📋 部屋${roomNumber}の設定読み込み: ${csvFilename}`);
                
                select.value = csvFilename;
                
                const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                if (!optionExists && csvFilename !== 'words.csv') {
                    const newOption = document.createElement('option');
                    newOption.value = csvFilename;
                    newOption.textContent = csvFilename;
                    select.appendChild(newOption);
                    select.value = csvFilename;
                    console.log(`➕ 新しいオプション追加: ${csvFilename}`);
                }
            }
        })
        .catch(error => {
            console.error(`❌ 部屋${roomNumber}の設定読み込みエラー:`, error);
        });
    });
}

// CSVファイル一覧を読み込む関数
function loadCsvFilesList() {
    console.log('🔍 CSV ファイル一覧読み込み開始...');
    
    const container = document.getElementById('csv-files-container');
    if (container) {
        container.innerHTML = '<p class="text-info">📋 ファイル一覧を読み込み中...</p>';
    }
    
    fetch('{{ url_for("admin_list_room_csv_files") }}')
        .then(response => {
            console.log('📡 レスポンス受信:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 受信データ:', data);
            
            if (data.status === 'success') {
                console.log(`✅ ファイル一覧取得成功: ${data.files.length}件`);
                updateCsvFilesDisplay(data.files);
                updateCsvSelectOptions(data.files);
            } else {
                console.error('❌ ファイル一覧取得失敗:', data.message);
                if (container) {
                    container.innerHTML = '<p class="text-danger">❌ ファイル一覧の取得に失敗しました: ' + (data.message || '不明なエラー') + '</p>';
                }
            }
        })
        .catch(error => {
            console.error('❌ ファイル一覧取得エラー:', error);
            if (container) {
                container.innerHTML = '<p class="text-danger">❌ ファイル一覧の取得中にエラーが発生しました: ' + error.message + '</p>';
            }
        });
}

function addHoursToTimestamp(dateString, hours) {
    const date = new Date(dateString);
    date.setHours(date.getHours() + hours);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// CSVファイル表示を更新する関数
function updateCsvFilesDisplay(files) {
    console.log('🔄 ファイル表示更新:', files);
    
    const container = document.getElementById('csv-files-container');
    if (!container) {
        console.error('❌ csv-files-container が見つかりません');
        return;
    }
    
    if (files.length === 0) {
        console.log('📭 アップロードされたファイルなし');
        container.innerHTML = '<p class="text-muted">📭 アップロードされたCSVファイルはありません。</p>';
        return;
    }
    
    console.log(`📋 ${files.length}件のファイルを表示中...`);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
    html += '<thead class="table-dark"><tr><th>ファイル名</th><th>単語数</th><th>サイズ</th><th>更新日時</th><th>操作</th></tr></thead><tbody>';
    
    files.forEach((file, index) => {
        const sizeKB = Math.round(file.size / 1024);
        const wordCountDisplay = file.word_count > 0 ? `${file.word_count}問` : '不明';
        
        html += '<tr>' +
                '<td><code>' + file.filename + '</code></td>' +
                '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                '<td>' + sizeKB + ' KB</td>' +
                '<td><small>' + addHoursToTimestamp(file.modified, 9) + '</small></td>' +
                '<td><button class="btn btn-danger btn-sm" onclick="deleteCsvFile(\'' + file.filename + '\')">削除</button></td>' +
                '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    console.log('✅ ファイル表示更新完了');
}

// セレクトボックスのオプションを更新する関数
function updateCsvSelectOptions(files) {
    console.log('🔄 CSVセレクトオプション更新:', files);
    
    const selects = document.querySelectorAll('.csv-setting-select');
    console.log(`📋 更新対象セレクト数: ${selects.length}`);
    
    selects.forEach((select, index) => {
        const roomNumber = select.dataset.roomNumber;
        const currentValue = select.value;
        
        // デフォルト以外のオプションを削除
        Array.from(select.options).forEach(option => {
            if (option.value !== 'words.csv') {
                option.remove();
            }
        });
        
        // アップロードされたファイルをオプションに追加
        if (files && Array.isArray(files)) {
            files.forEach(file => {
                if (file.filename !== 'words.csv') {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = file.filename;
                    select.appendChild(option);
                }
            });
        }
        
        // 元の値を復元
        if (currentValue && currentValue !== '') {
            select.value = currentValue;
        }
    });
}

// CSVファイル削除関数
function deleteCsvFile(filename) {
    if (confirm('CSVファイル "' + filename + '" を削除しますか？\n\n⚠️ このファイルを使用している部屋の設定はデフォルトに戻ります。')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_delete_room_csv", filename="_FILENAME_") }}'.replace('_FILENAME_', filename);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ユーザーテーブルのソート機能
function initializeUserTableSort() {
    const table = document.getElementById('userTable');
    const tbody = document.getElementById('userTableBody');
    
    if (!table || !tbody) return;
    
    // ソートアイコンクリック処理
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const column = this.dataset.column;
            const isAscending = this.classList.contains('fa-sort-up');
            
            // 全アイコンをリセット
            document.querySelectorAll('.sort-icon').forEach(i => {
                i.className = 'fas fa-sort sort-icon';
            });
            
            // 現在のアイコンを更新
            this.className = `fas fa-sort-${isAscending ? 'down' : 'up'} sort-icon`;
            
            sortUserTable(column, !isAscending);
        });
    });
}

function sortUserTable(column, ascending) {
    const tbody = document.getElementById('userTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
            case 'room':
                aVal = a.cells[1].textContent.trim();
                bVal = b.cells[1].textContent.trim();
                break;
            case 'name':
                aVal = a.cells[3].textContent.trim();
                bVal = b.cells[3].textContent.trim();
                break;
            case 'login':
                aVal = a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim();
                // 日付の場合は Date オブジェクトに変換
                if (aVal !== '未ログイン') aVal = new Date(aVal);
                if (bVal !== '未ログイン') bVal = new Date(bVal);
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });
    
    // テーブルを再構築
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// ユーザー検索・フィルタリング機能
function initializeUserFiltering() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    
    if (roomSelect) {
        roomSelect.addEventListener('change', filterUsers);
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterUsers);
    }
}

function filterUsers() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    const tbody = document.getElementById('userTableBody');
    
    if (!tbody) return;
    
    const selectedRoom = roomSelect ? roomSelect.value : '';
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const roomMatch = !selectedRoom || row.dataset.room === selectedRoom;
        const searchMatch = !searchTerm || 
            row.dataset.name.includes(searchTerm) || 
            row.dataset.student.includes(searchTerm);
        
        row.style.display = (roomMatch && searchMatch) ? '' : 'none';
    });
}

// ========================================
// 3. DOMContentLoaded イベントリスナー
// ========================================
// 個別論述問題追加
document.addEventListener('DOMContentLoaded', function() {
    const essayForm = document.getElementById('newEssayProblemForm');
    
    // フォームが存在する場合のみイベントリスナーを追加
    if (essayForm) {
        essayForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const formData = new FormData(form);
            
            // 必須項目の確認
            const chapter = formData.get('chapter');
            const question = formData.get('question');
            const type = formData.get('type');
            
            if (!chapter || !question || !type) {
                alert('❌ 章、タイプ、問題文は必須項目です。');
                return;
            }
            
            // 有効フラグの処理
            const enabledCheckbox = document.getElementById('new_essay_enabled');
            if (enabledCheckbox && enabledCheckbox.checked) {
                formData.set('enabled', 'on');
            } else {
                formData.delete('enabled');
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 追加中...';
            
            // FormDataで送信（画像ファイル対応）
            fetch('/admin/essay/add_problem', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    let message = '✅ ' + data.message;
                    if (data.has_image) {
                        message += ' （画像付き）';
                    }
                    alert(message);
                    
                    // フォームをリセット
                    form.reset();
                    if (typeof clearImagePreview === 'function') {
                        clearImagePreview();
                    }
                    document.getElementById('new_essay_enabled').checked = true;
                    
                    // 統計情報を更新
                    if (typeof loadEssayStats === 'function') {
                        loadEssayStats();
                    }
                    if (typeof loadEssayProblems === 'function') {
                        loadEssayProblems();
                    }
                } else {
                    alert('❌ エラー: ' + data.message);
                }
            })
            .catch(error => {
                console.error('追加エラー:', error);
                alert('❌ 追加中にエラーが発生しました。');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // 画像プレビュー機能も安全にチェック
    window.previewImage = function(input) {
        const previewDiv = document.getElementById('imagePreview');
        if (!previewDiv) return;
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                previewDiv.innerHTML = `
                    <div class="image-preview-container">
                        <img src="${e.target.result}" alt="プレビュー" 
                             style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                                onclick="clearImagePreview()">
                            <i class="fas fa-times"></i> 削除
                        </button>
                    </div>
                `;
            };
            
            reader.readAsDataURL(input.files[0]);
        } else {
            clearImagePreview();
        }
    };
    
    // 画像プレビューをクリア
    window.clearImagePreview = function() {
        const previewDiv = document.getElementById('imagePreview');
        const imageInput = document.getElementById('new_essay_image');
        
        if (previewDiv) {
            previewDiv.innerHTML = '';
        }
        if (imageInput) {
            imageInput.value = '';
        }
    };
});

// ========================================
// 4. データベース管理系の関数
// ========================================

// 無効履歴の削除
function cleanInvalidHistory() {
    if (confirm('無効な学習履歴を削除しますか？\n\n⚠️ この操作は元に戻せません\n⚠️ 現在の問題データと一致しない履歴が完全に削除されます\n⚠️ 有効な履歴は保持されます\n\n削除を実行しますか？')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '削除中...';
        
        // フォームを作成して送信
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/clean_invalid_history';
        
        document.body.appendChild(form);
        form.submit();
    }
}

function cleanupOrphanedTokens() {
    if (confirm('孤立したパスワードリセットトークンを削除しますか？\n\n※削除されたユーザーに関連する古いトークンが対象です。')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'クリーンアップ中...';
        
        fetch('/admin/cleanup_orphaned_tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ ${data.message}`);
            } else {
                alert(`❌ エラー: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('クリーンアップエラー:', error);
            alert('❌ クリーンアップ中にエラーが発生しました。');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

function checkDatabaseStatus() {
    fetch('/admin/check_database_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const status = data.database_status;
                let message = '📊 データベース状態確認結果:\n\n';
                
                for (const [tableName, tableInfo] of Object.entries(status.tables)) {
                    message += `📋 ${tableName}: ${tableInfo.exists ? '存在' : '不在'}\n`;
                    if (tableInfo.missing_columns.length > 0) {
                        message += `   不足カラム: ${tableInfo.missing_columns.join(', ')}\n`;
                    }
                }
                
                if (status.needs_migration) {
                    message += '\n⚠️ マイグレーションが必要です。';
                } else {
                    message += '\n✅ データベースは正常です。';
                }
                
                alert(message);
            } else {
                alert(`❌ エラー: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('状態確認エラー:', error);
            alert('❌ データベース状態確認中にエラーが発生しました。');
        });
}

function analyzeInvalidHistoryDetailed() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '詳細分析中...';
    
    fetch('/admin/analyze_invalid_history_detailed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displayInvalidHistoryAnalysisDetailed(data.analysis);
        } else {
            alert(`❌ エラー: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('分析エラー:', error);
        alert('❌ 分析中にエラーが発生しました。');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// 詳細分析結果の表示
function displayInvalidHistoryAnalysisDetailed(analysis) {
    const resultDiv = document.getElementById('invalidHistoryAnalysisResult');
    const contentDiv = document.getElementById('invalidAnalysisContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>📊 削除対象統計</h6>
                <ul>
                    <li>総ユーザー数: ${analysis.total_users}人</li>
                    <li>無効履歴があるユーザー: ${analysis.users_with_invalid}人</li>
                    <li>無効な学習履歴: ${analysis.total_invalid_entries}個</li>
                    <li>無効な苦手問題: ${analysis.total_invalid_incorrect}個</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>💡 推奨アクション</h6>
                ${analysis.users_with_invalid === 0 ? 
                    '<p class="text-success">✅ 無効な履歴はありません。削除は不要です。</p>' :
                    `<p class="text-warning">⚠️ ${analysis.total_invalid_entries}個の無効履歴があります。<br>「無効履歴を削除」の実行を推奨します。</p>`
                }
            </div>
        </div>
    `;
    
    if (analysis.user_details.length > 0) {
        html += '<h6>👥 影響を受けるユーザー</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>ユーザー名</th><th>部屋</th><th>有効履歴</th><th>無効履歴</th><th>無効苦手問題</th><th>サンプル無効ID</th></tr></thead><tbody>';
        
        analysis.user_details.forEach(user => {
            const sampleId = user.invalid_history_ids.length > 0 ? 
                user.invalid_history_ids[0].substring(0, 40) + '...' : 
                (user.invalid_incorrect_ids.length > 0 ? user.invalid_incorrect_ids[0].substring(0, 40) + '...' : '-');
            
            html += `<tr>
                <td>${user.username}</td>
                <td>${user.room_number}</td>
                <td class="text-success">${user.valid_history}</td>
                <td class="text-warning">${user.invalid_history}</td>
                <td class="text-warning">${user.invalid_incorrect}</td>
                <td><small class="text-muted">${sampleId}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// 特定ユーザーの強制削除
function forceCleanSpecificUser() {
    const username = document.getElementById('debugUsername').value.trim();
    if (!username) {
        alert('ユーザー名を入力してください。');
        return;
    }
    
    if (confirm(`ユーザー「${username}」の不一致履歴を強制削除しますか？\n\n⚠️ この操作は元に戻せません\n⚠️ 無効なIDの履歴のみが削除されます`)) {
        // フォームを作成して送信
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/force_clean_user/${encodeURIComponent(username)}`;
        
        document.body.appendChild(form);
        form.submit();
    }
}

function checkUserStats() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '確認中...';
    
    fetch('/admin/check_user_stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayStatsCheckResult(data);
            } else {
                alert(`❌ エラー: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('統計確認エラー:', error);
            alert('❌ 統計確認中にエラーが発生しました。');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
}

// 統計確認結果の表示
function displayStatsCheckResult(data) {
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    const summary = data.summary;
    const roomStats = data.room_stats;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>📊 全体統計</h6>
                <ul>
                    <li>総ユーザー数: ${summary.total_users}人</li>
                    <li>統計データ数: ${summary.total_stats}個</li>
                    <li>統計なしユーザー: ${summary.users_without_stats}人</li>
                    <li>古い統計: ${summary.outdated_stats}個</li>
                    <li>カバー率: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>💡 推奨アクション</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ? 
                    '<p class="text-success">✅ 統計データは最新です。修復は不要です。</p>' :
                    `<p class="text-warning">⚠️ ${summary.users_without_stats + summary.outdated_stats}件の統計に問題があります。<br>「統計データを修復」の実行を推奨します。</p>`
                }
            </div>
        </div>
    `;
    
    if (roomStats.length > 0) {
        html += '<h6>🏠 部屋別統計</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>部屋番号</th><th>ユーザー数</th><th>平均スコア</th><th>最高スコア</th></tr></thead><tbody>';
        
        roomStats.forEach(room => {
            html += `<tr>
                <td><span class="badge bg-secondary">${room.room_number}</span></td>
                <td>${room.user_count}人</td>
                <td>${room.avg_score}</td>
                <td class="text-success"><strong>${room.max_score}</strong></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// 統計データの修復
function repairUserStats() {
    if (confirm('統計データの修復を実行しますか？\n\n・統計がないユーザーに新規作成\n・古い統計データを更新\n\n処理に時間がかかる場合があります。')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '修復中...';
        
        fetch('/admin/repair_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ ${data.message}`);
                // 修復後に状態を再確認
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`❌ エラー: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('修復エラー:', error);
            alert('❌ 修復中にエラーが発生しました。');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// 全統計の強制再初期化
function initializeAllStats() {
    if (confirm('全ユーザーの統計を強制再初期化しますか？\n\n⚠️ この操作は時間がかかります\n⚠️ 全ての統計データが再計算されます\n\n実行しますか？')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '初期化中...';
        
        fetch('/admin/initialize_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ ${data.message}`);
                // 初期化後に状態を再確認
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`❌ エラー: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('初期化エラー:', error);
            alert('❌ 初期化中にエラーが発生しました。');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

console.log('🎉 admin.html スクリプト読み込み完了');

// ========================================
// 単元選択管理機能
// ========================================

// 利用可能な単元一覧を読み込む
function loadAvailableUnits(roomNumber) {
    console.log(`🔍 単元一覧読み込み: 部屋${roomNumber}`);
    
    const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
    if (!container) return;
    
    container.innerHTML = '<p class="text-info">読み込み中...</p>';
    
    fetch(`/admin/get_available_units/${roomNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayUnitCheckboxes(roomNumber, data.available_units);
                loadCurrentUnitSettings(roomNumber);
            } else {
                container.innerHTML = '<p class="text-danger">エラー: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            console.error('単元一覧取得エラー:', error);
            container.innerHTML = '<p class="text-danger">単元一覧の取得に失敗しました</p>';
        });
}

// 単元チェックボックスを表示
function displayUnitCheckboxes(roomNumber, availableUnits) {
    const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
    if (!container) return;
    
    if (availableUnits.length === 0) {
        container.innerHTML = '<p class="text-muted">利用可能な単元がありません</p>';
        return;
    }
    
    let html = '<div class="units-grid">';
    
    availableUnits.forEach(unit => {
        html += `
            <div class="form-check form-check-inline unit-checkbox">
                <input class="form-check-input" type="checkbox" 
                       id="unit_${roomNumber}_${unit}" 
                       value="${unit}"
                       onchange="updateSelectedCount('${roomNumber}')">
                <label class="form-check-label" for="unit_${roomNumber}_${unit}">
                    ${unit}
                </label>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log(`✅ 単元チェックボックス表示完了: ${availableUnits.length}個`);
}

// 現在の単元設定を読み込み
function loadCurrentUnitSettings(roomNumber) {
    fetch('/admin/get_room_setting', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room_number: roomNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.enabled_units) {
            const enabledUnits = data.enabled_units;
            
            // チェックボックスの状態を更新
            enabledUnits.forEach(unit => {
                const checkbox = document.getElementById(`unit_${roomNumber}_${unit}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            updateSelectedCount(roomNumber);
            console.log(`✅ 現在の設定適用: ${enabledUnits.length}個の単元が有効`);
        }
    })
    .catch(error => {
        console.error('現在設定の取得エラー:', error);
    });
}

// 選択された単元数を更新
function updateSelectedCount(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
    const countElement = document.getElementById(`selectedCount_${roomNumber}`);
    
    if (countElement) {
        countElement.textContent = checkboxes.length;
    }
}

// 全ての単元を選択
function selectAllUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount(roomNumber);
    console.log(`✅ 全単元選択: 部屋${roomNumber}`);
}

// 全ての単元選択を解除
function clearAllUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount(roomNumber);
    console.log(`🔄 全単元解除: 部屋${roomNumber}`);
}

// 選択された単元のリストを取得
function getSelectedUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
    return Array.from(checkboxes).map(cb => cb.value);
}

// 部屋設定保存ボタンのイベントリスナーを修正
document.addEventListener('DOMContentLoaded', function() {
    // 既存のイベントリスナーを削除して新しいものに置き換え
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        // 既存のイベントリスナーを削除
        button.replaceWith(button.cloneNode(true));
    });
    
    // 新しいイベントリスナーを追加
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;
            const csvFileSelect = document.getElementById('csvFile_' + roomNumber);
            
            console.log(`🔧 部屋設定保存開始: ${roomNumber}`);
            
            if (!csvFileSelect) {
                alert('設定要素が見つかりません。');
                return;
            }
            
            // 選択された単元を取得
            const selectedUnits = getSelectedUnits(roomNumber);
            const csvFilename = csvFileSelect.value;
            
            console.log(`📝 保存する設定:`, {
                roomNumber: roomNumber,
                selectedUnits: selectedUnits,
                csvFilename: csvFilename
            });

            // ボタンを無効化して重複実行を防ぐ
            this.disabled = true;
            this.textContent = '保存中...';

            // 単元設定、CSVファイル設定を同時に更新
            Promise.all([
                fetch('/admin/update_room_units_setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        enabled_units: selectedUnits
                    })
                }),
                fetch('/admin/update_room_csv_setting', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        csv_filename: csvFilename
                    })
                })
            ])
            .then(responses => {
                console.log('📡 サーバーレスポンス受信:', responses.map(r => r.status));
                return Promise.all(responses.map(r => r.json()));
            })
            .then(results => {
                const unitResult = results[0];
                const csvResult = results[1];
                
                console.log('📊 保存結果:', { unitResult, csvResult });
                
                if (unitResult.status === 'success' && csvResult.status === 'success') {
                    alert(`✅ 部屋 ${roomNumber} の設定を更新しました:\n・有効単元: ${selectedUnits.length}個\n・CSVファイル: ${csvFilename}`);
                    
                    // 設定を再読み込み
                    loadRoomSettings();
                } else {
                    const errorMsg = (unitResult.message || csvResult.message || '不明なエラー');
                    alert('❌ 設定の保存中にエラーが発生しました: ' + errorMsg);
                    console.error('❌ 保存エラー:', { unitResult, csvResult });
                }
            })
            .catch(error => {
                console.error('❌ 保存処理中にエラー:', error);
                alert('❌ 設定の保存中にエラーが発生しました: ' + error.message);
            })
            .finally(() => {
                // ボタンを元に戻す
                this.disabled = false;
                this.textContent = '保存';
            });
        });
    });
});

// 論述問題CSVテンプレートダウンロード
function downloadEssayTemplate() {
    const link = document.createElement('a');
    link.href = '/admin/download_essay_template';
    link.download = 'essay_problems_template.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 論述問題統計をロード
function loadEssayStats() {
    fetch('/admin/essay/stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateEssayStatistics(data);
                
                // 章リストを取得して動的にフィルターを更新
                fetch('/admin/essay/chapters')
                    .then(response => response.json())
                    .then(chaptersData => {
                        if (chaptersData.status === 'success') {
                            updateChapterFilter(chaptersData.chapters);
                        }
                    })
                    .catch(error => console.error('章リスト取得エラー:', error));
            }
        })
        .catch(error => {
            console.error('統計取得エラー:', error);
        });
}

// 論述問題CSVアップロード
document.getElementById('essayUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('essay_csv_file');
    const replaceCheckbox = document.getElementById('replaceExisting');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    if (!fileInput.files.length) {
        alert('❌ CSVファイルを選択してください。');
        return;
    }
    
    const file = fileInput.files[0];
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('❌ CSVファイルを選択してください。');
        return;
    }
    
    // 既存データ削除の確認
    if (replaceCheckbox.checked) {
        if (!confirm('⚠️ 既存の全ての論述問題が削除されます。本当に実行しますか？')) {
            return;
        }
    }
    
    const formData = new FormData();
    formData.append('file', file);
    if (replaceCheckbox.checked) {
        formData.append('replace_existing', 'on');
    }
    
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> アップロード中...';
    
    fetch('/admin/essay/upload_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `✅ ${data.message}`;
            if (data.added_count > 0) {
                message += `\n📊 追加された問題数: ${data.added_count}件`;
            }
            if (data.error_count > 0) {
                message += `\n⚠️ エラー件数: ${data.error_count}件`;
            }
            if (data.error_details && data.error_details.length > 0) {
                message += `\n\n詳細なエラー:\n${data.error_details.join('\n')}`;
            }
            alert(message);
            
            // フォームをリセット
            this.reset();
            
            // 統計情報を更新
            loadEssayStats();
            loadEssayProblems();
        } else {
            let errorMessage = `❌ エラー: ${data.message}`;
            if (data.error_details && data.error_details.length > 0) {
                errorMessage += `\n\n詳細:\n${data.error_details.join('\n')}`;
            }
            alert(errorMessage);
        }
    })
    .catch(error => {
        console.error('アップロードエラー:', error);
        alert('❌ アップロード中にエラーが発生しました。\nファイル形式とエンコーディング（UTF-8）を確認してください。');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

// 既存のloadEssayProblems関数を以下で完全に置き換える
function loadEssayProblems() {
    const container = document.getElementById('essay-problems-container');
    if (!container) return;
    
    container.innerHTML = '<p class="text-info">📋 問題一覧を読み込み中...</p>';
    
    const chapter = document.getElementById('essayChapterFilter')?.value || '';
    const type = document.getElementById('essayTypeFilter')?.value || '';
    const search = document.getElementById('essaySearch')?.value || '';
    
    const params = new URLSearchParams();
    if (chapter) params.append('chapter', chapter);
    if (type) params.append('type', type);
    if (search) params.append('search', search);
    
    fetch('/admin/essay/problems?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 章フィルターを更新（データに章リストが含まれている場合）
                if (data.chapters && data.chapters.length > 0) {
                    updateChapterFilter(data.chapters);
                }
                
                // 問題一覧を表示
                if (data.problems && data.problems.length > 0) {
                    // 統計サマリーを追加
                    let html = `
                        <div class="essay-stats-summary">
                            <div class="stat-item">
                                <div class="stat-value">${data.pagination.total}</div>
                                <div class="stat-label">総問題数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.problems.length}</div>
                                <div class="stat-label">表示中</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.pagination.pages}</div>
                                <div class="stat-label">総ページ数</div>
                            </div>
                        </div>
                        <div class="essay-problems-list">
                    `;
                    
                    // 各問題を表示
                    data.problems.forEach(problem => {
                        const typeColor = {
                            'A': 'type-A',
                            'B': 'type-B', 
                            'C': 'type-C',
                            'D': 'type-D'
                        }[problem.type] || '';
                        
                        const enabledBadge = problem.enabled 
                            ? '<span class="badge bg-success"><i class="fas fa-check"></i> 有効</span>'
                            : '<span class="badge bg-secondary"><i class="fas fa-times"></i> 無効</span>';
                        
                        // 問題文を短縮（100文字まで）
                        const shortQuestion = problem.question.length > 100 
                            ? problem.question.substring(0, 100) + '...' 
                            : problem.question;
                        
                        html += `
                            <div class="essay-problem-item">
                                <div class="problem-header">
                                    <div class="problem-info">
                                        <span class="badge badge-chapter">
                                            <i class="fas fa-book"></i> 第${problem.chapter}章
                                        </span>
                                        <span class="badge badge-${typeColor}">
                                            <i class="fas fa-tag"></i> タイプ${problem.type}
                                        </span>
                                        ${enabledBadge}
                                        <div class="university-info">
                                            <i class="fas fa-university"></i>
                                            <span>${problem.university} ${problem.year}年</span>
                                        </div>
                                    </div>
                                    <div class="problem-actions">
                                        <button class="btn btn-sm btn-info" onclick="editEssayProblem(${problem.id})" title="編集">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="toggleEssayProblem(${problem.id}, ${problem.enabled})" title="有効/無効">
                                            <i class="fas fa-toggle-${problem.enabled ? 'on' : 'off'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteEssayProblem(${problem.id})" title="削除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="problem-content">
                                    <p class="problem-question">
                                        <strong>問題:</strong> ${shortQuestion}
                                    </p>
                                </div>
                                <div class="problem-meta">
                                    <div class="problem-meta-item">
                                        <i class="fas fa-file-alt"></i>
                                        <span>解答: ${problem.answer_length}文字</span>
                                    </div>
                                    <div class="problem-meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>ID: ${problem.id}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-warning">⚠️ 該当する問題が見つかりませんでした。</p>';
                }
            } else {
                container.innerHTML = '<p class="text-danger">❌ エラー: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            console.error('読み込みエラー:', error);
            container.innerHTML = '<p class="text-danger">❌ 問題一覧の読み込み中にエラーが発生しました。</p>';
        });
}

// 論述問題一覧を表示
function displayEssayProblems(problems) {
    const container = document.getElementById('essay-problems-container');
    
    if (!problems || !Array.isArray(problems)) {
        container.innerHTML = '<p class="text-danger">❌ 問題データが不正です</p>';
        return;
    }
    
    if (problems.length === 0) {
        container.innerHTML = '<p class="text-muted">📭 条件に合う論述問題が見つかりません。</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
    html += '<thead class="table-dark"><tr>';
    html += '<th>ID</th><th>章</th><th>タイプ</th><th>大学</th><th>年度</th>';
    html += '<th>問題文（抜粋）</th><th>文字数</th><th>状態</th><th>操作</th>';
    html += '</tr></thead><tbody>';
    
    problems.forEach(problem => {
        // 各プロパティの存在を確認
        const questionPreview = (problem.question && problem.question.length > 50) ? 
            problem.question.substring(0, 50) + '...' : (problem.question || '問題文なし');
        
        html += '<tr>';
        html += '<td>' + (problem.id || 'N/A') + '</td>';
        html += '<td><span class="badge bg-secondary">' + (problem.chapter || 'N/A') + '</span></td>';
        html += '<td><span class="badge bg-' + getTypeColor(problem.type || 'A') + '">' + (problem.type || 'A') + '</span></td>';
        html += '<td>' + (problem.university || '未設定') + '</td>';
        html += '<td>' + (problem.year || 'N/A') + '</td>';
        html += '<td><small>' + questionPreview + '</small></td>';
        html += '<td>' + (problem.answer_length || 0) + '字</td>';
        html += '<td>';
        if (problem.enabled) {
            html += '<span class="badge bg-success">有効</span>';
        } else {
            html += '<span class="badge bg-secondary">無効</span>';
        }
        html += '</td>';
        html += '<td>';
        html += '<div class="btn-group-vertical btn-group-sm">';
        html += '<button class="btn btn-primary btn-sm" onclick="editEssayProblem(' + (problem.id || 0) + ')">編集</button>';
        html += '<button class="btn btn-warning btn-sm" onclick="toggleEssayProblem(' + (problem.id || 0) + ', ' + (problem.enabled || false) + ')">切替</button>';
        html += '<button class="btn btn-danger btn-sm" onclick="deleteEssayProblem(' + (problem.id || 0) + ')">削除</button>';
        html += '</div></td>';
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// タイプ別の色を取得
function getTypeColor(type) {
    switch(type) {
        case 'A': return 'danger';
        case 'B': return 'warning';
        case 'C': return 'info';
        case 'D': return 'success';
        default: return 'secondary';
    }
}

// 章フィルターを更新
function updateChapterFilter(chapters) {
    const select = document.getElementById('essayChapterFilter');
    const currentValue = select.value;
    
    // 既存オプションを削除（最初の全ての章は残す）
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // 新しいオプションを追加
    chapters.forEach(chapter => {
        const option = document.createElement('option');
        option.value = chapter;
        // 表示テキストをフォーマット
        if (chapter === 'com') {
            option.textContent = '総合問題';
        } else if (!isNaN(chapter)) {
            option.textContent = '第' + chapter + '章';
        } else {
            option.textContent = chapter;
        }
        select.appendChild(option);
    });
    
    // 値を復元
    select.value = currentValue;
}

// 論述問題編集
function editEssayProblem(problemId) {
    // まず問題データを取得
    fetch(`/admin/essay/problem/${problemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showEditDialog(data.problem);
            } else {
                alert('❌ エラー: ' + data.message);
            }
        })
        .catch(error => {
            console.error('問題取得エラー:', error);
            alert('❌ 問題データの取得中にエラーが発生しました。');
        });
}

// 論述問題更新（共通関数）
function updateEssayProblem(problemId, updateData) {
    fetch('/admin/essay/update_problem', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            problem_id: problemId,
            ...updateData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('✅ ' + data.message);
            loadEssayProblems();
        } else {
            alert('❌ エラー: ' + data.message);
        }
    })
    .catch(error => {
        console.error('更新エラー:', error);
        alert('❌ 更新中にエラーが発生しました。');
    });
}

function showEditDialog(problem) {
    // 既存のモーダルがあれば削除
    const existingModal = document.getElementById('editEssayModal');
    if (existingModal) {
        existingModal.remove();
    }

    // モーダルHTML作成
    const modalHTML = `
        <div class="modal fade" id="editEssayModal" tabindex="-1" aria-labelledby="editEssayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="editEssayModalLabel">
                            <i class="fas fa-edit"></i> 論述問題編集 (ID: ${problem.id})
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEssayForm">
                            <input type="hidden" id="edit_problem_id" value="${problem.id}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_chapter" class="form-label">
                                            <i class="fas fa-bookmark"></i> 章 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit_chapter" value="${problem.chapter}" required>
                                        <small class="form-text text-muted">例: 1, 2, com</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="edit_type" class="form-label">
                                            <i class="fas fa-tag"></i> タイプ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control" id="edit_type" required>
                                            <option value="A" ${problem.type === 'A' ? 'selected' : ''}>タイプA (200字以上)</option>
                                            <option value="B" ${problem.type === 'B' ? 'selected' : ''}>タイプB (100-150字程度)</option>
                                            <option value="C" ${problem.type === 'C' ? 'selected' : ''}>タイプC (50-75字程度)</option>
                                            <option value="D" ${problem.type === 'D' ? 'selected' : ''}>タイプD (30字程度)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="edit_university" class="form-label">
                                            <i class="fas fa-university"></i> 大学名
                                        </label>
                                        <input type="text" class="form-control" id="edit_university" value="${problem.university || ''}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="edit_year" class="form-label">
                                            <i class="fas fa-calendar-alt"></i> 年度
                                        </label>
                                        <input type="number" class="form-control" id="edit_year" value="${problem.year || 2025}" min="2000" max="2030">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_question" class="form-label">
                                    <i class="fas fa-question-circle"></i> 問題文 <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="edit_question" rows="4" required>${problem.question}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit_answer" class="form-label">
                                    <i class="fas fa-lightbulb"></i> 模範解答
                                </label>
                                <textarea class="form-control" id="edit_answer" rows="6">${problem.answer || ''}</textarea>
                                <small class="form-text text-muted">文字数: <span id="answerLength">${(problem.answer || '').length}</span>字</small>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_enabled" ${problem.enabled ? 'checked' : ''}>
                                <label class="form-check-label" for="edit_enabled">
                                    <i class="fas fa-check-circle"></i> 有効にする
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> キャンセル
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveEssayProblem()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // DOMに追加
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // 文字数カウンター設定
    const answerTextarea = document.getElementById('edit_answer');
    const answerLengthSpan = document.getElementById('answerLength');
    
    answerTextarea.addEventListener('input', function() {
        answerLengthSpan.textContent = this.value.length;
    });

    // モーダル表示
    const modal = new bootstrap.Modal(document.getElementById('editEssayModal'));
    modal.show();

    // モーダルが閉じられた時の cleanup
    document.getElementById('editEssayModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function saveEssayProblem() {
    const problemId = document.getElementById('edit_problem_id').value;
    const submitBtn = document.querySelector('#editEssayModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    
    // バリデーション
    const chapter = document.getElementById('edit_chapter').value.trim();
    const question = document.getElementById('edit_question').value.trim();
    const type = document.getElementById('edit_type').value;
    
    if (!chapter || !question || !type) {
        alert('❌ 章、タイプ、問題文は必須項目です。');
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
    
    const data = {
        problem_id: parseInt(problemId),
        chapter: chapter,
        type: type,
        university: document.getElementById('edit_university').value.trim() || '未指定',
        year: parseInt(document.getElementById('edit_year').value) || 2025,
        question: question,
        answer: document.getElementById('edit_answer').value.trim() || '解答なし',
        enabled: document.getElementById('edit_enabled').checked
    };
    
    fetch('/admin/essay/update_problem', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('✅ ' + data.message);
            
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('editEssayModal'));
            modal.hide();
            
            // 問題一覧を更新
            loadEssayProblems();
            loadEssayStats();
        } else {
            alert('❌ エラー: ' + data.message);
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('❌ 保存中にエラーが発生しました。');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// フィルター機能を改善
function filterEssayProblems() {
    loadEssayProblems();
}

// 編集内容を保存
function saveEditedProblem(problemId) {
    const formData = {
        chapter: document.getElementById('edit_chapter').value,
        type: document.getElementById('edit_type').value,
        university: document.getElementById('edit_university').value,
        year: parseInt(document.getElementById('edit_year').value),
        question: document.getElementById('edit_question').value,
        answer: document.getElementById('edit_answer').value,
        enabled: document.getElementById('edit_enabled').checked
    };
    
    const saveBtn = event.target;
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';
    
    // ★ POSTメソッドに変更し、URLも変更
    fetch('/admin/essay/update_problem', {
        method: 'POST',  // PUT から POST に変更
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            problem_id: problemId,  // ★ problem_id を追加
            ...formData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('✅ ' + data.message);
            // モーダルを閉じる
            bootstrap.Modal.getInstance(document.getElementById('editEssayModal')).hide();
            loadEssayProblems();
            if (typeof loadEssayStats === 'function') {
                loadEssayStats();
            }
        } else {
            alert('❌ エラー: ' + data.message);
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('❌ 保存中にエラーが発生しました。');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
    });
}

// 論述問題の有効/無効切り替え
function toggleEssayProblem(problemId, currentEnabled) {
    const newStatus = !currentEnabled;
    const action = newStatus ? '有効' : '無効';
    
    if (confirm('この問題を' + action + 'にしますか？')) {
        fetch('/admin/essay/toggle_enabled', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                problem_id: problemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message);
                loadEssayProblems();
                loadEssayStats();
            } else {
                alert('❌ エラー: ' + data.message);
            }
        })
        .catch(error => {
            console.error('切り替えエラー:', error);
            alert('❌ 切り替え中にエラーが発生しました。');
        });
    }
}

// loadEssayStats関数が定義されていない場合のフォールバック
if (typeof loadEssayStats === 'undefined') {
    window.loadEssayStats = function() {
        console.log('loadEssayStats関数は現在利用できません');
        // 統計の再読み込みを試行
        if (typeof updateEssayStatistics === 'function') {
            updateEssayStatistics();
        }
    };
}

function updateEssayStatistics() {
    fetch('/admin/essay/stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.stats) {
                const statsElements = {
                    'totalEssayProblems': data.stats.total_problems || 0,
                    'enabledEssayProblems': data.stats.total_problems || 0,
                    'totalChapters': data.stats.total_chapters || 0,
                    'totalUniversities': data.stats.total_universities || 0
                };
                
                Object.entries(statsElements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            }
        })
        .catch(error => {
            console.error('統計更新エラー:', error);
        });
}

// 論述問題削除
function deleteEssayProblem(problemId) {
    if (confirm('この論述問題を削除しますか？\n\n⚠️ この操作は元に戻せません。')) {
        fetch('/admin/essay/delete_problem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                problem_id: problemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message);
                loadEssayProblems();
                if (typeof loadEssayStats === 'function') {
                    loadEssayStats();
                }
            } else {
                alert('❌ エラー: ' + data.message);
            }
        })
        .catch(error => {
            console.error('削除エラー:', error);
            alert('❌ 削除中にエラーが発生しました。');
        });
    }
}

// CSV出力
function exportEssayProblems() {
    const chapter = document.getElementById('essayChapterFilter').value;
    const type = document.getElementById('essayTypeFilter').value;
    const search = document.getElementById('essaySearch').value;
    
    const params = new URLSearchParams();
    if (chapter) params.append('chapter', chapter);
    if (type) params.append('type', type);
    if (search) params.append('search', search);
    
    window.open('/admin/essay/export_csv?' + params.toString(), '_blank');
}

// フィルター変更時の自動更新
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('essayChapterFilter').addEventListener('change', loadEssayProblems);
    document.getElementById('essayTypeFilter').addEventListener('change', loadEssayProblems);
    
    let searchTimeout;
    document.getElementById('essaySearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadEssayProblems, 500);
    });
    setTimeout(() => {
        // 論述問題統計とリストを読み込み
        if (document.getElementById('essay-stats-container')) {
            loadEssayStats();
        }
        if (document.getElementById('essay-problems-container')) {
            loadEssayProblems();
        }
    }, 1000);
    
    // 論述問題フィルター機能の初期化
    const essayChapterFilter = document.getElementById('essayChapterFilter');
    const essayTypeFilter = document.getElementById('essayTypeFilter');
    const essaySearch = document.getElementById('essaySearch');
    
    if (essayChapterFilter) {
        essayChapterFilter.addEventListener('change', filterEssayProblems);
    }
    if (essayTypeFilter) {
        essayTypeFilter.addEventListener('change', filterEssayProblems);
    }
    if (essaySearch) {
        essaySearch.addEventListener('input', debounce(filterEssayProblems, 500));
    }
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 画像プレビュー機能
function previewImage(input) {
    const previewDiv = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewDiv.innerHTML = `
                <div class="image-preview-container">
                    <img src="${e.target.result}" alt="プレビュー" 
                         style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" 
                            onclick="clearImagePreview()">
                        <i class="fas fa-times"></i> 削除
                    </button>
                </div>
            `;
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        clearImagePreview();
    }
}

// 画像プレビューをクリア
function clearImagePreview() {
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('new_essay_image').value = '';
}

function addEssayProblem() {
    const form = document.getElementById('newEssayProblemForm');
    const formData = new FormData(form);
    
    // 有効フラグの処理
    const enabledCheckbox = document.getElementById('new_essay_enabled');
    if (enabledCheckbox.checked) {
        formData.set('enabled', 'on');
    }
    
    fetch('/admin/essay/add_problem', {
        method: 'POST',
        body: formData  // JSONではなくFormDataを送信
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`✅ ${data.message}`);
            form.reset();
            clearImagePreview();  // 画像プレビューもクリア
            loadEssayProblems();  // 問題一覧を再読み込み
        } else {
            alert(`❌ エラー: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('問題追加エラー:', error);
        alert('❌ 問題の追加中にエラーが発生しました');
    });
}

// 論述問題公開設定管理のJavaScript（改善版）

let currentVisibilitySettings = {};
let availableChapters = [];
let availableTypes = ['A', 'B', 'C', 'D'];

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeVisibilitySettings();
});

function initializeVisibilitySettings() {
    // 部屋一覧を読み込み
    loadRoomList();
    
    // イベントリスナーを設定
    document.getElementById('visibilityRoomSelect').addEventListener('change', function() {
        const selectedRoom = this.value;
        const loadBtn = document.getElementById('loadVisibilitySettings');
        const saveBtn = document.getElementById('saveVisibilitySettings');
        const resetBtn = document.getElementById('resetVisibilitySettings');
        
        if (selectedRoom) {
            loadBtn.disabled = false;
            saveBtn.disabled = false;
            resetBtn.disabled = false;
        } else {
            loadBtn.disabled = true;
            saveBtn.disabled = true;
            resetBtn.disabled = true;
            document.getElementById('visibilityMatrix').style.display = 'none';
        }
    });
    
    document.getElementById('loadVisibilitySettings').addEventListener('click', loadVisibilitySettings);
    document.getElementById('saveVisibilitySettings').addEventListener('click', saveVisibilitySettings);
    document.getElementById('resetVisibilitySettings').addEventListener('click', resetVisibilitySettings);
}

function loadRoomList() {
    fetch('/admin/get_room_list')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const select = document.getElementById('visibilityRoomSelect');
                
                // 既存オプションをクリア（最初のオプションは残す）
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // 部屋番号を追加
                data.rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = `部屋 ${room}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('部屋一覧読み込みエラー:', error);
            showVisibilityStatus('error', '部屋一覧の読み込みに失敗しました');
        });
}

function loadVisibilitySettings() {
    const roomNumber = document.getElementById('visibilityRoomSelect').value;
    if (!roomNumber) return;
    
    showVisibilityStatus('info', '設定を読み込み中...');
    
    fetch(`/admin/essay_visibility_settings/${roomNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                currentVisibilitySettings = data.settings;
                availableChapters = data.chapters;
                createVisibilityMatrix();
                updateSettingsSummary();
                showVisibilityStatus('success', `部屋 ${roomNumber} の設定を読み込みました`);
            } else {
                showVisibilityStatus('error', data.message);
            }
        })
        .catch(error => {
            console.error('設定読み込みエラー:', error);
            showVisibilityStatus('error', '設定の読み込みに失敗しました');
        });
}

function createVisibilityMatrix() {
    const tbody = document.getElementById('visibilityTableBody');
    tbody.innerHTML = '';
    
    availableChapters.forEach(chapter => {
        const row = document.createElement('tr');
        
        // 章名セル
        const chapterCell = document.createElement('td');
        chapterCell.className = 'chapter-name';
        chapterCell.textContent = chapter === 'com' ? '総合問題' : `第${chapter}章`;
        row.appendChild(chapterCell);
        
        // 各タイプのセル
        availableTypes.forEach(type => {
            const cell = document.createElement('td');
            cell.className = 'visibility-cell';
            cell.dataset.chapter = chapter;
            cell.dataset.type = type;
            
            // 現在の設定状態を取得
            const isVisible = getVisibilitySetting(chapter, type);
            updateCellAppearance(cell, isVisible);
            
            // ★重要：個別クリックイベント
            cell.addEventListener('click', function(event) {
                event.stopPropagation(); // イベントの伝播を停止
                toggleIndividualVisibility(chapter, type, cell);
            });
            
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    });
    
    document.getElementById('visibilityMatrix').style.display = 'block';
}

function getVisibilitySetting(chapter, type) {
    // 設定が存在する場合はその値、存在しない場合はデフォルトでtrue（公開）
    if (currentVisibilitySettings[chapter] && currentVisibilitySettings[chapter][type] !== undefined) {
        return currentVisibilitySettings[chapter][type];
    }
    return true;
}

function updateCellAppearance(cell, isVisible) {
    cell.classList.remove('visible', 'hidden');
    cell.classList.add(isVisible ? 'visible' : 'hidden');
    
    const iconClass = isVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
    const statusText = isVisible ? '公開' : '非公開';
    
    cell.innerHTML = `
        <div class="status-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="status-text">${statusText}</div>
    `;
}

function toggleIndividualVisibility(chapter, type, cell) {
    const currentState = getVisibilitySetting(chapter, type);
    const newState = !currentState; // トグル（反転）
    
    console.log(`🔄 個別切り替え: 第${chapter}章 タイプ${type} ${currentState ? '公開' : '非公開'} → ${newState ? '公開' : '非公開'}`);
    
    // 設定を更新
    if (!currentVisibilitySettings[chapter]) {
        currentVisibilitySettings[chapter] = {};
    }
    currentVisibilitySettings[chapter][type] = newState;
    
    // セルの外観を更新
    updateCellAppearance(cell, newState);
    cell.classList.add('changed');
    
    // アニメーション終了後にクラスを削除
    setTimeout(() => {
        cell.classList.remove('changed');
    }, 500);
    
    // サマリーを更新
    updateSettingsSummary();
    
    // 変更をユーザーに通知
    showVisibilityStatus('info', `第${chapter}章 タイプ${type}問題を${newState ? '公開' : '非公開'}に変更しました`);
}

function setAllVisible(isVisible) {
    availableChapters.forEach(chapter => {
        availableTypes.forEach(type => {
            if (!currentVisibilitySettings[chapter]) {
                currentVisibilitySettings[chapter] = {};
            }
            currentVisibilitySettings[chapter][type] = isVisible;
            
            // セルを更新
            const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${type}"]`);
            if (cell) {
                updateCellAppearance(cell, isVisible);
                cell.classList.add('changed');
                setTimeout(() => cell.classList.remove('changed'), 500);
            }
        });
    });
    
    updateSettingsSummary();
    showVisibilityStatus('success', `全ての問題を${isVisible ? '公開' : '非公開'}に設定しました`);
}

function setTypeVisible(targetType, isVisible) {
    availableChapters.forEach(chapter => {
        if (!currentVisibilitySettings[chapter]) {
            currentVisibilitySettings[chapter] = {};
        }
        currentVisibilitySettings[chapter][targetType] = isVisible;
        
        // セルを更新
        const cell = document.querySelector(`[data-chapter="${chapter}"][data-type="${targetType}"]`);
        if (cell) {
            updateCellAppearance(cell, isVisible);
            cell.classList.add('changed');
            setTimeout(() => cell.classList.remove('changed'), 500);
        }
    });
    
    updateSettingsSummary();
    showVisibilityStatus('success', `全ての${targetType}問題を${isVisible ? '公開' : '非公開'}に設定しました`);
}

function updateSettingsSummary() {
    let visibleCount = 0;
    let totalCount = 0;
    
    availableChapters.forEach(chapter => {
        availableTypes.forEach(type => {
            totalCount++;
            if (getVisibilitySetting(chapter, type)) {
                visibleCount++;
            }
        });
    });
    
    const hiddenCount = totalCount - visibleCount;
    const visibilityRate = totalCount > 0 ? Math.round((visibleCount / totalCount) * 100) : 0;
    
    document.getElementById('visibleCount').textContent = visibleCount;
    document.getElementById('hiddenCount').textContent = hiddenCount;
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('visibilityRate').textContent = visibilityRate + '%';
}

function saveVisibilitySettings() {
    const roomNumber = document.getElementById('visibilityRoomSelect').value;
    if (!roomNumber) return;
    
    showVisibilityStatus('info', '設定を保存中...');
    
    fetch('/admin/essay_visibility_settings/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            room_number: roomNumber,
            settings: currentVisibilitySettings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showVisibilityStatus('success', `部屋 ${roomNumber} の設定を保存しました`);
        } else {
            showVisibilityStatus('error', data.message);
        }
    })
    .catch(error => {
        console.error('設定保存エラー:', error);
        showVisibilityStatus('error', '設定の保存に失敗しました');
    });
}

function resetVisibilitySettings() {
    if (!confirm('全ての設定を公開状態にリセットしますか？')) {
        return;
    }
    
    setAllVisible(true);
    showVisibilityStatus('info', '全ての設定を公開状態にリセットしました');
}

function showVisibilityStatus(type, message) {
    const statusDiv = document.getElementById('visibilityStatus');
    const iconClass = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle',
        'warning': 'fas fa-exclamation-triangle'
    }[type] || 'fas fa-info-circle';
    
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[type] || 'alert-info';
    
    statusDiv.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 5秒後に自動で非表示
    setTimeout(() => {
        const alert = statusDiv.querySelector('.alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 150);
        }
    }, 5000);
}
</script>

<style>
/* ========================================
   1. 基本的な管理者パネルスタイル
   ======================================== */
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 15px;
    margin-bottom: 25px;
}

.admin-header h2 {
    margin: 0;
    color: #343a40;
}

/* ========================================
   2. 折りたたみセクションのスタイル
   ======================================== */
.admin-section {
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.section-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid #dee2e6;
    transition: all 0.3s ease;
    user-select: none;
}

.section-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.section-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1.3rem;
    color: #495057;
    font-weight: 600;
}

.section-header h3 i:first-child {
    margin-right: 10px;
    color: #6c757d;
}

.toggle-icon {
    transition: transform 0.3s ease;
    color: #6c757d;
    font-size: 0.9rem;
}

.section-header[aria-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
}

.section-content {
    padding: 25px;
    background-color: #fff;
}

/* ========================================
   3. 管理者パネルのスタイル
   ======================================== */
.admin-panel {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #eee;
}

.admin-panel h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #343a40;
}

.admin-panel p {
    margin-bottom: 15px;
    line-height: 1.5;
}

/* ========================================
   4. テーブルとスクロールコンテナ
   ======================================== */
.scrollable-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.scrollable-table-container .table {
    margin-bottom: 0;
}

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #343a40 !important;
}

.table-controls {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    margin-bottom: 15px;
}

.table-controls label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

/* ========================================
   5. ソートアイコンとインタラクティブ要素
   ======================================== */
.sort-icon {
    margin-left: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
    cursor: pointer;
}

.sort-icon:hover {
    opacity: 1;
}

.badge {
    font-size: 0.8em;
}

#userTableBody tr:hover {
    background-color: #f8f9fa;
}

.delete-user-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* ========================================
   6. フォームとボタンのスタイル
   ======================================== */
.upload-form, .add-user-form {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #495057;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

/* ========================================
   7. アニメーションとトランジション
   ======================================== */
.section-content {
    transition: all 0.3s ease;
}

.collapse {
    transition: height 0.35s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#invalidHistoryAnalysisResult,
#userDebugResult,
#statsCheckResult {
    animation: fadeIn 0.3s ease-in;
}

/* ========================================
   8. レスポンシブデザイン
   ======================================== */
@media (max-width: 768px) {
    .admin-container {
        padding: 15px;
    }
    
    .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .section-header {
        padding: 12px 15px;
    }
    
    .section-header h3 {
        font-size: 1.1rem;
    }
    
    .section-content {
        padding: 20px 15px;
    }
    
    .upload-form, .add-user-form {
        padding: 15px;
    }
    
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group-vertical .btn {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .scrollable-table-container {
        max-height: 300px;
    }
    
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.3rem;
        white-space: nowrap;
    }
    
    .table-controls .row {
        margin-bottom: 0;
    }
    
    .table-controls .col-md-6 {
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    .section-header h3 {
        font-size: 1rem;
    }
    
    .admin-panel {
        padding: 15px;
    }
    
    .table {
        font-size: 0.75rem;
    }
}

/* ========================================
   9. 状態表示とフィードバック
   ======================================== */
.text-success {
    color: #28a745 !important;
}

.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.text-info {
    color: #17a2b8 !important;
}

.text-muted {
    color: #6c757d !important;
}

/* ========================================
   10. 特殊な表示要素
   ======================================== */
.csv-template-section {
    margin-bottom: 25px;
    padding: 15px;
    background-color: #f0f8ff;
    border: 1px solid #87ceeb;
    border-radius: 6px;
    border-left: 4px solid #17a2b8;
}

.flashes {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
}

.flashes li {
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    border-left: 4px solid;
}

.flashes li.success {
    background-color: #d4edda;
    border-left-color: #28a745;
    color: #155724;
}

.flashes li.error {
    background-color: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.flashes li.warning {
    background-color: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.flashes li.info {
    background-color: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

/* 単元選択用のスタイル */
.unit-setting-container {
    max-width: 400px;
}

.units-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    background-color: #f8f9fa;
}

.unit-checkbox {
    margin: 0 !important;
    font-size: 0.9em;
}

.unit-checkbox .form-check-input {
    margin-right: 4px;
}

.unit-controls .btn {
    margin-right: 5px;
    margin-bottom: 5px;
}

.selected-units-display {
    font-weight: 500;
}

@media (max-width: 768px) {
    .units-grid {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 6px;
    }
    
    .unit-setting-container {
        max-width: 100%;
    }
}

/* 横スクロール対応の追加 */
.scrollable-table-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto; /* 横スクロール追加 */
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.table-responsive {
    overflow-x: auto !important;
}

/* スマホ対応の追加 */
@media (max-width: 768px) {
    .scrollable-table-container {
        max-height: 300px;
        overflow-x: auto;
    }
    
    .table {
        font-size: 0.75rem;
        min-width: 600px; /* 最小幅を保証 */
    }
    
    .table th,
    .table td {
        padding: 0.3rem;
        white-space: nowrap;
        min-width: 80px; /* 各セルの最小幅 */
    }
}

/* 論述問題管理用の追加スタイル */
.stat-card {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #3498db;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.essay-management-controls .form-control {
    font-size: 0.9rem;
}

.essay-management-controls label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

.template-format {
    background: white;
    padding: 10px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.8em;
    margin-bottom: 15px;
    border: 1px solid #ddd;
}

#essay-problems-container .table {
    margin-bottom: 0;
}

#essay-problems-container .btn-group-vertical .btn {
    margin-bottom: 2px;
    font-size: 0.7rem;
    padding: 2px 6px;
}

@media (max-width: 768px) {
    .stat-card {
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .essay-management-controls .col-md-4 {
        margin-bottom: 15px;
    }
}

/* 統計セクション */
.essay-stats-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #90caf9;
}

.essay-stats-section h4 {
    color: #1565c0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* CSVインポートセクション */
.csv-import-section {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #81c784;
}

.csv-import-section h4 {
    color: #2e7d32;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* CSVテンプレートセクション */
.csv-template-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.csv-template-section h5 {
    color: #37474f;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.template-format {
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    margin: 15px 0;
    line-height: 1.6;
}

.template-format code {
    background: #e8f5e8;
    color: #2e7d32;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
}

/* CSVアップロードフォーム */
.csv-upload-form {
    background: white;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #e0e0e0;
}

.upload-area {
    border: 2px dashed #90caf9;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #42a5f5;
    background: #f0f8ff;
}

.file-input-wrapper {
    position: relative;
    margin-bottom: 20px;
}

.file-input-label {
    display: block;
    padding: 20px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.file-input-label:hover {
    background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
    transform: translateY(-2px);
}

.file-input-label i {
    font-size: 1.5rem;
    margin-bottom: 8px;
    display: block;
}

#essay_csv_file {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.upload-options {
    margin: 20px 0;
}

.upload-options .form-check {
    background: #fff3e0;
    border: 1px solid #ffcc02;
    border-radius: 6px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-upload {
    background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
    border: none;
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 25px;
    color: white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    transition: all 0.3s ease;
}

.btn-upload:hover {
    background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

/* 個別論述問題登録セクション */
.essay-form-section {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border: 1px solid #ce93d8;
    border-radius: 12px;
    padding: 25px;
    margin: 20px 0;
}

.essay-form-section h4 {
    color: #7b1fa2;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.4rem;
    font-weight: 600;
}

/* フォームコンテナ */
.essay-form-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

/* フォームグリッドレイアウト */
.essay-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.essay-form-full-width {
    grid-column: 1 / -1;
}

/* 入力グループのスタイル */
.essay-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.essay-input-group label {
    font-weight: 600;
    color: #495057;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.essay-input-group label i {
    color: #6c757d;
    width: 16px;
}

.essay-input-group input,
.essay-input-group select,
.essay-input-group textarea {
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: #fafafa;
    font-family: inherit;
}

.essay-input-group input:focus,
.essay-input-group select:focus,
.essay-input-group textarea:focus {
    outline: none;
    border-color: #7b1fa2;
    background: white;
    box-shadow: 0 0 0 3px rgba(123, 31, 162, 0.1);
}

.essay-question-input,
.essay-answer-input {
    min-height: 120px !important;
    resize: vertical;
    line-height: 1.6;
}

/* チェックボックス */
.essay-checkbox-group {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #e9ecef;
    margin-bottom: 20px;
}

.essay-checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
    accent-color: #7b1fa2;
}

.essay-checkbox-group label {
    margin: 0;
    font-weight: 500;
    cursor: pointer;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* 送信ボタン */
.essay-submit-btn {
    background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
}

.essay-submit-btn:hover {
    background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(123, 31, 162, 0.4);
}

.essay-submit-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* ヘルプテキスト */
.essay-help-text {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 4px;
    font-style: italic;
}

/* 論述問題管理セクション */
.essay-management-section {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: 1px solid #ffb74d;
    border-radius: 12px;
    padding: 25px;
    margin: 20px 0;
}

.essay-management-section h4 {
    color: #ef6c00;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.4rem;
    font-weight: 600;
}

/* フィルターセクション */
.essay-filter-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.essay-filter-section label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    display: block;
}

.essay-filter-section .form-control {
    border: 2px solid #e9ecef;
    border-radius: 6px;
    padding: 8px 12px;
    transition: border-color 0.3s ease;
}

.essay-filter-section .form-control:focus {
    border-color: #ef6c00;
    box-shadow: 0 0 0 2px rgba(239, 108, 0, 0.1);
}

/* 統計カード */
.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* 問題一覧テーブル */
#essay-problems-container .table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

#essay-problems-container .table th {
    background: #ef6c00;
    color: white;
    border: none;
    padding: 12px 8px;
    font-weight: 600;
}

#essay-problems-container .table td {
    padding: 10px 8px;
    border-color: #f0f0f0;
    vertical-align: middle;
}

#essay-problems-container .table tr:hover {
    background-color: #fff3e0;
}

/* バッジスタイル */
.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.bg-success {
    background-color: #28a745 !important;
}

.bg-secondary {
    background-color: #6c757d !important;
}

.bg-primary {
    background-color: #007bff !important;
}

/* ボタンスタイル */
.btn-sm {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
    margin: 0 2px;
}

.btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
}

.btn-outline-primary:hover {
    background-color: #007bff;
    color: white;
}

.btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .essay-form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .essay-form-container,
    .csv-upload-form,
    .csv-template-section,
    .essay-filter-section {
        padding: 15px;
    }
    
    .essay-form-section,
    .csv-import-section,
    .essay-management-section,
    .essay-stats-section {
        padding: 15px;
        margin: 15px 0;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    .template-format {
        font-size: 0.75rem;
        padding: 10px;
    }
    
    .upload-area {
        padding: 20px;
    }
    
    .file-input-label {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .essay-form-section,
    .csv-import-section,
    .essay-management-section,
    .essay-stats-section {
        padding: 10px;
        margin: 10px 0;
    }
    
    .essay-form-container,
    .csv-upload-form {
        padding: 12px;
    }
    
    .essay-input-group input,
    .essay-input-group select,
    .essay-input-group textarea {
        padding: 8px 10px;
        font-size: 0.9rem;
    }
    
    .essay-submit-btn,
    .btn-upload {
        padding: 10px 20px;
        font-size: 0.95rem;
    }
    
    .upload-area {
        padding: 15px;
    }
    
    .file-input-label i {
        font-size: 1.2rem;
    }
    
    /* テーブルを横スクロール可能に */
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 6px 4px;
        white-space: nowrap;
    }
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
    .essay-stats-section {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        border-color: #3b82f6;
    }
    
    .csv-import-section {
        background: linear-gradient(135deg, #166534 0%, #15803d 100%);
        border-color: #22c55e;
    }
    
    .essay-form-section {
        background: linear-gradient(135deg, #581c87 0%, #7c2d12 100%);
        border-color: #a855f7;
    }
    
    .essay-management-section {
        background: linear-gradient(135deg, #9a3412 0%, #c2410c 100%);
        border-color: #f97316;
    }
    
    .essay-form-container,
    .csv-upload-form,
    .csv-template-section,
    .essay-filter-section {
        background: #374151;
        border-color: #6b7280;
        color: #f9fafb;
    }
    
    .essay-input-group input,
    .essay-input-group select,
    .essay-input-group textarea {
        background: #4b5563;
        border-color: #6b7280;
        color: #f9fafb;
    }
    
    .essay-input-group input:focus,
    .essay-input-group select:focus,
    .essay-input-group textarea:focus {
        border-color: #8b5cf6;
        background: #4b5563;
    }
    
    .essay-checkbox-group {
        background: #4b5563;
        border-color: #6b7280;
    }
    
    .upload-area {
        background: #374151;
        border-color: #6b7280;
    }
    
    .template-format {
        background: #4b5563;
        border-color: #6b7280;
        color: #f9fafb;
    }
}

/* 論述問題一覧のスタイル改善 - admin.htmlの<style>タグ内の最後に追加 */
.essay-problem-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.essay-problem-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #ffa726;
}

.problem-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.problem-info {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.problem-info .badge {
    font-size: 0.85rem;
    padding: 5px 12px;
    font-weight: 500;
}

/* 章番号のバッジ */
.badge-chapter {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* タイプ別の配色 */
.badge-type-A {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.badge-type-B {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: #333;
}

.badge-type-C {
    background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
    color: white;
}

.badge-type-D {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
}

/* 大学名と年度 */
.university-info {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
}

.university-info i {
    color: #ff6b6b;
}

/* 問題文表示エリア */
.problem-content {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
}

.problem-question {
    color: #2c3e50;
    line-height: 1.6;
    margin: 0;
    font-size: 1rem;
}

.problem-question strong {
    color: #e67e22;
    font-weight: 600;
}

/* 問題の詳細情報 */
.problem-meta {
    display: flex;
    gap: 20px;
    color: #6c757d;
    font-size: 0.85rem;
    padding-top: 10px;
}

.problem-meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.problem-meta-item i {
    color: #95a5a6;
}

/* アクションボタン */
.problem-actions {
    display: flex;
    gap: 5px;
}

.problem-actions .btn {
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.problem-actions .btn-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
}

.problem-actions .btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
}

.problem-actions .btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    color: white;
}

.problem-actions .btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    border: none;
    color: white;
}

/* 統計情報の表示 */
.essay-stats-summary {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: 1px solid #ffb74d;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #f57c00;
}

.stat-label {
    font-size: 0.85rem;
    color: #6c757d;
}

/* 論述問題公開設定用CSS */
.visibility-matrix {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.matrix-header h4 {
    color: #495057;
    font-weight: 600;
}

.visibility-table {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
}

.visibility-table th {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    color: white;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
}

.visibility-cell {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    vertical-align: middle;
    padding: 15px;
    min-height: 60px;
}

.visibility-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.visibility-cell.visible {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 2px solid #28a745;
    color: #155724;
}

.visibility-cell.hidden {
    background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
    border: 2px solid #dc3545;
    color: #721c24;
}

.visibility-cell .status-icon {
    font-size: 1.5em;
    display: block;
    margin-bottom: 5px;
}

.visibility-cell .status-text {
    font-weight: 600;
    font-size: 0.9em;
}

.chapter-name {
    font-weight: 600;
    color: #495057;
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    text-align: center;
    vertical-align: middle;
}

.bulk-operations {
    background: rgba(255, 255, 255, 0.8);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.settings-summary .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.visibility-room-selector {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .visibility-table {
        font-size: 0.8em;
    }
    
    .visibility-cell {
        padding: 10px;
        min-height: 50px;
    }
    
    .bulk-operations .btn-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    
    .bulk-operations .btn-group .btn {
        margin-bottom: 5px;
    }
}

/* アニメーション */
@keyframes settingChanged {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.visibility-cell.changed {
    animation: settingChanged 0.5s ease;
}
</style>
{% endblock %}