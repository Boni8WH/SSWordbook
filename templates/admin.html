{% extends "base.html" %}
{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - {{ app_name }}{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="admin-app-info-management">
        <h3>ğŸ“± ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†</h3>
        <p>ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºåã€æ›´æ–°å†…å®¹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã©ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
        
        <div class="admin-panel" style="background-color: #e8f4fd; border-left: 5px solid #3498db;">
            <h4>ç¾åœ¨ã®ã‚¢ãƒ—ãƒªæƒ…å ±</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ã‚¢ãƒ—ãƒªå:</strong> {{ app_info.app_name if app_info else 'ä¸–ç•Œå²å˜èªå¸³' }}</p>
                    <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> {{ app_info.version if app_info else '1.0.0' }}</p>
                    <p><strong>æœ€çµ‚æ›´æ–°æ—¥:</strong> {{ app_info.last_updated_date if app_info else '2025å¹´6æœˆ15æ—¥' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>æ›´æ–°å†…å®¹:</strong></p>
                    <div style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em;">
                        {{ app_info.update_content if app_info else 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚' }}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <a href="{{ url_for('admin_app_info') }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ã‚’ç·¨é›†
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-info" target="_blank">
                    <i class="fas fa-external-link-alt"></i> å®Ÿéš›ã®è¡¨ç¤ºã‚’ç¢ºèª
                </a>
            </div>
        </div>
    </section>

    <hr>

    <section id="admin-user-management">
        <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
        <p>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ users|length }}äºº</p>

        <h4>å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
        <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
            <div class="input-group">
                <label for="new_room_number">éƒ¨å±‹ç•ªå·:</label>
                <input type="text" id="new_room_number" name="room_number" required>
            </div>
            <div class="input-group">
                <label for="new_room_password">å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_room_password" name="room_password" required>
            </div>
            <div class="input-group">
                <label for="new_student_id">å‡ºå¸­ç•ªå·:</label>
                <input type="text" id="new_student_id" name="student_id" required>
            </div>
            <div class="input-group">
                <label for="new_individual_password">å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_individual_password" name="individual_password" required>
            </div>
            <div class="input-group">
                <label for="new_username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:</label>
                <input type="text" id="new_username" name="username" required>
                <small class="form-text text-muted">â€»åŒä¸€äººç‰©ãŒè¤‡æ•°ã®éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆã€åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã§ã‚‚ç™»éŒ²å¯èƒ½ã§ã™</small>
            </div>
            <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
        </form>

        <h4>CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
        <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
            <ul>
                <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: éƒ¨å±‹ç•ªå·,å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,å‡ºå¸­ç•ªå·,å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</li>
                <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
                <li>ä¾‹: 101,password123,001,student001,æˆå¯Œå…µåº«èŒ‚å®‰</li>
                <li>åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®ç™»éŒ²ã‚‚å¯èƒ½ã§ã™ï¼ˆåŒä¸€äººç‰©ãŒè¤‡æ•°éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆï¼‰</li>
            </ul>
            <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-download"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>

        <form action="{{ url_for('admin_upload_users') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <div class="input-group">
                <label for="users_csv_file">ãƒ¦ãƒ¼ã‚¶ãƒ¼CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="users_csv_file" name="file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-upload"></i> CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            </button>
        </form>

        <h4>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
        <!-- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
        <div class="table-controls mb-3">
            <div class="row">
                <div class="col-md-6">
                    <label for="roomSortSelect">éƒ¨å±‹ã§ã‚½ãƒ¼ãƒˆ:</label>
                    <select id="roomSortSelect" class="form-control form-control-sm">
                        <option value="">å…¨ã¦ã®éƒ¨å±‹</option>
                        {% set room_numbers = [] %}
                        {% for user in users %}
                            {% if user.room_number not in room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = room_numbers.append(user.room_number) %}
                            {% endif %}
                        {% endfor %}
                        {% for room_num in room_numbers|sort %}
                            <option value="{{ room_num }}">éƒ¨å±‹ {{ room_num }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="userSearchInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢:</label>
                    <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="åå‰ã€å‡ºå¸­ç•ªå·ã§æ¤œç´¢...">
                </div>
            </div>
        </div>

        <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="scrollable-table-container">
            <div class="table-responsive">
                <table class="table table-striped user-list-table" id="userTable">
                    <thead class="table-dark sticky-header">
                        <tr>
                            <th>ID</th>
                            <th>éƒ¨å±‹ <i class="fas fa-sort sort-icon" data-column="room" style="cursor: pointer;"></i></th>
                            <th>å‡ºå¸­ç•ªå·</th>
                            <th>ç¾åœ¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå <i class="fas fa-sort sort-icon" data-column="name" style="cursor: pointer;"></i></th>
                            <th>æœ€åˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</th>
                            <th>å¤‰æ›´æ—¥æ™‚</th>
                            <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³ <i class="fas fa-sort sort-icon" data-column="login" style="cursor: pointer;"></i></th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in users %}
                        {% if user.username != 'admin' %}
                        <tr data-room="{{ user.room_number }}" data-name="{{ user.username|lower }}" data-student="{{ user.student_id|lower }}">
                            <td>{{ user.id }}</td>
                            <td><span class="badge bg-secondary">{{ user.room_number }}</span></td>
                            <td>{{ user.student_id }}</td>
                            <td>
                                {{ user.username }}
                                {% if user.original_username and user.original_username != user.username %}
                                <span class="badge bg-warning text-dark ms-1">
                                    <i class="fas fa-edit"></i> å¤‰æ›´æ¸ˆã¿
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.original_username and user.original_username != user.username %}
                                <span class="text-muted">{{ user.original_username }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ user.username_changed_at | to_jst if user.username_changed_at else '-' }}</td>
                            <td>{{ user.last_login | to_jst if user.last_login else 'æœªãƒ­ã‚°ã‚¤ãƒ³' }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-user-btn"
                                        data-user-id="{{ user.id }}"
                                        data-username="{{ user.username }}"
                                        data-room="{{ user.room_number }}">å‰Šé™¤</button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <hr>

    <!-- éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="admin-csv-management-fixed">
        <h3>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰</h3>
        <p>æ”¹å–„ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§å®‰å…¨ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
        
        <div class="csv-template-section" style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px;">
            <h4 style="margin-top: 0; color: #17a2b8;">
                <i class="fas fa-download"></i> CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </h4>
            <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-file-csv"></i> å˜èªå¸³CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>
        
        <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿®æ­£ç‰ˆï¼‰</h4>
        <div class="upload-form-container">
            <form id="csvUploadForm" enctype="multipart/form-data" class="upload-form">
                <div class="input-group">
                    <label for="room_csv_file_fixed">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                    <input type="file" id="room_csv_file_fixed" name="file" accept=".csv" required>
                    <small class="form-text text-muted">
                        âœ… UTF-8ã¾ãŸã¯Shift_JISå¯¾å¿œ<br>
                        âœ… è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸<br>
                        âœ… ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è‡ªå‹•æ¤œè¨¼
                    </small>
                </div>
                <button type="button" class="btn btn-success" onclick="uploadCsvFixed()">
                    <i class="fas fa-upload"></i> å®‰å…¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
            </form>
        </div>
        
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—è¡¨ç¤º -->
        <div id="uploadProgress" style="display: none; margin-top: 15px;">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
            <p class="mt-2 text-center">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>
        
        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="uploadResult" style="margin-top: 15px;"></div>
    </section>

    <hr>

    <section id="admin-room-settings">
        <h3>ğŸ  éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç†</h3>
        <p>å„éƒ¨å±‹ã®å­¦ç¿’ç¯„å›²ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

        <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªéƒ¨å±‹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="scrollable-table-container">
            <div class="table-responsive">
                <table class="table table-striped room-setting-table">
                    <thead class="table-dark sticky-header">
                        <tr>
                            <th>éƒ¨å±‹ç•ªå·</th>
                            <th>æœ€å¤§å˜å…ƒç•ªå·</th>
                            <th>ä½¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set unique_room_numbers = [] %}
                        {% for user in users %}
                            {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(user.room_number) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for setting in room_max_unit_settings.keys() %}
                            {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(setting) %}
                            {% endif %}
                        {% endfor %}

                        {% for room_num in unique_room_numbers|sort %}
                        <tr>
                            <td><strong>{{ room_num }}</strong></td>
                            <td>
                                <input type="text"
                                    id="maxUnit_{{ room_num }}"
                                    value="{{ room_max_unit_settings.get(room_num, '9999') }}"
                                    class="form-control unit-setting-input"
                                    data-room-number="{{ room_num }}"
                                    placeholder="ä¾‹: 34 ã¾ãŸã¯ 9999ï¼ˆå…¨ã¦ï¼‰">
                            </td>
                            <td>
                                <select id="csvFile_{{ room_num }}" 
                                        class="form-control csv-setting-select" 
                                        data-room-number="{{ room_num }}">
                                    <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv') == 'words.csv' %}selected{% endif %}>
                                        words.csv (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                                    </option>
                                    <!-- å‹•çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                                </select>
                                <small class="form-text text-muted">
                                    ç¾åœ¨ã®è¨­å®š: <code id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                </small>
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-primary btn-sm save-room-setting-btn" 
                                            data-room-number="{{ room_num }}">ä¿å­˜</button>
                                    <button class="btn btn-danger btn-sm delete-room-setting-btn" 
                                            data-room-number="{{ room_num }}">å‰Šé™¤</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <hr>

    <!-- å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-panel">
    <h3>ğŸ† å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º</h3>
    <p>å„éƒ¨å±‹ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
    
    <div class="room-selector-container">
        <h4>éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</h4>
        
        <div class="room-select-form">
            <div class="form-group">
                <label for="roomSelectDropdown">éƒ¨å±‹é¸æŠ:</label>
                <select id="roomSelectDropdown" class="form-control">
                    <option value="">-- éƒ¨å±‹ã‚’é¸æŠ --</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="loadSelectedRoom()">
                <i class="fas fa-chart-bar"></i> ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            </button>
            <button class="btn btn-secondary" onclick="refreshRoomList()">
                <i class="fas fa-sync"></i> éƒ¨å±‹ä¸€è¦§æ›´æ–°
            </button>
        </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="adminRankingContainer">
    <div id="adminRankingInitial" class="text-center py-4">
        <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
        <p class="text-muted">ä¸Šè¨˜ã‹ã‚‰éƒ¨å±‹ã‚’é¸æŠã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
    </div>
    
    <div id="adminRankingTableContainer" style="display: none;">
        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div class="ranking-summary">
            <div class="row">
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h5>
                        <span class="summary-value" id="totalUsers">-</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</h5>
                        <span class="summary-value" id="activeUsers">-</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5>å¹³å‡ã‚¹ã‚³ã‚¢</h5>
                        <span class="summary-value" id="averageScore">-</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card">
                        <h5>æœ€é«˜ã‚¹ã‚³ã‚¢</h5>
                        <span class="summary-value" id="maxScore">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«-->
        <div class="table-responsive">
            <table class="table table-striped table-hover ranking-table">
                <thead class="table-dark">
                    <tr>
                        <th>é †ä½</th>
                        <th>åå‰</th>
                        <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                        <th>å›ç­”æ•°</th>
                        <th>æ­£è§£æ•°</th>
                        <th>æ­£ç­”ç‡</th>
                        <th>ãƒã‚¹ã‚¿ãƒ¼æ•°</th>
                        <th>ç·åˆã‚¹ã‚³ã‚¢</th>
                        <th>ç¶²ç¾…ç‡</th>
                    </tr>
                </thead>
                <tbody id="adminRankingTableBody">
                    <!-- å‹•çš„ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<section id="admin-user-stats-management">
    <h3>ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’çµ±è¨ˆã®çŠ¶æ…‹ç¢ºèªãƒ»ä¿®å¾©ã‚’è¡Œã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒ0ã«ãªã£ã¦ã„ã‚‹å ´åˆã‚„æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ãŸå¾Œã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>

    <!-- çµ±è¨ˆçŠ¶æ…‹ç¢ºèª -->
    <div class="admin-panel" style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
        <h4>ğŸ“ˆ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ç¢ºèªãƒ»ä¿®å¾©</h4>
        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®æ•´åˆæ€§ã¨æœ€æ–°æ€§ã‚’ç¢ºèªã—ã€å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ä¿®å¾©ã—ã¾ã™ã€‚</p>
        
        <div style="margin-top: 15px;">
            <button type="button" class="btn btn-info" onclick="checkUserStatsDetailed()">
                <i class="fas fa-chart-line"></i> ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ã‚’è©³ç´°ç¢ºèª
            </button>
            
            <button type="button" class="btn btn-warning" onclick="fixStatsComprehensive()" style="margin-left: 10px;">
                <i class="fas fa-tools"></i> ğŸ”§ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¿®å¾©
            </button>
            
            <button type="button" class="btn btn-success" onclick="checkSystemStatus()" style="margin-left: 10px;">
                <i class="fas fa-search"></i> ğŸ” ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ç¢ºèª
            </button>
        </div>
    </div>

    <!-- çµ±è¨ˆç¢ºèªçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="statsCheckResult" style="margin-top: 15px; display: none;">
        <h5>ğŸ“Š çµ±è¨ˆç¢ºèªçµæœ</h5>
        <div id="statsCheckContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
            <!-- ç¢ºèªçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>
</section>

    <hr>

    <section id="admin-database-management">
        <h3>ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h3>
        <p>å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>

        <!-- å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— -->
        <div class="admin-panel" style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
            <h4>ğŸ§¹ å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h4>
            <p>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
            <strong>æ¨å¥¨ï¼š</strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="margin-top: 15px;">
                <button type="button" class="btn btn-warning" onclick="cleanupOrphanedTokens()">
                    <i class="fas fa-broom"></i> ğŸ§¹ å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
                </button>
                
                <button type="button" class="btn btn-info" onclick="checkDatabaseStatus()" style="margin-left: 10px;">
                    <i class="fas fa-search"></i> ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
                </button>
            </div>
        </div>

        <div class="admin-panel" style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
            <h4>ğŸ—‘ï¸ IDä¸ä¸€è‡´å±¥æ­´ã®å‰Šé™¤</h4>
            <p>ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å¤ã„å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
            <strong>ç”¨é€”ï¼š</strong>å•é¡Œæ–‡ä¿®æ­£å¾Œã«å¤ã„IDã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã«ä½¿ç”¨ã€‚<br>
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>å‰Šé™¤ã•ã‚ŒãŸå±¥æ­´ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</p>
            
            <div style="margin-top: 15px;">
                <button type="button" class="btn btn-info" onclick="analyzeInvalidHistoryDetailed()">
                    <i class="fas fa-search"></i> ğŸ“Š è©³ç´°åˆ†æï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
                </button>
                
                <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory()" style="margin-left: 10px;">
                    <i class="fas fa-trash-alt"></i> ğŸ—‘ï¸ ç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                <h5>ğŸ” ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="debugUsername" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
                            <button class="btn btn-outline-secondary" onclick="debugSpecificUser()">
                                <i class="fas fa-bug"></i> ãƒ‡ãƒãƒƒã‚°
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-danger btn-sm" onclick="forceCleanSpecificUser()">
                            <i class="fas fa-exclamation-triangle"></i> å¼·åˆ¶å‰Šé™¤
                        </button>
                        <small class="text-muted d-block">â€»ä¸Šè¨˜ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›å¾Œã«ä½¿ç”¨</small>
                    </div>
                </div>
            </div>
            
            <!-- ç„¡åŠ¹å±¥æ­´åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                <h5>ğŸ“Š ç„¡åŠ¹å±¥æ­´åˆ†æçµæœ</h5>
                <div id="invalidAnalysisContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                    <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="userDebugResult" style="margin-top: 15px; display: none;">
                <h5>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒãƒƒã‚°çµæœ</h5>
                <div id="debugContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                    <!-- ãƒ‡ãƒãƒƒã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
        
        <!-- å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆå¾“æ¥æ©Ÿèƒ½ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰ -->
        <div class="admin-panel" style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
            <h4>âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰</h4>
            <p>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚’å¼·åˆ¶çš„ã«æ–°ã—ã„IDå½¢å¼ã«çµ±ä¸€ã—ã¾ã™ã€‚<br>
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>ã“ã®æ“ä½œã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã«å½±éŸ¿ã—ã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚<br>
            <strong>æ¨å¥¨ï¼š</strong>é€šå¸¸ã¯ä¸Šè¨˜ã®ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="margin-top: 15px;">
                <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST" style="display: inline;" 
                    onsubmit="return confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ãŒæ–°ã—ã„å½¢å¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚\nâš ï¸ é€šå¸¸ã¯ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã§ååˆ†ã§ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶ä¿®æ­£ï¼ˆéæ¨å¥¨ï¼‰
                    </button>
                </form>
                
                <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank" style="margin-left: 10px;">
                    <i class="fas fa-chart-line"></i> ğŸ“Š ä¿®æ­£å‰ã®çŠ¶æ…‹ç¢ºèª
                </a>
            </div>
        </div>
    </section>
    <!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
    </form>
</div>

<script>
console.log('ğŸ”§ admin.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆä¿®æ­£ç‰ˆï¼‰');

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆé‡è¤‡å®£è¨€ã‚’ä¿®æ­£ï¼‰
// ========================================
let selectedRoom = null;
let currentRankingData = null;
let recentRooms = JSON.parse(localStorage.getItem('recentRooms') || '[]');

// ========================================
// 1. åŸºæœ¬çš„ãªéƒ¨å±‹ãƒ»CSVç®¡ç†æ©Ÿèƒ½
// ========================================

// éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹é–¢æ•°
function loadRoomSettings() {
    console.log('ğŸ”„ éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
    
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const roomNumber = select.dataset.roomNumber;
        if (!roomNumber) return;
        
        fetch('/admin/get_room_setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_number: roomNumber })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const csvFilename = data.csv_filename || 'words.csv';
                select.value = csvFilename;
                
                const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                if (!optionExists && csvFilename !== 'words.csv') {
                    const newOption = document.createElement('option');
                    newOption.value = csvFilename;
                    newOption.textContent = csvFilename;
                    select.appendChild(newOption);
                    select.value = csvFilename;
                }
            }
        })
        .catch(error => {
            console.error(`âŒ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
        });
    });
}

// ===== ç·Šæ€¥ä¿®å¾©æ©Ÿèƒ½ =====
function emergencyFixAll() {
    if (!confirm('å…¨ã¦ã®å•é¡Œã‚’ä¿®å¾©ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š\nâ€¢ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å†è¨ˆç®—\nâ€¢ ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã®ä¿®å¾©\nâ€¢ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ•´åˆæ€§ç¢ºèª\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ä¿®å¾©ä¸­...';
    
    fetch('/admin/fix_ranking_display', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`âœ… ä¿®å¾©å®Œäº†ï¼\n\n${data.message}\nçµ±è¨ˆä¿®å¾©: ${data.stats_fixed}äººåˆ†\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
            location.reload();
        } else {
            alert(`âŒ ä¿®å¾©ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function checkSystemStatus() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ç¢ºèªä¸­...';
    
    fetch('/admin/check_system_status')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let statusMessage = 'ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªçµæœ:\n\n';
            statusMessage += `ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.total_users}äºº\n`;
            statusMessage += `çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${data.total_stats}å€‹\n`;
            statusMessage += `çµ±è¨ˆã‚«ãƒãƒ¼ç‡: ${data.stats_coverage}\n\n`;
            
            if (data.total_stats < data.total_users) {
                statusMessage += 'âš ï¸ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ãŒå¿…è¦ã§ã™';
            } else {
                statusMessage += 'âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã§ã™';
            }
            
            alert(statusMessage);
        } else {
            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadCsvFilesList() {
    console.log('ğŸ” CSV ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹...');
    
    const container = document.getElementById('csv-files-container');
    if (container) {
        container.innerHTML = '<p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
    }
    
    fetch('/admin/list_room_csv_files')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateCsvFilesDisplay(data.files);
                updateCsvSelectOptions(data.files);
            } else {
                if (container) {
                    container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '</p>';
                }
            }
        })
        .catch(error => {
            console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            if (container) {
                container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        });
}

// æ™‚åˆ»ã«9æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°ï¼ˆJSTå¯¾å¿œï¼‰
function addHoursToTimestamp(dateString, hours) {
    const date = new Date(dateString);
    date.setHours(date.getHours() + hours);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvFilesDisplay(files) {
    const container = document.getElementById('csv-files-container');
    if (!container) return;
    
    if (files.length === 0) {
        container.innerHTML = '<p class="text-muted">ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
    html += '<thead class="table-dark"><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>å˜èªæ•°</th><th>ã‚µã‚¤ã‚º</th><th>æ›´æ–°æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead><tbody>';
    
    files.forEach(file => {
        const sizeKB = Math.round(file.size / 1024);
        const wordCountDisplay = file.word_count > 0 ? `${file.word_count}å•` : 'ä¸æ˜';
        const modifiedTime = new Date(file.modified);
        modifiedTime.setHours(modifiedTime.getHours() + 9); // JSTå¤‰æ›
        
        html += '<tr>' +
                '<td><code>' + file.filename + '</code></td>' +
                '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                '<td>' + sizeKB + ' KB</td>' +
                '<td><small>' + modifiedTime.toLocaleString('ja-JP') + '</small></td>' +
                '<td><button class="btn btn-danger btn-sm" onclick="deleteCsvFile(\'' + file.filename + '\')">å‰Šé™¤</button></td>' +
                '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvSelectOptions(files) {
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const currentValue = select.value;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        Array.from(select.options).forEach(option => {
            if (option.value !== 'words.csv') {
                option.remove();
            }
        });
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        if (files && Array.isArray(files)) {
            files.forEach(file => {
                if (file.filename !== 'words.csv') {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = file.filename;
                    select.appendChild(option);
                }
            });
        }
        
        // å…ƒã®å€¤ã‚’å¾©å…ƒ
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤é–¢æ•°
function deleteCsvFile(filename) {
    if (confirm('CSVãƒ•ã‚¡ã‚¤ãƒ« "' + filename + '" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹éƒ¨å±‹ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/delete_room_csv/' + encodeURIComponent(filename);
        document.body.appendChild(form);
        form.submit();
    }
}

function uploadCsvFixed() {
    const fileInput = document.getElementById('room_csv_file_fixed');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (!file.name.endsWith('.csv')) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
    if (file.size > 10 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰ã€‚');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // UIæ›´æ–°
    const progressDiv = document.getElementById('uploadProgress');
    const resultDiv = document.getElementById('uploadResult');
    const uploadButton = event.target;
    
    progressDiv.style.display = 'block';
    resultDiv.innerHTML = '';
    uploadButton.disabled = true;
    uploadButton.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const progressBar = progressDiv.querySelector('.progress-bar');
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 200);
    
    fetch('/admin/upload_room_csv_fixed', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            progressDiv.style.display = 'none';
            
            if (data.status === 'success') {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ</h6>
                        <p>${data.message}</p>
                        <small>
                            ğŸ“Š å˜èªæ•°: ${data.word_count}å•<br>
                            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${data.file_size_kb}KB
                        </small>
                    </div>
                `;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                if (typeof loadCsvFilesList === 'function') {
                    loadCsvFilesList();
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                fileInput.value = '';
                
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—</h6>
                        <p>${data.message}</p>
                        <small>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</small>
                    </div>
                `;
            }
        }, 500);
    })
    .catch(error => {
        clearInterval(progressInterval);
        progressDiv.style.display = 'none';
        
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼</h6>
                <p>ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                <small>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</small>
            </div>
        `;
    })
    .finally(() => {
        uploadButton.disabled = false;
        uploadButton.textContent = 'å®‰å…¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
    });
}

// ========================================
// 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½
// ========================================

// éƒ¨å±‹ä¸€è¦§ã‚’å–å¾—
async function loadRoomList() {
    try {
        console.log('ğŸ” éƒ¨å±‹ä¸€è¦§å–å¾—é–‹å§‹...');
        const response = await fetch('/api/rooms');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… éƒ¨å±‹ä¸€è¦§å–å¾—æˆåŠŸ:', data.rooms.length, 'éƒ¨å±‹');
            updateRoomDropdown(data.rooms);
            updateQuickAccessButtons();
        } else {
            throw new Error(data.message || 'éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('âŒ éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        showRankingError('éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
function updateRoomDropdown(rooms) {
    const dropdown = document.getElementById('roomSelectDropdown');
    if (!dropdown) return;
    
    dropdown.innerHTML = '<option value="">-- éƒ¨å±‹ã‚’é¸æŠ --</option>';
    
    rooms.forEach(room => {
        if (room.room_number !== 'ADMIN') {
            const option = document.createElement('option');
            option.value = room.room_number;
            option.textContent = `éƒ¨å±‹: ${room.room_number} (${room.user_count}äºº)`;
            dropdown.appendChild(option);
        }
    });
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
function updateQuickAccessButtons() {
    const container = document.getElementById('quickAccessButtons');
    const section = document.querySelector('.quick-access-section');
    
    if (!container || !section) return;
    
    if (recentRooms.length > 0) {
        container.innerHTML = '';
        recentRooms.slice(0, 5).forEach(roomNumber => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary btn-sm quick-access-btn';
            button.textContent = `éƒ¨å±‹: ${roomNumber}`;
            button.onclick = () => selectRoomQuick(roomNumber);
            container.appendChild(button);
        });
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

// é¸æŠã•ã‚ŒãŸéƒ¨å±‹ã‚’èª­ã¿è¾¼ã¿
function loadSelectedRoom() {
    const dropdown = document.getElementById('roomSelectDropdown');
    if (!dropdown) {
        alert('éƒ¨å±‹é¸æŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const roomNumber = dropdown.value;
    if (!roomNumber) {
        alert('éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    selectRoom(roomNumber);
}

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§éƒ¨å±‹ã‚’é¸æŠ
function selectRoomQuick(roomNumber) {
    const dropdown = document.getElementById('roomSelectDropdown');
    if (dropdown) {
        dropdown.value = roomNumber;
    }
    selectRoom(roomNumber);
}

// éƒ¨å±‹ã‚’é¸æŠã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
async function selectRoom(roomNumber) {
    selectedRoom = roomNumber;
    console.log('ğŸ  éƒ¨å±‹é¸æŠ:', roomNumber);
    
    // æœ€è¿‘ä½¿ç”¨ã—ãŸéƒ¨å±‹ã«è¿½åŠ 
    addToRecentRooms(roomNumber);
    
    // UIæ›´æ–°
    const selectedRoomName = document.getElementById('selectedRoomName');
    const selectedRoomInfo = document.getElementById('selectedRoomInfo');
    
    if (selectedRoomName) selectedRoomName.textContent = roomNumber;
    if (selectedRoomInfo) selectedRoomInfo.style.display = 'block';
    
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
    await loadRankingForRoom(roomNumber);
}

// æœ€è¿‘ä½¿ç”¨ã—ãŸéƒ¨å±‹ã«è¿½åŠ 
function addToRecentRooms(roomNumber) {
    recentRooms = recentRooms.filter(room => room !== roomNumber);
    recentRooms.unshift(roomNumber);
    recentRooms = recentRooms.slice(0, 5);
    
    localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
    updateQuickAccessButtons();
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
async function loadRankingForRoom(roomNumber) {
    try {
        console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹:', roomNumber);
        showRankingLoading();
        
        // é€šå¸¸ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆå­˜åœ¨ç¢ºèªæ¸ˆã¿ï¼‰
        const response = await fetch(`/api/admin/room_ranking/${encodeURIComponent(roomNumber)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—æˆåŠŸ:', data.ranking_data.length, 'äºº');
            currentRankingData = data.ranking_data;
            displayRanking(data.ranking_data, data.statistics);
            showRankingTable();
        } else {
            throw new Error(data.message || 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        showRankingError('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
function displayRanking(rankingData, statistics) {
    console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹:', rankingData.length, 'äºº');
    
    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    const statsElements = {
        totalUsers: document.getElementById('totalUsers'),
        activeUsers: document.getElementById('activeUsers'),
        averageScore: document.getElementById('averageScore'),
        maxScore: document.getElementById('maxScore')
    };
    
    if (statsElements.totalUsers) statsElements.totalUsers.textContent = statistics.total_users || 0;
    if (statsElements.activeUsers) statsElements.activeUsers.textContent = statistics.active_users || 0;
    if (statsElements.averageScore) statsElements.averageScore.textContent = (statistics.average_score || 0).toFixed(1);
    if (statsElements.maxScore) statsElements.maxScore.textContent = (statistics.max_score || 0).toFixed(1);
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
    const tbody = document.getElementById('adminRankingTableBody');
    if (!tbody) {
        console.error('âŒ adminRankingTableBody ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (rankingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    rankingData.forEach((user, index) => {
        const row = document.createElement('tr');
        
        // é †ä½ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        if (index === 0) row.classList.add('table-warning');
        else if (index === 1) row.classList.add('table-secondary');
        else if (index === 2) row.classList.add('table-info');
        
        const lastLogin = user.last_login ? 
            new Date(user.last_login).toLocaleString('ja-JP') : 
            'ãªã—';
        
        // æ“ä½œåˆ—ã‚’å‰Šé™¤ã—ã€åå‰ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼ˆä¿®æ­£ç‰ˆï¼‰
        row.innerHTML = `
            <td>
                <strong>${index + 1}</strong>
                ${index === 0 ? '<i class="fas fa-crown text-warning ms-1"></i>' : ''}
                ${index === 1 ? '<i class="fas fa-medal text-secondary ms-1"></i>' : ''}
                ${index === 2 ? '<i class="fas fa-medal text-warning ms-1"></i>' : ''}
            </td>
            <td>
                <span class="user-name-link" onclick="showUserDetailsSimple('${user.username}', ${user.total_attempts}, ${user.total_correct}, ${user.accuracy_rate}, ${user.mastered_count})" style="cursor: pointer; color: #007bff; text-decoration: underline; font-weight: 600;">
                    ${user.username || 'N/A'}
                </span>
            </td>
            <td><small>${lastLogin}</small></td>
            <td>${user.total_attempts || 0}</td>
            <td>${user.total_correct || 0}</td>
            <td>${(user.accuracy_rate || 0).toFixed(1)}%</td>
            <td>${user.mastered_count || 0}</td>
            <td><strong>${(user.balance_score || 0).toFixed(1)}</strong></td>
            <td>${(user.coverage_rate || 0).toFixed(1)}%</td>
        `;
        
        tbody.appendChild(row);
    });
}

// ç·Šæ€¥ä¿®å¾©æ©Ÿèƒ½ã‚’è¿½åŠ 
function fixStatsOnly() {
    if (!confirm('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š\nâ€¢ çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆãƒ»ç¢ºèª\nâ€¢ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å†è¨ˆç®—\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ä¿®å¾©ä¸­...';
    
    fetch('/admin/fix_stats_only', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`âœ… çµ±è¨ˆä¿®å¾©å®Œäº†ï¼\n\n${data.message}\nä¿®å¾©äººæ•°: ${data.fixed_count}äºº\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
            location.reload();
        } else {
            alert(`âŒ ä¿®å¾©ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
function showUserDetailsSimple(username, totalAttempts, totalCorrect, accuracyRate, masteredCount) {
    const message = `ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°æƒ…å ±:

ğŸ‘¤ åå‰: ${username}
ğŸ“Š ç·å›ç­”æ•°: ${totalAttempts}
âœ… æ­£è§£æ•°: ${totalCorrect}
ğŸ“ˆ æ­£ç­”ç‡: ${accuracyRate.toFixed(1)}%
ğŸ† ãƒã‚¹ã‚¿ãƒ¼æ•°: ${masteredCount}

â€» ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã¯é€²æ—ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚`;
    
    alert(message);
}

function showUserDetails(userId) {
    // ç°¡æ˜“ç‰ˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (currentRankingData) {
        const user = currentRankingData.find(u => u.user_id === userId);
        if (user) {
            showUserDetailsSimple(user.username, user.total_attempts, user.total_correct, user.accuracy_rate, user.mastered_count);
        }
    }
}

console.log('âœ… ç®¡ç†è€…ãƒšãƒ¼ã‚¸ JavaScriptï¼ˆä¿®æ­£ç‰ˆï¼‰èª­ã¿è¾¼ã¿å®Œäº†');

// ========================================
// 3. ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
// ========================================

function showRankingLoading() {
    const elements = {
        initial: document.getElementById('adminRankingInitial'),
        loading: document.getElementById('adminRankingLoading'),
        container: document.getElementById('adminRankingTableContainer'),
        error: document.getElementById('adminRankingError')
    };
    
    if (elements.initial) elements.initial.style.display = 'none';
    if (elements.loading) elements.loading.style.display = 'block';
    if (elements.container) elements.container.style.display = 'none';
    if (elements.error) elements.error.style.display = 'none';
}

function showRankingTable() {
    const elements = {
        initial: document.getElementById('adminRankingInitial'),
        loading: document.getElementById('adminRankingLoading'),
        container: document.getElementById('adminRankingTableContainer'),
        error: document.getElementById('adminRankingError')
    };
    
    if (elements.initial) elements.initial.style.display = 'none';
    if (elements.loading) elements.loading.style.display = 'none';
    if (elements.container) elements.container.style.display = 'block';
    if (elements.error) elements.error.style.display = 'none';
}

function showRankingError(message) {
    const elements = {
        initial: document.getElementById('adminRankingInitial'),
        loading: document.getElementById('adminRankingLoading'),
        container: document.getElementById('adminRankingTableContainer'),
        error: document.getElementById('adminRankingError'),
        errorMessage: document.getElementById('adminRankingErrorMessage')
    };
    
    if (elements.initial) elements.initial.style.display = 'none';
    if (elements.loading) elements.loading.style.display = 'none';
    if (elements.container) elements.container.style.display = 'none';
    if (elements.error) elements.error.style.display = 'block';
    if (elements.errorMessage) elements.errorMessage.textContent = message;
}

// ========================================
// 4. ãã®ä»–ã®æ©Ÿèƒ½
// ========================================
function refreshRoomList() {
    console.log('ğŸ”„ éƒ¨å±‹ä¸€è¦§æ›´æ–°');
    loadRoomList();
}

function refreshRoomRanking() {
    if (selectedRoom) {
        console.log('ğŸ”„ ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°:', selectedRoom);
        loadRankingForRoom(selectedRoom);
    }
}

function retryLoadRanking() {
    if (selectedRoom) {
        loadRankingForRoom(selectedRoom);
    }
}

function clearRankingView() {
    selectedRoom = null;
    currentRankingData = null;
    
    const dropdown = document.getElementById('roomSelectDropdown');
    if (dropdown) dropdown.value = '';
    
    const selectedRoomInfo = document.getElementById('selectedRoomInfo');
    if (selectedRoomInfo) selectedRoomInfo.style.display = 'none';
    
    const elements = {
        initial: document.getElementById('adminRankingInitial'),
        container: document.getElementById('adminRankingTableContainer'),
        error: document.getElementById('adminRankingError')
    };
    
    if (elements.initial) elements.initial.style.display = 'block';
    if (elements.container) elements.container.style.display = 'none';
    if (elements.error) elements.error.style.display = 'none';
}

function exportRoomData() {
    if (!selectedRoom) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹éƒ¨å±‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
    const exportUrl = `/admin/export_room_ranking/${encodeURIComponent(selectedRoom)}`;
    window.open(exportUrl, '_blank');
}

function showRoomComparison() {
    alert('éƒ¨å±‹æ¯”è¼ƒæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™');
}

// ========================================
// 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†æ©Ÿèƒ½
// ========================================

function checkUserStats() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ç¢ºèªä¸­...';
    
    fetch('/admin/check_user_stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayStatsCheckResult(data);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('çµ±è¨ˆç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ çµ±è¨ˆç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
}

function displayStatsCheckResult(data) {
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    if (!resultDiv || !contentDiv) return;
    
    const summary = data.summary;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${summary.total_users}äºº</li>
                    <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${summary.total_stats}å€‹</li>
                    <li>çµ±è¨ˆãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${summary.users_without_stats}äºº</li>
                    <li>å¤ã„çµ±è¨ˆ: ${summary.outdated_stats}å€‹</li>
                    <li>ã‚«ãƒãƒ¼ç‡: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ? 
                    '<p class="text-success">âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™ã€‚ä¿®å¾©ã¯ä¸è¦ã§ã™ã€‚</p>' :
                    `<p class="text-warning">âš ï¸ ${summary.users_without_stats + summary.outdated_stats}ä»¶ã®çµ±è¨ˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
                }
            </div>
        </div>
    `;
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†é–¢æ•°ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ç¶­æŒï¼‰
function repairUserStats() {
    if (confirm('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ä¿®å¾©ä¸­...';
        
        fetch('/admin/repair_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

function initializeAllStats() {
    if (confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'åˆæœŸåŒ–ä¸­...';
        
        fetch('/admin/initialize_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// ========================================
// 6. çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆçµ±åˆç‰ˆï¼‰åˆæœŸåŒ–é–‹å§‹...');
    
    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    setTimeout(() => {
        loadCsvFilesList();
        loadRoomSettings();
        loadRoomList();
    }, 500);
});

console.log('âœ… ç®¡ç†è€…ãƒšãƒ¼ã‚¸ JavaScriptï¼ˆçµ±åˆç‰ˆï¼‰èª­ã¿è¾¼ã¿å®Œäº†');

function fixStatsComprehensive() {
    if (!confirm('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’åŒ…æ‹¬çš„ã«ä¿®å¾©ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š\nâ€¢ æ—¢å­˜çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢\nâ€¢ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚’è©³ç´°åˆ†æ\nâ€¢ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å†è¨ˆç®—\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ä¿®å¾©ä¸­...';
    
    // é€²æ—è¡¨ç¤ºã‚’è¿½åŠ 
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    if (resultDiv && contentDiv) {
        contentDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ä¸­...</div>';
        resultDiv.style.display = 'block';
    }
    
    fetch('/admin/fix_stats_comprehensive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ä¿®å¾©å®Œäº†</h6>
                        <p>${data.message}</p>
                        <ul>
                            <li>ä¿®å¾©ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.fixed_count}äºº</li>
                            <li>ç·å›ç­”æ•°: ${data.total_attempts_sum}å›</li>
                        </ul>
                    </div>
                `;
            }
            alert(`âœ… åŒ…æ‹¬çš„ä¿®å¾©å®Œäº†ï¼\n\n${data.message}\nä¿®å¾©äººæ•°: ${data.fixed_count}äºº\nç·å›ç­”æ•°: ${data.total_attempts_sum}å›\n\nãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        } else {
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> ä¿®å¾©ã‚¨ãƒ©ãƒ¼</h6>
                        <p>${data.message}</p>
                    </div>
                `;
            }
            alert(`âŒ ä¿®å¾©ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
        if (contentDiv) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼</h6>
                    <p>ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                </div>
            `;
        }
        alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function checkUserStatsDetailed() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ç¢ºèªä¸­...';
    
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    if (contentDiv) {
        contentDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...</div>';
        resultDiv.style.display = 'block';
    }
    
    fetch('/admin/check_user_stats_detailed')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const summary = data.summary;
            const userDetails = data.user_details;
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h6>
                        <ul>
                            <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${summary.total_users}äºº</li>
                            <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${summary.total_stats}å€‹</li>
                            <li>ã‚«ãƒãƒ¼ç‡: ${summary.coverage_rate}%</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ” ã‚µãƒ³ãƒ—ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†æ</h6>
                        <ul>
            `;
            
            userDetails.forEach(user => {
                const status = user.has_stats && user.stats_attempts > 0 ? 'âœ…' : 'âŒ';
                html += `<li>${status} ${user.username}: å±¥æ­´${user.history_count}ä»¶, ã‚¹ã‚³ã‚¢${user.stats_balance_score}</li>`;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            if (summary.coverage_rate < 100 || userDetails.some(u => !u.has_stats || u.stats_attempts === 0)) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <strong>âš ï¸ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã€Œçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¿®å¾©ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-success mt-3">
                        <strong>âœ… çŠ¶æ…‹:</strong> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã§ã™ã€‚
                    </div>
                `;
            }
            
            if (contentDiv) {
                contentDiv.innerHTML = html;
            }
        } else {
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> ç¢ºèªã‚¨ãƒ©ãƒ¼</h6>
                        <p>${data.message}</p>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        if (contentDiv) {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼</h6>
                    <p>ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                </div>
            `;
        }
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}
</script>

<style>
.admin-panel {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #eee;
}

.admin-panel h4 {
    margin-top: 0;
    margin-bottom: 10px;
}

.admin-panel p {
    margin-bottom: 15px;
    line-height: 1.5;
}

.download-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
.scrollable-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.scrollable-table-container .table {
    margin-bottom: 0;
}

/* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #343a40 !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ¶å¾¡è¦ç´  */
.table-controls {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.table-controls label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

/* ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ */
.sort-icon {
    margin-left: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.sort-icon:hover {
    opacity: 1;
}

/* ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
.badge {
    font-size: 0.8em;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œã®ãƒ›ãƒãƒ¼åŠ¹æœ */
#userTableBody tr:hover {
    background-color: #f8f9fa;
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
.delete-user-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* ç®¡ç†è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.room-selector-container {
    margin-bottom: 25px;
}

.room-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.room-button {
    padding: 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6;
}

.room-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.room-button.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.room-button small {
    color: inherit;
    opacity: 0.8;
}

.ranking-summary {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.summary-card {
    text-align: center;
    padding: 15px;
    background-color: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.summary-card h5 {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 10px;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    display: block;
}

.admin-ranking-actions {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    text-align: center;
}

.admin-ranking-actions button {
    margin: 0 5px;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.table-hover tbody tr:hover {
    background-color: rgba(0,0,0,0.05);
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.85rem;
}

/* ã‚¢ã‚¤ã‚³ãƒ³ */
.fas.fa-crown {
    margin-left: 5px;
}

.fas.fa-medal {
    margin-left: 5px;
}

/* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³åŠ¹æœ */
#invalidHistoryAnalysisResult,
#userDebugResult,
#statsCheckResult {
    margin-top: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
.table-responsive {
    margin-top: 10px;
}

.text-success {
    color: #28a745 !important;
}

.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .download-buttons {
        flex-direction: column;
    }
    
    .download-buttons .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group-vertical .btn {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .scrollable-table-container {
        max-height: 300px;
    }
    
    .table-controls .row {
        margin-bottom: 0;
    }
    
    .table-controls .col-md-6 {
        margin-bottom: 10px;
    }
    
    /* ã‚¹ãƒãƒ›ã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºæ”¹å–„ */
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.3rem;
        white-space: nowrap;
    }
    
    /* éƒ¨å±‹ãƒœã‚¿ãƒ³ */
    .room-buttons-grid {
        grid-template-columns: 1fr;
    }
    
    .ranking-summary .row {
        text-align: center;
    }
    
    .summary-card {
        margin-bottom: 15px;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .admin-ranking-actions {
        text-align: center;
    }
    
    .admin-ranking-actions button {
        margin: 5px 2px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .room-button {
        padding: 10px;
        font-size: 0.9rem;
    }
    
    .summary-value {
        font-size: 1.5rem;
    }
    
    .table {
        font-size: 0.75rem;
    }
}

.room-select-form {
    display: flex;
    align-items: end;
    gap: 15px;
    margin-bottom: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.room-select-form .form-group {
    flex: 1;
    margin-bottom: 0;
}

.room-select-form label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

.room-select-form select {
    min-width: 200px;
}

.quick-access-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.quick-access-btn {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.room-info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.room-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.ranking-summary {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
}

.summary-card {
    text-align: center;
    padding: 15px;
    background-color: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.summary-card h5 {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 10px;
    font-weight: 600;
}

.summary-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    display: block;
}

.ranking-table {
    font-size: 0.9rem;
}

.ranking-table th {
    background-color: #343a40;
    color: white;
    font-weight: 600;
    border: none;
    padding: 12px 8px;
}

.ranking-table td {
    vertical-align: middle;
    padding: 10px 8px;
}

.ranking-table tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
}

/* é †ä½ã«å¿œã˜ãŸè‰²åˆ†ã‘ */
.ranking-table tbody tr:nth-child(1) {
    background-color: rgba(255,215,0,0.2); /* é‡‘ */
}

.ranking-table tbody tr:nth-child(2) {
    background-color: rgba(192,192,192,0.2); /* éŠ€ */
}

.ranking-table tbody tr:nth-child(3) {
    background-color: rgba(205,127,50,0.2); /* éŠ… */
}

.user-name-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
}

.user-name-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

.score-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.score-high {
    background-color: #d4edda;
    color: #155724;
}

.score-medium {
    background-color: #fff3cd;
    color: #856404;
}

.score-low {
    background-color: #f8d7da;
    color: #721c24;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .room-select-form {
        flex-direction: column;
        align-items: stretch;
    }
    
    .room-actions {
        justify-content: center;
    }
    
    .ranking-summary .row > div {
        margin-bottom: 15px;
    }
    
    .summary-card {
        margin-bottom: 10px;
    }
    
    .ranking-table {
        font-size: 0.8rem;
    }
    
    .ranking-table th,
    .ranking-table td {
        padding: 6px 4px;
    }
}

* ç·Šæ€¥ä¿®å¾©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#admin-emergency-fixes .admin-panel {
    margin-bottom: 30px;
}

#admin-emergency-fixes .btn-lg {
    font-size: 1.2rem;
    padding: 12px 30px;
    margin-bottom: 15px;
}

/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.progress {
    height: 25px;
    background-color: #e9ecef;
    border-radius: 15px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
    background: linear-gradient(45deg, #007bff, #0056b3);
}

/* çµæœè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
#uploadResult .alert {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#uploadResult .alert-success {
    border-left: 5px solid #28a745;
}

#uploadResult .alert-danger {
    border-left: 5px solid #dc3545;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
.user-name-link {
    font-weight: 600;
    transition: all 0.2s ease;
}

.user-name-link:hover {
    color: #0056b3 !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ”¹å–„ */
.ranking-table th {
    position: sticky;
    top: 0;
    background-color: #343a40 !important;
    z-index: 10;
}

.ranking-table tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
    transform: scale(1.005);
    transition: all 0.2s ease;
}

/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ”¹å–„ */
.summary-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    #admin-emergency-fixes .btn-lg {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .ranking-table {
        font-size: 0.85rem;
    }
    
    .summary-card {
        margin-bottom: 15px;
    }
}
</style>
{% endblock %}