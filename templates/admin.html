{% extends "base.html" %}
{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - {{ app_name }}{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="admin-app-info-management">
        <h3>ğŸ“± ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†</h3>
        <p>ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºåã€æ›´æ–°å†…å®¹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã©ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
        
        <div class="admin-panel" style="background-color: #e8f4fd; border-left: 5px solid #3498db;">
            <h4>ç¾åœ¨ã®ã‚¢ãƒ—ãƒªæƒ…å ±</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ã‚¢ãƒ—ãƒªå:</strong> {{ app_info.app_name if app_info else 'ä¸–ç•Œå²å˜èªå¸³' }}</p>
                    <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> {{ app_info.version if app_info else '1.0.0' }}</p>
                    <p><strong>æœ€çµ‚æ›´æ–°æ—¥:</strong> {{ app_info.last_updated_date if app_info else '2025å¹´6æœˆ15æ—¥' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>æ›´æ–°å†…å®¹:</strong></p>
                    <div style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em;">
                        {{ app_info.update_content if app_info else 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚' }}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <a href="{{ url_for('admin_app_info') }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ã‚’ç·¨é›†
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-info" target="_blank">
                    <i class="fas fa-external-link-alt"></i> å®Ÿéš›ã®è¡¨ç¤ºã‚’ç¢ºèª
                </a>
            </div>
        </div>
    </section>

    <hr>

    <section id="admin-user-management">
        <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
        <p>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ users|length }}äºº</p>

        <h4>å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
        <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
            <div class="input-group">
                <label for="new_room_number">éƒ¨å±‹ç•ªå·:</label>
                <input type="text" id="new_room_number" name="room_number" required>
            </div>
            <div class="input-group">
                <label for="new_room_password">å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_room_password" name="room_password" required>
            </div>
            <div class="input-group">
                <label for="new_student_id">å‡ºå¸­ç•ªå·:</label>
                <input type="text" id="new_student_id" name="student_id" required>
            </div>
            <div class="input-group">
                <label for="new_individual_password">å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_individual_password" name="individual_password" required>
            </div>
            <div class="input-group">
                <label for="new_username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:</label>
                <input type="text" id="new_username" name="username" required>
                <small class="form-text text-muted">â€»åŒä¸€äººç‰©ãŒè¤‡æ•°ã®éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆã€åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã§ã‚‚ç™»éŒ²å¯èƒ½ã§ã™</small>
            </div>
            <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
        </form>

        <h4>CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
        <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
            <ul>
                <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: éƒ¨å±‹ç•ªå·,å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,å‡ºå¸­ç•ªå·,å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</li>
                <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
                <li>ä¾‹: 101,password123,001,student001,æˆå¯Œå…µåº«èŒ‚å®‰</li>
                <li>åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®ç™»éŒ²ã‚‚å¯èƒ½ã§ã™ï¼ˆåŒä¸€äººç‰©ãŒè¤‡æ•°éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆï¼‰</li>
            </ul>
            <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-download"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>

        <form action="{{ url_for('admin_upload_users') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <div class="input-group">
                <label for="users_csv_file">ãƒ¦ãƒ¼ã‚¶ãƒ¼CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="users_csv_file" name="file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-upload"></i> CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            </button>
        </form>

        <h4>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
        <!-- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
        <div class="table-controls mb-3">
            <div class="row">
                <div class="col-md-6">
                    <label for="roomSortSelect">éƒ¨å±‹ã§ã‚½ãƒ¼ãƒˆ:</label>
                    <select id="roomSortSelect" class="form-control form-control-sm">
                        <option value="">å…¨ã¦ã®éƒ¨å±‹</option>
                        {% set room_numbers = [] %}
                        {% for user in users %}
                            {% if user.room_number not in room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = room_numbers.append(user.room_number) %}
                            {% endif %}
                        {% endfor %}
                        {% for room_num in room_numbers|sort %}
                            <option value="{{ room_num }}">éƒ¨å±‹ {{ room_num }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="userSearchInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢:</label>
                    <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="åå‰ã€å‡ºå¸­ç•ªå·ã§æ¤œç´¢...">
                </div>
            </div>
        </div>

        <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="scrollable-table-container">
            <div class="table-responsive">
                <table class="table table-striped user-list-table" id="userTable">
                    <thead class="table-dark sticky-header">
                        <tr>
                            <th>ID</th>
                            <th>éƒ¨å±‹ <i class="fas fa-sort sort-icon" data-column="room" style="cursor: pointer;"></i></th>
                            <th>å‡ºå¸­ç•ªå·</th>
                            <th>ç¾åœ¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå <i class="fas fa-sort sort-icon" data-column="name" style="cursor: pointer;"></i></th>
                            <th>æœ€åˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</th>
                            <th>å¤‰æ›´æ—¥æ™‚</th>
                            <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³ <i class="fas fa-sort sort-icon" data-column="login" style="cursor: pointer;"></i></th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in users %}
                        {% if user.username != 'admin' %}
                        <tr data-room="{{ user.room_number }}" data-name="{{ user.username|lower }}" data-student="{{ user.student_id|lower }}">
                            <td>{{ user.id }}</td>
                            <td><span class="badge bg-secondary">{{ user.room_number }}</span></td>
                            <td>{{ user.student_id }}</td>
                            <td>
                                {{ user.username }}
                                {% if user.original_username and user.original_username != user.username %}
                                <span class="badge bg-warning text-dark ms-1">
                                    <i class="fas fa-edit"></i> å¤‰æ›´æ¸ˆã¿
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.original_username and user.original_username != user.username %}
                                <span class="text-muted">{{ user.original_username }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ user.username_changed_at | to_jst if user.username_changed_at else '-' }}</td>
                            <td>{{ user.last_login | to_jst if user.last_login else 'æœªãƒ­ã‚°ã‚¤ãƒ³' }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-user-btn"
                                        data-user-id="{{ user.id }}"
                                        data-username="{{ user.username }}"
                                        data-room="{{ user.room_number }}">å‰Šé™¤</button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <hr>

    <!-- éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="admin-csv-management">
        <h3>ğŸ“ éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
        <p>å„éƒ¨å±‹ã§ä½¿ç”¨ã™ã‚‹å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®words.csvãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
        <div class="csv-template-section" style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px; border-left: 4px solid #17a2b8;">
            <h4 style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-download"></i> CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </h4>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                æ­£ã—ã„å½¢å¼ã®å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ãã§ã™ãã«ç·¨é›†ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
            </p>
            <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-file-csv"></i> å˜èªå¸³CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
            <small class="text-muted d-block mt-2">
                â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šchapter, number, category, question, answer, enabled
            </small>
        </div>
        <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h4>
        <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
            <ul>
                <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: chapter, number, category, question, answer, enabled</li>
                <li>enabledåˆ—: 1ï¼ˆæœ‰åŠ¹ï¼‰ã¾ãŸã¯0ï¼ˆç„¡åŠ¹ï¼‰</li>
                <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
                <li>ãƒ•ã‚¡ã‚¤ãƒ«åã¯å…ƒã®åå‰ã®ã¾ã¾ä¿å­˜ã•ã‚Œã¾ã™</li>
            </ul>
        </div>
        
        <form action="{{ url_for('admin_upload_room_csv') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <div class="input-group">
                <label for="room_csv_file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="room_csv_file" name="file" accept=".csv" required>
                <small class="form-text text-muted">ï¼Šãƒ•ã‚¡ã‚¤ãƒ«åã¯åŠè§’è‹±æ•°å­—ï¼Š</small>
            </div>
            <button type="submit" class="btn btn-success">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </form>

        <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h4>
        <div id="csv-files-list">
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">
                    <i class="fas fa-sync-alt"></i> ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                </button>
            </div>
            <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
            <div class="scrollable-table-container">
                <div id="csv-files-container" style="margin-top: 15px;">
                    <p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </section>

    <hr>

    <section id="admin-room-settings">
        <h3>ğŸ  éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç†</h3>
        <p>å„éƒ¨å±‹ã®å­¦ç¿’ç¯„å›²ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

        <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªéƒ¨å±‹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="scrollable-table-container">
            <div class="table-responsive">
                <table class="table table-striped room-setting-table">
                    <thead class="table-dark sticky-header">
                        <tr>
                            <th>éƒ¨å±‹ç•ªå·</th>
                            <th>æœ€å¤§å˜å…ƒç•ªå·</th>
                            <th>ä½¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set unique_room_numbers = [] %}
                        {% for user in users %}
                            {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(user.room_number) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for setting in room_max_unit_settings.keys() %}
                            {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                {% set _ = unique_room_numbers.append(setting) %}
                            {% endif %}
                        {% endfor %}

                        {% for room_num in unique_room_numbers|sort %}
                        <tr>
                            <td><strong>{{ room_num }}</strong></td>
                            <td>
                                <input type="text"
                                    id="maxUnit_{{ room_num }}"
                                    value="{{ room_max_unit_settings.get(room_num, '9999') }}"
                                    class="form-control unit-setting-input"
                                    data-room-number="{{ room_num }}"
                                    placeholder="ä¾‹: 34 ã¾ãŸã¯ 9999ï¼ˆå…¨ã¦ï¼‰">
                            </td>
                            <td>
                                <select id="csvFile_{{ room_num }}" 
                                        class="form-control csv-setting-select" 
                                        data-room-number="{{ room_num }}">
                                    <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv') == 'words.csv' %}selected{% endif %}>
                                        words.csv (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                                    </option>
                                    <!-- å‹•çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                                </select>
                                <small class="form-text text-muted">
                                    ç¾åœ¨ã®è¨­å®š: <code id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                </small>
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-primary btn-sm save-room-setting-btn" 
                                            data-room-number="{{ room_num }}">ä¿å­˜</button>
                                    <button class="btn btn-danger btn-sm delete-room-setting-btn" 
                                            data-room-number="{{ room_num }}">å‰Šé™¤</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <hr>

    <!-- å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-panel">
        <h3>ğŸ† å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º</h3>
        <p>å„éƒ¨å±‹ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        
        <!-- éƒ¨å±‹é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="room-selector-container">
            <h4>éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</h4>
            <div id="room-buttons" class="room-buttons-grid">
                <!-- å‹•çš„ã«éƒ¨å±‹ãƒœã‚¿ãƒ³ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- é¸æŠä¸­ã®éƒ¨å±‹æƒ…å ± -->
        <div id="selected-room-info" class="alert alert-info" style="display: none;">
            <h5>é¸æŠä¸­ã®éƒ¨å±‹: <span id="selected-room-name"></span></h5>
            <button class="btn btn-sm btn-outline-warning" onclick="clearRankingView()">
                <i class="fas fa-times"></i> é¸æŠè§£é™¤
            </button>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="admin-ranking-container">
            <div id="admin-ranking-initial" class="text-center py-4">
                <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                <p class="text-muted">ä¸Šè¨˜ã‹ã‚‰éƒ¨å±‹ã‚’é¸æŠã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
            </div>
            
            <div id="admin-ranking-loading" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ä¸­...</p>
            </div>
            
            <div id="admin-ranking-table-container" style="display: none;">
                <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
                <div class="ranking-summary">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-card">
                                <h5>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h5>
                                <span class="summary-value" id="total-users">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <h5>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</h5>
                                <span class="summary-value" id="active-users">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <h5>å¹³å‡ã‚¹ã‚³ã‚¢</h5>
                                <span class="summary-value" id="average-score">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <h5>æœ€é«˜ã‚¹ã‚³ã‚¢</h5>
                                <span class="summary-value" id="max-score">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>é †ä½</th>
                                <th>åå‰</th>
                                <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                                <th>å›ç­”æ•°</th>
                                <th>æ­£è§£æ•°</th>
                                <th>æ­£ç­”ç‡</th>
                                <th>ãƒã‚¹ã‚¿ãƒ¼æ•°</th>
                                <th>ç·åˆã‚¹ã‚³ã‚¢</th>
                                <th>ç¶²ç¾…ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="admin-ranking-table-body">
                            <!-- å‹•çš„ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="admin-ranking-error" class="alert alert-danger" style="display: none;">
                <h5>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h5>
                <p id="admin-ranking-error-message"></p>
                <button class="btn btn-primary" onclick="retryLoadRanking()">
                    <i class="fas fa-redo"></i> å†è©¦è¡Œ
                </button>
            </div>
        </div>
        
        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="admin-ranking-actions mt-3" id="admin-ranking-actions" style="display: none;">
            <button class="btn btn-success" onclick="exportRankingData()">
                <i class="fas fa-download"></i> CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button class="btn btn-info" onclick="refreshRanking()">
                <i class="fas fa-sync"></i> ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            </button>
            <button class="btn btn-warning" onclick="showRoomsComparison()">
                <i class="fas fa-chart-bar"></i> éƒ¨å±‹æ¯”è¼ƒ
            </button>
            <button class="btn btn-primary" onclick="showDetailedUserInfo()">
                <i class="fas fa-user-friends"></i> è©³ç´°åˆ†æ
            </button>
        </div>
    </div>

    <hr>

    <section id="admin-user-stats-management">
        <h3>ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆç®¡ç†</h3>
        <p>äº‹å‰è¨ˆç®—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®çŠ¶æ…‹ç¢ºèªãƒ»ä¿®å¾©ã‚’è¡Œã„ã¾ã™ã€‚</p>

        <!-- çµ±è¨ˆçŠ¶æ…‹ç¢ºèª -->
        <div class="admin-panel" style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
            <h4>ğŸ“ˆ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ç¢ºèª</h4>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®æ•´åˆæ€§ã¨æœ€æ–°æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚<br>
            <strong>æ¨å¥¨ï¼š</strong>æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ãŸå¾Œã‚„ã€ãƒ‡ãƒ¼ã‚¿ã«ä¸æ•´åˆãŒã‚ã‚‹å ´åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="margin-top: 15px;">
                <button type="button" class="btn btn-info" onclick="checkUserStats()">
                    <i class="fas fa-chart-line"></i> ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ã‚’ç¢ºèª
                </button>
                
                <button type="button" class="btn btn-success" onclick="repairUserStats()" style="margin-left: 10px;">
                    <i class="fas fa-tools"></i> ğŸ”§ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©
                </button>
                
                <button type="button" class="btn btn-warning" onclick="initializeAllStats()" style="margin-left: 10px;">
                    <i class="fas fa-sync-alt"></i> ğŸ”„ å…¨çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆç¢ºèªçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="statsCheckResult" style="margin-top: 15px; display: none;">
            <h5>ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ç¢ºèªçµæœ</h5>
            <div id="statsCheckContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                <!-- ç¢ºèªçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </section>

    <hr>

    <section id="admin-database-management">
        <h3>ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h3>
        <p>å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>

        <!-- å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— -->
        <div class="admin-panel" style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
            <h4>ğŸ§¹ å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h4>
            <p>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
            <strong>æ¨å¥¨ï¼š</strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="margin-top: 15px;">
                <button type="button" class="btn btn-warning" onclick="cleanupOrphanedTokens()">
                    <i class="fas fa-broom"></i> ğŸ§¹ å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
                </button>
                
                <button type="button" class="btn btn-info" onclick="checkDatabaseStatus()" style="margin-left: 10px;">
                    <i class="fas fa-search"></i> ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
                </button>
            </div>
        </div>

        <div class="admin-panel" style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
            <h4>ğŸ—‘ï¸ IDä¸ä¸€è‡´å±¥æ­´ã®å‰Šé™¤</h4>
            <p>ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å¤ã„å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
            <strong>ç”¨é€”ï¼š</strong>å•é¡Œæ–‡ä¿®æ­£å¾Œã«å¤ã„IDã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã«ä½¿ç”¨ã€‚<br>
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>å‰Šé™¤ã•ã‚ŒãŸå±¥æ­´ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</p>
            
            <div style="margin-top: 15px;">
                <button type="button" class="btn btn-info" onclick="analyzeInvalidHistoryDetailed()">
                    <i class="fas fa-search"></i> ğŸ“Š è©³ç´°åˆ†æï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
                </button>
                
                <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory()" style="margin-left: 10px;">
                    <i class="fas fa-trash-alt"></i> ğŸ—‘ï¸ ç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                <h5>ğŸ” ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="debugUsername" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
                            <button class="btn btn-outline-secondary" onclick="debugSpecificUser()">
                                <i class="fas fa-bug"></i> ãƒ‡ãƒãƒƒã‚°
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-danger btn-sm" onclick="forceCleanSpecificUser()">
                            <i class="fas fa-exclamation-triangle"></i> å¼·åˆ¶å‰Šé™¤
                        </button>
                        <small class="text-muted d-block">â€»ä¸Šè¨˜ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›å¾Œã«ä½¿ç”¨</small>
                    </div>
                </div>
            </div>
            
            <!-- ç„¡åŠ¹å±¥æ­´åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                <h5>ğŸ“Š ç„¡åŠ¹å±¥æ­´åˆ†æçµæœ</h5>
                <div id="invalidAnalysisContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                    <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="userDebugResult" style="margin-top: 15px; display: none;">
                <h5>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒãƒƒã‚°çµæœ</h5>
                <div id="debugContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                    <!-- ãƒ‡ãƒãƒƒã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <!-- å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆå¾“æ¥æ©Ÿèƒ½ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰ -->
        <div class="admin-panel" style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
            <h4>âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰</h4>
            <p>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚’å¼·åˆ¶çš„ã«æ–°ã—ã„IDå½¢å¼ã«çµ±ä¸€ã—ã¾ã™ã€‚<br>
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>ã“ã®æ“ä½œã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã«å½±éŸ¿ã—ã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚<br>
            <strong>æ¨å¥¨ï¼š</strong>é€šå¸¸ã¯ä¸Šè¨˜ã®ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="margin-top: 15px;">
                <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST" style="display: inline;" 
                    onsubmit="return confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ãŒæ–°ã—ã„å½¢å¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚\nâš ï¸ é€šå¸¸ã¯ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã§ååˆ†ã§ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶ä¿®æ­£ï¼ˆéæ¨å¥¨ï¼‰
                    </button>
                </form>
                
                <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank" style="margin-left: 10px;">
                    <i class="fas fa-chart-line"></i> ğŸ“Š ä¿®æ­£å‰ã®çŠ¶æ…‹ç¢ºèª
                </a>
            </div>
        </div>
    </section>

    <!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
    </form>
</div>

<script>
console.log('ğŸ”§ admin.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆä¿®æ­£ç‰ˆï¼‰');

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆé‡è¤‡å®£è¨€ã‚’ä¿®æ­£ï¼‰
// ========================================
var selectedRoom = null;
var currentRankingData = null;

// ========================================
// 1. åŸºæœ¬çš„ãªéƒ¨å±‹ãƒ»CSVç®¡ç†æ©Ÿèƒ½
// ========================================

// éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹é–¢æ•°
function loadRoomSettings() {
    console.log('ğŸ”„ éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
    
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const roomNumber = select.dataset.roomNumber;
        if (!roomNumber) return;
        
        fetch('/admin/get_room_setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_number: roomNumber })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const csvFilename = data.csv_filename || 'words.csv';
                console.log(`ğŸ“‹ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿: ${csvFilename}`);
                
                select.value = csvFilename;
                
                const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                if (!optionExists && csvFilename !== 'words.csv') {
                    const newOption = document.createElement('option');
                    newOption.value = csvFilename;
                    newOption.textContent = csvFilename;
                    select.appendChild(newOption);
                    select.value = csvFilename;
                    console.log(`â• æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ : ${csvFilename}`);
                }
            }
        })
        .catch(error => {
            console.error(`âŒ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
        });
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadCsvFilesList() {
    console.log('ğŸ” CSV ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹...');
    
    const container = document.getElementById('csv-files-container');
    if (container) {
        container.innerHTML = '<p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
    }
    
    fetch('/admin/list_room_csv_files')
        .then(response => {
            console.log('ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“Š å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.status === 'success') {
                console.log(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—æˆåŠŸ: ${data.files.length}ä»¶`);
                updateCsvFilesDisplay(data.files);
                updateCsvSelectOptions(data.files);
            } else {
                console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—å¤±æ•—:', data.message);
                if (container) {
                    container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '</p>';
                }
            }
        })
        .catch(error => {
            console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            if (container) {
                container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        });
}

// æ™‚åˆ»ã«9æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°ï¼ˆJSTå¯¾å¿œï¼‰
function addHoursToTimestamp(dateString, hours) {
    const date = new Date(dateString);
    date.setHours(date.getHours() + hours);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvFilesDisplay(files) {
    console.log('ğŸ”„ ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ›´æ–°:', files);
    
    const container = document.getElementById('csv-files-container');
    if (!container) {
        console.error('âŒ csv-files-container ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    if (files.length === 0) {
        console.log('ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
        container.innerHTML = '<p class="text-muted">ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    console.log(`ğŸ“‹ ${files.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºä¸­...`);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
    html += '<thead class="table-dark"><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>å˜èªæ•°</th><th>ã‚µã‚¤ã‚º</th><th>æ›´æ–°æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead><tbody>';
    
    files.forEach((file, index) => {
        const sizeKB = Math.round(file.size / 1024);
        const wordCountDisplay = file.word_count > 0 ? `${file.word_count}å•` : 'ä¸æ˜';
        
        html += '<tr>' +
                '<td><code>' + file.filename + '</code></td>' +
                '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                '<td>' + sizeKB + ' KB</td>' +
                '<td><small>' + addHoursToTimestamp(file.modified, 9) + '</small></td>' +
                '<td><button class="btn btn-danger btn-sm" onclick="deleteCsvFile(\'' + file.filename + '\')">å‰Šé™¤</button></td>' +
                '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ›´æ–°å®Œäº†');
}

// ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvSelectOptions(files) {
    console.log('ğŸ”„ CSVã‚»ãƒ¬ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°:', files);
    
    const selects = document.querySelectorAll('.csv-setting-select');
    console.log(`ğŸ“‹ æ›´æ–°å¯¾è±¡ã‚»ãƒ¬ã‚¯ãƒˆæ•°: ${selects.length}`);
    
    selects.forEach((select, index) => {
        const roomNumber = select.dataset.roomNumber;
        const currentValue = select.value;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        Array.from(select.options).forEach(option => {
            if (option.value !== 'words.csv') {
                option.remove();
            }
        });
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        if (files && Array.isArray(files)) {
            files.forEach(file => {
                if (file.filename !== 'words.csv') {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = file.filename;
                    select.appendChild(option);
                }
            });
        }
        
        // å…ƒã®å€¤ã‚’å¾©å…ƒ
        if (currentValue && currentValue !== '') {
            select.value = currentValue;
        }
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤é–¢æ•°
function deleteCsvFile(filename) {
    if (confirm('CSVãƒ•ã‚¡ã‚¤ãƒ« "' + filename + '" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹éƒ¨å±‹ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/delete_room_csv/' + encodeURIComponent(filename);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ========================================
// 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½
// ========================================

// éƒ¨å±‹ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
async function loadRoomList() {
    try {
        console.log('ğŸ” éƒ¨å±‹ä¸€è¦§å–å¾—é–‹å§‹...');
        const response = await fetch('/api/rooms');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… éƒ¨å±‹ä¸€è¦§å–å¾—æˆåŠŸ:', data.rooms.length, 'éƒ¨å±‹');
            displayRoomButtons(data.rooms);
        } else {
            throw new Error(data.message || 'éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('âŒ éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤º
        const container = document.getElementById('room-buttons');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    éƒ¨å±‹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
                </div>
            `;
        }
    }
}

// éƒ¨å±‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
function displayRoomButtons(rooms) {
    const container = document.getElementById('room-buttons');
    if (!container) {
        console.error('âŒ room-buttons ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    container.innerHTML = '';
    
    if (rooms.length === 0) {
        container.innerHTML = '<p class="text-muted">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    rooms.forEach(room => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary room-button';
        button.innerHTML = `
            <i class="fas fa-door-open"></i>
            éƒ¨å±‹: ${room.room_number}
            <small class="d-block">(${room.user_count}äºº)</small>
        `;
        
        // onclick ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        button.onclick = () => selectRoom(room.room_number);
        
        container.appendChild(button);
    });
    
    console.log('âœ… éƒ¨å±‹ãƒœã‚¿ãƒ³è¡¨ç¤ºå®Œäº†:', rooms.length, 'å€‹');
}

// éƒ¨å±‹ã‚’é¸æŠ
function selectRoom(roomNumber) {
    console.log('ğŸ  éƒ¨å±‹é¸æŠ:', roomNumber);
    selectedRoom = roomNumber;
    
    // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.room-button').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’å–å¾—
    const clickedButton = Array.from(document.querySelectorAll('.room-button')).find(btn => 
        btn.onclick && btn.onclick.toString().includes(roomNumber)
    );
    
    if (clickedButton) {
        clickedButton.classList.remove('btn-outline-primary');
        clickedButton.classList.add('btn-primary');
    }
    
    // é¸æŠä¸­ã®éƒ¨å±‹æƒ…å ±ã‚’è¡¨ç¤º
    const selectedRoomName = document.getElementById('selected-room-name');
    const selectedRoomInfo = document.getElementById('selected-room-info');
    
    if (selectedRoomName) {
        selectedRoomName.textContent = roomNumber;
    }
    if (selectedRoomInfo) {
        selectedRoomInfo.style.display = 'block';
    }
    
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
    loadRankingForRoom(roomNumber);
}

// ç‰¹å®šã®éƒ¨å±‹ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
async function loadRankingForRoom(roomNumber) {
    try {
        console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹:', roomNumber);
        
        // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        const elements = {
            initial: document.getElementById('admin-ranking-initial'),
            loading: document.getElementById('admin-ranking-loading'),
            container: document.getElementById('admin-ranking-table-container'),
            error: document.getElementById('admin-ranking-error'),
            actions: document.getElementById('admin-ranking-actions')
        };
        
        if (elements.initial) elements.initial.style.display = 'none';
        if (elements.loading) elements.loading.style.display = 'block';
        if (elements.container) elements.container.style.display = 'none';
        if (elements.error) elements.error.style.display = 'none';
        if (elements.actions) elements.actions.style.display = 'none';
        
        // APIã‚’å‘¼ã³å‡ºã—
        const response = await fetch(`/api/admin/room_ranking/${encodeURIComponent(roomNumber)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—æˆåŠŸ:', data.ranking_data.length, 'äºº');
            currentRankingData = data.ranking_data;
            displayAdminRanking(data.ranking_data, data.statistics);
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            if (elements.loading) elements.loading.style.display = 'none';
            if (elements.container) elements.container.style.display = 'block';
            if (elements.actions) elements.actions.style.display = 'block';
            
        } else {
            throw new Error(data.message || 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
    } catch (error) {
        console.error('âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        const loadingEl = document.getElementById('admin-ranking-loading');
        const errorEl = document.getElementById('admin-ranking-error');
        const errorMsgEl = document.getElementById('admin-ranking-error-message');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'block';
        if (errorMsgEl) errorMsgEl.textContent = error.message;
    }
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
function displayAdminRanking(rankingData, statistics) {
    console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹:', rankingData.length, 'äºº');
    
    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    const statsElements = {
        totalUsers: document.getElementById('total-users'),
        activeUsers: document.getElementById('active-users'),
        averageScore: document.getElementById('average-score'),
        maxScore: document.getElementById('max-score')
    };
    
    if (statsElements.totalUsers) statsElements.totalUsers.textContent = statistics.total_users || 0;
    if (statsElements.activeUsers) statsElements.activeUsers.textContent = statistics.active_users || 0;
    if (statsElements.averageScore) statsElements.averageScore.textContent = (statistics.average_score || 0).toFixed(1);
    if (statsElements.maxScore) statsElements.maxScore.textContent = (statistics.max_score || 0).toFixed(1);
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
    const tbody = document.getElementById('admin-ranking-table-body');
    if (!tbody) {
        console.error('âŒ admin-ranking-table-body ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (rankingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    rankingData.forEach((user, index) => {
        const row = document.createElement('tr');
        
        // é †ä½ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        if (index === 0) row.classList.add('table-warning'); // 1ä½
        else if (index === 1) row.classList.add('table-secondary'); // 2ä½
        else if (index === 2) row.classList.add('table-info'); // 3ä½
        
        // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const lastLogin = user.last_login ? 
            new Date(user.last_login).toLocaleString('ja-JP') : 
            'ãªã—';
        
        row.innerHTML = `
            <td>
                ${index + 1}
                ${index === 0 ? '<i class="fas fa-crown text-warning"></i>' : ''}
                ${index === 1 ? '<i class="fas fa-medal text-secondary"></i>' : ''}
                ${index === 2 ? '<i class="fas fa-medal text-info"></i>' : ''}
            </td>
            <td>
                <strong style="cursor: pointer; color: #007bff;" onclick="showUserDetails(${user.user_id || 0})">
                    ${user.username || 'N/A'}
                </strong>
                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7em; color: #6c757d;"></i>
            </td>
            <td><small>${lastLogin}</small></td>
            <td>${user.total_attempts || 0}</td>
            <td>${user.total_correct || 0}</td>
            <td>${(user.accuracy_rate || 0).toFixed(1)}%</td>
            <td>${user.mastered_count || 0}</td>
            <td><strong>${(user.balance_score || 0).toFixed(1)}</strong></td>
            <td>${(user.coverage_rate || 0).toFixed(1)}%</td>
        `;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
        row.dataset.userId = user.user_id || 0;
        
        tbody.appendChild(row);
    });
    
    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºå®Œäº†');
}

// ========================================
// 3. ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
// ========================================

// ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
function showUserDetails(userId) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'userDetailsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°æƒ…å ±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Bootstrap 5ã®ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã«å‰Šé™¤
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
    
    // ç°¡æ˜“ç‰ˆã®è©³ç´°è¡¨ç¤º
    setTimeout(() => {
        const modalBody = modal.querySelector('.modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="alert alert-info">
                    <h6>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}</h6>
                    <p>è©³ç´°æƒ…å ±æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚</p>
                </div>
            `;
        }
    }, 1000);
}

// ========================================
// 4. ãã®ä»–ã®æ©Ÿèƒ½
// ========================================

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ“ä½œé–¢æ•°
function refreshRanking() {
    if (selectedRoom) {
        loadRankingForRoom(selectedRoom);
    }
}

function retryLoadRanking() {
    if (selectedRoom) {
        loadRankingForRoom(selectedRoom);
    }
}

function clearRankingView() {
    selectedRoom = null;
    currentRankingData = null;
    
    // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.room-button').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    const elements = {
        info: document.getElementById('selected-room-info'),
        initial: document.getElementById('admin-ranking-initial'),
        container: document.getElementById('admin-ranking-table-container'),
        error: document.getElementById('admin-ranking-error'),
        actions: document.getElementById('admin-ranking-actions')
    };
    
    if (elements.info) elements.info.style.display = 'none';
    if (elements.initial) elements.initial.style.display = 'block';
    if (elements.container) elements.container.style.display = 'none';
    if (elements.error) elements.error.style.display = 'none';
    if (elements.actions) elements.actions.style.display = 'none';
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportRankingData() {
    if (!currentRankingData || !selectedRoom) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    console.log('ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹');
    
    try {
        // CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const csvHeader = 'é †ä½,åå‰,æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³,å›ç­”æ•°,æ­£è§£æ•°,æ­£ç­”ç‡,ãƒã‚¹ã‚¿ãƒ¼æ•°,ç·åˆã‚¹ã‚³ã‚¢,ç¶²ç¾…ç‡\n';
        const csvRows = currentRankingData.map((user, index) => {
            const lastLogin = user.last_login ? 
                new Date(user.last_login).toLocaleString('ja-JP') : 
                'ãªã—';
            
            return [
                index + 1,
                user.username || 'N/A',
                lastLogin,
                user.total_attempts || 0,
                user.total_correct || 0,
                (user.accuracy_rate || 0).toFixed(1) + '%',
                user.mastered_count || 0,
                (user.balance_score || 0).toFixed(1),
                (user.coverage_rate || 0).toFixed(1) + '%'
            ].join(',');
        });
        
        const csvData = csvHeader + csvRows.join('\n');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ranking_room_${selectedRoom}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('âœ… CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    } catch (error) {
        console.error('âŒ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
}

// éƒ¨å±‹æ¯”è¼ƒæ©Ÿèƒ½ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function showRoomsComparison() {
    alert('éƒ¨å±‹æ¯”è¼ƒæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™');
}

function showDetailedUserInfo() {
    alert('è©³ç´°åˆ†ææ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™');
}

// ========================================
// 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†æ©Ÿèƒ½
// ========================================

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
function initializeUserTableSort() {
    const table = document.getElementById('userTable');
    const tbody = document.getElementById('userTableBody');
    
    if (!table || !tbody) return;
    
    // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const column = this.dataset.column;
            const isAscending = this.classList.contains('fa-sort-up');
            
            // å…¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.sort-icon').forEach(i => {
                i.className = 'fas fa-sort sort-icon';
            });
            
            // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            this.className = `fas fa-sort-${isAscending ? 'down' : 'up'} sort-icon`;
            
            sortUserTable(column, !isAscending);
        });
    });
}

function sortUserTable(column, ascending) {
    const tbody = document.getElementById('userTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
            case 'room':
                aVal = a.cells[1].textContent.trim();
                bVal = b.cells[1].textContent.trim();
                break;
            case 'name':
                aVal = a.cells[3].textContent.trim();
                bVal = b.cells[3].textContent.trim();
                break;
            case 'login':
                aVal = a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim();
                // æ—¥ä»˜ã®å ´åˆã¯ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                if (aVal !== 'æœªãƒ­ã‚°ã‚¤ãƒ³') aVal = new Date(aVal);
                if (bVal !== 'æœªãƒ­ã‚°ã‚¤ãƒ³') bVal = new Date(bVal);
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
function initializeUserFiltering() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    
    if (roomSelect) {
        roomSelect.addEventListener('change', filterUsers);
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterUsers);
    }
}

function filterUsers() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    const tbody = document.getElementById('userTableBody');
    
    if (!tbody) return;
    
    const selectedRoom = roomSelect ? roomSelect.value : '';
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const roomMatch = !selectedRoom || row.dataset.room === selectedRoom;
        const searchMatch = !searchTerm || 
            row.dataset.name.includes(searchTerm) || 
            row.dataset.student.includes(searchTerm);
        
        row.style.display = (roomMatch && searchMatch) ? '' : 'none';
    });
}

// ========================================
// 6. çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½
// ========================================

// çµ±è¨ˆç®¡ç†é–¢æ•°
function checkUserStats() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ç¢ºèªä¸­...';
    
    fetch('/admin/check_user_stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayStatsCheckResult(data);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('çµ±è¨ˆç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ çµ±è¨ˆç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
}

// çµ±è¨ˆç¢ºèªçµæœã®è¡¨ç¤º
function displayStatsCheckResult(data) {
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    if (!resultDiv || !contentDiv) return;
    
    const summary = data.summary;
    const roomStats = data.room_stats;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${summary.total_users}äºº</li>
                    <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${summary.total_stats}å€‹</li>
                    <li>çµ±è¨ˆãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${summary.users_without_stats}äºº</li>
                    <li>å¤ã„çµ±è¨ˆ: ${summary.outdated_stats}å€‹</li>
                    <li>ã‚«ãƒãƒ¼ç‡: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ? 
                    '<p class="text-success">âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™ã€‚ä¿®å¾©ã¯ä¸è¦ã§ã™ã€‚</p>' :
                    `<p class="text-warning">âš ï¸ ${summary.users_without_stats + summary.outdated_stats}ä»¶ã®çµ±è¨ˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
                }
            </div>
        </div>
    `;
    
    if (roomStats.length > 0) {
        html += '<h6>ğŸ  éƒ¨å±‹åˆ¥çµ±è¨ˆ</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>éƒ¨å±‹ç•ªå·</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th><th>å¹³å‡ã‚¹ã‚³ã‚¢</th><th>æœ€é«˜ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>';
        
        roomStats.forEach(room => {
            html += `<tr>
                <td><span class="badge bg-secondary">${room.room_number}</span></td>
                <td>${room.user_count}äºº</td>
                <td>${room.avg_score}</td>
                <td class="text-success"><strong>${room.max_score}</strong></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©
function repairUserStats() {
    if (confirm('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»çµ±è¨ˆãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ–°è¦ä½œæˆ\nãƒ»å¤ã„çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ä¿®å¾©ä¸­...';
        
        fetch('/admin/repair_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                // ä¿®å¾©å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// å…¨çµ±è¨ˆã®å¼·åˆ¶å†åˆæœŸåŒ–
function initializeAllStats() {
    if (confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™\nâš ï¸ å…¨ã¦ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒå†è¨ˆç®—ã•ã‚Œã¾ã™\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'åˆæœŸåŒ–ä¸­...';
        
        fetch('/admin/initialize_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                // åˆæœŸåŒ–å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†é–¢æ•°
function cleanupOrphanedTokens() {
    if (confirm('å­¤ç«‹ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¯¾è±¡ã§ã™ã€‚')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...';
        
        fetch('/admin/cleanup_orphaned_tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

function checkDatabaseStatus() {
    fetch('/admin/check_database_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const status = data.database_status;
                let message = 'ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªçµæœ:\n\n';
                
                for (const [tableName, tableInfo] of Object.entries(status.tables)) {
                    message += `ğŸ“‹ ${tableName}: ${tableInfo.exists ? 'å­˜åœ¨' : 'ä¸åœ¨'}\n`;
                    if (tableInfo.missing_columns.length > 0) {
                        message += `   ä¸è¶³ã‚«ãƒ©ãƒ : ${tableInfo.missing_columns.join(', ')}\n`;
                    }
                }
                
                if (status.needs_migration) {
                    message += '\nâš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
                } else {
                    message += '\nâœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ­£å¸¸ã§ã™ã€‚';
                }
                
                alert(message);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
}

// ç„¡åŠ¹å±¥æ­´åˆ†æãƒ»å‰Šé™¤é–¢æ•°
function analyzeInvalidHistoryDetailed() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'è©³ç´°åˆ†æä¸­...';
    
    fetch('/admin/analyze_invalid_history_detailed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displayInvalidHistoryAnalysisDetailed(data.analysis);
        } else {
            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// è©³ç´°åˆ†æçµæœã®è¡¨ç¤º
function displayInvalidHistoryAnalysisDetailed(analysis) {
    const resultDiv = document.getElementById('invalidHistoryAnalysisResult');
    const contentDiv = document.getElementById('invalidAnalysisContent');
    
    if (!resultDiv || !contentDiv) return;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å‰Šé™¤å¯¾è±¡çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${analysis.total_users}äºº</li>
                    <li>ç„¡åŠ¹å±¥æ­´ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${analysis.users_with_invalid}äºº</li>
                    <li>ç„¡åŠ¹ãªå­¦ç¿’å±¥æ­´: ${analysis.total_invalid_entries}å€‹</li>
                    <li>ç„¡åŠ¹ãªè‹¦æ‰‹å•é¡Œ: ${analysis.total_invalid_incorrect}å€‹</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${analysis.users_with_invalid === 0 ? 
                    '<p class="text-success">âœ… ç„¡åŠ¹ãªå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å‰Šé™¤ã¯ä¸è¦ã§ã™ã€‚</p>' :
                    `<p class="text-warning">âš ï¸ ${analysis.total_invalid_entries}å€‹ã®ç„¡åŠ¹å±¥æ­´ãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
                }
            </div>
        </div>
    `;
    
    if (analysis.user_details && analysis.user_details.length > 0) {
        html += '<h6>ğŸ‘¥ å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>éƒ¨å±‹</th><th>æœ‰åŠ¹å±¥æ­´</th><th>ç„¡åŠ¹å±¥æ­´</th><th>ç„¡åŠ¹è‹¦æ‰‹å•é¡Œ</th><th>ã‚µãƒ³ãƒ—ãƒ«ç„¡åŠ¹ID</th></tr></thead><tbody>';
        
        analysis.user_details.forEach(user => {
            const sampleId = user.invalid_history_ids && user.invalid_history_ids.length > 0 ? 
                user.invalid_history_ids[0].substring(0, 40) + '...' : 
                (user.invalid_incorrect_ids && user.invalid_incorrect_ids.length > 0 ? user.invalid_incorrect_ids[0].substring(0, 40) + '...' : '-');
            
            html += `<tr>
                <td>${user.username}</td>
                <td>${user.room_number}</td>
                <td class="text-success">${user.valid_history}</td>
                <td class="text-warning">${user.invalid_history}</td>
                <td class="text-warning">${user.invalid_incorrect}</td>
                <td><small class="text-muted">${sampleId}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

function cleanInvalidHistory() {
    if (confirm('ç„¡åŠ¹ãªå­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™\nâš ï¸ æœ‰åŠ¹ãªå±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™\n\nå‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'å‰Šé™¤ä¸­...';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦é€ä¿¡
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/clean_invalid_history';
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°
function debugSpecificUser() {
    const username = document.getElementById('debugUsername').value.trim();
    if (!username) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    fetch(`/admin/debug_user/${encodeURIComponent(username)}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displayUserDebugResult(data.debug_data);
        } else {
            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒ‡ãƒãƒƒã‚°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒãƒƒã‚°çµæœã®è¡¨ç¤º
function displayUserDebugResult(debugData) {
    const resultDiv = document.getElementById('userDebugResult');
    const contentDiv = document.getElementById('debugContent');
    
    if (!resultDiv || !contentDiv) return;
    
    let html = `
        <h6>ğŸ‘¤ ${debugData.user} ã®ãƒ‡ãƒãƒƒã‚°çµæœ</h6>
        <div class="row">
            <div class="col-md-6">
                <ul>
                    <li>éƒ¨å±‹ç•ªå·: ${debugData.room_number}</li>
                    <li>ç·å±¥æ­´æ•°: ${debugData.total_history}</li>
                    <li>ä¸€è‡´ã™ã‚‹å±¥æ­´: ${debugData.matched_history}</li>
                    <li>ä¸ä¸€è‡´ãªå±¥æ­´: ${debugData.unmatched_history}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul>
                    <li>æœ‰åŠ¹IDæ•°: ${debugData.valid_ids_count}</li>
                    <li>ä¸ä¸€è‡´è‹¦æ‰‹å•é¡Œ: ${debugData.unmatched_incorrect ? debugData.unmatched_incorrect.length : 0}</li>
                </ul>
            </div>
        </div>
    `;
    
    if (debugData.unmatched_details && debugData.unmatched_details.length > 0) {
        html += '<h6>âŒ ä¸ä¸€è‡´ãªå±¥æ­´ã®è©³ç´°</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>å•é¡ŒID</th><th>æ­£è§£å›æ•°</th><th>ä¸æ­£è§£å›æ•°</th><th>æœ€çµ‚å›ç­”æ—¥</th></tr></thead><tbody>';
        
        debugData.unmatched_details.forEach(detail => {
            html += `<tr>
                <td><small>${detail.id}</small></td>
                <td>${detail.correct_attempts}</td>
                <td>${detail.incorrect_attempts}</td>
                <td><small>${detail.last_answered}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¼·åˆ¶å‰Šé™¤
function forceCleanSpecificUser() {
    const username = document.getElementById('debugUsername').value.trim();
    if (!username) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã®ä¸ä¸€è‡´å±¥æ­´ã‚’å¼·åˆ¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç„¡åŠ¹ãªIDã®å±¥æ­´ã®ã¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™`)) {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦é€ä¿¡
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/force_clean_user/${encodeURIComponent(username)}`;
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ========================================
// 7. DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“‹ ç®¡ç†è€…ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰');
    
    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    setTimeout(() => {
        console.log('ğŸ”„ åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        loadCsvFilesList();
        loadRoomSettings();
    }, 500);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ©Ÿèƒ½åˆæœŸåŒ–
    initializeUserTableSort();
    initializeUserFiltering();

    // éƒ¨å±‹è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;
            const maxUnitInput = document.getElementById('maxUnit_' + roomNumber);
            const csvFileSelect = document.getElementById('csvFile_' + roomNumber);
            
            console.log(`ğŸ”§ éƒ¨å±‹è¨­å®šä¿å­˜é–‹å§‹: ${roomNumber}`);
            
            if (!maxUnitInput || !csvFileSelect) {
                alert('è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                console.error('âŒ è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
                    maxUnit: !!maxUnitInput,
                    csvFile: !!csvFileSelect
                });
                return;
            }
            
            const maxUnit = maxUnitInput.value.trim();
            const csvFilename = csvFileSelect.value;
            
            console.log(`ğŸ“ ä¿å­˜ã™ã‚‹è¨­å®š:`, {
                roomNumber: roomNumber,
                maxUnit: maxUnit,
                csvFilename: csvFilename
            });

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            this.disabled = true;
            this.textContent = 'ä¿å­˜ä¸­...';

            // å˜å…ƒè¨­å®šã€CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åŒæ™‚ã«æ›´æ–°
            Promise.all([
                fetch('/admin/update_room_unit_setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        max_unit: maxUnit
                    })
                }),
                fetch('/admin/update_room_csv_setting', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        csv_filename: csvFilename
                    })
                })
            ])
            .then(responses => {
                console.log('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', responses.map(r => r.status));
                return Promise.all(responses.map(r => r.json()));
            })
            .then(results => {
                const unitResult = results[0];
                const csvResult = results[1];
                
                console.log('ğŸ“Š ä¿å­˜çµæœ:', { unitResult, csvResult });
                
                if (unitResult.status === 'success' && csvResult.status === 'success') {
                    alert(`âœ… éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ:\nãƒ»æœ€å¤§å˜å…ƒ: ${maxUnit}\nãƒ»CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFilename}`);
                    
                    loadRoomSettings();
                } else {
                    const errorMsg = (unitResult.message || csvResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                    alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
                    console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', { unitResult, csvResult });
                }
            })
            .catch(error => {
                console.error('âŒ ä¿å­˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                this.disabled = false;
                this.textContent = 'ä¿å­˜';
            });
        });
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            const roomNumber = this.dataset.room;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ "${username}" (éƒ¨å±‹: ${roomNumber}, ID: ${userId}) ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/delete_user/' + userId;

                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // éƒ¨å±‹è¨­å®šå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;

            if (confirm('éƒ¨å±‹ "' + roomNumber + '" ã®è¨­å®šã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®éƒ¨å±‹ã«å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/delete_room_setting/' + encodeURIComponent(roomNumber);

                document.body.appendChild(form);
                form.submit();
            }
        });
    });
    
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–ï¼ˆå°‘ã—é…å»¶ï¼‰
    setTimeout(() => {
        console.log('ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½åˆæœŸåŒ–');
        loadRoomList();
    }, 1000);
});

console.log('ğŸ‰ admin.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰');
</script>

<style>
.admin-panel {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #eee;
}

.admin-panel h4 {
    margin-top: 0;
    margin-bottom: 10px;
}

.admin-panel p {
    margin-bottom: 15px;
    line-height: 1.5;
}

.download-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
.scrollable-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.scrollable-table-container .table {
    margin-bottom: 0;
}

/* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #343a40 !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ¶å¾¡è¦ç´  */
.table-controls {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.table-controls label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

/* ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ */
.sort-icon {
    margin-left: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.sort-icon:hover {
    opacity: 1;
}

/* ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
.badge {
    font-size: 0.8em;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œã®ãƒ›ãƒãƒ¼åŠ¹æœ */
#userTableBody tr:hover {
    background-color: #f8f9fa;
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
.delete-user-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* ç®¡ç†è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.room-selector-container {
    margin-bottom: 25px;
}

.room-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.room-button {
    padding: 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6;
}

.room-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.room-button.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.room-button small {
    color: inherit;
    opacity: 0.8;
}

.ranking-summary {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.summary-card {
    text-align: center;
    padding: 15px;
    background-color: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.summary-card h5 {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 10px;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    display: block;
}

.admin-ranking-actions {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    text-align: center;
}

.admin-ranking-actions button {
    margin: 0 5px;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.table-hover tbody tr:hover {
    background-color: rgba(0,0,0,0.05);
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.85rem;
}

/* ã‚¢ã‚¤ã‚³ãƒ³ */
.fas.fa-crown {
    margin-left: 5px;
}

.fas.fa-medal {
    margin-left: 5px;
}

/* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³åŠ¹æœ */
#invalidHistoryAnalysisResult,
#userDebugResult,
#statsCheckResult {
    margin-top: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
.table-responsive {
    margin-top: 10px;
}

.text-success {
    color: #28a745 !important;
}

.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .download-buttons {
        flex-direction: column;
    }
    
    .download-buttons .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group-vertical .btn {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .scrollable-table-container {
        max-height: 300px;
    }
    
    .table-controls .row {
        margin-bottom: 0;
    }
    
    .table-controls .col-md-6 {
        margin-bottom: 10px;
    }
    
    /* ã‚¹ãƒãƒ›ã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºæ”¹å–„ */
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.3rem;
        white-space: nowrap;
    }
    
    /* éƒ¨å±‹ãƒœã‚¿ãƒ³ */
    .room-buttons-grid {
        grid-template-columns: 1fr;
    }
    
    .ranking-summary .row {
        text-align: center;
    }
    
    .summary-card {
        margin-bottom: 15px;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .admin-ranking-actions {
        text-align: center;
    }
    
    .admin-ranking-actions button {
        margin: 5px 2px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .room-button {
        padding: 10px;
        font-size: 0.9rem;
    }
    
    .summary-value {
        font-size: 1.5rem;
    }
    
    .table {
        font-size: 0.75rem;
    }
}
</style>

{% endblock %}