{% extends "base.html" %}
{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - {{ app_name }}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header d-flex justify-content-between align-items-center mb-4">
        <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>
        <a href="{{ url_for('admin_ranking_page') }}" class="btn btn-success">
            <i class="fas fa-trophy"></i> å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="expandAllSections()">
            <i class="fas fa-expand-arrows-alt"></i> å…¨ã¦å±•é–‹
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllSections()">
            <i class="fas fa-compress-arrows-alt"></i> å…¨ã¦æŠ˜ã‚ŠãŸãŸã¿
        </button>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-app-info" aria-expanded="false">
            <h3><i class="fas fa-mobile-alt"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-app-info">
            <div class="section-content">
                <p>ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºåã€æ›´æ–°å†…å®¹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãªã©ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
                
                <div class="admin-panel" style="background-color: #e8f4fd; border-left: 5px solid #3498db;">
                    <h4>ç¾åœ¨ã®ã‚¢ãƒ—ãƒªæƒ…å ±</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ã‚¢ãƒ—ãƒªå:</strong> {{ app_info.app_name if app_info else 'ä¸–ç•Œå²å˜èªå¸³' }}</p>
                            <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> {{ app_info.version if app_info else '1.0.0' }}</p>
                            <p><strong>æœ€çµ‚æ›´æ–°æ—¥:</strong> {{ app_info.last_updated_date if app_info else '2025å¹´6æœˆ15æ—¥' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>æ›´æ–°å†…å®¹:</strong></p>
                            <div style="background-color: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em;">
                                {{ app_info.update_content if app_info else 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚' }}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <a href="{{ url_for('admin_app_info') }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> ã‚¢ãƒ—ãƒªæƒ…å ±ã‚’ç·¨é›†
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-external-link-alt"></i> å®Ÿéš›ã®è¡¨ç¤ºã‚’ç¢ºèª
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-management" aria-expanded="true">
            <h3><i class="fas fa-users"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-management">
            <div class="section-content">
                <p>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ users|length }}äºº</p>
                
                <h4>CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
                <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                    <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
                    <ul>
                        <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: éƒ¨å±‹ç•ªå·,å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,å‡ºå¸­ç•ªå·,å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</li>
                        <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
                        <li>ä¾‹: 101,password123,001,student001,æˆå¯Œå…µåº«èŒ‚å®‰</li>
                        <li>åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®ç™»éŒ²ã‚‚å¯èƒ½ã§ã™ï¼ˆåŒä¸€äººç‰©ãŒè¤‡æ•°éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆï¼‰</li>
                    </ul>
                    <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-download"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>

                <form action="{{ url_for('admin_upload_users') }}" method="POST" enctype="multipart/form-data" class="upload-form">
                    <div class="input-group">
                        <label for="users_csv_file">ãƒ¦ãƒ¼ã‚¶ãƒ¼CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                        <input type="file" id="users_csv_file" name="file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> CSVä¸€æ‹¬ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
                    </button>
                </form>
                
                <h4>å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
                <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
                    <div class="input-group">
                        <label for="new_room_number">éƒ¨å±‹ç•ªå·:</label>
                        <input type="text" id="new_room_number" name="room_number" required>
                    </div>
                    <div class="input-group">
                        <label for="new_room_password">å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="new_room_password" name="room_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_student_id">å‡ºå¸­ç•ªå·:</label>
                        <input type="text" id="new_student_id" name="student_id" required>
                    </div>
                    <div class="input-group">
                        <label for="new_individual_password">å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                        <input type="password" id="new_individual_password" name="individual_password" required>
                    </div>
                    <div class="input-group">
                        <label for="new_username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:</label>
                        <input type="text" id="new_username" name="username" required>
                        <small class="form-text text-muted">â€»åŒä¸€äººç‰©ãŒè¤‡æ•°ã®éƒ¨å±‹ã«å‚åŠ ã™ã‚‹å ´åˆã€åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã§ã‚‚ç™»éŒ²å¯èƒ½ã§ã™</small>
                    </div>
                    <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                </form>
                
                <h4>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
                <!-- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
                <div class="table-controls mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="roomSortSelect">éƒ¨å±‹ã§ã‚½ãƒ¼ãƒˆ:</label>
                            <select id="roomSortSelect" class="form-control form-control-sm">
                                <option value="">å…¨ã¦ã®éƒ¨å±‹</option>
                                {% set room_numbers = [] %}
                                {% for user in users %}
                                    {% if user.room_number not in room_numbers and user.room_number != 'ADMIN' %}
                                        {% set _ = room_numbers.append(user.room_number) %}
                                    {% endif %}
                                {% endfor %}
                                {% for room_num in room_numbers|sort %}
                                    <option value="{{ room_num }}">éƒ¨å±‹ {{ room_num }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="userSearchInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢:</label>
                            <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="åå‰ã€å‡ºå¸­ç•ªå·ã§æ¤œç´¢...">
                        </div>
                    </div>
                </div>

                <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div class="scrollable-table-container">
                    <div class="table-responsive">
                        <table class="table table-striped user-list-table" id="userTable">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th>ID</th>
                                    <th>éƒ¨å±‹ <i class="fas fa-sort sort-icon" data-column="room" style="cursor: pointer;"></i></th>
                                    <th>å‡ºå¸­ç•ªå·</th>
                                    <th>ç¾åœ¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå <i class="fas fa-sort sort-icon" data-column="name" style="cursor: pointer;"></i></th>
                                    <th>æœ€åˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</th>
                                    <th>å¤‰æ›´æ—¥æ™‚</th>
                                    <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³ <i class="fas fa-sort sort-icon" data-column="login" style="cursor: pointer;"></i></th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                {% for user in users %}
                                {% if user.username != 'admin' %}
                                <tr data-room="{{ user.room_number }}" data-name="{{ user.username|lower }}" data-student="{{ user.student_id|lower }}">
                                    <td>{{ user.id }}</td>
                                    <td><span class="badge bg-secondary">{{ user.room_number }}</span></td>
                                    <td>{{ user.student_id }}</td>
                                    <td>
                                        {{ user.username }}
                                        {% if user.original_username and user.original_username != user.username %}
                                        <span class="badge bg-warning text-dark ms-1">
                                            <i class="fas fa-edit"></i> å¤‰æ›´æ¸ˆã¿
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.original_username and user.original_username != user.username %}
                                        <span class="text-muted">{{ user.original_username }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.username_changed_at | to_jst if user.username_changed_at else '-' }}</td>
                                    <td>{{ user.last_login | to_jst if user.last_login else 'æœªãƒ­ã‚°ã‚¤ãƒ³' }}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-user-btn"
                                                data-user-id="{{ user.id }}"
                                                data-username="{{ user.username }}"
                                                data-room="{{ user.room_number }}">å‰Šé™¤</button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-csv-management" aria-expanded="false">
            <h3><i class="fas fa-folder-open"></i> éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-csv-management">
            <div class="section-content">
                <p>å„éƒ¨å±‹ã§ä½¿ç”¨ã™ã‚‹å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®words.csvãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                <div class="csv-template-section" style="margin-bottom: 25px; padding: 15px; background-color: #f0f8ff; border: 1px solid #87ceeb; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #17a2b8; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i> CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </h4>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        æ­£ã—ã„å½¢å¼ã®å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ãã§ã™ãã«ç·¨é›†ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
                    </p>
                    <a href="{{ url_for('download_csv_template') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-file-csv"></i> å˜èªå¸³CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                    <small class="text-muted d-block mt-2">
                        â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šchapter, number, category, question, answer, enabled
                    </small>
                </div>        
                <form action="{{ url_for('admin_upload_room_csv') }}" method="POST" enctype="multipart/form-data" class="upload-form">
                    <div class="input-group">
                        <label for="room_csv_file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                        <input type="file" id="room_csv_file" name="file" accept=".csv" required>
                        <small class="form-text text-muted">ï¼Šãƒ•ã‚¡ã‚¤ãƒ«åã¯åŠè§’è‹±æ•°å­—ï¼Š</small>
                    </div>
                    <button type="submit" class="btn btn-success">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </form>

                <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h4>
                <div id="csv-files-list">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">
                            <i class="fas fa-sync-alt"></i> ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                        </button>
                    </div>
                    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
                    <div class="scrollable-table-container">
                        <div id="csv-files-container" style="margin-top: 15px;">
                            <p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-room-settings" aria-expanded="false">
            <h3><i class="fas fa-home"></i> éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-room-settings">
            <div class="section-content">
                <p>å„éƒ¨å±‹ã®å­¦ç¿’ç¯„å›²ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

                <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªéƒ¨å±‹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="scrollable-table-container">
                    <div class="table-responsive">
                        <table class="table table-striped room-setting-table">
                            <thead class="table-dark sticky-header">
                                <tr>
                                    <th>éƒ¨å±‹ç•ªå·</th>
                                    <th>æœ‰åŠ¹å˜å…ƒè¨­å®š</th>
                                    <th>ä½¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set unique_room_numbers = [] %}
                                {% for user in users %}
                                    {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                                        {% set _ = unique_room_numbers.append(user.room_number) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for setting in room_max_unit_settings.keys() %}
                                    {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                                        {% set _ = unique_room_numbers.append(setting) %}
                                    {% endif %}
                                {% endfor %}

                                {% for room_num in unique_room_numbers|sort %}
                                <tr>
                                    <td><strong>{{ room_num }}</strong></td>
                                    <td>
                                        <div class="unit-setting-container" id="unitContainer_{{ room_num }}">
                                            <div class="unit-controls mb-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadAvailableUnits('{{ room_num }}')">
                                                    <i class="fas fa-sync"></i> å˜å…ƒä¸€è¦§èª­ã¿è¾¼ã¿
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-check-double"></i> å…¨ã¦é¸æŠ
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllUnits('{{ room_num }}')">
                                                    <i class="fas fa-times"></i> å…¨ã¦è§£é™¤
                                                </button>
                                            </div>
                                            <div class="unit-checkboxes" id="unitCheckboxes_{{ room_num }}">
                                                <p class="text-muted">ã€Œå˜å…ƒä¸€è¦§èª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åˆ©ç”¨å¯èƒ½ãªå˜å…ƒã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
                                            </div>
                                            <div class="selected-units-display mt-2">
                                                <small class="text-info">
                                                    é¸æŠä¸­: <span id="selectedCount_{{ room_num }}">0</span>å€‹ã®å˜å…ƒ
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <select id="csvFile_{{ room_num }}" 
                                                class="form-control csv-setting-select" 
                                                data-room-number="{{ room_num }}">
                                            <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv') == 'words.csv' %}selected{% endif %}>
                                                words.csv (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                                            </option>
                                            <!-- å‹•çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                                        </select>
                                        <small class="form-text text-muted">
                                            ç¾åœ¨ã®è¨­å®š: <code id="current_csv_{{ room_num }}">{{ room_csv_settings.get(room_num, 'words.csv') }}</code>
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-primary btn-sm save-room-setting-btn" 
                                                    data-room-number="{{ room_num }}">ä¿å­˜</button>
                                            <button class="btn btn-danger btn-sm delete-room-setting-btn" 
                                                    data-room-number="{{ room_num }}">å‰Šé™¤</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-user-stats" aria-expanded="false">
            <h3><i class="fas fa-chart-bar"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-user-stats">
            <div class="section-content">
                <p>äº‹å‰è¨ˆç®—ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®çŠ¶æ…‹ç¢ºèªãƒ»ä¿®å¾©ã‚’è¡Œã„ã¾ã™ã€‚</p>

                <!-- çµ±è¨ˆçŠ¶æ…‹ç¢ºèª -->
                <div class="admin-panel" style="background-color: #e8f5e8; border-left: 5px solid #28a745; margin-bottom: 20px;">
                    <h4>ğŸ“ˆ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ç¢ºèª</h4>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®æ•´åˆæ€§ã¨æœ€æ–°æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚<br>
                    <strong>æ¨å¥¨ï¼š</strong>æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ãŸå¾Œã‚„ã€ãƒ‡ãƒ¼ã‚¿ã«ä¸æ•´åˆãŒã‚ã‚‹å ´åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="checkUserStats()">
                            <i class="fas fa-chart-line"></i> ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ã‚’ç¢ºèª
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="repairUserStats()" style="margin-left: 10px;">
                            <i class="fas fa-tools"></i> ğŸ”§ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="initializeAllStats()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> ğŸ”„ å…¨çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–
                        </button>
                    </div>
                </div>

                <!-- çµ±è¨ˆç¢ºèªçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="statsCheckResult" style="margin-top: 15px; display: none;">
                    <h5>ğŸ“Š çµ±è¨ˆçŠ¶æ…‹ç¢ºèªçµæœ</h5>
                    <div id="statsCheckContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <!-- ç¢ºèªçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="admin-section">
        <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-database-management" aria-expanded="false">
            <h3><i class="fas fa-database"></i> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç† <i class="fas fa-chevron-down toggle-icon"></i></h3>
        </div>
        <div class="collapse" id="section-database-management">
            <div class="section-content">
                <p>å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèªã¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>

                <!-- å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— -->
                <div class="admin-panel" style="background-color: #fff3cd; border-left: 5px solid #ffc107; margin-bottom: 20px;">
                    <h4>ğŸ§¹ å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h4>
                    <p>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
                    <strong>æ¨å¥¨ï¼š</strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-warning" onclick="cleanupOrphanedTokens()">
                            <i class="fas fa-broom"></i> ğŸ§¹ å­¤ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
                        </button>
                        
                        <button type="button" class="btn btn-info" onclick="checkDatabaseStatus()" style="margin-left: 10px;">
                            <i class="fas fa-search"></i> ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
                        </button>
                    </div>
                </div>

                <div class="admin-panel" style="background-color: #fff8e1; border-left: 5px solid #ff9800; margin-bottom: 20px;">
                    <h4>ğŸ—‘ï¸ IDä¸ä¸€è‡´å±¥æ­´ã®å‰Šé™¤</h4>
                    <p>ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å¤ã„å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
                    <strong>ç”¨é€”ï¼š</strong>å•é¡Œæ–‡ä¿®æ­£å¾Œã«å¤ã„IDã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã«ä½¿ç”¨ã€‚<br>
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong>å‰Šé™¤ã•ã‚ŒãŸå±¥æ­´ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</p>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-info" onclick="analyzeInvalidHistoryDetailed()">
                            <i class="fas fa-search"></i> ğŸ“Š è©³ç´°åˆ†æï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
                        </button>
                        
                        <button type="button" class="btn btn-warning" onclick="cleanInvalidHistory()" style="margin-left: 10px;">
                            <i class="fas fa-trash-alt"></i> ğŸ—‘ï¸ ç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h5>ğŸ” ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" id="debugUsername" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
                                    <button class="btn btn-outline-secondary" onclick="debugSpecificUser()">
                                        <i class="fas fa-bug"></i> ãƒ‡ãƒãƒƒã‚°
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger btn-sm" onclick="forceCleanSpecificUser()">
                                    <i class="fas fa-exclamation-triangle"></i> å¼·åˆ¶å‰Šé™¤
                                </button>
                                <small class="text-muted d-block">â€»ä¸Šè¨˜ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›å¾Œã«ä½¿ç”¨</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç„¡åŠ¹å±¥æ­´åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="invalidHistoryAnalysisResult" style="margin-top: 15px; display: none;">
                        <h5>ğŸ“Š ç„¡åŠ¹å±¥æ­´åˆ†æçµæœ</h5>
                        <div id="invalidAnalysisContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                    
                    <!-- ãƒ‡ãƒãƒƒã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="userDebugResult" style="margin-top: 15px; display: none;">
                        <h5>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒãƒƒã‚°çµæœ</h5>
                        <div id="debugContent" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <!-- ãƒ‡ãƒãƒƒã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>

                <!-- å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆå¾“æ¥æ©Ÿèƒ½ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰ -->
                <div class="admin-panel" style="background-color: #ffebee; border-left: 5px solid #f44336; margin-top: 20px;">
                    <h4>âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰</h4>
                    <p>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚’å¼·åˆ¶çš„ã«æ–°ã—ã„IDå½¢å¼ã«çµ±ä¸€ã—ã¾ã™ã€‚<br>
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong>ã“ã®æ“ä½œã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã«å½±éŸ¿ã—ã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚<br>
                    <strong>æ¨å¥¨ï¼š</strong>é€šå¸¸ã¯ä¸Šè¨˜ã®ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div style="margin-top: 15px;">
                        <form action="{{ url_for('admin_fix_all_data_legacy') }}" method="POST" style="display: inline;" 
                            onsubmit="return confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ãŒæ–°ã—ã„å½¢å¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚\nâš ï¸ é€šå¸¸ã¯ã€ŒIDä¸ä¸€è‡´å•é¡Œã®ã¿ä¿®æ­£ã€ã§ååˆ†ã§ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-exclamation-triangle"></i> âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶ä¿®æ­£ï¼ˆéæ¨å¥¨ï¼‰
                            </button>
                            </form>
                        
                        <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info" target="_blank" style="margin-left: 10px;">
                            <i class="fas fa-chart-line"></i> ğŸ“Š ä¿®æ­£å‰ã®çŠ¶æ…‹ç¢ºèª
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
<form id="resetForm" action="{{ url_for('admin_app_info_reset') }}" method="POST" style="display: none;">
</form>

<script>
// ========================================
// 1. æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
// ========================================

// å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹
function expandAllSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(section => {
        const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
        bsCollapse.show();
    });
    updateToggleIcons();
}

// å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚ŠãŸãŸã¿
function collapseAllSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(section => {
        const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
        bsCollapse.hide();
    });
    updateToggleIcons();
}

// ãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
function updateToggleIcons() {
    document.querySelectorAll('.admin-section').forEach(section => {
        const collapseElement = section.querySelector('.collapse');
        const toggleIcon = section.querySelector('.toggle-icon');
        
        if (collapseElement && toggleIcon) {
            const isShown = collapseElement.classList.contains('show');
            toggleIcon.className = isShown ? 'fas fa-chevron-up toggle-icon' : 'fas fa-chevron-down toggle-icon';
        }
    });
}

// æŠ˜ã‚ŠãŸãŸã¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
function initializeCollapseSections() {
    document.querySelectorAll('.admin-section .collapse').forEach(collapseElement => {
        collapseElement.addEventListener('shown.bs.collapse', updateToggleIcons);
        collapseElement.addEventListener('hidden.bs.collapse', updateToggleIcons);
    });
}

// ========================================
// 2. æ—¢å­˜ã®ç®¡ç†æ©Ÿèƒ½ï¼ˆå…ƒã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ç§»æ¤ï¼‰
// ========================================

console.log('ğŸ”§ admin.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');

// éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹é–¢æ•°
function loadRoomSettings() {
    console.log('ğŸ”„ éƒ¨å±‹è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
    
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const roomNumber = select.dataset.roomNumber;
        if (!roomNumber) return;
        
        fetch('/admin/get_room_setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_number: roomNumber })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const csvFilename = data.csv_filename || 'words.csv';
                console.log(`ğŸ“‹ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿: ${csvFilename}`);
                
                select.value = csvFilename;
                
                const optionExists = Array.from(select.options).some(option => option.value === csvFilename);
                if (!optionExists && csvFilename !== 'words.csv') {
                    const newOption = document.createElement('option');
                    newOption.value = csvFilename;
                    newOption.textContent = csvFilename;
                    select.appendChild(newOption);
                    select.value = csvFilename;
                    console.log(`â• æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ : ${csvFilename}`);
                }
            }
        })
        .catch(error => {
            console.error(`âŒ éƒ¨å±‹${roomNumber}ã®è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
        });
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadCsvFilesList() {
    console.log('ğŸ” CSV ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹...');
    
    const container = document.getElementById('csv-files-container');
    if (container) {
        container.innerHTML = '<p class="text-info">ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
    }
    
    fetch('{{ url_for("admin_list_room_csv_files") }}')
        .then(response => {
            console.log('ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“Š å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.status === 'success') {
                console.log(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—æˆåŠŸ: ${data.files.length}ä»¶`);
                updateCsvFilesDisplay(data.files);
                updateCsvSelectOptions(data.files);
            } else {
                console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—å¤±æ•—:', data.message);
                if (container) {
                    container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '</p>';
                }
            }
        })
        .catch(error => {
            console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            if (container) {
                container.innerHTML = '<p class="text-danger">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        });
}

function addHoursToTimestamp(dateString, hours) {
    const date = new Date(dateString);
    date.setHours(date.getHours() + hours);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvFilesDisplay(files) {
    console.log('ğŸ”„ ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ›´æ–°:', files);
    
    const container = document.getElementById('csv-files-container');
    if (!container) {
        console.error('âŒ csv-files-container ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    if (files.length === 0) {
        console.log('ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
        container.innerHTML = '<p class="text-muted">ğŸ“­ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    console.log(`ğŸ“‹ ${files.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºä¸­...`);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
    html += '<thead class="table-dark"><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>å˜èªæ•°</th><th>ã‚µã‚¤ã‚º</th><th>æ›´æ–°æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead><tbody>';
    
    files.forEach((file, index) => {
        const sizeKB = Math.round(file.size / 1024);
        const wordCountDisplay = file.word_count > 0 ? `${file.word_count}å•` : 'ä¸æ˜';
        
        html += '<tr>' +
                '<td><code>' + file.filename + '</code></td>' +
                '<td><span class="badge bg-primary">' + wordCountDisplay + '</span></td>' +
                '<td>' + sizeKB + ' KB</td>' +
                '<td><small>' + addHoursToTimestamp(file.modified, 9) + '</small></td>' +
                '<td><button class="btn btn-danger btn-sm" onclick="deleteCsvFile(\'' + file.filename + '\')">å‰Šé™¤</button></td>' +
                '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ›´æ–°å®Œäº†');
}

// ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCsvSelectOptions(files) {
    console.log('ğŸ”„ CSVã‚»ãƒ¬ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°:', files);
    
    const selects = document.querySelectorAll('.csv-setting-select');
    console.log(`ğŸ“‹ æ›´æ–°å¯¾è±¡ã‚»ãƒ¬ã‚¯ãƒˆæ•°: ${selects.length}`);
    
    selects.forEach((select, index) => {
        const roomNumber = select.dataset.roomNumber;
        const currentValue = select.value;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        Array.from(select.options).forEach(option => {
            if (option.value !== 'words.csv') {
                option.remove();
            }
        });
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
        if (files && Array.isArray(files)) {
            files.forEach(file => {
                if (file.filename !== 'words.csv') {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = file.filename;
                    select.appendChild(option);
                }
            });
        }
        
        // å…ƒã®å€¤ã‚’å¾©å…ƒ
        if (currentValue && currentValue !== '') {
            select.value = currentValue;
        }
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤é–¢æ•°
function deleteCsvFile(filename) {
    if (confirm('CSVãƒ•ã‚¡ã‚¤ãƒ« "' + filename + '" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹éƒ¨å±‹ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_delete_room_csv", filename="_FILENAME_") }}'.replace('_FILENAME_', filename);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
function initializeUserTableSort() {
    const table = document.getElementById('userTable');
    const tbody = document.getElementById('userTableBody');
    
    if (!table || !tbody) return;
    
    // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const column = this.dataset.column;
            const isAscending = this.classList.contains('fa-sort-up');
            
            // å…¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.sort-icon').forEach(i => {
                i.className = 'fas fa-sort sort-icon';
            });
            
            // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            this.className = `fas fa-sort-${isAscending ? 'down' : 'up'} sort-icon`;
            
            sortUserTable(column, !isAscending);
        });
    });
}

function sortUserTable(column, ascending) {
    const tbody = document.getElementById('userTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(column) {
            case 'room':
                aVal = a.cells[1].textContent.trim();
                bVal = b.cells[1].textContent.trim();
                break;
            case 'name':
                aVal = a.cells[3].textContent.trim();
                bVal = b.cells[3].textContent.trim();
                break;
            case 'login':
                aVal = a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim();
                // æ—¥ä»˜ã®å ´åˆã¯ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                if (aVal !== 'æœªãƒ­ã‚°ã‚¤ãƒ³') aVal = new Date(aVal);
                if (bVal !== 'æœªãƒ­ã‚°ã‚¤ãƒ³') bVal = new Date(bVal);
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
function initializeUserFiltering() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    
    if (roomSelect) {
        roomSelect.addEventListener('change', filterUsers);
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterUsers);
    }
}

function filterUsers() {
    const roomSelect = document.getElementById('roomSortSelect');
    const searchInput = document.getElementById('userSearchInput');
    const tbody = document.getElementById('userTableBody');
    
    if (!tbody) return;
    
    const selectedRoom = roomSelect ? roomSelect.value : '';
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const roomMatch = !selectedRoom || row.dataset.room === selectedRoom;
        const searchMatch = !searchTerm || 
            row.dataset.name.includes(searchTerm) || 
            row.dataset.student.includes(searchTerm);
        
        row.style.display = (roomMatch && searchMatch) ? '' : 'none';
    });
}

// ========================================
// 3. DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“‹ ç®¡ç†è€…ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
    
    // æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½åˆæœŸåŒ–
    initializeCollapseSections();
    updateToggleIcons();
    
    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    setTimeout(() => {
        console.log('ğŸ”„ åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        loadCsvFilesList();
        loadRoomSettings();
    }, 500);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ©Ÿèƒ½åˆæœŸåŒ–
    initializeUserTableSort();
    initializeUserFiltering();

    // éƒ¨å±‹è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;
            const maxUnitInput = document.getElementById('maxUnit_' + roomNumber);
            const csvFileSelect = document.getElementById('csvFile_' + roomNumber);
            
            console.log(`ğŸ”§ éƒ¨å±‹è¨­å®šä¿å­˜é–‹å§‹: ${roomNumber}`);
            
            if (!maxUnitInput || !csvFileSelect) {
                alert('è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                console.error('âŒ è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
                    maxUnit: !!maxUnitInput,
                    csvFile: !!csvFileSelect
                });
                return;
            }
            
            const maxUnit = maxUnitInput.value.trim();
            const csvFilename = csvFileSelect.value;
            
            console.log(`ğŸ“ ä¿å­˜ã™ã‚‹è¨­å®š:`, {
                roomNumber: roomNumber,
                maxUnit: maxUnit,
                csvFilename: csvFilename
            });

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            this.disabled = true;
            this.textContent = 'ä¿å­˜ä¸­...';

            // å˜å…ƒè¨­å®šã€CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åŒæ™‚ã«æ›´æ–°
            Promise.all([
                fetch('{{ url_for("admin_update_room_unit_setting") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        max_unit: maxUnit
                    })
                }),
                fetch('{{ url_for("admin_update_room_csv_setting") }}', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        csv_filename: csvFilename
                    })
                })
            ])
            .then(responses => {
                console.log('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', responses.map(r => r.status));
                return Promise.all(responses.map(r => r.json()));
            })
            .then(results => {
                const unitResult = results[0];
                const csvResult = results[1];
                
                console.log('ğŸ“Š ä¿å­˜çµæœ:', { unitResult, csvResult });
                
                if (unitResult.status === 'success' && csvResult.status === 'success') {
                    alert(`âœ… éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ:\nãƒ»æœ€å¤§å˜å…ƒ: ${maxUnit}\nãƒ»CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFilename}`);
                    
                    loadRoomSettings();
                } else {
                    const errorMsg = (unitResult.message || csvResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                    alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
                    console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', { unitResult, csvResult });
                }
            })
            .catch(error => {
                console.error('âŒ ä¿å­˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                this.disabled = false;
                this.textContent = 'ä¿å­˜';
            });
        });
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            const roomNumber = this.dataset.room;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ "${username}" (éƒ¨å±‹: ${roomNumber}, ID: ${userId}) ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_delete_user", user_id=0) }}'.replace('0', userId);

                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // éƒ¨å±‹è¨­å®šå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;

            if (confirm('éƒ¨å±‹ "' + roomNumber + '" ã®è¨­å®šã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®éƒ¨å±‹ã«å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_delete_room_setting", room_number="_ROOM_NUMBER_") }}'.replace('_ROOM_NUMBER_', roomNumber);

                document.body.appendChild(form);
                form.submit();
            }
        });
    });
});

// ========================================
// 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ç³»ã®é–¢æ•°
// ========================================

// ç„¡åŠ¹å±¥æ­´ã®å‰Šé™¤
function cleanInvalidHistory() {
    if (confirm('ç„¡åŠ¹ãªå­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„å±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™\nâš ï¸ æœ‰åŠ¹ãªå±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™\n\nå‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'å‰Šé™¤ä¸­...';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦é€ä¿¡
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/clean_invalid_history';
        
        document.body.appendChild(form);
        form.submit();
    }
}

function cleanupOrphanedTokens() {
    if (confirm('å­¤ç«‹ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¯¾è±¡ã§ã™ã€‚')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...';
        
        fetch('/admin/cleanup_orphaned_tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

function checkDatabaseStatus() {
    fetch('/admin/check_database_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const status = data.database_status;
                let message = 'ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªçµæœ:\n\n';
                
                for (const [tableName, tableInfo] of Object.entries(status.tables)) {
                    message += `ğŸ“‹ ${tableName}: ${tableInfo.exists ? 'å­˜åœ¨' : 'ä¸åœ¨'}\n`;
                    if (tableInfo.missing_columns.length > 0) {
                        message += `   ä¸è¶³ã‚«ãƒ©ãƒ : ${tableInfo.missing_columns.join(', ')}\n`;
                    }
                }
                
                if (status.needs_migration) {
                    message += '\nâš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
                } else {
                    message += '\nâœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ­£å¸¸ã§ã™ã€‚';
                }
                
                alert(message);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
}

function analyzeInvalidHistoryDetailed() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'è©³ç´°åˆ†æä¸­...';
    
    fetch('/admin/analyze_invalid_history_detailed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displayInvalidHistoryAnalysisDetailed(data.analysis);
        } else {
            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// è©³ç´°åˆ†æçµæœã®è¡¨ç¤º
function displayInvalidHistoryAnalysisDetailed(analysis) {
    const resultDiv = document.getElementById('invalidHistoryAnalysisResult');
    const contentDiv = document.getElementById('invalidAnalysisContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å‰Šé™¤å¯¾è±¡çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${analysis.total_users}äºº</li>
                    <li>ç„¡åŠ¹å±¥æ­´ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${analysis.users_with_invalid}äºº</li>
                    <li>ç„¡åŠ¹ãªå­¦ç¿’å±¥æ­´: ${analysis.total_invalid_entries}å€‹</li>
                    <li>ç„¡åŠ¹ãªè‹¦æ‰‹å•é¡Œ: ${analysis.total_invalid_incorrect}å€‹</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${analysis.users_with_invalid === 0 ? 
                    '<p class="text-success">âœ… ç„¡åŠ¹ãªå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å‰Šé™¤ã¯ä¸è¦ã§ã™ã€‚</p>' :
                    `<p class="text-warning">âš ï¸ ${analysis.total_invalid_entries}å€‹ã®ç„¡åŠ¹å±¥æ­´ãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œç„¡åŠ¹å±¥æ­´ã‚’å‰Šé™¤ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
                }
            </div>
        </div>
    `;
    
    if (analysis.user_details.length > 0) {
        html += '<h6>ğŸ‘¥ å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>éƒ¨å±‹</th><th>æœ‰åŠ¹å±¥æ­´</th><th>ç„¡åŠ¹å±¥æ­´</th><th>ç„¡åŠ¹è‹¦æ‰‹å•é¡Œ</th><th>ã‚µãƒ³ãƒ—ãƒ«ç„¡åŠ¹ID</th></tr></thead><tbody>';
        
        analysis.user_details.forEach(user => {
            const sampleId = user.invalid_history_ids.length > 0 ? 
                user.invalid_history_ids[0].substring(0, 40) + '...' : 
                (user.invalid_incorrect_ids.length > 0 ? user.invalid_incorrect_ids[0].substring(0, 40) + '...' : '-');
            
            html += `<tr>
                <td>${user.username}</td>
                <td>${user.room_number}</td>
                <td class="text-success">${user.valid_history}</td>
                <td class="text-warning">${user.invalid_history}</td>
                <td class="text-warning">${user.invalid_incorrect}</td>
                <td><small class="text-muted">${sampleId}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¼·åˆ¶å‰Šé™¤
function forceCleanSpecificUser() {
    const username = document.getElementById('debugUsername').value.trim();
    if (!username) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${username}ã€ã®ä¸ä¸€è‡´å±¥æ­´ã‚’å¼·åˆ¶å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nâš ï¸ ç„¡åŠ¹ãªIDã®å±¥æ­´ã®ã¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™`)) {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦é€ä¿¡
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/force_clean_user/${encodeURIComponent(username)}`;
        
        document.body.appendChild(form);
        form.submit();
    }
}

function checkUserStats() {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ç¢ºèªä¸­...';
    
    fetch('/admin/check_user_stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayStatsCheckResult(data);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('çµ±è¨ˆç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ çµ±è¨ˆç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
}

// çµ±è¨ˆç¢ºèªçµæœã®è¡¨ç¤º
function displayStatsCheckResult(data) {
    const resultDiv = document.getElementById('statsCheckResult');
    const contentDiv = document.getElementById('statsCheckContent');
    
    const summary = data.summary;
    const roomStats = data.room_stats;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h6>
                <ul>
                    <li>ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${summary.total_users}äºº</li>
                    <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ•°: ${summary.total_stats}å€‹</li>
                    <li>çµ±è¨ˆãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${summary.users_without_stats}äºº</li>
                    <li>å¤ã„çµ±è¨ˆ: ${summary.outdated_stats}å€‹</li>
                    <li>ã‚«ãƒãƒ¼ç‡: ${summary.coverage_rate}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                ${summary.users_without_stats === 0 && summary.outdated_stats === 0 ? 
                    '<p class="text-success">âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™ã€‚ä¿®å¾©ã¯ä¸è¦ã§ã™ã€‚</p>' :
                    `<p class="text-warning">âš ï¸ ${summary.users_without_stats + summary.outdated_stats}ä»¶ã®çµ±è¨ˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>ã€Œçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã€ã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>`
                }
            </div>
        </div>
    `;
    
    if (roomStats.length > 0) {
        html += '<h6>ğŸ  éƒ¨å±‹åˆ¥çµ±è¨ˆ</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>éƒ¨å±‹ç•ªå·</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th><th>å¹³å‡ã‚¹ã‚³ã‚¢</th><th>æœ€é«˜ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>';
        
        roomStats.forEach(room => {
            html += `<tr>
                <td><span class="badge bg-secondary">${room.room_number}</span></td>
                <td>${room.user_count}äºº</td>
                <td>${room.avg_score}</td>
                <td class="text-success"><strong>${room.max_score}</strong></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    contentDiv.innerHTML = html;
    resultDiv.style.display = 'block';
}

// çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©
function repairUserStats() {
    if (confirm('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»çµ±è¨ˆãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ–°è¦ä½œæˆ\nãƒ»å¤ã„çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°\n\nå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ä¿®å¾©ä¸­...';
        
        fetch('/admin/repair_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                // ä¿®å¾©å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('ä¿®å¾©ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// å…¨çµ±è¨ˆã®å¼·åˆ¶å†åˆæœŸåŒ–
function initializeAllStats() {
    if (confirm('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆã‚’å¼·åˆ¶å†åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™\nâš ï¸ å…¨ã¦ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒå†è¨ˆç®—ã•ã‚Œã¾ã™\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'åˆæœŸåŒ–ä¸­...';
        
        fetch('/admin/initialize_user_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`âœ… ${data.message}`);
                // åˆæœŸåŒ–å¾Œã«çŠ¶æ…‹ã‚’å†ç¢ºèª
                setTimeout(() => checkUserStats(), 1000);
            } else {
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

console.log('ğŸ‰ admin.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');

// ========================================
// å˜å…ƒé¸æŠç®¡ç†æ©Ÿèƒ½
// ========================================

// åˆ©ç”¨å¯èƒ½ãªå˜å…ƒä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
function loadAvailableUnits(roomNumber) {
    console.log(`ğŸ” å˜å…ƒä¸€è¦§èª­ã¿è¾¼ã¿: éƒ¨å±‹${roomNumber}`);
    
    const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
    if (!container) return;
    
    container.innerHTML = '<p class="text-info">èª­ã¿è¾¼ã¿ä¸­...</p>';
    
    fetch(`/admin/get_available_units/${roomNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayUnitCheckboxes(roomNumber, data.available_units);
                loadCurrentUnitSettings(roomNumber);
            } else {
                container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
            }
        })
        .catch(error => {
            console.error('å˜å…ƒä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            container.innerHTML = '<p class="text-danger">å˜å…ƒä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        });
}

// å˜å…ƒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
function displayUnitCheckboxes(roomNumber, availableUnits) {
    const container = document.getElementById(`unitCheckboxes_${roomNumber}`);
    if (!container) return;
    
    if (availableUnits.length === 0) {
        container.innerHTML = '<p class="text-muted">åˆ©ç”¨å¯èƒ½ãªå˜å…ƒãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    let html = '<div class="units-grid">';
    
    availableUnits.forEach(unit => {
        html += `
            <div class="form-check form-check-inline unit-checkbox">
                <input class="form-check-input" type="checkbox" 
                       id="unit_${roomNumber}_${unit}" 
                       value="${unit}"
                       onchange="updateSelectedCount('${roomNumber}')">
                <label class="form-check-label" for="unit_${roomNumber}_${unit}">
                    ${unit}
                </label>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log(`âœ… å˜å…ƒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºå®Œäº†: ${availableUnits.length}å€‹`);
}

// ç¾åœ¨ã®å˜å…ƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
function loadCurrentUnitSettings(roomNumber) {
    fetch('/admin/get_room_setting', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room_number: roomNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.enabled_units) {
            const enabledUnits = data.enabled_units;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            enabledUnits.forEach(unit => {
                const checkbox = document.getElementById(`unit_${roomNumber}_${unit}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            updateSelectedCount(roomNumber);
            console.log(`âœ… ç¾åœ¨ã®è¨­å®šé©ç”¨: ${enabledUnits.length}å€‹ã®å˜å…ƒãŒæœ‰åŠ¹`);
        }
    })
    .catch(error => {
        console.error('ç¾åœ¨è¨­å®šã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    });
}

// é¸æŠã•ã‚ŒãŸå˜å…ƒæ•°ã‚’æ›´æ–°
function updateSelectedCount(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
    const countElement = document.getElementById(`selectedCount_${roomNumber}`);
    
    if (countElement) {
        countElement.textContent = checkboxes.length;
    }
}

// å…¨ã¦ã®å˜å…ƒã‚’é¸æŠ
function selectAllUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount(roomNumber);
    console.log(`âœ… å…¨å˜å…ƒé¸æŠ: éƒ¨å±‹${roomNumber}`);
}

// å…¨ã¦ã®å˜å…ƒé¸æŠã‚’è§£é™¤
function clearAllUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount(roomNumber);
    console.log(`ğŸ”„ å…¨å˜å…ƒè§£é™¤: éƒ¨å±‹${roomNumber}`);
}

// é¸æŠã•ã‚ŒãŸå˜å…ƒã®ãƒªã‚¹ãƒˆã‚’å–å¾—
function getSelectedUnits(roomNumber) {
    const checkboxes = document.querySelectorAll(`#unitCheckboxes_${roomNumber} input[type="checkbox"]:checked`);
    return Array.from(checkboxes).map(cb => cb.value);
}

// éƒ¨å±‹è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿®æ­£
document.addEventListener('DOMContentLoaded', function() {
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã«ç½®ãæ›ãˆ
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        button.replaceWith(button.cloneNode(true));
    });
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;
            const csvFileSelect = document.getElementById('csvFile_' + roomNumber);
            
            console.log(`ğŸ”§ éƒ¨å±‹è¨­å®šä¿å­˜é–‹å§‹: ${roomNumber}`);
            
            if (!csvFileSelect) {
                alert('è¨­å®šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // é¸æŠã•ã‚ŒãŸå˜å…ƒã‚’å–å¾—
            const selectedUnits = getSelectedUnits(roomNumber);
            const csvFilename = csvFileSelect.value;
            
            console.log(`ğŸ“ ä¿å­˜ã™ã‚‹è¨­å®š:`, {
                roomNumber: roomNumber,
                selectedUnits: selectedUnits,
                csvFilename: csvFilename
            });

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            this.disabled = true;
            this.textContent = 'ä¿å­˜ä¸­...';

            // å˜å…ƒè¨­å®šã€CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åŒæ™‚ã«æ›´æ–°
            Promise.all([
                fetch('/admin/update_room_units_setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        enabled_units: selectedUnits
                    })
                }),
                fetch('/admin/update_room_csv_setting', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        csv_filename: csvFilename
                    })
                })
            ])
            .then(responses => {
                console.log('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', responses.map(r => r.status));
                return Promise.all(responses.map(r => r.json()));
            })
            .then(results => {
                const unitResult = results[0];
                const csvResult = results[1];
                
                console.log('ğŸ“Š ä¿å­˜çµæœ:', { unitResult, csvResult });
                
                if (unitResult.status === 'success' && csvResult.status === 'success') {
                    alert(`âœ… éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ:\nãƒ»æœ‰åŠ¹å˜å…ƒ: ${selectedUnits.length}å€‹\nãƒ»CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFilename}`);
                    
                    // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                    loadRoomSettings();
                } else {
                    const errorMsg = (unitResult.message || csvResult.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                    alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + errorMsg);
                    console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', { unitResult, csvResult });
                }
            })
            .catch(error => {
                console.error('âŒ ä¿å­˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            })
            .finally(() => {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                this.disabled = false;
                this.textContent = 'ä¿å­˜';
            });
        });
    });
});
</script>

<style>
/* ========================================
   1. åŸºæœ¬çš„ãªç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 15px;
    margin-bottom: 25px;
}

.admin-header h2 {
    margin: 0;
    color: #343a40;
}

/* ========================================
   2. æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
.admin-section {
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.section-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid #dee2e6;
    transition: all 0.3s ease;
    user-select: none;
}

.section-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.section-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1.3rem;
    color: #495057;
    font-weight: 600;
}

.section-header h3 i:first-child {
    margin-right: 10px;
    color: #6c757d;
}

.toggle-icon {
    transition: transform 0.3s ease;
    color: #6c757d;
    font-size: 0.9rem;
}

.section-header[aria-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
}

.section-content {
    padding: 25px;
    background-color: #fff;
}

/* ========================================
   3. ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
.admin-panel {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #eee;
}

.admin-panel h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #343a40;
}

.admin-panel p {
    margin-bottom: 15px;
    line-height: 1.5;
}

/* ========================================
   4. ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ
   ======================================== */
.scrollable-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.scrollable-table-container .table {
    margin-bottom: 0;
}

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #343a40 !important;
}

.table-controls {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    margin-bottom: 15px;
}

.table-controls label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

/* ========================================
   5. ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ 
   ======================================== */
.sort-icon {
    margin-left: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
    cursor: pointer;
}

.sort-icon:hover {
    opacity: 1;
}

.badge {
    font-size: 0.8em;
}

#userTableBody tr:hover {
    background-color: #f8f9fa;
}

.delete-user-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* ========================================
   6. ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */
.upload-form, .add-user-form {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #495057;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

/* ========================================
   7. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³
   ======================================== */
.section-content {
    transition: all 0.3s ease;
}

.collapse {
    transition: height 0.35s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#invalidHistoryAnalysisResult,
#userDebugResult,
#statsCheckResult {
    animation: fadeIn 0.3s ease-in;
}

/* ========================================
   8. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
   ======================================== */
@media (max-width: 768px) {
    .admin-container {
        padding: 15px;
    }
    
    .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .section-header {
        padding: 12px 15px;
    }
    
    .section-header h3 {
        font-size: 1.1rem;
    }
    
    .section-content {
        padding: 20px 15px;
    }
    
    .upload-form, .add-user-form {
        padding: 15px;
    }
    
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group-vertical .btn {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .scrollable-table-container {
        max-height: 300px;
    }
    
    .table {
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.3rem;
        white-space: nowrap;
    }
    
    .table-controls .row {
        margin-bottom: 0;
    }
    
    .table-controls .col-md-6 {
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    .section-header h3 {
        font-size: 1rem;
    }
    
    .admin-panel {
        padding: 15px;
    }
    
    .table {
        font-size: 0.75rem;
    }
}

/* ========================================
   9. çŠ¶æ…‹è¡¨ç¤ºã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
   ======================================== */
.text-success {
    color: #28a745 !important;
}

.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.text-info {
    color: #17a2b8 !important;
}

.text-muted {
    color: #6c757d !important;
}

/* ========================================
   10. ç‰¹æ®Šãªè¡¨ç¤ºè¦ç´ 
   ======================================== */
.csv-template-section {
    margin-bottom: 25px;
    padding: 15px;
    background-color: #f0f8ff;
    border: 1px solid #87ceeb;
    border-radius: 6px;
    border-left: 4px solid #17a2b8;
}

.flashes {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
}

.flashes li {
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    border-left: 4px solid;
}

.flashes li.success {
    background-color: #d4edda;
    border-left-color: #28a745;
    color: #155724;
}

.flashes li.error {
    background-color: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.flashes li.warning {
    background-color: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.flashes li.info {
    background-color: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

/* å˜å…ƒé¸æŠç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.unit-setting-container {
    max-width: 400px;
}

.units-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    background-color: #f8f9fa;
}

.unit-checkbox {
    margin: 0 !important;
    font-size: 0.9em;
}

.unit-checkbox .form-check-input {
    margin-right: 4px;
}

.unit-controls .btn {
    margin-right: 5px;
    margin-bottom: 5px;
}

.selected-units-display {
    font-weight: 500;
}

@media (max-width: 768px) {
    .units-grid {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 6px;
    }
    
    .unit-setting-container {
        max-width: 100%;
    }
}
</style>
{% endblock %}