{% extends "base.html" %}
{% block title %}苦手問題一覧 - {{ app_name }}{% endblock %}

{% block content %}
<section class="weak-problems-section">
    <h2>苦手問題一覧</h2>
    <p>あなたの苦手な問題と、部屋のみんなが苦手としている問題を確認して、効率的に学習を進めましょう。</p>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs" id="weakProblemTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-weak-tab" data-bs-toggle="tab" data-bs-target="#my-weak" type="button" role="tab" aria-controls="my-weak" aria-selected="true">
                <i class="fas fa-user-graduate"></i> あなたの苦手問題
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="everyone-weak-tab" data-bs-toggle="tab" data-bs-target="#everyone-weak" type="button" role="tab" aria-controls="everyone-weak" aria-selected="false">
                <i class="fas fa-users"></i> みんなの苦手問題 Top 20
            </button>
        </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="weakProblemTabsContent">
        <!-- あなたの苦手問題 -->
        <div class="tab-pane fade show active" id="my-weak" role="tabpanel" aria-labelledby="my-weak-tab">
            <div class="table-responsive mt-3">
                {% if my_weak_problems %}
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">問題</th>
                                <th scope="col">答え</th>
                                <th scope="col" class="text-center">あなたの回答</th>
                                <th scope="col" class="text-center" style="min-width: 120px;">あなたの正答率</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for problem in my_weak_problems %}
                                <tr>
                                    <td>{{ problem.question }}</td>
                                    <td>{{ problem.answer }}</td>
                                    <td class="text-center">
                                        <span class="text-success">{{ problem.correct }}</span> / <span class="text-danger">{{ problem.incorrect }}</span>
                                        <small class="text-muted"> (正/誤)</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ problem.accuracy }}%;" aria-valuenow="{{ problem.accuracy }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ "%.1f"|format(problem.accuracy) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="alert alert-success mt-3" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-check-circle"></i> 素晴らしい！</h4>
                        <p>現在、あなたの苦手な問題はありません。この調子で学習を続けましょう！</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- みんなの苦手問題 -->
        <div class="tab-pane fade" id="everyone-weak" role="tabpanel" aria-labelledby="everyone-weak-tab">
            <div class="table-responsive mt-3">
                {% if everyone_weak_problems %}
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" class="text-center">順位</th>
                                <th scope="col">問題</th>
                                <th scope="col">答え</th>
                                <th scope="col" class="text-center" style="min-width: 120px;">全体の正答率</th>
                                <th scope="col" class="text-center" style="min-width: 120px;">あなたの正答率</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for problem in everyone_weak_problems %}
                                <tr>
                                    <td class="text-center"><strong>{{ loop.index }}</strong></td>
                                    <td>{{ problem.question }}</td>
                                    <td>{{ problem.answer }}</td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ problem.accuracy }}%;" aria-valuenow="{{ problem.accuracy }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ "%.1f"|format(problem.accuracy) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if problem.my_accuracy is not none %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar {% if problem.my_accuracy >= 80 %}bg-success{% elif problem.my_accuracy >= 50 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ problem.my_accuracy }}%;" aria-valuenow="{{ problem.my_accuracy }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ "%.1f"|format(problem.my_accuracy) }}%
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">未回答</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                     <div class="alert alert-info mt-3" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-info-circle"></i> データ不足</h4>
                        <p>まだ十分な解答データが蓄積されていないため、「みんなの苦手問題」を表示できません。</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}