{% extends "base.html" %}
{% block title %}å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ - {{ app_name }}{% endblock %}

{% block content %}
<section class="selection-area">
    <div class="controls-area">
        <div class="question-count-and-auth">
            <div class="question-count-selection">
                <h3>å‡ºé¡Œæ•°ã‚’é¸æŠ</h3>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="questionCount" value="10"> 
                        <span>10å•</span>
                    </label>
                    <label>
                        <input type="radio" name="questionCount" value="20"> 
                        <span>20å•</span>
                    </label>
                    <label>
                        <input type="radio" name="questionCount" value="50"> 
                        <span>50å•</span>
                    </label>
                    <label>
                        <input type="radio" name="questionCount" value="all"> 
                        <span>å…¨å•</span>
                    </label>
                    <label>
                        <input type="radio" name="questionCount" value="incorrectOnly" id="incorrectOnlyRadio" {% if not session.get('user_id') %}disabled{% endif %}> 
                        <span>è‹¦æ‰‹å•é¡Œ</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="range-selection-area">
            <h3>å‡ºé¡Œç¯„å›²ã‚’é¸æŠ</h3>
            <div class="chapters-container">
                {% for chapter_num, chapter in chapter_data.items() %}
                <div class="chapter-item" data-chapter-num="{{ chapter_num }}">
                    <div class="chapter-header">
                        <span class="chapter-title">ç¬¬{{ chapter_num }}ç« </span>
                        <div class="chapter-options">
                            <button class="select-all-chapter-btn" data-chapter="{{ chapter_num }}" type="button">å…¨ã¦é¸æŠ</button>
                            <span class="toggle-icon">â–¶</span>
                        </div>
                    </div>
                    <div class="unit-list">
                        {% for unit_num, unit in chapter.units.items() %}
                        {% if unit.enabled %}
                        <div class="unit-item" data-unit-type="{{ 'â­ï¸' if unit_num == 'â­ï¸' else 'regular' }}">
                            <input type="checkbox" 
                                id="unit-{{ chapter_num }}-{{ unit_num }}" 
                                value="{{ unit_num }}" 
                                data-chapter="{{ chapter_num }}"
                                {% if unit_num == 'â­ï¸' %}data-is-star="true"{% endif %}>
                            <label for="unit-{{ chapter_num }}-{{ unit_num }}">
                                {% if unit_num == 'â­ï¸' %}
                                    <span class="star-unit-label">
                                        <span class="star-icon">â­ï¸</span>
                                        {{ unit.categoryName }}
                                        <span class="star-status" id="star-status-{{ chapter_num }}">
                                            <!-- JavaScriptã§å‹•çš„ã«è¨­å®š -->
                                        </span>
                                    </span>
                                {% else %}
                                    {{ unit_num }}. {{ unit.categoryName }}
                                {% endif %}
                            </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="bottom-controls">
            <button id="startButton" class="primary-button">å­¦ç¿’é–‹å§‹</button>
            <button id="resetSelectionButton" class="secondary-button">é¸æŠãƒªã‚»ãƒƒãƒˆ</button>
            <button id="showWeakWordsButton" class="secondary-button" {% if not session.get('user_id') %}style="display: none;"{% endif %}>è‹¦æ‰‹å•é¡Œä¸€è¦§</button>
        </div>
    </div>
</section>

<section class="card-area hidden">
    <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
        <span id="questionNumberDisplay" class="question-number-display"></span>
    </div>
    <div class="card">
        <div class="question-content">
            <p id="question"></p>
        </div>
        <div class="answer-content">
            <p id="answer" class="hidden"></p>
        </div>
    </div>
    <div class="card-buttons">
        <button id="showAnswerButton" class="primary-button">ç­”ãˆã‚’è¦‹ã‚‹</button>
        <button id="correctButton" class="correct-button hidden">æ­£è§£</button>
        <button id="incorrectButton" class="incorrect-button hidden">ä¸æ­£è§£</button>
    </div>
    <div class="back-to-selection-container">
        <button id="backToSelectionFromCardButton" class="secondary-button">é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
    </div>
</section>

<section id="quizResult" class="quiz-result-area hidden">
    <div id="quizResultContent">
        <h2>å­¦ç¿’çµæœ</h2>
        <p>å‡ºé¡Œæ•°: <span id="totalQuestionsCount"></span>å•</p>
        <p>æ­£è§£æ•°: <span id="correctCount"></span>å•</p>
        <p>ä¸æ­£è§£æ•°: <span id="incorrectCount"></span>å•</p>
        <p>æ­£ç­”ç‡: <span id="accuracyRate"></span>%</p>
        <p class="total-in-range">é¸æŠç¯„å›²ã®å…¨å•é¡Œæ•°: <span id="selectedRangeTotalQuestions"></span>å•</p>
    </div>

    <div id="incorrectWordList" class="incorrect-word-list hidden">
        <h3>ä»Šå›ã®ä¸æ­£è§£å•é¡Œ</h3>
        <ul id="incorrectWordsContainer">
        </ul>
    </div>

    <div class="result-buttons">
        <button id="backToSelectionButton" class="secondary-button">é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
        <button id="restartQuizButton" class="primary-button">åŒã˜æ¡ä»¶ã§å†å­¦ç¿’</button>
        <button id="shareXButton" class="share-button">Xã§ã‚·ã‚§ã‚¢</button>
        <button id="downloadImageButton" class="share-button">ç”»åƒã§ã‚·ã‚§ã‚¢</button>
    </div>
</section>

<section id="weakWordsListSection" class="weak-words-list-area hidden">
    <h2>è‹¦æ‰‹å•é¡Œä¸€è¦§</h2>
    <p>éå»ã®å­¦ç¿’ã§æ­£ç­”ç‡ãŒä½ã„å•é¡Œã®ä¸Šä½20å•ã§ã™ã€‚
        <br>â€»ç¾åœ¨ã®è‹¦æ‰‹å•é¡Œãƒ¢ãƒ¼ãƒ‰ã¯ã€1å›ä»¥ä¸Šé–“é•ãˆã€ã¾ã 2å›é€£ç¶šæ­£è§£ã—ã¦ã„ãªã„å•é¡Œã‹ã‚‰å‡ºé¡Œã•ã‚Œã¾ã™ã€‚</p>
    <ul id="weakWordsContainer">
    </ul>
    <p id="noWeakWordsMessage" class="hidden">ã¾ã å•é¡Œã‚’è§£ã„ã¦ã„ã¾ã›ã‚“ã€‚</p>
    <button id="backToSelectionFromWeakListButton" class="secondary-button">é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
</section>

<!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
<div class="info-icon" id="infoIcon">i</div>
<div class="info-panel hidden" id="infoPanel">
    <h3 id="appInfoTitle">ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
    <p><strong>æœ€çµ‚æ›´æ–°æ—¥:</strong> <span id="lastUpdatedDate"></span></p>
    <h4>æ›´æ–°å†…å®¹</h4>
    <p id="updateContent"></p>
    
    <!-- é€£çµ¡å…ˆæƒ…å ±ã‚’è¿½åŠ  -->
    <div id="contactSection" class="mt-3" style="display: none;">
        <hr style="margin: 10px 0; border-color: #ddd;">
        <h5 style="font-size: 0.9rem; margin-bottom: 5px;">ãŠå•ã„åˆã‚ã›</h5>
        <p style="font-size: 0.8rem; margin-bottom: 0;">
            <i class="fas fa-envelope me-1"></i>
            <a href="#" id="contactEmail" class="text-decoration-none"></a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let starAvailability = {};
let starRequirements = {};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«â­ï¸å•é¡Œã®çŠ¶æ…‹ã‚’å–å¾—
async function loadStarProblemStatusEnhanced() {
    try {
        console.log('ğŸŒŸ â­ï¸å•é¡ŒçŠ¶æ…‹å–å¾—é–‹å§‹ï¼ˆå¼·åŒ–ç‰ˆï¼‰');
        
        const response = await fetch('/api/star_problem_status_enhanced');
        const data = await response.json();
        
        if (data.status === 'success') {
            starProblemStatus = data.star_availability || {};
            starRequirements = data.star_requirements || {};
            
            console.log('â­ï¸å•é¡ŒçŠ¶æ…‹å–å¾—å®Œäº†:', {
                available: Object.keys(starProblemStatus).filter(id => starProblemStatus[id]).length,
                total: Object.keys(starProblemStatus).length,
                chapterProgress: data.chapter_progress
            });
            
            // UIæ›´æ–°
            updateStarProblemUIComplete();
            updateChapterProgressDisplay(data.chapter_progress);
            
            return data;
        } else {
            console.error('â­ï¸å•é¡ŒçŠ¶æ…‹å–å¾—å¤±æ•—:', data.message);
            return null;
        }
    } catch (error) {
        console.error('â­ï¸å•é¡ŒçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
    }
}

// å®Œå…¨ç‰ˆâ­ï¸å•é¡ŒUIæ›´æ–°
function updateStarProblemUIComplete() {
    console.log('ğŸ¨ â­ï¸å•é¡ŒUIå®Œå…¨æ›´æ–°é–‹å§‹');
    
    // å„â­ï¸å•é¡Œãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('input[data-is-star="true"]').forEach(checkbox => {
        const chapterNum = checkbox.dataset.chapter;
        const unitNum = checkbox.value; // 'â­ï¸'
        
        // ã“ã®ç« ã®â­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        const isAvailable = checkChapterStarAvailability(chapterNum);
        
        updateStarCheckboxState(checkbox, isAvailable, chapterNum);
    });
    
    // ã€Œå…¨ã¦é¸æŠã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateSelectAllButtonsForStarProblems();
    
    console.log('ğŸ¨ â­ï¸å•é¡ŒUIå®Œå…¨æ›´æ–°å®Œäº†');
}

// â­ï¸ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateStarCheckboxState(checkbox, isAvailable, chapterNum) {
    const unitItem = checkbox.closest('.unit-item');
    const starStatus = document.getElementById(`star-status-${chapterNum}`);
    
    if (!unitItem) return;
    
    if (isAvailable) {
        // â­ï¸å•é¡ŒãŒåˆ©ç”¨å¯èƒ½
        checkbox.disabled = false;
        unitItem.classList.remove('star-locked');
        unitItem.classList.add('star-available');
        
        if (starStatus) {
            starStatus.textContent = 'åˆ©ç”¨å¯èƒ½';
            starStatus.className = 'star-status available';
        }
        
        checkbox.title = 'â­ï¸å•é¡Œï¼šã“ã®ç« ã®å…¨ã¦ã®é€šå¸¸å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸãŸã‚åˆ©ç”¨å¯èƒ½ã§ã™';
        
        // è§£æ”¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!unitItem.classList.contains('star-unlock-animated')) {
            unitItem.classList.add('star-unlock-animated');
            setTimeout(() => {
                unitItem.classList.remove('star-unlock-animated');
            }, 2000);
        }
        
    } else {
        // â­ï¸å•é¡ŒãŒåˆ©ç”¨ä¸å¯
        checkbox.disabled = true;
        checkbox.checked = false;
        unitItem.classList.add('star-locked');
        unitItem.classList.remove('star-available');
        
        // å¿…è¦ãªå•é¡Œæ•°ã‚’è¨ˆç®—
        const requiredCount = calculateRequiredProblemsForChapter(chapterNum);
        
        if (starStatus) {
            if (requiredCount > 0) {
                starStatus.textContent = `ã‚ã¨${requiredCount}å•`;
                starStatus.className = 'star-status locked';
            } else {
                starStatus.textContent = 'æº–å‚™ä¸­';
                starStatus.className = 'star-status locked';
            }
        }
        
        checkbox.title = `â­ï¸å•é¡Œï¼šã“ã®ç« ã®é€šå¸¸å•é¡Œã‚’ã‚ã¨${requiredCount}å•ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™`;
    }
}

// ç« ã«å¿…è¦ãªæ®‹ã‚Šå•é¡Œæ•°ã‚’è¨ˆç®—
function calculateRequiredProblemsForChapter(chapterNum) {
    const chapterWords = word_data.filter(word => 
        String(word.chapter) === String(chapterNum) && String(word.number) !== 'â­ï¸'
    );
    
    let masteredCount = 0;
    
    chapterWords.forEach(word => {
        const problemId = generateProblemId(word);
        const history = problemHistory[problemId];
        
        if (history) {
            const correctAttempts = history.correct_attempts || 0;
            const incorrectAttempts = history.incorrect_attempts || 0;
            const totalAttempts = correctAttempts + incorrectAttempts;
            
            if (totalAttempts > 0) {
                const accuracyRate = (correctAttempts / totalAttempts) * 100;
                if (accuracyRate >= 80.0) {
                    masteredCount++;
                }
            }
        }
    });
    
    return Math.max(0, chapterWords.length - masteredCount);
}

// ç« ã®â­ï¸å•é¡ŒãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
function checkChapterStarAvailability(chapterNum) {
    // ãã®ç« ã®â­ï¸å•é¡Œã‚’æ¤œç´¢
    const chapterStarProblems = word_data.filter(word => 
        String(word.chapter) === String(chapterNum) && String(word.number) === 'â­ï¸'
    );
    
    if (chapterStarProblems.length === 0) {
        return false; // â­ï¸å•é¡ŒãŒãªã„ç« 
    }
    
    // ã©ã‚Œã‹ä¸€ã¤ã§ã‚‚åˆ©ç”¨å¯èƒ½ãªã‚‰ true
    return chapterStarProblems.some(word => {
        const problemId = generateProblemId(word);
        return starProblemStatus[problemId] === true;
    });
}

// â­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
function updateStarProblemUI() {
    console.log('ğŸŒŸ â­ï¸å•é¡ŒUIæ›´æ–°é–‹å§‹');
    
    if (!word_data || word_data.length === 0) {
        console.log('å˜èªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    // ç« ã”ã¨ã®â­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
    const starAvailability = checkStarProblemAvailabilityByChapter();
    
    // å„â­ï¸å•é¡Œã®UIã‚’æ›´æ–°
    Object.keys(starAvailability).forEach(chapterNum => {
        const availability = starAvailability[chapterNum];
        updateStarUnitUI(chapterNum, availability);
    });
    
    // ã€Œå…¨ã¦é¸æŠã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚æ›´æ–°
    updateSelectAllButtonsForStarProblems();
    
    console.log('ğŸŒŸ â­ï¸å•é¡ŒUIæ›´æ–°å®Œäº†', starAvailability);
}

// ç‰¹å®šã®ç« ã®â­ï¸å˜å…ƒã®UIã‚’æ›´æ–°
function updateStarUnitUI(chapterNum, availability) {
    if (!availability.hasStarProblems) return;
    
    const starCheckbox = document.getElementById(`unit-${chapterNum}-â­ï¸`);
    const starStatus = document.getElementById(`star-status-${chapterNum}`);
    const unitItem = starCheckbox ? starCheckbox.closest('.unit-item') : null;
    
    if (!starCheckbox || !unitItem) return;
    
    if (availability.isAvailable) {
        // â­ï¸å•é¡ŒãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
        starCheckbox.disabled = false;
        unitItem.classList.remove('star-locked');
        unitItem.classList.add('star-available');
        
        if (starStatus) {
            starStatus.textContent = 'åˆ©ç”¨å¯èƒ½';
            starStatus.className = 'star-status available';
        }
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        starCheckbox.title = 'â­ï¸å•é¡Œï¼šã“ã®ç« ã®å…¨ã¦ã®é€šå¸¸å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸãŸã‚åˆ©ç”¨å¯èƒ½ã§ã™';
        
    } else {
        // â­ï¸å•é¡ŒãŒåˆ©ç”¨ä¸å¯ãªå ´åˆ
        starCheckbox.disabled = true;
        starCheckbox.checked = false; // ãƒã‚§ãƒƒã‚¯ã‚‚å¤–ã™
        unitItem.classList.add('star-locked');
        unitItem.classList.remove('star-available');
        
        if (starStatus) {
            if (availability.requiredRemaining > 0) {
                starStatus.textContent = `ã‚ã¨${availability.requiredRemaining}å•`;
                starStatus.className = 'star-status locked';
            } else {
                starStatus.textContent = 'æº–å‚™ä¸­';
                starStatus.className = 'star-status locked';
            }
        }
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        starCheckbox.title = `â­ï¸å•é¡Œï¼šã“ã®ç« ã®é€šå¸¸å•é¡Œã‚’ã‚ã¨${availability.requiredRemaining}å•ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™`;
    }
}

// ã€Œå…¨ã¦é¸æŠã€ãƒœã‚¿ãƒ³ã‚’â­ï¸å•é¡Œã®çŠ¶æ…‹ã«åˆã‚ã›ã¦æ›´æ–°
function updateSelectAllButtonsForStarProblems() {
    document.querySelectorAll('.select-all-chapter-btn').forEach(button => {
        const chapterNum = button.dataset.chapter;
        const chapterItem = button.closest('.chapter-item');
        
        if (chapterItem) {
            // ãã®ç« ã®æœ‰åŠ¹ãªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆâ­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚‚è€ƒæ…®ï¼‰
            const allCheckboxes = chapterItem.querySelectorAll(`input[type="checkbox"][data-chapter="${chapterNum}"]`);
            const enabledCheckboxes = Array.from(allCheckboxes).filter(cb => !cb.disabled);
            const checkedCheckboxes = enabledCheckboxes.filter(cb => cb.checked);
            
            const allChecked = enabledCheckboxes.length > 0 && checkedCheckboxes.length === enabledCheckboxes.length;
            
            updateSelectAllButtonText(button, allChecked);
        }
    });
}

// ç« ã”ã¨ã®â­ï¸å•é¡Œåˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
function checkStarProblemAvailabilityByChapter() {
    const availability = {};
    
    // ç« ã”ã¨ã«å•é¡Œã‚’åˆ†é¡
    const chapterData = {};
    word_data.forEach(word => {
        const chapter = String(word.chapter);
        const number = String(word.number);
        
        if (!chapterData[chapter]) {
            chapterData[chapter] = {
                regularProblems: [],
                starProblems: [],
                masteredRegular: 0,
                totalRegular: 0
            };
        }
        
        if (number === 'â­ï¸') {
            chapterData[chapter].starProblems.push(word);
        } else {
            chapterData[chapter].regularProblems.push(word);
            chapterData[chapter].totalRegular++;
        }
    });
    
    // å„ç« ã®ãƒã‚¹ã‚¿ãƒ¼çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
    Object.keys(chapterData).forEach(chapterNum => {
        const data = chapterData[chapterNum];
        
        // ãã®ç« ã®é€šå¸¸å•é¡Œã®ãƒã‚¹ã‚¿ãƒ¼æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let masteredCount = 0;
        data.regularProblems.forEach(word => {
            const problemId = generateProblemId(word);
            const history = problemHistory[problemId];
            
            if (history) {
                const correctAttempts = history.correct_attempts || 0;
                const incorrectAttempts = history.incorrect_attempts || 0;
                const totalAttempts = correctAttempts + incorrectAttempts;
                
                if (totalAttempts > 0) {
                    const accuracyRate = (correctAttempts / totalAttempts) * 100;
                    if (accuracyRate >= 80.0) { // ãƒã‚¹ã‚¿ãƒ¼åˆ¤å®šï¼šæ­£ç­”ç‡80%ä»¥ä¸Š
                        masteredCount++;
                    }
                }
            }
        });
        
        data.masteredRegular = masteredCount;
        
        // â­ï¸å•é¡ŒãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹åˆ¤å®š
        const isStarAvailable = data.totalRegular > 0 && masteredCount >= data.totalRegular;
        
        availability[chapterNum] = {
            hasStarProblems: data.starProblems.length > 0,
            totalRegular: data.totalRegular,
            masteredRegular: masteredCount,
            isAvailable: isStarAvailable,
            requiredRemaining: Math.max(0, data.totalRegular - masteredCount)
        };
        
        console.log(`ç¬¬${chapterNum}ç« : ${masteredCount}/${data.totalRegular} ãƒã‚¹ã‚¿ãƒ¼ â†’ â­ï¸å•é¡Œ${isStarAvailable ? 'åˆ©ç”¨å¯' : 'åˆ©ç”¨ä¸å¯'}`);
    });
    
    return availability;
}

// ç« ãƒ»å˜å…ƒé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
function updateChapterUnitDropdowns() {
    const chapterSelect = document.getElementById('chapter-select');
    const unitSelect = document.getElementById('unit-select');
    
    if (!chapterSelect || !unitSelect) return;
    
    // é¸æŠã•ã‚ŒãŸç« ã®å˜å…ƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
    const selectedChapter = chapterSelect.value;
    if (selectedChapter && chapterData[selectedChapter]) {
        updateUnitOptions(selectedChapter);
    }
}

// å˜å…ƒé¸æŠè‚¢ã®æ›´æ–°ï¼ˆâ­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’è€ƒæ…®ï¼‰
function updateUnitOptions(chapterNum) {
    const unitSelect = document.getElementById('unit-select');
    if (!unitSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    unitSelect.innerHTML = '<option value="">å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    
    if (!chapterData[chapterNum] || !chapterData[chapterNum].units) return;
    
    const units = chapterData[chapterNum].units;
    
    // é€šå¸¸ã®å˜å…ƒã¨â­ï¸å•é¡Œã‚’åˆ†é›¢
    const regularUnits = [];
    const starUnits = [];
    
    Object.keys(units).forEach(unitNum => {
        const unitData = units[unitNum];
        
        if (unitNum === 'â­ï¸') {
            // â­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            const isAvailable = checkStarUnitAvailability(chapterNum);
            starUnits.push({
                unitNum: unitNum,
                data: unitData,
                available: isAvailable
            });
        } else {
            regularUnits.push({
                unitNum: unitNum,
                data: unitData,
                available: true
            });
        }
    });
    
    // é€šå¸¸ã®å˜å…ƒã‚’æ•°å€¤é †ã§ã‚½ãƒ¼ãƒˆ
    regularUnits.sort((a, b) => {
        const aNum = parseInt(a.unitNum) || 0;
        const bNum = parseInt(b.unitNum) || 0;
        return aNum - bNum;
    });
    
    // é€šå¸¸ã®å˜å…ƒã‚’è¿½åŠ 
    regularUnits.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.unitNum;
        option.textContent = `${unit.unitNum}. ${unit.data.categoryName}`;
        unitSelect.appendChild(option);
    });
    
    // â­ï¸å•é¡Œã‚’è¿½åŠ 
    starUnits.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.unitNum;
        
        if (unit.available) {
            option.textContent = `â­ï¸ ${unit.data.categoryName}`;
            option.style.color = '#ffd700'; // é‡‘è‰²
        } else {
            option.textContent = `â­ï¸ ${unit.data.categoryName} (è¦è§£æ”¾)`;
            option.disabled = true;
            option.style.color = '#999';
            option.title = `ã“ã®â­ï¸å•é¡Œã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ç¬¬${chapterNum}ç« ã®ä»–ã®å…¨ã¦ã®å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ãã ã•ã„`;
        }
        
        unitSelect.appendChild(option);
    });
}

// â­ï¸å˜å…ƒã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
function checkStarUnitAvailability(chapterNum) {
    // è©²å½“ç« ã®â­ï¸å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
    for (const [problemId, isAvailable] of Object.entries(starAvailability)) {
        const requirement = starRequirements[problemId];
        if (requirement && requirement.chapter === chapterNum) {
            return isAvailable;
        }
    }
    return false;
}

// ç¯„å›²é¸æŠãƒ¢ãƒ¼ãƒ‰ã®é¸æŠè‚¢æ›´æ–°
function updateRangeSelectionOptions() {
    const rangeOptions = document.querySelectorAll('.range-option');
    
    rangeOptions.forEach(option => {
        const chapterNum = option.dataset.chapter;
        const unitNum = option.dataset.unit;
        
        if (unitNum === 'â­ï¸') {
            const isAvailable = checkStarUnitAvailability(chapterNum);
            
            if (!isAvailable) {
                option.classList.add('star-locked');
                option.style.opacity = '0.5';
                option.style.pointerEvents = 'none';
                
                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¿½åŠ 
                option.title = `â­ï¸å•é¡Œï¼šç¬¬${chapterNum}ç« ã®ä»–ã®å…¨ã¦ã®å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™`;
                
                // ãƒ­ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
                if (!option.querySelector('.lock-icon')) {
                    const lockIcon = document.createElement('span');
                    lockIcon.className = 'lock-icon';
                    lockIcon.innerHTML = ' ğŸ”’';
                    lockIcon.style.color = '#999';
                    option.appendChild(lockIcon);
                }
            } else {
                option.classList.remove('star-locked');
                option.style.opacity = '1';
                option.style.pointerEvents = 'auto';
                option.title = 'â­ï¸å•é¡Œï¼šåˆ©ç”¨å¯èƒ½';
                
                // ãƒ­ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
                const lockIcon = option.querySelector('.lock-icon');
                if (lockIcon) {
                    lockIcon.remove();
                }
                
                // ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
                option.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                option.style.color = '#000';
                option.style.border = '2px solid #ffd700';
            }
        }
    });
}

// ç« åˆ¥é€²æ—è¡¨ç¤ºã®æ›´æ–°
function updateChapterProgressDisplay(chapterProgress) {
    Object.keys(chapterProgress).forEach(chapterNum => {
        const progress = chapterProgress[chapterNum];
        const chapterElement = document.querySelector(`[data-chapter="${chapterNum}"]`);
        
        if (chapterElement && progress.star_total > 0) {
            // æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’å‰Šé™¤
            const existingStatus = chapterElement.querySelector('.chapter-star-progress');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’ä½œæˆ
            const statusDiv = document.createElement('div');
            statusDiv.className = 'chapter-star-progress';
            
            const availableStars = progress.star_available;
            const totalStars = progress.star_total;
            const masteredRegular = progress.regular_mastered;
            const totalRegular = progress.regular_total;
            
            let statusText = '';
            let statusClass = '';
            
            if (availableStars === totalStars && totalStars > 0) {
                statusText = `â­ï¸ å…¨ã¦è§£æ”¾æ¸ˆã¿ (${totalStars}å•)`;
                statusClass = 'star-unlocked';
            } else {
                const remaining = totalRegular - masteredRegular;
                if (remaining > 0) {
                    statusText = `â­ï¸ è¦è§£æ”¾ (æ®‹ã‚Š${remaining}å•)`;
                } else {
                    statusText = 'â­ï¸ è§£æ”¾å‡¦ç†ä¸­...';
                }
                statusClass = 'star-locked';
            }
            
            statusDiv.innerHTML = `
                <div class="star-progress-info ${statusClass}">
                    <span class="star-status-text">${statusText}</span>
                    <small class="star-progress-detail">
                        é€šå¸¸å•é¡Œ: ${masteredRegular}/${totalRegular} ãƒã‚¹ã‚¿ãƒ¼
                    </small>
                </div>
            `;
            
            // ç« ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
            const chapterHeader = chapterElement.querySelector('.chapter-header');
            if (chapterHeader) {
                chapterHeader.appendChild(statusDiv);
            }
        }
    });
}

// å­¦ç¿’é€²æ—ä¿å­˜ã‚’â­ï¸å•é¡Œå¯¾å¿œç‰ˆã«å¤‰æ›´
async function saveQuizProgressWithStarCheck() {
    console.log('\n=== â­ï¸å•é¡Œå¯¾å¿œé€²æ—ä¿å­˜é–‹å§‹ ===');
    
    const dataToSave = {
        problemHistory: problemHistory,
        incorrectWords: incorrectWords
    };

    try {
        const response = await fetch('/api/save_progress_with_star_check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSave)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… â­ï¸å•é¡Œå¯¾å¿œé€²æ—ä¿å­˜æˆåŠŸ');
            
            // æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸâ­ï¸å•é¡ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (data.newly_unlocked_stars && data.newly_unlocked_stars.length > 0) {
                console.log('ğŸŒŸ æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸâ­ï¸å•é¡Œ:', data.newly_unlocked_stars);
                
                // è§£æ”¾é€šçŸ¥ã‚’è¡¨ç¤º
                showStarUnlockNotification(data.newly_unlocked_stars, data.unlock_message);
                
                // â­ï¸å•é¡ŒçŠ¶æ…‹ã‚’å†å–å¾—ã—ã¦UIã‚’æ›´æ–°
                setTimeout(async () => {
                    await loadStarProblemStatusEnhanced();
                }, 500);
            }
            
            if (data.debug_info) {
                console.log('ä¿å­˜ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', data.debug_info);
            }
        } else {
            console.error('âŒ â­ï¸å•é¡Œå¯¾å¿œé€²æ—ä¿å­˜å¤±æ•—:', data.message);
            flashMessage(data.message, 'danger');
        }
        
        console.log('=== â­ï¸å•é¡Œå¯¾å¿œé€²æ—ä¿å­˜çµ‚äº† ===\n');
        return data;
        
    } catch (error) {
        console.error('âŒ â­ï¸å•é¡Œå¯¾å¿œé€²æ—ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        flashMessage('é€²æ—ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
        throw error;
    }
}

// â­ï¸å•é¡Œè§£æ”¾é€šçŸ¥ã‚’è¡¨ç¤º
function showStarUnlockNotification(newlyUnlocked, message) {
    // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
    const existingNotification = document.querySelector('.star-unlock-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'star-unlock-notification';
    
    const chapters = [...new Set(newlyUnlocked.map(star => star.chapter))];
    
    notification.innerHTML = `
        <div class="notification-content">
            <div class="star-icon">ğŸŒŸ</div>
            <div class="notification-text">
                <strong>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</strong><br>
                ${message || `ç¬¬${chapters.join('ã€')}ç« ã®â­ï¸å•é¡ŒãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼`}
            </div>
            <div class="unlock-details">
                <small>è§£æ”¾ã•ã‚ŒãŸå•é¡Œ:</small>
                <ul>
                    ${newlyUnlocked.map(star => 
                        `<li>ç¬¬${star.chapter}ç« : ${star.question.substring(0, 30)}...</li>`
                    ).join('')}
                </ul>
            </div>
        </div>
    `;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
        z-index: 10000;
        animation: starUnlockPulse 3s ease-in-out;
        border: 3px solid #ffd700;
        text-align: center;
        min-width: 350px;
        max-width: 90vw;
    `;
    
    document.body.appendChild(notification);
    
    // 4ç§’å¾Œã«é€šçŸ¥ã‚’å‰Šé™¤
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 4000);
    
    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤º
    flashMessage('ğŸŒŸ æ–°ã—ã„â­ï¸å•é¡ŒãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼', 'success');
}

// ã‚¯ã‚¤ã‚ºé–‹å§‹æ™‚ã®â­ï¸å•é¡Œãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
function filterStarProblemsForQuiz(problems) {
    return problems.filter(problem => {
        // â­ï¸å•é¡Œã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
        if (problem.number === 'â­ï¸') {
            const problemId = generateProblemId(problem);
            return starAvailability[problemId] === true;
        }
        return true; // é€šå¸¸å•é¡Œã¯å¸¸ã«å«ã‚ã‚‹
    });
}

// å•é¡Œé¸æŠæ™‚ã®â­ï¸å•é¡Œãƒã‚§ãƒƒã‚¯
function validateStarProblemSelection(selectedProblems) {
    const invalidProblems = [];
    
    selectedProblems.forEach(problem => {
        if (problem.number === 'â­ï¸') {
            const problemId = generateProblemId(problem);
            if (!starAvailability[problemId]) {
                invalidProblems.push({
                    problem: problem,
                    chapter: problem.chapter,
                    requirement: starRequirements[problemId]
                });
            }
        }
    });
    
    return invalidProblems;
}

// ç¯„å›²é¸æŠã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆâ­ï¸å•é¡Œå¯¾å¿œï¼‰
function validateStarProblemSelection() {
    const selectedStarUnits = [];
    
    // é¸æŠã•ã‚ŒãŸâ­ï¸å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
    document.querySelectorAll('input[data-is-star="true"]:checked').forEach(checkbox => {
        const chapterNum = checkbox.dataset.chapter;
        selectedStarUnits.push(chapterNum);
    });
    
    if (selectedStarUnits.length === 0) {
        return true; // â­ï¸å•é¡ŒãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯OK
    }
    
    // é¸æŠã•ã‚ŒãŸâ­ï¸å•é¡Œã®åˆ©ç”¨å¯èƒ½æ€§ã‚’å†ãƒã‚§ãƒƒã‚¯
    const starAvailability = checkStarProblemAvailabilityByChapter();
    const invalidSelections = [];
    
    selectedStarUnits.forEach(chapterNum => {
        const availability = starAvailability[chapterNum];
        if (!availability || !availability.isAvailable) {
            invalidSelections.push({
                chapter: chapterNum,
                required: availability ? availability.requiredRemaining : 0
            });
        }
    });
    
    if (invalidSelections.length > 0) {
        // ç„¡åŠ¹ãªé¸æŠãŒã‚ã£ãŸå ´åˆã€ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        invalidSelections.forEach(invalid => {
            const checkbox = document.getElementById(`unit-${invalid.chapter}-â­ï¸`);
            if (checkbox) {
                checkbox.checked = false;
            }
        });
        
        const errorChapters = invalidSelections.map(inv => `ç¬¬${inv.chapter}ç« `).join('ã€');
        flashMessage(`${errorChapters}ã®â­ï¸å•é¡Œã¯ã¾ã åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚è©²å½“ç« ã®é€šå¸¸å•é¡Œã‚’å…¨ã¦ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`, 'warning');
        
        return false;
    }
    
    return true;
}

// â­ï¸å•é¡Œè§£æ”¾é€šçŸ¥
function showStarProblemUnlocked(chapterNum) {
    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const notification = document.createElement('div');
    notification.className = 'star-unlock-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <span class="star-icon">â­ï¸</span>
            <div class="notification-text">
                <strong>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</strong><br>
                ç¬¬${chapterNum}ç« ã®â­ï¸å•é¡ŒãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼
            </div>
        </div>
    `;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        z-index: 10000;
        animation: starUnlockPulse 2s ease-in-out;
        border: 3px solid #ffd700;
        text-align: center;
        min-width: 300px;
    `;
    
    document.body.appendChild(notification);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSã‚’è¿½åŠ 
    if (!document.getElementById('star-unlock-styles')) {
        const style = document.createElement('style');
        style.id = 'star-unlock-styles';
        style.textContent = `
            @keyframes starUnlockPulse {
                0% { 
                    opacity: 0; 
                    transform: translate(-50%, -50%) scale(0.5); 
                }
                50% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1.1); 
                }
                100% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1); 
                }
            }
            
            .star-unlock-notification .star-icon {
                font-size: 2em;
                display: block;
                margin-bottom: 10px;
                animation: starRotate 2s infinite linear;
            }
            
            @keyframes starRotate {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            .star-status.star-unlocked {
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #000;
                padding: 5px 10px;
                border-radius: 15px;
                font-weight: bold;
                margin-top: 5px;
            }
            
            .star-status.star-locked {
                background: #f0f0f0;
                color: #666;
                padding: 5px 10px;
                border-radius: 15px;
                margin-top: 5px;
            }
        `;
        document.head.appendChild(style);
    }
    
    // 3ç§’å¾Œã«é€šçŸ¥ã‚’å‰Šé™¤
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

// å­¦ç¿’å±¥æ­´ä¿å­˜å¾Œã«â­ï¸å•é¡Œã®çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
async function recheckStarProblemsAfterProgress() {
    const oldAvailability = { ...starAvailability };
    
    // æœ€æ–°ã®â­ï¸å•é¡ŒçŠ¶æ…‹ã‚’å–å¾—
    await loadStarProblemStatus();
    
    // æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸâ­ï¸å•é¡ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    Object.keys(starAvailability).forEach(problemId => {
        const wasLocked = !oldAvailability[problemId];
        const isNowUnlocked = starAvailability[problemId];
        
        if (wasLocked && isNowUnlocked) {
            const requirement = starRequirements[problemId];
            if (requirement) {
                showStarProblemUnlocked(requirement.chapter);
            }
        }
    });
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    addStarUnlockStyles();
    
    // æ—¢å­˜ã®åˆæœŸåŒ–å®Œäº†å¾Œã«â­ï¸å•é¡ŒçŠ¶æ…‹ã‚’å–å¾—
    setTimeout(async () => {
        await loadStarProblemStatusEnhanced();
    }, 2500);
});

// handleAnsweré–¢æ•°ã‚’ä¿®æ­£ã—ã¦â­ï¸å•é¡Œãƒã‚§ãƒƒã‚¯ã‚’å«ã‚ã‚‹
const originalHandleAnswer = window.handleAnswer;
window.handleAnswer = function(isCorrect) {
    // å…ƒã®handleAnswerå‡¦ç†ã‚’å®Ÿè¡Œ
    if (originalHandleAnswer) {
        originalHandleAnswer.call(this, isCorrect);
    }
    
    // å›ç­”å¾Œã«â­ï¸å•é¡ŒçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆé…å»¶ï¼‰
    setTimeout(async () => {
        console.log('ğŸ”„ å›ç­”å¾Œâ­ï¸å•é¡ŒçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯');
        await loadStarProblemStatusEnhanced();
    }, 1000);
};

// å­¦ç¿’é€²æ—ä¿å­˜å¾Œã«â­ï¸å•é¡Œã®çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
const originalSaveProgress = window.saveQuizProgressToServer;
window.saveQuizProgressToServer = saveQuizProgressWithStarCheck;

// ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šâ­ï¸å•é¡Œã®å®Œå…¨ãªçŠ¶æ…‹ã‚’ç¢ºèª
window.debugStarProblemsComplete = function() {
    console.log('ğŸŒŸ === â­ï¸å•é¡Œå®Œå…¨ãƒ‡ãƒãƒƒã‚° ===');
    console.log('ç¾åœ¨ã®â­ï¸å•é¡ŒçŠ¶æ…‹:', starProblemStatus);
    console.log('â­ï¸å•é¡Œè¦ä»¶:', starRequirements);
    
    // ç« ã”ã¨ã®è©³ç´°
    const chapterData = {};
    word_data.forEach(word => {
        const chapter = String(word.chapter);
        const number = String(word.number);
        
        if (!chapterData[chapter]) {
            chapterData[chapter] = { regular: [], star: [] };
        }
        
        if (number === 'â­ï¸') {
            const problemId = generateProblemId(word);
            chapterData[chapter].star.push({
                question: word.question,
                available: starProblemStatus[problemId] || false,
                problemId: problemId
            });
        } else {
            const problemId = generateProblemId(word);
            const history = problemHistory[problemId] || {};
            const correctAttempts = history.correct_attempts || 0;
            const incorrectAttempts = history.incorrect_attempts || 0;
            const totalAttempts = correctAttempts + incorrectAttempts;
            const accuracyRate = totalAttempts > 0 ? (correctAttempts / totalAttempts) * 100 : 0;
            
            chapterData[chapter].regular.push({
                number: number,
                question: word.question,
                mastered: accuracyRate >= 80.0,
                accuracyRate: accuracyRate.toFixed(1)
            });
        }
    });
    
    Object.keys(chapterData).forEach(chapter => {
        const data = chapterData[chapter];
        const masteredCount = data.regular.filter(p => p.mastered).length;
        const totalRegular = data.regular.length;
        
        console.log(`\nç¬¬${chapter}ç« :`);
        console.log(`  é€šå¸¸å•é¡Œ: ${masteredCount}/${totalRegular} ãƒã‚¹ã‚¿ãƒ¼`);
        console.log(`  â­ï¸å•é¡Œ: ${data.star.length}å•`);
        
        data.star.forEach((star, index) => {
            console.log(`    ${index + 1}. ${star.available ? 'âœ…' : 'ğŸ”’'} ${star.question.substring(0, 30)}...`);
        });
    });
    
    console.log('==========================');
    return { starProblemStatus, starRequirements, chapterData };
};

// ç¯„å›²é¸æŠã§ã®â­ï¸å•é¡Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateRangeSelection() {
    const selectedRanges = document.querySelectorAll('.range-option.selected');
    const invalidSelections = [];
    
    selectedRanges.forEach(option => {
        const chapterNum = option.dataset.chapter;
        const unitNum = option.dataset.unit;
        
        if (unitNum === 'â­ï¸') {
            const isAvailable = checkStarUnitAvailability(chapterNum);
            if (!isAvailable) {
                invalidSelections.push({
                    chapter: chapterNum,
                    unit: unitNum,
                    element: option
                });
            }
        }
    });
    
    if (invalidSelections.length > 0) {
        // ç„¡åŠ¹ãªé¸æŠã‚’è§£é™¤
        invalidSelections.forEach(invalid => {
            invalid.element.classList.remove('selected');
        });
        
        // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const chapters = invalidSelections.map(inv => `ç¬¬${inv.chapter}ç« `).join('ã€');
        alert(`${chapters}ã®â­ï¸å•é¡Œã¯ã¾ã åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nè©²å½“ç« ã®ä»–ã®å…¨ã¦ã®å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
        
        return false;
    }
    
    return true;
}

// å˜å…ƒé¸æŠã§ã®â­ï¸å•é¡Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateUnitSelection() {
    const chapterSelect = document.getElementById('chapter-select');
    const unitSelect = document.getElementById('unit-select');
    
    if (!chapterSelect || !unitSelect) return true;
    
    const selectedChapter = chapterSelect.value;
    const selectedUnit = unitSelect.value;
    
    if (selectedUnit === 'â­ï¸') {
        const isAvailable = checkStarUnitAvailability(selectedChapter);
        if (!isAvailable) {
            alert(`ç¬¬${selectedChapter}ç« ã®â­ï¸å•é¡Œã¯ã¾ã åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nè©²å½“ç« ã®ä»–ã®å…¨ã¦ã®å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
            unitSelect.value = '';
            return false;
        }
    }
    
    return true;
}


function debugRoomSetting(roomNumber) {
    console.log(`ğŸ” éƒ¨å±‹${roomNumber}ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±:`);
    
    const maxUnitInput = document.getElementById('maxUnit_' + roomNumber);
    const csvFileSelect = document.getElementById('csvFile_' + roomNumber);
    const currentCsvDisplay = document.getElementById('current_csv_' + roomNumber);
    
    console.log('ğŸ“‹ DOMè¦ç´ :', {
        maxUnit: maxUnitInput ? maxUnitInput.value : 'ãªã—',
        csvFile: csvFileSelect ? csvFileSelect.value : 'ãªã—',
        currentDisplay: currentCsvDisplay ? currentCsvDisplay.textContent : 'ãªã—'
    });
    
    console.log('ğŸ¯ ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³:');
    if (csvFileSelect) {
        Array.from(csvFileSelect.options).forEach((option, index) => {
            console.log(`  ${index}: ${option.value} (${option.selected ? 'é¸æŠä¸­' : 'æœªé¸æŠ'})`);
        });
    }
    
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®è¨­å®šã‚’å–å¾—
    fetch('/admin/get_room_setting', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room_number: roomNumber })
    })
    .then(response => response.json())
    .then(data => {
        console.log('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è¨­å®š:', data);
        
        if (data.status === 'success') {
            // è¡¨ç¤ºã‚’æ›´æ–°
            if (currentCsvDisplay) {
                currentCsvDisplay.textContent = data.csv_filename;
            }
            if (csvFileSelect) {
                csvFileSelect.value = data.csv_filename;
            }
        }
    })
    .catch(error => {
        console.error('âŒ è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    });
}

// CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
function addStarUnlockStyles() {
    if (!document.getElementById('star-unlock-styles')) {
        const style = document.createElement('style');
        style.id = 'star-unlock-styles';
        style.textContent = `
            @keyframes starUnlockPulse {
                0% { 
                    opacity: 0; 
                    transform: translate(-50%, -50%) scale(0.5); 
                }
                20% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1.1); 
                }
                100% { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1); 
                }
            }
            
            .star-unlock-notification .star-icon {
                font-size: 2.5em;
                display: block;
                margin-bottom: 15px;
                animation: starRotate 2s infinite linear;
            }
            
            @keyframes starRotate {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            .star-unlock-animated {
                animation: starUnlockGlow 2s ease-in-out;
            }
            
            @keyframes starUnlockGlow {
                0%, 100% { box-shadow: none; }
                50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            }
            
            .chapter-star-progress {
                margin-top: 8px;
                font-size: 0.85em;
            }
            
            .star-progress-info {
                padding: 5px 10px;
                border-radius: 12px;
                display: inline-block;
            }
            
            .star-progress-info.star-unlocked {
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            
            .star-progress-info.star-locked {
                background: linear-gradient(135deg, #f8d7da, #f5c6cb);
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            
            .star-progress-detail {
                display: block;
                margin-top: 2px;
                opacity: 0.8;
            }
        `;
        document.head.appendChild(style);
    }
}
</script>
<script>
    // Flaskã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
    window.appInfoFromFlask = {{ app_info_for_js | tojson | safe }};  <!-- ã“ã®è¡Œã‚’ä¿®æ­£ -->
    window.chapterDataFromFlask = {{ chapter_data | tojson | safe }};
</script>
<!-- html2canvas ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- ãƒ¡ã‚¤ãƒ³ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="{{ url_for('static', filename='script.js') }}"></script>

<style>
/* è‹¦æ‰‹å•é¡Œåˆ¶é™æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
.weak-problem-warning {
    animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        transform: translateY(-20px);
        max-height: 0;
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
        max-height: 300px;
    }
}

/* åˆ¶é™æ™‚ã®ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢èª¿æ•´ */
.controls-area.restricted-mode {
    padding-bottom: 20px;
}

.controls-area.restricted-mode .bottom-controls {
    margin-top: 20px;
    justify-content: center;
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
@media (max-width: 768px) {
    .weak-problem-warning div {
        padding: 15px !important;
        margin: 15px 0 !important;
        font-size: 0.95em;
    }
    
    .weak-problem-warning h4 {
        font-size: 1.1em !important;
    }
    
    .weak-problem-warning p {
        font-size: 1em !important;
    }
}

.star-unit-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.star-icon {
    color: #ffd700;
    font-size: 1.2em;
    margin-right: 5px;
}

.star-status {
    font-size: 0.8em;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: bold;
}

.star-status.available {
    background-color: #d4edda;
    color: #155724;
}

.star-status.locked {
    background-color: #f8d7da;
    color: #721c24;
}

.unit-item[data-unit-type="â­ï¸"].star-locked {
    opacity: 0.6;
    pointer-events: none;
}

.unit-item[data-unit-type="â­ï¸"].star-locked input[type="checkbox"] {
    cursor: not-allowed;
}

.unit-item[data-unit-type="â­ï¸"].star-locked label {
    color: #6c757d;
    cursor: not-allowed;
}

.unit-item[data-unit-type="â­ï¸"].star-available {
    background: linear-gradient(135deg, #fff8dc, #fffacd);
    border: 1px solid #ffd700;
    border-radius: 5px;
    padding: 5px;
}

@media (max-width: 767px) {
    .star-unit-label {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .star-status {
        margin-top: 3px;
        font-size: 0.7em;
    }
}
</style>
{% endblock %}