{% extends "base.html" %}

{% block head_extra %}
<link href="https://fonts.googleapis.com/css2?family=Yuji+Boku&family=Kaisei+Tokumin:wght@400;700&display=swap"
    rel="stylesheet">
<style>
    .map-quiz-title {
        font-family: 'Yuji Boku', serif;
        font-size: 2.2rem;
        background: linear-gradient(135deg, #0d6efd 0%, #003d99 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        letter-spacing: 0.05em;
    }

    .map-quiz-title i {
        -webkit-text-fill-color: #0d6efd;
        /* Reset for icon */
        margin-right: 12px;
        filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.1));
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="map-quiz-title"><i class="fas fa-globe-americas"></i>地図の深淵</h2>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-home me-1"></i> ホーム
        </a>
    </div>

    <div class="alert alert-light border shadow-sm">
        <i class="fas fa-info-circle text-info"></i> 地図を選択してクイズに挑戦しよう！
    </div>

    <div class="accordion" id="mapQuizAccordion">

        {# 1. Sorted Genres #}
        {% for genre in genres %}
        {% set map_list = genre.maps %}
        {% if map_list|length > 0 %}
        {% set genre_id = 'genre-' ~ genre.id %}
        <div class="accordion-item shadow-sm mb-3 border-0 rounded overflow-hidden">
            <h2 class="accordion-header" id="heading-{{ genre_id }}">
                <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-{{ genre_id }}"
                    aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse-{{ genre_id }}"
                    style="font-weight: bold; background-color: #f8f9fa;">
                    <i class="fas fa-tag me-2 text-primary"></i> {{ genre.name }}
                    <span class="badge bg-secondary ms-3 rounded-pill">{{ map_list|length }}</span>
                </button>
            </h2>
            <div id="collapse-{{ genre_id }}" class="accordion-collapse collapse {{ 'show' if loop.first }}"
                aria-labelledby="heading-{{ genre_id }}">
                <div class="accordion-body p-0">
                    <div class="list-group list-group-flush">
                        {% for map in map_list %}
                        <div
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3">
                            <div>
                                <h6 class="mb-1 fw-bold text-dark">
                                    <i class="fas fa-map me-2 text-secondary"></i>{{ map.name }}
                                </h6>
                                <small class="text-muted">{{ map.locations|length }} 地点</small>
                            </div>
                            <span class="btn btn-sm btn-outline-primary rounded-pill text-nowrap"
                                onclick="openDifficultyModal({{ map.id }}, '{{ map.name }}')">
                                <i class="fas fa-play me-1"></i> 挑戦
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        {# 2. Others (No Genre) #}
        {% if others_maps and others_maps|length > 0 %}
        {% set genre_id = 'genre-others' %}
        <div class="accordion-item shadow-sm mb-3 border-0 rounded overflow-hidden">
            <h2 class="accordion-header" id="heading-{{ genre_id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-{{ genre_id }}" aria-expanded="false"
                    aria-controls="collapse-{{ genre_id }}" style="font-weight: bold; background-color: #f8f9fa;">
                    <i class="fas fa-question-circle me-2 text-secondary"></i> その他
                    <span class="badge bg-secondary ms-3 rounded-pill">{{ others_maps|length }}</span>
                </button>
            </h2>
            <div id="collapse-{{ genre_id }}" class="accordion-collapse collapse"
                aria-labelledby="heading-{{ genre_id }}">
                <div class="accordion-body p-0">
                    <div class="list-group list-group-flush">
                        {% for map in others_maps %}
                        <div
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3">
                            <div>
                                <h6 class="mb-1 fw-bold text-dark">
                                    <i class="fas fa-map me-2 text-secondary"></i>{{ map.name }}
                                </h6>
                                <small class="text-muted">{{ map.locations|length }} 地点</small>
                            </div>
                            <span class="btn btn-sm btn-outline-primary rounded-pill text-nowrap"
                                onclick="openDifficultyModal({{ map.id }}, '{{ map.name }}')">
                                <i class="fas fa-play me-1"></i> 挑戦
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if genres|length == 0 and others_maps|length == 0 %}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-map fa-3x mb-3"></i><br>
            登録された地図クイズはまだありません。
        </div>
        {% endif %}
    </div>
</div>

<!-- Difficulty Selection Modal -->
<div class="modal fade" id="difficultyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-gamepad"></i> 難易度を選択</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">「<span id="selectedMapName" class="fw-bold"></span>」に挑戦します。<br>難易度を選んでください。</p>

                <div id="difficultyLoading" class="py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2 small">問題を読み込み中...</p>
                </div>

                <div id="difficultyButtons" class="d-grid gap-2 col-10 mx-auto" style="display: none !important;">
                    <button id="difficulty-btn-1" class="btn btn-outline-success btn-lg" onclick="startMapQuiz(1)">
                        <i class="fas fa-seedling"></i> 易（やさしい）
                    </button>
                    <button id="difficulty-btn-2" class="btn btn-outline-primary btn-lg" onclick="startMapQuiz(2)">
                        <i class="fas fa-walking"></i> 標準（ふつう）
                    </button>
                    <button id="difficulty-btn-3" class="btn btn-outline-danger btn-lg" onclick="startMapQuiz(3)">
                        <i class="fas fa-skull"></i> 難（むずかしい）
                    </button>
                    <button id="difficulty-btn-all" class="btn btn-secondary btn-lg" onclick="startMapQuiz(0)">
                        <i class="fas fa-layer-group"></i> すべて（All）
                    </button>
                </div>

                <div id="noProblemsMessage" class="py-3 text-muted" style="display: none;">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>この地図には問題が登録されていません。</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMapId = null;

    async function openDifficultyModal(mapId, mapName) {
        currentMapId = mapId;
        document.getElementById('selectedMapName').innerText = mapName;

        const modalEl = document.getElementById('difficultyModal');
        const modal = new bootstrap.Modal(modalEl);

        // Reset UI
        document.getElementById('difficultyLoading').style.display = 'block';
        document.getElementById('difficultyButtons').style.setProperty('display', 'none', 'important');
        document.getElementById('noProblemsMessage').style.display = 'none';

        modal.show();

        try {
            const response = await fetch(`/api/map_quiz/map/${mapId}/difficulty_counts`);
            const data = await response.json();

            document.getElementById('difficultyLoading').style.display = 'none';

            if (data.status === 'success') {
                const counts = data.counts;

                if (counts.total === 0) {
                    document.getElementById('noProblemsMessage').style.display = 'block';
                } else {
                    document.getElementById('difficultyButtons').style.setProperty('display', 'grid', 'important');

                    // Show/Hide specific buttons
                    document.getElementById('difficulty-btn-1').style.display = counts.easy > 0 ? 'block' : 'none';
                    document.getElementById('difficulty-btn-2').style.display = counts.standard > 0 ? 'block' : 'none';
                    document.getElementById('difficulty-btn-3').style.display = counts.hard > 0 ? 'block' : 'none';

                    // "All" button remains visible if total > 0
                    document.getElementById('difficulty-btn-all').style.display = 'block';
                }
            } else {
                alert('データ取得エラー');
            }
        } catch (e) {
            console.error(e);
            document.getElementById('difficultyLoading').innerText = '通信エラーが発生しました';
        }
    }

    function startMapQuiz(difficulty) {
        if (!currentMapId) return;
        let url = "{{ url_for('map_quiz_play', map_id=0) }}".replace('/0', '/' + currentMapId);
        if (difficulty > 0) {
            url += '?difficulty=' + difficulty;
        }
        window.location.href = url;
    }
</script>
{% endblock %}