{% extends "base.html" %}
{% block title %}スコア算出方法について - {{ app_name }}{% endblock %}

{% block content %}
<section class="score-details-section">
    <div class="header-section">
        <h2>📐 スコア算出方法について</h2>
        <p class="subtitle">信頼性重視の総合学習評価システムの詳細</p>
        <div class="back-link">
            <a href="{{ url_for('progress_page') }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-arrow-left"></i> 進捗ページに戻る
            </a>
        </div>
    </div>

    <!-- 基本式セクション -->
    <div class="formula-container">
        <h3>🔢 基本式</h3>
        <div class="formula-box">
            <div class="formula-main">
                総合スコア = <span class="condition">{ 0 (回答数 = 0の場合) | (A + B + C) ÷ 100 (回答数 > 0の場合) }</span>
            </div>
        </div>
    </div>

    <!-- 各要素の詳細 -->
    <div class="components-section">
        <h3>📊 各要素の計算</h3>
        
        <!-- A. マスター数評価 -->
        <div class="component-card mastery-card">
            <div class="component-header">
                <h4><span class="component-label">A</span> マスター数評価</h4>
                <span class="weight-badge">最重要</span>
            </div>
            <div class="formula-detail">
                <code>A = (マスター数)<sup>1.3</sup> × 10</code>
            </div>
            <ul class="explanation-list">
                <li><strong>マスター数</strong> = 正答率80%以上の問題数</li>
                <li><strong>1.3乗</strong>により、多くマスターするほど指数的に高評価</li>
                <li><strong>狙い</strong>：深い理解と定着を最重視</li>
            </ul>
            <div class="example-box">
                <strong>例：</strong> 15問マスター → 15<sup>1.3</sup> × 10 = <strong>274ポイント</strong>
            </div>
        </div>

        <!-- B. 信頼性補正済み正答率評価 -->
        <div class="component-card accuracy-card">
            <div class="component-header">
                <h4><span class="component-label">B</span> 信頼性補正済み正答率評価</h4>
                <span class="feature-badge">統計補正</span>
            </div>
            <div class="formula-detail">
                <code>補正正答率 = (7 + 実際の正解数) ÷ (10 + 実際の回答数)</code><br>
                <code>B = (補正正答率)<sup>2</sup> × 500</code>
            </div>
            <ul class="explanation-list">
                <li><strong>ベイズ統計</strong>による信頼性補正を適用</li>
                <li>回答数が少ない場合、想定正答率70%に引っ張られる</li>
                <li><strong>2乗</strong>により高正答率に大きな報酬</li>
            </ul>
            <div class="example-box">
                <strong>例：</strong> 80/100回正解 → ((7+80)÷(10+100))<sup>2</sup> × 500 = <strong>312ポイント</strong>
            </div>
        </div>

        <!-- C. 学習量評価 -->
        <div class="component-card effort-card">
            <div class="component-header">
                <h4><span class="component-label">C</span> 学習量評価</h4>
                <span class="balance-badge">適度な評価</span>
            </div>
            <div class="formula-detail">
                <code>C = ln(回答数 + 1) × 20</code>
            </div>
            <ul class="explanation-list">
                <li><strong>自然対数</strong>により、努力するほど伸びるが過度な優遇なし</li>
                <li>大量回答による力技を適切に抑制</li>
                <li>継続的な学習を適度に評価</li>
            </ul>
            <div class="example-box">
                <strong>例：</strong> 100回答 → ln(101) × 20 = <strong>92ポイント</strong>
            </div>
        </div>
    </div>

    <!-- 具体例セクション -->
    <div class="example-section">
        <h3>🎯 具体的な計算例</h3>
        <div class="calculation-example">
            <div class="example-title">マスター15問、正解80回/100回答の学習者の場合</div>
            <div class="calculation-steps">
                <div class="step">
                    <span class="step-label">A</span>
                    <span class="step-calc">15<sup>1.3</sup> × 10 = <strong>274ポイント</strong></span>
                </div>
                <div class="step">
                    <span class="step-label">B</span>
                    <span class="step-calc">((7+80)÷(10+100))<sup>2</sup> × 500 = 0.79<sup>2</sup> × 500 = <strong>312ポイント</strong></span>
                </div>
                <div class="step">
                    <span class="step-label">C</span>
                    <span class="step-calc">ln(101) × 20 = <strong>92ポイント</strong></span>
                </div>
                <div class="final-result">
                    <span class="result-label">総合スコア</span>
                    <span class="result-calc">(274 + 312 + 92) ÷ 100 = <strong>6.78ポイント</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 設計思想セクション -->
    <div class="philosophy-section">
        <h3>⚖️ 設計思想</h3>
        <div class="philosophy-content">
            <p class="philosophy-main">
                質の高い学習（理解+定着）を統計的信頼性とともに評価し、
                「少数回答での偶然高得点」や「大量回答での力技」を適切に補正する公平な評価システム
            </p>
            <div class="fairness-features">
                <div class="feature-item">
                    <i class="fas fa-shield-alt text-success"></i>
                    <span>少ない回答数での高正答率は統計的に補正</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-balance-scale text-warning"></i>
                    <span>大量回答でも低正答率では高スコアにならない</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-trophy text-primary"></i>
                    <span>真の理解と定着を最も高く評価</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 比較表セクション -->
    <div class="comparison-section">
        <h3>📋 学習パターン別スコア比較</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>学習パターン</th>
                        <th>マスター数</th>
                        <th>正解/回答</th>
                        <th>実正答率</th>
                        <th>補正正答率</th>
                        <th>総合スコア</th>
                        <th>評価</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-success">
                        <td>質重視型</td>
                        <td>25問</td>
                        <td>90/100</td>
                        <td>90%</td>
                        <td>89%</td>
                        <td><strong>10.2</strong></td>
                        <td>優秀</td>
                    </tr>
                    <tr class="table-info">
                        <td>バランス型</td>
                        <td>15問</td>
                        <td>80/100</td>
                        <td>80%</td>
                        <td>79%</td>
                        <td><strong>6.8</strong></td>
                        <td>良好</td>
                    </tr>
                    <tr class="table-warning">
                        <td>量重視型</td>
                        <td>10問</td>
                        <td>120/200</td>
                        <td>60%</td>
                        <td>61%</td>
                        <td><strong>4.1</strong></td>
                        <td>要改善</td>
                    </tr>
                    <tr class="table-secondary">
                        <td>少数高得点</td>
                        <td>2問</td>
                        <td>10/10</td>
                        <td>100%</td>
                        <td>85%</td>
                        <td><strong>3.6</strong></td>
                        <td>補正済み</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 戻るボタン -->
    <div class="back-section">
        <a href="{{ url_for('progress_page') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> 進捗ページに戻る
        </a>
    </div>
</section>

<style>
.score-details-section {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #007bff;
}

.subtitle {
    color: #6c757d;
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.back-link {
    margin-top: 15px;
}

.formula-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid #007bff;
}

.formula-box {
    text-align: center;
}

.formula-main {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.condition {
    color: #007bff;
}

.components-section {
    margin-bottom: 30px;
}

.component-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-left: 5px solid;
}

.mastery-card { border-left-color: #28a745; }
.accuracy-card { border-left-color: #ffc107; }
.effort-card { border-left-color: #17a2b8; }

.component-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.component-label {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    margin-right: 10px;
}

.weight-badge { background: #28a745; }
.feature-badge { background: #ffc107; color: #000; }
.balance-badge { background: #17a2b8; }

.weight-badge, .feature-badge, .balance-badge {
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.formula-detail {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-family: 'Courier New', monospace;
    border: 1px solid #dee2e6;
}

.explanation-list {
    margin-bottom: 15px;
    padding-left: 20px;
}

.explanation-list li {
    margin-bottom: 5px;
    color: #495057;
}

.example-box {
    background: #e7f3ff;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #b8daff;
    color: #004085;
}

.example-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
}

.calculation-example {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.example-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.1rem;
}

.calculation-steps {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.step {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
}

.step-label {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    min-width: 25px;
    text-align: center;
}

.final-result {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 6px;
    font-weight: 600;
    margin-top: 10px;
}

.result-label {
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 4px;
    min-width: 80px;
    text-align: center;
}

.philosophy-section {
    background: linear-gradient(135deg, #6f42c1, #007bff);
    color: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
}

.philosophy-main {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
    text-align: center;
}

.fairness-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.1);
    padding: 12px;
    border-radius: 6px;
}

.comparison-section {
    margin-bottom: 30px;
}

.back-section {
    text-align: center;
    padding-top: 20px;
    border-top: 2px solid #e9ecef;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .score-details-section {
        padding: 15px;
    }
    
    .component-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .step {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
    }
    
    .final-result {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .fairness-features {
        grid-template-columns: 1fr;
    }
    
    .formula-main {
        font-size: 1rem;
        line-height: 1.4;
    }
}
</style>
{% endblock %}