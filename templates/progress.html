{% extends "base.html" %}
{% block title %}進捗確認 - {{ app_name }}{% endblock %}

{% block content %}
<section class="progress-section">
    <h2>進捗確認 - {{ current_user.username }} (部屋: {{ current_user.room_number }})</h2>

    <!-- ランキングセクションを上に移動 -->
    <div class="ranking-container">
        <h3>ランキング (部屋：{{ current_user.room_number }})</h3>
        <p>同じ部屋のユーザー内での上位10名を表示しています。</p>
        <div class="ranking-criteria">
            <p><strong>📊 ランキング基準:</strong> 信頼性重視の総合学習評価スコアの高い順</p>
            <p><strong>🔢 スコア算出:</strong> ① マスター数重視 + ② 信頼性補正済み正答率 + ③ 適度な学習量</p>
            <p><strong>⚖️ 公平性の仕組み:</strong></p>
            <ul style="font-size: 0.85em; margin: 8px 0; padding-left: 20px; color: #495057;">
                <li>少ない回答数での高正答率は統計的に補正されます</li>
                <li>大量回答でも低正答率では高スコアになりません</li>
                <li>80%以上正解した問題数（マスター数）を最重視</li>
            </ul>
            <p><small style="color: #6c757d;">※ 質の高い学習（理解+定着）と統計的に信頼できる成績を評価する方式です</small></p>
        </div>
        {% if top_10_ranking %}
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>順位</th>
                        <th>名前</th>
                        <th>回答数</th>
                        <th>正解数</th>
                        <th>正答率</th>
                        <th>スコア</th>
                        <th>網羅率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in top_10_ranking %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ entry.username }}</td>
                        <td>{{ entry.total_attempts }}</td>
                        <td>{{ entry.total_correct }}</td>
                        <td>{{ entry.accuracy_rate|round(1) }}%</td>
                        <td><strong>{{ entry.balance_score|round(1) }}</strong></td>
                        <td>{{ entry.coverage_rate|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>まだランキングデータがありません。</p>
        {% endif %}
    </div>

    <!-- セクション間の仕切り -->
    <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0; border-radius: 1px;">

    <!-- あなたの単元別進捗セクション -->
    <div class="progress-container">
        <h3>あなたの単元別進捗</h3>
        {% if user_progress_by_unit %}
        <div class="progress-list">
            {% for unit_num, progress in user_progress_by_unit %}
                <div class="progress-item">
                    <h4>{{ unit_num }}. {{ progress.categoryName }}</h4>
                    {% set total_attempts = progress.total_attempts %}
                    {% set mastered_count = progress.mastered_problems|length %}
                    {% set total_questions = progress.total_questions_in_unit %}
                    
                    <p>
                        問題を解いた数: {{ total_attempts }}回
                    </p>
                    <p>
                        マスターした問題数: {{ mastered_count }} / {{ total_questions }}
                        （{% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %}）
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %};"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <p>まだ問題を解いていません。</p>
        {% endif %}
    </div>
</section>
{% endblock %}