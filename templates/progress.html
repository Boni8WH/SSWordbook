{% extends "base.html" %}
{% block title %}進捗確認 - {{ app_name }}{% endblock %}

{% block content %}
<section class="progress-section">
    <h2>進捗確認 - {{ current_user.username }} (部屋: {{ current_user.room_number }})</h2>

    <!-- ランキングセクション -->
    <div class="ranking-container">
    <h3>ランキング (部屋：{{ current_user.room_number }})</h3>
    <p>同じ部屋のユーザー内での上位5名を表示しています。</p>
        {% if current_user_stats %}
        <div class="current-user-stats">
            <div class="stats-header">
                <div class="stats-title-section">
                    <h4>📊 あなたのスコア詳細</h4>
                </div>
                <div class="rank-section">
                    <h4>🏆 あなたの順位</h4>
                    {% if current_user_rank %}
                    <div class="rank-display">
                        <span class="rank-number">{{ current_user_rank }}</span>
                        <span class="rank-text">位</span>
                        <span class="rank-total">/ {{ total_users_in_room }}人</span>
                    </div>
                    {% else %}
                    <div class="rank-display">
                        <span class="rank-text">順位なし</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">総合スコア</span>
                    <span class="stat-value main-score">{{ current_user_stats.balance_score|round(1) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">マスタリースコア</span>
                    <span class="stat-value">{{ current_user_stats.mastery_score|round(1) }}</span>
                    <small class="stat-description">マスターした問題数×10</small>
                </div>
                <div class="stat-item">
                    <span class="stat-label">信頼性スコア</span>
                    <span class="stat-value">{{ current_user_stats.reliability_score|round(1) }}</span>
                    <small class="stat-description">統計的補正済み正答率</small>
                </div>
                <div class="stat-item">
                    <span class="stat-label">活動スコア</span>
                    <span class="stat-value">{{ current_user_stats.activity_score|round(1) }}</span>
                    <small class="stat-description">学習活動量の評価</small>
                </div>
            </div>
            <div class="basic-stats">
                <p><strong>基本統計:</strong> 
                    回答数: {{ current_user_stats.total_attempts }}回 | 
                    正解数: {{ current_user_stats.total_correct }}回 | 
                    正答率: {{ current_user_stats.accuracy_rate|round(1) }}% | 
                    マスター数: {{ current_user_stats.mastered_count }}問 | 
                    網羅率: {{ current_user_stats.coverage_rate|round(1) }}%
                </p>
            </div>
        </div>
        {% endif %}
        <div class="ranking-criteria">
            <p><strong>📊 ランキング基準:</strong> 信頼性重視の総合学習評価スコアの高い順</p>
            <p><strong>🔢 スコア算出:</strong> ① マスター数重視 + ② 信頼性補正済み正答率 + ③ 適度な学習量</p>
            <p><strong>⚖️ 公平性の仕組み:</strong></p>
            <ul style="font-size: 0.85em; margin: 8px 0; padding-left: 20px; color: #495057;">
                <li>少ない回答数での高正答率は統計的に補正されます</li>
                <li>大量回答でも低正答率では高スコアになりません</li>
                <li>80%以上正解した問題数（マスター数）を最重視</li>
            </ul>
            <p style="margin-top: 15px;">
                <a href="{{ url_for('score_details') }}" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-calculator"></i> 詳細な算出方法を見る
                </a>
            </p>
            <p><small style="color: #6c757d;">※ 質の高い学習（理解+定着）と統計的に信頼できる成績を評価する方式です</small></p>
        </div>
        {% if top_10_ranking %}
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>順位</th>
                        <th>名前</th>
                        <th>回答数</th>
                        <th>正解数</th>
                        <th>正答率</th>
                        <th>総合スコア</th>
                        <th>網羅率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in top_10_ranking %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ entry.username }}</td>
                        <td>{{ entry.total_attempts }}</td>
                        <td>{{ entry.total_correct }}</td>
                        <td>{{ entry.accuracy_rate|round(1) }}%</td>
                        <td><strong>{{ entry.balance_score|round(1) }}</strong></td>
                        <td>{{ entry.coverage_rate|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>まだランキングデータがありません。</p>
        {% endif %}
    </div>

    <!-- セクション間の仕切り -->
    <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0; border-radius: 1px;">

    <!-- あなたの章別進捗セクション -->
    <div class="progress-container">
        <h3>あなたの章別進捗</h3>
        {% if user_progress_by_chapter %}
        <div class="progress-accordion">
            {% for chapter_num, chapter_data in user_progress_by_chapter.items() %}
            <div class="chapter-progress-item" data-chapter="{{ chapter_num }}">
                <!-- 章ヘッダー（クリック可能） -->
                <div class="chapter-progress-header" onclick="toggleChapterProgress('{{ chapter_num }}')">
                    <div class="chapter-progress-info">
                        <span class="chapter-toggle-icon" id="icon-{{ chapter_num }}">▶</span>
                        <span class="chapter-title">{{ chapter_data.chapter_name }}</span>
                    </div>
                    <div class="chapter-summary">
                        <span class="mastered-count">{{ chapter_data.total_mastered }}/{{ chapter_data.total_questions }}問マスター</span>
                        <span class="chapter-percentage">({{ ((chapter_data.total_mastered / chapter_data.total_questions * 100) if chapter_data.total_questions > 0 else 0)|round(1) }}%)</span>
                    </div>
                </div>
                
                <!-- 章の進捗バー -->
                <div class="chapter-progress-bar-container">
                    <div class="chapter-progress-bar" style="width: {{ ((chapter_data.total_mastered / chapter_data.total_questions * 100) if chapter_data.total_questions > 0 else 0)|round(1) }}%;"></div>
                </div>

                <!-- 単元詳細（初期状態は非表示） -->
                <div class="unit-details" id="units-{{ chapter_num }}" style="display: none;">
                    {% for unit_data in chapter_data.units %}
                    <div class="unit-progress-item">
                        <h5>{{ unit_data.unit_num }}. {{ unit_data.category_name }}</h5>
                        {% set total_attempts = unit_data.total_attempts %}
                        {% set mastered_count = unit_data.mastered_problems|length %}
                        {% set total_questions = unit_data.total_questions_in_unit %}
                        
                        <p>問題を解いた数: {{ total_attempts }}回</p>
                        <p>
                            マスターした問題数: {{ mastered_count }} / {{ total_questions }}
                            （{% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %}）
                        </p>
                        <div class="unit-progress-bar-container">
                            <div class="unit-progress-bar" style="width: {% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %};"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>まだ問題を解いていません。</p>
        {% endif %}
    </div>
</section>

<script>
function toggleChapterProgress(chapterNum) {
    const unitsDiv = document.getElementById('units-' + chapterNum);
    const icon = document.getElementById('icon-' + chapterNum);
    
    if (unitsDiv.style.display === 'none' || unitsDiv.style.display === '') {
        unitsDiv.style.display = 'block';
        icon.textContent = '▼';
    } else {
        unitsDiv.style.display = 'none';
        icon.textContent = '▶';
    }
}
</script>
{% endblock %}
