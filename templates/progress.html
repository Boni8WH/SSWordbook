{% extends "base.html" %}
{% block title %}é€²æ—ç¢ºèª - {{ app_name }}{% endblock %}

{% block content %}
<section class="progress-section">
    <div class="progress-header">
        <h2>é€²æ—ç¢ºèª - {{ current_user.username }} (éƒ¨å±‹: {{ current_user.room_number }})</h2>
        
        <!-- æ›´æ–°æƒ…å ±ã¨ãƒœã‚¿ãƒ³ -->
        <div class="update-info-container">
            <div class="update-info">
                {% if using_cache %}
                    <p class="cache-status">
                        <i class="fas fa-clock text-primary"></i>
                        <strong>è‡ªå‹•æ›´æ–°:</strong> 2æ™‚é–“ãŠãï¼ˆ0:00, 2:00, 4:00...ï¼‰
                    </p>
                    {% if last_update_time %}
                    <p class="last-update">
                        <i class="fas fa-sync-alt text-success"></i>
                        <strong>æœ€çµ‚æ›´æ–°:</strong> {{ last_update_time|to_jst }}
                    </p>
                    {% endif %}
                    {% if next_update_time %}
                    <p class="next-update">
                        <i class="fas fa-clock text-info"></i>
                        <strong>æ¬¡å›æ›´æ–°:</strong> {{ next_update_time.strftime('%H:%M') }}
                    </p>
                    {% endif %}
                {% else %}
                    <p class="realtime-status">
                        <i class="fas fa-bolt text-warning"></i>
                        <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºä¸­</strong>ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
                    </p>
                {% endif %}
            </div>
            
            <!-- æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ -->
            <div class="manual-update-section">
                <button id="updateMyProgressBtn" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-sync-alt"></i> è‡ªåˆ†ã®é€²æ—ã‚’æ›´æ–°
                </button>
                <small class="text-muted d-block mt-1">
                    æœ€æ–°ã®å­¦ç¿’çŠ¶æ³ã‚’åæ˜ ã—ã¾ã™
                </small>
            </div>
        </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="ranking-container">
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨é †ä½ã‚’æ¨ªä¸¦ã³ï¼‰ -->
        <div class="ranking-header">
            <div class="ranking-title-section">
                <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° (éƒ¨å±‹ï¼š{{ current_user.room_number }})</h3>
                <p>åŒã˜éƒ¨å±‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å†…ã§ã®ä¸Šä½5åã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
            </div>
            
            {% if current_user_rank %}
            <div class="user-rank-section">
                <h4>ã‚ãªãŸã®é †ä½</h4>
                <div class="rank-display{% if current_user_rank == 1 %} rank-1{% elif current_user_rank == 2 %} rank-2{% elif current_user_rank == 3 %} rank-3{% endif %}">
                    {% if current_user_rank == 1 %}
                        <span class="rank-icon">ğŸ‘‘</span>
                    {% elif current_user_rank == 2 %}
                        <span class="rank-icon">ğŸ¥ˆ</span>
                    {% elif current_user_rank == 3 %}
                        <span class="rank-icon">ğŸ¥‰</span>
                    {% endif %}
                    <span class="rank-number">{{ current_user_rank }}</span>
                    <span class="rank-text">ä½</span>
                    <span class="rank-total">/ {{ total_users_in_room }}äºº</span>
                </div>
            </div>
            {% endif %}
        </div>

        {% if current_user_stats %}
        <div class="current-user-stats">
            <h4>ğŸ“Š ã‚ãªãŸã®ã‚¹ã‚³ã‚¢è©³ç´°</h4>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">ç·åˆã‚¹ã‚³ã‚¢</span>
                    <span class="stat-value main-score">{{ current_user_stats.balance_score|round(1) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ãƒã‚¹ã‚¿ãƒªãƒ¼ã‚¹ã‚³ã‚¢</span>
                    <span class="stat-value">{{ current_user_stats.mastery_score|round(1) }}</span>
                    <small class="stat-description">(ãƒã‚¹ã‚¿ãƒ¼æ•°)<sup>1.3</sup> Ã— 0.1</small>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢</span>
                    <span class="stat-value">{{ current_user_stats.reliability_score|round(1) }}</span>
                    <small class="stat-description">(è£œæ­£æ­£ç­”ç‡)<sup>2</sup> Ã— 5</small>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ´»å‹•ã‚¹ã‚³ã‚¢</span>
                    <span class="stat-value">{{ current_user_stats.activity_score|round(1) }}</span>
                    <small class="stat-description">ln(å›ç­”æ•° + 1) Ã— 0.2</small>
                </div>
            </div>
            <div class="basic-stats">
                <p><strong>åŸºæœ¬çµ±è¨ˆ:</strong> 
                    å›ç­”æ•°: {{ current_user_stats.total_attempts }}å› | 
                    æ­£è§£æ•°: {{ current_user_stats.total_correct }}å› | 
                    æ­£ç­”ç‡: {{ current_user_stats.accuracy_rate|round(1) }}% | 
                    ãƒã‚¹ã‚¿ãƒ¼æ•°: {{ current_user_stats.mastered_count }}å• | 
                    ç¶²ç¾…ç‡: {{ current_user_stats.coverage_rate|round(1) }}%
                </p>
            </div>
        </div>
        {% endif %}

        <div class="ranking-criteria">
            <p><strong>ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åŸºæº–:</strong> ä¿¡é ¼æ€§é‡è¦–ã®ç·åˆå­¦ç¿’è©•ä¾¡ã‚¹ã‚³ã‚¢ã®é«˜ã„é †</p>
            <p><strong>ğŸ”¢ ã‚¹ã‚³ã‚¢ç®—å‡º:</strong> â‘  ãƒã‚¹ã‚¿ãƒ¼æ•°é‡è¦– + â‘¡ ä¿¡é ¼æ€§è£œæ­£æ¸ˆã¿æ­£ç­”ç‡ + â‘¢ é©åº¦ãªå­¦ç¿’é‡</p>
            <p><strong>âš–ï¸ å…¬å¹³æ€§ã®ä»•çµ„ã¿:</strong></p>
            <ul style="font-size: 0.85em; margin: 8px 0; padding-left: 20px; color: #495057;">
                <li>å°‘ãªã„å›ç­”æ•°ã§ã®é«˜æ­£ç­”ç‡ã¯çµ±è¨ˆçš„ã«è£œæ­£ã•ã‚Œã¾ã™</li>
                <li>å¤§é‡å›ç­”ã§ã‚‚ä½æ­£ç­”ç‡ã§ã¯é«˜ã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã›ã‚“</li>
                <li>80%ä»¥ä¸Šæ­£è§£ã—ãŸå•é¡Œæ•°ï¼ˆãƒã‚¹ã‚¿ãƒ¼æ•°ï¼‰ã‚’æœ€é‡è¦–</li>
            </ul>
            <p style="margin-top: 15px;">
                <a href="{{ url_for('score_details') }}" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-calculator"></i> è©³ç´°ãªç®—å‡ºæ–¹æ³•ã‚’è¦‹ã‚‹
                </a>
            </p>
            <p><small style="color: #6c757d;">â€» è³ªã®é«˜ã„å­¦ç¿’ï¼ˆç†è§£+å®šç€ï¼‰ã¨çµ±è¨ˆçš„ã«ä¿¡é ¼ã§ãã‚‹æˆç¸¾ã‚’è©•ä¾¡ã™ã‚‹æ–¹å¼ã§ã™</small></p>
        </div>

        {% if top_10_ranking %}
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>é †ä½</th>
                        <th>åå‰</th>
                        <th>å›ç­”æ•°</th>
                        <th>æ­£è§£æ•°</th>
                        <th>æ­£ç­”ç‡</th>
                        <th>ç·åˆã‚¹ã‚³ã‚¢</th>
                        <th>ç¶²ç¾…ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in top_10_ranking %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ entry.username }}</td>
                        <td>{{ entry.total_attempts }}</td>
                        <td>{{ entry.total_correct }}</td>
                        <td>{{ entry.accuracy_rate|round(1) }}%</td>
                        <td><strong>{{ entry.balance_score|round(1) }}</strong></td>
                        <td>{{ entry.coverage_rate|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ä»•åˆ‡ã‚Š -->
    <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0; border-radius: 1px;">

    <!-- ã‚ãªãŸã®ç« åˆ¥é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="progress-container">
        <h3>ã‚ãªãŸã®ç« åˆ¥é€²æ—</h3>
        {% if user_progress_by_chapter %}
        <div class="progress-accordion">
            {% for chapter_num, chapter_data in user_progress_by_chapter.items() %}
            <div class="chapter-progress-item" data-chapter="{{ chapter_num }}">
                <!-- ç« ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ -->
                <div class="chapter-progress-header" onclick="toggleChapterProgress('{{ chapter_num }}')">
                    <div class="chapter-progress-info">
                        <span class="chapter-toggle-icon" id="icon-{{ chapter_num }}">â–¶</span>
                        <span class="chapter-title">{{ chapter_data.chapter_name }}</span>
                    </div>
                    <div class="chapter-summary">
                        <span class="mastered-count">{{ chapter_data.total_mastered }}/{{ chapter_data.total_questions }}å•ãƒã‚¹ã‚¿ãƒ¼</span>
                        <span class="chapter-percentage">({{ ((chapter_data.total_mastered / chapter_data.total_questions * 100) if chapter_data.total_questions > 0 else 0)|round(1) }}%)</span>
                    </div>
                </div>
                
                <!-- ç« ã®é€²æ—ãƒãƒ¼ -->
                <div class="chapter-progress-bar-container">
                    <div class="chapter-progress-bar" style="width: {{ ((chapter_data.total_mastered / chapter_data.total_questions * 100) if chapter_data.total_questions > 0 else 0)|round(1) }}%;"></div>
                </div>

                <!-- å˜å…ƒè©³ç´°ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
                <div class="unit-details" id="units-{{ chapter_num }}" style="display: none;">
                    {% for unit_data in chapter_data.units %}
                    <div class="unit-progress-item">
                        <h5>{{ unit_data.unit_num }}. {{ unit_data.category_name }}</h5>
                        {% set total_attempts = unit_data.total_attempts %}
                        {% set mastered_count = unit_data.mastered_problems|length %}
                        {% set total_questions = unit_data.total_questions_in_unit %}
                        
                        <p>å•é¡Œã‚’è§£ã„ãŸæ•°: {{ total_attempts }}å›</p>
                        <p>
                            ãƒã‚¹ã‚¿ãƒ¼ã—ãŸå•é¡Œæ•°: {{ mastered_count }} / {{ total_questions }}
                            ï¼ˆ{% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %}ï¼‰
                        </p>
                        <div class="unit-progress-bar-container">
                            <div class="unit-progress-bar" style="width: {% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %};"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>ã¾ã å•é¡Œã‚’è§£ã„ã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</section>

<!-- CSSè¿½åŠ  -->
<style>
.progress-header {
    margin-bottom: 30px;
}

.update-info-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border-left: 4px solid #007bff;
}

.update-info {
    flex: 1;
}

.update-info p {
    margin: 0 0 5px 0;
    font-size: 0.9em;
}

.cache-status i, .last-update i, .next-update i, .realtime-status i {
    margin-right: 5px;
}

.manual-update-section {
    text-align: center;
    min-width: 180px;
}

.manual-update-section small {
    font-size: 0.8em;
}

.btn-loading {
    opacity: 0.6;
    pointer-events: none;
}

.update-success {
    color: #28a745;
    font-weight: bold;
}

.update-error {
    color: #dc3545;
    font-weight: bold;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin-custom {
    animation: spin 1s linear infinite;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .update-info-container {
        flex-direction: column;
        gap: 15px;
    }
    
    .manual-update-section {
        min-width: auto;
        width: 100%;
    }
}
</style>

<!-- JavaScriptè¿½åŠ  -->
<script>
function toggleChapterProgress(chapterNum) {
    const unitsDiv = document.getElementById('units-' + chapterNum);
    const icon = document.getElementById('icon-' + chapterNum);
    
    if (unitsDiv.style.display === 'none' || unitsDiv.style.display === '') {
        unitsDiv.style.display = 'block';
        icon.textContent = 'â–¼';
    } else {
        unitsDiv.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}

// æ‰‹å‹•æ›´æ–°æ©Ÿèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const updateBtn = document.getElementById('updateMyProgressBtn');
    
    if (updateBtn) {
        updateBtn.addEventListener('click', function() {
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            updateBtn.classList.add('btn-loading');
            updateBtn.disabled = true;
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const icon = updateBtn.querySelector('i');
            icon.classList.add('fa-spin-custom');
            
            // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
            updateBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin-custom"></i> æ›´æ–°ä¸­...';
            
            // AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            fetch('/update_my_progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æˆåŠŸæ™‚
                    updateBtn.innerHTML = '<i class="fas fa-check text-success"></i> æ›´æ–°å®Œäº†ï¼';
                    updateBtn.classList.add('update-success');
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    showUpdateMessage(data.message, 'success');
                    
                    // 2ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    // ã‚¨ãƒ©ãƒ¼æ™‚
                    updateBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> ã‚¨ãƒ©ãƒ¼';
                    updateBtn.classList.add('update-error');
                    
                    showUpdateMessage(data.message || 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                    
                    // 3ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
                    setTimeout(resetUpdateButton, 3000);
                }
            })
            .catch(error => {
                console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                updateBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼';
                updateBtn.classList.add('update-error');
                
                showUpdateMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                
                // 3ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
                setTimeout(resetUpdateButton, 3000);
            });
        });
    }
    
    function resetUpdateButton() {
        updateBtn.classList.remove('btn-loading', 'update-success', 'update-error');
        updateBtn.disabled = false;
        updateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> è‡ªåˆ†ã®é€²æ—ã‚’æ›´æ–°';
    }
    
    function showUpdateMessage(message, type) {
        // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const existingAlert = document.querySelector('.update-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show update-alert`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        
        alertDiv.innerHTML = `
            <strong>${type === 'success' ? 'æˆåŠŸ!' : 'ã‚¨ãƒ©ãƒ¼!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}