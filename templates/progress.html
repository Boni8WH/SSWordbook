{% extends "base.html" %}
{% block title %}é€²æ—ç¢ºèª - {{ app_name }}{% endblock %}

{% block content %}
<section class="progress-section">
    <h2>é€²æ—ç¢ºèª - {{ current_user.username }} (éƒ¨å±‹: {{ current_user.room_number }})</h2>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸Šã«ç§»å‹• -->
    <div class="ranking-container">
        <h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚° (éƒ¨å±‹ï¼š{{ current_user.room_number }})</h3>
        <p>åŒã˜éƒ¨å±‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å†…ã§ã®ä¸Šä½10åã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
        <div class="ranking-criteria">
            <p><strong>ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åŸºæº–:</strong> ã‚¹ã‚³ã‚¢ã®é«˜ã„é †</p>
            <p><strong>ğŸ”¢ ã‚¹ã‚³ã‚¢ç®—å‡º:</strong> ãƒã‚¹ã‚¿ãƒ¼æ•°&æ­£ç­”ç‡é‡è¦– + é©åº¦ãªå­¦ç¿’é‡è©•ä¾¡ï¼š(ãƒã‚¹ã‚¿ãƒ¼æ•°)^1.3*10+(æ­£ç­”ç‡)*2*500+log(ç·å›ç­”æ•°)*20</p>
            <p><small>â€» æ­£ç­”ç‡ãŒä½ã„ã¾ã¾ã§ã¯ã€ã„ãã‚‰å¤§é‡ã«è§£ã„ã¦ã‚‚é«˜ã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã›ã‚“ã€‚è³ªã®é«˜ã„å­¦ç¿’ã‚’é‡è¦–ã—ãŸè©•ä¾¡æ–¹å¼ã§ã™ã€‚</small></p>
        </div>
        {% if top_10_ranking %}
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>é †ä½</th>
                        <th>åå‰</th>
                        <th>å›ç­”æ•°</th>
                        <th>æ­£è§£æ•°</th>
                        <th>æ­£ç­”ç‡</th>
                        <th>ã‚¹ã‚³ã‚¢</th>
                        <th>ç¶²ç¾…ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in top_10_ranking %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ entry.username }}</td>
                        <td>{{ entry.total_attempts }}</td>
                        <td>{{ entry.total_correct }}</td>
                        <td>{{ entry.accuracy_rate|round(1) }}%</td>
                        <td><strong>{{ entry.balance_score|round(1) }}</strong></td>
                        <td>{{ entry.coverage_rate|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ä»•åˆ‡ã‚Š -->
    <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0; border-radius: 1px;">

    <!-- ã‚ãªãŸã®å˜å…ƒåˆ¥é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="progress-container">
        <h3>ã‚ãªãŸã®å˜å…ƒåˆ¥é€²æ—</h3>
        {% if user_progress_by_unit %}
        <div class="progress-list">
            {% for unit_num, progress in user_progress_by_unit %}
                <div class="progress-item">
                    <h4>{{ unit_num }}. {{ progress.categoryName }}</h4>
                    {% set total_attempts = progress.total_attempts %}
                    {% set mastered_count = progress.mastered_problems|length %}
                    {% set total_questions = progress.total_questions_in_unit %}
                    
                    <p>
                        å•é¡Œã‚’è§£ã„ãŸæ•°: {{ total_attempts }}å›
                    </p>
                    <p>
                        ãƒã‚¹ã‚¿ãƒ¼ã—ãŸå•é¡Œæ•°: {{ mastered_count }} / {{ total_questions }}
                        ï¼ˆ{% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %}ï¼‰
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {% if total_questions > 0 %}{{ (mastered_count / total_questions * 100)|round(1) }}%{% else %}0%{% endif %};"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <p>ã¾ã å•é¡Œã‚’è§£ã„ã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</section>
{% endblock %}
