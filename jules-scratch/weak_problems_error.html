<!DOCTYPE html><html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=3.0">
    <title>苦手問題一覧 - 世界史単語帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="/static/NapoleonIcon.png">
    <link rel="shortcut icon" href="/static/NapoleonIcon.png">

    <script>
        // Flaskからのデータをグローバル変数として先に設定
        window.appInfoFromFlask = null;
        window.chapterDataFromFlask = null;
    </script>
    <style>
        .navbar-brand {
            font-family: 'Merriweather', serif !important;
            font-weight: 700 !important; /* ボールド */
        }
    </style>


</head>
<body>
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm rounded mb-4">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary" href="/" style="display: flex; align-items: center;">
                    <img src="/static/NapoleonIcon.png" alt="App Icon" style="height: 30px;" class="me-2">

                        <span class="ms-1">世界史単語帳</span>

                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">

                    <div class="navbar-nav me-auto">
                        <div class="nav-item">
                            <span class="nav-link text-muted">
                                <i class="fas fa-user me-1"></i>test_user_weak_problems
                            </span>
                        </div>

                        <div class="nav-item">
                            <span class="nav-link text-muted">
                                <i class="fas fa-door-open me-1"></i>部屋番号: 987
                            </span>
                        </div>

                    </div>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link btn btn-danger text-white btn-sm me-2" href="https://www.youtube.com/channel/UCf3wJznXaY9z7K2eAgZI98Q" target="_blank" rel="noopener noreferrer" title="YouTubeチャンネルを開く">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-primary btn-sm me-2" href="/progress">
                                <i class="fas fa-chart-line me-1"></i>進捗確認
                            </a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link btn btn-outline-warning change-username-button btn-sm me-2" href="/change_username">
                        <i class="fas fa-user-edit me-1"></i>アカウント名変更
                        </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-danger btn-sm" href="/logout">
                                <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                            </a>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>






<section class="weak-problems-page">
    <div class="page-header">
        <h2><i class="fas fa-exclamation-triangle text-danger"></i> 苦手問題一覧</h2>
        <p>あなたの苦手な問題と、部屋のみんなが苦手としている問題を確認して、効率的に学習を進めましょう。</p>
    </div>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs" id="weakProblemTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-weak-tab" data-bs-toggle="tab" data-bs-target="#my-weak-content" type="button" role="tab" aria-controls="my-weak-content" aria-selected="true">
                <i class="fas fa-user-graduate"></i> あなたの苦手問題 Top 20
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="everyone-weak-tab" data-bs-toggle="tab" data-bs-target="#everyone-weak-content" type="button" role="tab" aria-controls="everyone-weak-content" aria-selected="false" tabindex="-1">
                <i class="fas fa-users"></i> みんなの苦手問題 Top 20
            </button>
        </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="weakProblemTabsContent">
        <!-- あなたの苦手問題 -->
        <div class="tab-pane fade show active" id="my-weak-content" role="tabpanel" aria-labelledby="my-weak-tab">
            <div id="my-weak-loading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">あなたの苦手問題を取得中...</p>
            </div>
            <div id="my-weak-problems-container" class="row g-3 mt-3" style="display: none;">
                <!-- JavaScriptでカードを挿入 -->
            </div>
            <div id="my-weak-empty" class="alert alert-success mt-3" style="display: none;">
                <h4 class="alert-heading"><i class="fas fa-check-circle"></i> 素晴らしい！</h4>
                <p>現在、あなたの苦手な問題はありません。この調子で学習を続けましょう！</p>
            </div>
        </div>

        <!-- みんなの苦手問題 -->
        <div class="tab-pane fade" id="everyone-weak-content" role="tabpanel" aria-labelledby="everyone-weak-tab">
            <div id="everyone-weak-loading" class="text-center py-5">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">みんなの苦手問題を取得中...</p>
            </div>
            <div id="everyone-weak-problems-container" class="row g-3 mt-3" style="display: none;">
                <!-- JavaScriptでカードを挿入 -->
            </div>
             <div id="everyone-weak-empty" class="alert alert-info mt-3" style="display: none;">
                <h4 class="alert-heading"><i class="fas fa-info-circle"></i> データ不足</h4>
                <p>まだ十分な解答データが蓄積されていないため、「みんなの苦手問題」を表示できません。</p>
            </div>
        </div>
    </div>
</section>

<style>
.weak-problems-page {
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #dee2e6;
}

.problem-card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    background-color: #fff;
    transition: box-shadow 0.2s ease-in-out;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.problem-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
}

.card-body {
    padding: 1rem;
    flex-grow: 1;
}

.card-question {
    font-size: 1.1em;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.card-answer {
    background-color: #f1f3f5;
    border-radius: 0.25rem;
    padding: 0.75rem;
    font-size: 1.1em;
    font-weight: 500;
    color: #212529;
}

.card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
    font-size: 0.9em;
}

.stat-label {
    font-weight: 600;
    color: #495057;
}

.accuracy-bar-container {
    height: 20px;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    overflow: hidden;
}

.accuracy-bar {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8em;
    transition: width 0.5s ease-in-out;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // タブが切り替わったときにもデータをロードするようにイベントリスナーを設定
    const myWeakTab = document.getElementById('my-weak-tab');
    const everyoneWeakTab = document.getElementById('everyone-weak-tab');

    myWeakTab.addEventListener('shown.bs.tab', () => loadMyWeakProblems());
    everyoneWeakTab.addEventListener('shown.bs.tab', () => loadEveryoneWeakProblems());

    // 初期表示
    loadMyWeakProblems();

    async function loadMyWeakProblems() {
        const container = document.getElementById('my-weak-problems-container');
        const loading = document.getElementById('my-weak-loading');
        const emptyMessage = document.getElementById('my-weak-empty');

        // すでにデータがあれば再読み込みしない
        if (container.innerHTML.trim() !== '') {
            loading.style.display = 'none';
            return;
        }

        loading.style.display = 'block';
        container.style.display = 'none';
        emptyMessage.style.display = 'none';

        try {
            const response = await fetch('/api/my_weak_problems');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (data.status === 'success' && data.problems.length > 0) {
                renderProblemCards(container, data.problems, 'my');
                container.style.display = 'flex';
            } else {
                emptyMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching my weak problems:', error);
            container.innerHTML = '<div class="alert alert-danger">データの読み込みに失敗しました。</div>';
            container.style.display = 'flex';
        } finally {
            loading.style.display = 'none';
        }
    }

    async function loadEveryoneWeakProblems() {
        const container = document.getElementById('everyone-weak-problems-container');
        const loading = document.getElementById('everyone-weak-loading');
        const emptyMessage = document.getElementById('everyone-weak-empty');

        // すでにデータがあれば再読み込みしない
        if (container.innerHTML.trim() !== '') {
            loading.style.display = 'none';
            return;
        }

        loading.style.display = 'block';
        container.style.display = 'none';
        emptyMessage.style.display = 'none';

        try {
            const response = await fetch('/api/everyone_weak_problems');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (data.status === 'success' && data.problems.length > 0) {
                renderProblemCards(container, data.problems, 'everyone');
                container.style.display = 'flex';
            } else {
                emptyMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching everyone\'s weak problems:', error);
            container.innerHTML = '<div class="alert alert-danger">データの読み込みに失敗しました。</div>';
            container.style.display = 'flex';
        } finally {
            loading.style.display = 'none';
        }
    }

    function renderProblemCards(container, problems, type) {
        container.innerHTML = '';
        problems.forEach((problem, index) => {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 col-sm-12';

            let footerHtml = '';
            if (type === 'my') {
                footerHtml = `
                    <div class="d-flex justify-content-between">
                        <div><span class="stat-label">あなたの回答:</span> <span class="text-success">${problem.correct}</span> / <span class="text-danger">${problem.incorrect}</span> (正/誤)</div>
                        <div>
                            <span class="stat-label">正答率:</span>
                            <div class="progress" style="height: 20px; min-width: 100px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: ${problem.accuracy}%;" aria-valuenow="${problem.accuracy}" aria-valuemin="0" aria-valuemax="100">
                                    ${problem.accuracy.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else { // everyone
                footerHtml = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="stat-label">全体の正答率:</span>
                            <div class="progress" style="height: 20px; min-width: 100px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: ${problem.accuracy}%;" aria-valuenow="${problem.accuracy}" aria-valuemin="0" aria-valuemax="100">
                                    ${problem.accuracy.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                        <div>
                            <span class="stat-label">あなたの正答率:</span>
                            ${problem.my_accuracy !== null ? `
                                <div class="progress" style="height: 20px; min-width: 100px;">
                                    <div class="progress-bar ${getAccuracyColor(problem.my_accuracy)}" role="progressbar" style="width: ${problem.my_accuracy}%;" aria-valuenow="${problem.my_accuracy}" aria-valuemin="0" aria-valuemax="100">
                                        ${problem.my_accuracy.toFixed(1)}%
                                    </div>
                                </div>
                            ` : '<span class="text-muted">未回答</span>'}
                        </div>
                    </div>
                `;
            }

            col.innerHTML = `
                <div class="problem-card">
                    <div class="card-header">
                        <span>${type === 'my' ? '' : `<strong>${index + 1}.</strong> `}問題</span>
                        <button class="btn btn-sm btn-outline-secondary toggle-answer-btn">答えを見る</button>
                    </div>
                    <div class="card-body">
                        <p class="card-question">${problem.question}</p>
                        <div class="card-answer" style="display: none;">${problem.answer}</div>
                    </div>
                    <div class="card-footer">
                        ${footerHtml}
                    </div>
                </div>
            `;
            container.appendChild(col);
        });

        // Add event listeners for the new buttons
        container.querySelectorAll('.toggle-answer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const cardBody = e.target.closest('.problem-card').querySelector('.card-body');
                const answer = cardBody.querySelector('.card-answer');
                const isHidden = answer.style.display === 'none';
                answer.style.display = isHidden ? 'block' : 'none';
                e.target.textContent = isHidden ? '答えを隠す' : '答えを見る';
            });
        });
    }

    function getAccuracyColor(accuracy) {
        if (accuracy >= 80) return 'bg-success';
        if (accuracy >= 50) return 'bg-warning';
        return 'bg-danger';
    }
});
</script>

    </div>


    <footer class="footer mt-5 py-4 bg-light border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="footer-text">

                            © 2025 世界史単語帳. All rights reserved.

                    </div>
                </div>
                <div class="col-md-6 text-md-end">

                    <div class="app-version mt-1">
                        <small class="text-muted">
                            世界史単語帳 v1.0.0
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> <script src="/static/script.js"></script>
    <script src="/static/essay_quiz.js"></script>
    <script src="/static/daily_quiz.js"></script>


</body></html>