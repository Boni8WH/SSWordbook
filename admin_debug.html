{% extends "base.html" %}

{% block title %}ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª - ä¸–ç•Œå²å˜èªå¸³{% endblock %}

{% block content %}
<div class="container">
    <h2>ğŸ“Š é€²æ—ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª</h2>
    
    <div class="alert alert-info">
        <strong>ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ï¼š</strong> å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã€å•é¡ŒIDç”Ÿæˆã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
    </div>

    <!-- æ¦‚è¦çµ±è¨ˆ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h3>ğŸ“ˆ æ¦‚è¦çµ±è¨ˆ</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ debug_info|length }}</h5>
                            <p class="card-text">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ debug_info|sum(attribute='total_history_entries') }}</h5>
                            <p class="card-text">ç·å­¦ç¿’å±¥æ­´æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ debug_info|sum(attribute='matched_problems') }}</h5>
                            <p class="card-text">ãƒãƒƒãƒã—ãŸå•é¡Œæ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ debug_info|sum(attribute='unmatched_problems') }}</h5>
                            <p class="card-text">ãƒãƒƒãƒã—ãªã„å•é¡Œæ•°</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿ -->
    <div class="mb-4">
        <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿çŠ¶æ³</h3>
        {% if debug_info %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                        <th>éƒ¨å±‹ç•ªå·</th>
                        <th>å­¦ç¿’å±¥æ­´æ•°</th>
                        <th>ãƒãƒƒãƒã™ã‚‹å•é¡Œ</th>
                        <th>ãƒãƒƒãƒã—ãªã„å•é¡Œ</th>
                        <th>è‹¦æ‰‹å•é¡Œæ•°</th>
                        <th>ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§</th>
                    </tr>
                </thead>
                <tbody>
                    {% for info in debug_info %}
                    <tr>
                        <td><strong>{{ info.username }}</strong></td>
                        <td><span class="badge bg-secondary">{{ info.room_number }}</span></td>
                        <td>{{ info.total_history_entries }}</td>
                        <td>
                            <span class="text-success">{{ info.matched_problems }}</span>
                        </td>
                        <td>
                            {% if info.unmatched_problems > 0 %}
                                <span class="text-danger">{{ info.unmatched_problems }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>{{ info.incorrect_words_count }}</td>
                        <td>
                            {% if info.unmatched_problems == 0 %}
                                <span class="badge bg-success">âœ… æ­£å¸¸</span>
                            {% else %}
                                <span class="badge bg-warning">âš ï¸ è¦ç§»è¡Œ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if info.unmatched_problems > 0 and info.unmatched_list %}
                    <tr class="table-light">
                        <td colspan="7">
                            <small class="text-muted">
                                <strong>ãƒãƒƒãƒã—ãªã„IDä¾‹:</strong> 
                                {{ info.unmatched_list|join(', ') }}
                                {% if info.unmatched_problems > 5 %}...ä»–{{ info.unmatched_problems - 5 }}ä»¶{% endif %}
                            </small>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">å­¦ç¿’å±¥æ­´ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</div>
        {% endif %}
    </div>

    <!-- å•é¡ŒIDç”Ÿæˆãƒ†ã‚¹ãƒˆ -->
    <div class="mb-4">
        <h3>ğŸ” å•é¡ŒIDç”Ÿæˆãƒ†ã‚¹ãƒˆ</h3>
        <p class="text-muted">JavaScriptå´ã¨Pythonå´ã§åŒã˜IDãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        
        {% if id_test_results %}
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å•é¡Œæ–‡</th>
                        <th>ç« </th>
                        <th>å˜å…ƒ</th>
                        <th>ç”Ÿæˆã•ã‚ŒãŸID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in id_test_results %}
                    <tr>
                        <td>{{ result.question }}</td>
                        <td>{{ result.chapter }}</td>
                        <td>{{ result.number }}</td>
                        <td><code>{{ result.generated_id }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
        {% endif %}
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="d-flex gap-2 mb-4">
        <a href="{{ url_for('admin_page') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        </a>
        <button onclick="window.location.reload()" class="btn btn-outline-secondary">
            <i class="fas fa-sync-alt"></i> æ›´æ–°
        </button>
    </div>

    <!-- æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% set total_unmatched = debug_info|sum(attribute='unmatched_problems') %}
    {% if total_unmatched > 0 %}
    <div class="alert alert-warning">
        <h5>ğŸ”§ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h5>
        <p>{{ total_unmatched }}ä»¶ã®ãƒãƒƒãƒã—ãªã„å­¦ç¿’å±¥æ­´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</p>
        <p><strong>æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š</strong></p>
        <ol>
            <li>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</li>
            <li>ã€ŒğŸ”„ å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã€ãƒœã‚¿ãƒ³ã‚’å®Ÿè¡Œ</li>
            <li>ã“ã®ãƒšãƒ¼ã‚¸ã§å†ç¢ºèª</li>
        </ol>
    </div>
    {% else %}
    <div class="alert alert-success">
        <h5>âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèªå®Œäº†</h5>
        <p>ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ãŒæ­£ã—ãé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã¯ä¸è¦ã§ã™ã€‚</p>
    </div>
    {% endif %}
</div>
{% endblock %}