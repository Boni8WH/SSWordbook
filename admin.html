{# admin.html - éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œç‰ˆï¼ˆä¿®æ­£ç‰ˆï¼‰ #}

{% extends "base.html" %}

{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - ä¸–ç•Œå²å˜èªå¸³{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <section id="admin-user-management">
        <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
        <p>ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ users|length }}äºº</p>

        <h4>å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h4>
        <form action="{{ url_for('admin_add_user') }}" method="POST" class="add-user-form">
            <div class="input-group">
                <label for="new_room_number">éƒ¨å±‹ç•ªå·:</label>
                <input type="text" id="new_room_number" name="room_number" required>
            </div>
            <div class="input-group">
                <label for="new_room_password">å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_room_password" name="room_password" required>
            </div>
            <div class="input-group">
                <label for="new_student_id">å‡ºå¸­ç•ªå·:</label>
                <input type="text" id="new_student_id" name="student_id" required>
            </div>
            <div class="input-group">
                <label for="new_individual_password">å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="new_individual_password" name="individual_password" required>
            </div>
            <div class="input-group">
                <label for="new_username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:</label>
                <input type="text" id="new_username" name="username" required>
            </div>
            <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
        </form>

        <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ‹¬ç™»éŒ² (CSV)</h4>
        <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã«ã€Œéƒ¨å±‹ç•ªå·,å…¥å®¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,å‡ºå¸­ç•ªå·,å€‹åˆ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰,ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã€ã‚’æŒã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
        <form action="{{ url_for('admin_upload_users') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <div class="input-group">
                <label for="user_csv_file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="user_csv_file" name="file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-secondary">ä¸€æ‹¬ç™»éŒ²</button>
        </form>

        <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
        <p>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
        <div class="download-buttons">
            <a href="{{ url_for('download_users_csv') }}" class="btn btn-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
            <a href="{{ url_for('download_users_template_csv') }}" class="btn btn-outline-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <h4 style="margin-top: 30px; color: #e67e22;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h4>
        <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <p><strong>å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ:</strong></p>
            <p>å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®å­¦ç¿’å±¥æ­´ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚é€²æ—ç¢ºèªãƒšãƒ¼ã‚¸ã§å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            <p><em>âš ï¸ ã“ã®æ“ä½œã¯ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚å®Ÿè¡Œå‰ã«ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</em></p>
            <div style="margin-top: 10px;">
                <a href="{{ url_for('admin_debug_progress') }}" class="btn btn-info btn-sm" target="_blank">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’ç¢ºèª</a>
                <form action="{{ url_for('admin_migrate_data') }}" method="POST" style="display: inline-block; margin-left: 10px;" onsubmit="return confirm('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“\nãƒ»å®Ÿè¡Œä¸­ã¯ã‚¢ãƒ—ãƒªã‚’åœæ­¢ã—ãªã„ã§ãã ã•ã„\nãƒ»å®Ÿè¡Œå¾Œã¯é€²æ—ç¢ºèªãƒšãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-warning">ğŸ”„ å­¦ç¿’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ</button>
                </form>
            </div>
        </div>

        <h4 style="margin-top: 30px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h4>
        <div class="table-responsive">
            <table class="table table-striped user-list-table">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>éƒ¨å±‹</th>
                        <th>å‡ºå¸­ç•ªå·</th>
                        <th>åå‰</th>
                        <th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    {% if user.username != 'admin' %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.room_number }}</td>
                        <td>{{ user.student_id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'æœªãƒ­ã‚°ã‚¤ãƒ³' }}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-user-btn" data-user-id="{{ user.id }}" data-username="{{ user.username }}">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <hr>

    <!-- æ–°ã—ã„éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section id="admin-csv-management">
        <h3>ğŸ“ éƒ¨å±‹ã”ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
        <p>å„éƒ¨å±‹ã§ä½¿ç”¨ã™ã‚‹å˜èªå¸³CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®words.csvãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>

        <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h4>
        <div style="background-color: #e8f4fd; border: 1px solid #b3d7ff; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼è¦ä»¶:</strong></p>
            <ul>
                <li>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: chapter, number, category, question, answer, enabled</li>
                <li>enabledåˆ—: 1ï¼ˆæœ‰åŠ¹ï¼‰ã¾ãŸã¯0ï¼ˆç„¡åŠ¹ï¼‰</li>
                <li>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8</li>
            </ul>
        </div>
        
        <form action="{{ url_for('admin_upload_room_csv') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <div class="input-group">
                <label for="room_number_for_csv">å¯¾è±¡éƒ¨å±‹ç•ªå·:</label>
                <input type="text" id="room_number_for_csv" name="room_number_for_csv" required placeholder="ä¾‹: 101">
            </div>
            <div class="input-group">
                <label for="room_csv_file">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="room_csv_file" name="file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-success">éƒ¨å±‹ç”¨CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </form>

        <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h4>
        <div id="csv-files-list">
            <button class="btn btn-info btn-sm" onclick="loadCsvFilesList()">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°</button>
            <div id="csv-files-container" style="margin-top: 15px;">
                <!-- JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
            </div>
        </div>
    </section>

    <hr>

    <section id="admin-room-settings">
        <h3>éƒ¨å±‹ã”ã¨ã®è¨­å®šç®¡ç†</h3>
        <p>å„éƒ¨å±‹ã®å­¦ç¿’ç¯„å›²ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

        <div class="table-responsive">
            <table class="table table-striped room-setting-table">
                <thead class="table-dark">
                    <tr>
                        <th>éƒ¨å±‹ç•ªå·</th>
                        <th>æœ€å¤§å˜å…ƒç•ªå·</th>
                        <th>ä½¿ç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {# ç™»éŒ²æ¸ˆã¿ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨å±‹ç•ªå·ã‚’é‡è¤‡ãªãå–å¾—ã—ã€ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º #}
                    {% set unique_room_numbers = [] %}
                    {% for user in users %}
                        {% if user.room_number not in unique_room_numbers and user.room_number != 'ADMIN' %}
                            {% set _ = unique_room_numbers.append(user.room_number) %}
                        {% endif %}
                    {% endfor %}
                    
                    {# RoomSettingãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›´æ¥å­˜åœ¨ã™ã‚‹éƒ¨å±‹ç•ªå·ã‚‚å–å¾—ã—ã€çµåˆã™ã‚‹ #}
                    {% for setting in room_max_unit_settings.keys() %}
                        {% if setting not in unique_room_numbers and setting != 'ADMIN' %}
                            {% set _ = unique_room_numbers.append(setting) %}
                        {% endif %}
                    {% endfor %}

                    {% for room_num in unique_room_numbers|sort %}
                    <tr>
                        <td><strong>{{ room_num }}</strong></td>
                        <td>
                            <input type="text"
                                   id="maxUnit_{{ room_num }}"
                                   value="{{ room_max_unit_settings.get(room_num, '9999') }}"
                                   class="form-control unit-setting-input"
                                   data-room-number="{{ room_num }}"
                                   placeholder="ä¾‹: 34 ã¾ãŸã¯ 9999ï¼ˆå…¨ã¦ï¼‰">
                        </td>
                        <td>
                            <select id="csvFile_{{ room_num }}" 
                                    class="form-control csv-setting-select" 
                                    data-room-number="{{ room_num }}">
                                <option value="words.csv" {% if room_csv_settings.get(room_num, 'words.csv') == 'words.csv' %}selected{% endif %}>
                                    words.csv (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                                </option>
                                <!-- å‹•çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
                            </select>
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm">
                                <button class="btn btn-primary btn-sm save-room-setting-btn" data-room-number="{{ room_num }}">ä¿å­˜</button>
                                <button class="btn btn-danger btn-sm delete-room-setting-btn" data-room-number="{{ room_num }}">å‰Šé™¤</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <h4>è¨­å®šãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
        <p>ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹ã”ã¨ã®è¨­å®šã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
        <div class="download-buttons">
            <a href="{{ url_for('download_room_settings_csv') }}" class="btn btn-info">éƒ¨å±‹è¨­å®šCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
            <a href="{{ url_for('download_room_settings_template_csv') }}" class="btn btn-outline-info">è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
        </div>
    </section>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    loadCsvFilesList();
    updateCsvSelectOptions();

    // éƒ¨å±‹è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.save-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;
            const maxUnitInput = document.getElementById(`maxUnit_${roomNumber}`);
            const csvFileSelect = document.getElementById(`csvFile_${roomNumber}`);
            const maxUnit = maxUnitInput.value.trim();
            const csvFilename = csvFileSelect.value;

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            this.disabled = true;
            this.textContent = 'ä¿å­˜ä¸­...';

            // å˜å…ƒè¨­å®šã¨CSVãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åŒæ™‚ã«æ›´æ–°
            Promise.all([
                fetch('{{ url_for("admin_update_room_unit_setting") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        max_unit: maxUnit
                    })
                }),
                fetch('{{ url_for("admin_update_room_csv_setting") }}', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        csv_filename: csvFilename
                    })
                })
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                const unitResult = results[0];
                const csvResult = results[1];
                
                if (unitResult.status === 'success' && csvResult.status === 'success') {
                    alert(`éƒ¨å±‹ ${roomNumber} ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ:\nãƒ»æœ€å¤§å˜å…ƒ: ${maxUnit}\nãƒ»CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFilename}`);
                    window.location.reload();
                } else {
                    alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'ä¿å­˜';
            });
        });
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ "${username}" (ID: ${userId}) ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `{{ url_for('admin_delete_user', user_id=0) }}`.replace('0', userId);

                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // éƒ¨å±‹è¨­å®šå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.querySelectorAll('.delete-room-setting-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomNumber = this.dataset.roomNumber;

            if (confirm(`éƒ¨å±‹ "${roomNumber}" ã®è¨­å®šã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®éƒ¨å±‹ã«å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `{{ url_for('admin_delete_room_setting', room_number='_ROOM_NUMBER_') }}`.replace('_ROOM_NUMBER_', roomNumber);

                document.body.appendChild(form);
                form.submit();
            }
        });
    });
});

// CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€é–¢æ•°
function loadCsvFilesList() {
    fetch('{{ url_for("admin_list_room_csv_files") }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('csv-files-container');
            
            if (data.status === 'success' && data.files.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>ã‚µã‚¤ã‚º</th><th>æ›´æ–°æ—¥æ™‚</th><th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr></thead><tbody>';
                
                data.files.forEach(file => {
                    const sizeKB = Math.round(file.size / 1024 * 100) / 100;
                    html += `
                        <tr>
                            <td><code>${file.filename}</code></td>
                            <td>${sizeKB} KB</td>
                            <td>${file.modified}</td>
                            <td>
                                <button class="btn btn-danger btn-xs" onclick="deleteCsvFile('${file.filename}')">å‰Šé™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-muted">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
            updateCsvSelectOptions(data.files || []);
        })
        .catch(error => {
            console.error('Error loading CSV files:', error);
            document.getElementById('csv-files-container').innerHTML = '<p class="text-danger">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
function updateCsvSelectOptions(csvFiles = []) {
    // ã™ã¹ã¦ã®CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    document.querySelectorAll('.csv-setting-select').forEach(select => {
        const roomNumber = select.dataset.roomNumber;
        const currentValue = select.value;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ã‚’ä¸€æ—¦å‰Šé™¤
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        csvFiles.forEach(file => {
            const option = document.createElement('option');
            option.value = file.filename;
            option.textContent = file.filename;
            if (file.filename === '{{ room_csv_settings.get(room_num, "") }}') {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // ç¾åœ¨ã®å€¤ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
            select.value = currentValue;
        }
    });
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤é–¢æ•°
function deleteCsvFile(filename) {
    if (confirm(`CSVãƒ•ã‚¡ã‚¤ãƒ« "${filename}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹éƒ¨å±‹è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ã€‚\nâš ï¸ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('admin_delete_room_csv', filename='_FILENAME_') }}`.replace('_FILENAME_', filename);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

<style>
/* ç®¡ç†è€…ãƒšãƒ¼ã‚¸å°‚ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
.download-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

@media (max-width: 767px) {
    .download-buttons {
        flex-direction: column;
    }
    
    .download-buttons .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group-vertical .btn {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
}
</style>
{% endblock %}